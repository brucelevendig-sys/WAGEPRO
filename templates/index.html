<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WAGEPRO - Payroll Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Login Screen */
        #loginScreen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .login-box {
            background: white;
            padding: 3rem;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
        }

        .login-box h1 {
            text-align: center;
            margin-bottom: 2rem;
            color: #667eea;
            font-size: 2.5rem;
            font-weight: 900;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            pointer-events: auto;
            position: relative;
            z-index: 1;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .cell-number {
            color: #dc2626 !important;
            font-weight: 700 !important;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            width: auto !important;
            flex-shrink: 0;
        }

        /* Dashboard */
        #dashboard {
            display: none;
        }

        .header {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2rem;
            font-weight: 900;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .tab {
            padding: 1rem 2rem;
            background: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .tab.active {
            opacity: 1;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
        }

        .tab:not(.active) {
            opacity: 0.7;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .card-header h2 {
            color: #1f2937;
            font-size: 1.5rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f9fafb;
        }

        th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        tr:hover {
            background: #f9fafb;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            pointer-events: none;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            pointer-events: auto;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .modal-header h2 {
            color: #1f2937;
        }

        .close-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .close-btn:hover {
            background: #dc2626;
        }

        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .hidden {
            display: none;
        }

        /* Fortnight Days Grid */
        .week-section {
            margin-bottom: 1.5rem;
        }

        .week-header {
            padding: 0.5rem 1rem;
            border-radius: 6px 6px 0 0;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .week-1-header {
            background: #e0f2fe;
            color: #0c4a6e;
        }

        .week-2-header {
            background: #ddd6fe;
            color: #4c1d95;
        }

        .day-row {
            display: grid;
            grid-template-columns: 130px 1fr;
            gap: 0.5rem;
            align-items: center;
            padding: 0.5rem;
            background: white;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }

        .day-row.weekend {
            background: #fef3c7;
            border: 1px solid #fbbf24;
        }

        .day-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .day-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .ot-input {
            width: 70px;
            padding: 0.25rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-box">
            <h1>WAGEPRO</h1>
            <div id="loginError" class="alert alert-error hidden"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="loginUsername" required value="BRUCE">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" required value="bruce">
                </div>
                <button type="submit" class="btn btn-primary">Login</button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <h1>WAGEPRO</h1>
                <div class="user-info">
                    <span id="userName"></span>
                    <button class="btn btn-secondary btn-small" onclick="logout()">Logout</button>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab tab-payroll" onclick="showTab('payroll')" style="background: #ec4899; color: white;">Payroll</button>
                <button class="tab tab-staff" onclick="showTab('staff')" style="background: #10b981; color: white;">Staff</button>
                <button class="tab tab-sites" onclick="showTab('sites')" style="background: #f59e0b; color: white;">Sites</button>
                <button class="tab tab-tracking active" onclick="showTab('tracking')" style="background: white; color: #0ea5e9; border: 2px solid #0ea5e9;">üìç Tracking</button>
                <button class="tab tab-leave" onclick="showTab('leave')" style="background: #8b5cf6; color: white;">üìÖ Leave</button>
                <button class="tab tab-config" onclick="showTab('config')" style="background: #6366f1; color: white;">‚öôÔ∏è Config</button>
                <button class="tab tab-admin" onclick="showTab('admin')" style="background: #dc2626; color: white;">üîê Admin</button>
                <button class="tab tab-productivity" onclick="showTab('productivity')" style="background: #059669; color: white;">üìä Productivity</button>
            </div>

            <!-- Tab Content -->

            <!-- SITES TAB -->
            <div id="sitesTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2>Sites</h2>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 600;">
                                <input type="checkbox" id="sitesShowInactive" onchange="loadSites()" style="width: 18px; height: 18px; cursor: pointer;">
                                Show Inactive
                            </label>
                            <button class="btn btn-primary btn-small" onclick="showAddSiteModal()">+ Add Site</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Code</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sitesTableBody">
                            <tr><td colspan="5" style="text-align: center;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- STAFF TAB -->
            <div id="staffTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2>Staff Members</h2>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <label for="staffSiteFilter" style="font-weight: 600;">Filter by Site:</label>
                            <select id="staffSiteFilter" onchange="filterStaffBySite()" style="padding: 0.5rem; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.875rem; min-width: 150px;">
                                <option value="">All Sites</option>
                            </select>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 600;">
                                <input type="checkbox" id="staffShowCasuals" onchange="filterStaffBySite()" checked style="width: 18px; height: 18px; cursor: pointer;">
                                Show Casuals
                            </label>
                            <button class="btn btn-primary btn-small" onclick="showAddStaffModal()">+ Add Staff</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Cell No</th>
                                <th>Daily Rate</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="staffTableBody">
                            <tr><td colspan="4" style="text-align: center;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- PAYROLL TAB -->
            <div id="payrollTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2>Pay Periods</h2>
                        <button class="btn btn-primary btn-small" onclick="showAddPeriodModal()">+ New Pay Period</button>
                    </div>
                    <div id="payPeriodSelector" style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 1rem;">
                        <select id="payPeriodSelect" class="form-group" onchange="loadPayslips()" style="flex: 1; max-width: 400px; font-size: 1rem; font-weight: 500; padding: 0.75rem; margin: 0;">
                            <option value="">Select a pay period...</option>
                        </select>
                        <button id="deletePeriodBtn" class="btn btn-small" style="background: #ef4444; color: white; display: none;" onclick="deleteCurrentPeriod()">Delete Period</button>
                    </div>
                </div>

                <div id="payslipsCard" class="card hidden">
                    <div class="card-header">
                        <h2>Payslips</h2>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <label for="payslipSiteFilter" style="font-weight: 600;">Filter by Site:</label>
                            <select id="payslipSiteFilter" onchange="filterPayslipsBySite()" style="padding: 0.5rem; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.875rem; min-width: 150px;">
                                <option value="">All Sites</option>
                            </select>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 600;">
                                <input type="checkbox" id="payslipShowCasuals" onchange="filterPayslipsBySite()" checked style="width: 18px; height: 18px; cursor: pointer;">
                                Show Casuals
                            </label>
                            <button id="addAllToPayrollBtn" class="btn btn-primary btn-small" onclick="addAllToPayroll()" style="background: #7c3aed; display: none;">‚ûï Add All to Payroll</button>
                            <button id="paymentSummaryBtn" class="btn btn-primary btn-small" onclick="showPaymentSummary()" style="background: #0284c7; display: none;">üìä Payment Summary</button>
                            <button id="generatePDFsBtn" class="btn btn-primary btn-small" onclick="generatePDFs()" style="background: #059669; display: none;">Generate PDFs</button>
                            <button id="sendSMSBtn" class="btn btn-primary btn-small" onclick="sendPayslipSMS()" style="background: #f59e0b; display: none;">üì± Send SMS</button>
                        </div>
                    </div>
                    <div id="payslipsContainer"></div>
                </div>
            </div>

            <!-- TRACKING TAB -->
            <div id="trackingTab" class="tab-content active">
                <div class="card">
                    <div class="card-header">
                        <h2>üìç Staff Tracking</h2>
                        <div style="display: flex; gap: 0.5rem; align-items: center; position: relative; z-index: 10;">
                            <label for="trackingSiteFilter" style="font-weight: 600; color: white;">Site:</label>
                            <select id="trackingSiteFilter" onchange="filterTrackingBySite()" style="padding: 0.4rem; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.875rem; min-width: 120px;">
                                <option value="">All Sites</option>
                            </select>
                            <button type="button" class="btn btn-primary btn-small" onclick="loadTracking(); return false;" style="background: #0ea5e9; cursor: pointer; pointer-events: auto;">üîÑ Refresh</button>
                            <button type="button" class="btn btn-primary btn-small" onclick="showWhereaboutsModal(); return false;" style="background: #8b5cf6; cursor: pointer; pointer-events: auto;">üìç Request Whereabouts</button>
                        </div>
                    </div>

                    <!-- Summary Cards (Clickable) -->
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                        <div onclick="showStaffList('signed_in')" style="background: #10b981; color: white; padding: 1.5rem; border-radius: 8px; text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                            <div style="font-size: 2rem; font-weight: bold;" id="trackingSignedIn">0</div>
                            <div>Signed In</div>
                            <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;">Click to view</div>
                        </div>
                        <div onclick="showStaffList('signed_out')" style="background: #6b7280; color: white; padding: 1.5rem; border-radius: 8px; text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                            <div style="font-size: 2rem; font-weight: bold;" id="trackingSignedOut">0</div>
                            <div>Signed Out</div>
                            <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;">Click to view</div>
                        </div>
                        <div onclick="showStaffList('not_signed_in')" style="background: #f59e0b; color: white; padding: 1.5rem; border-radius: 8px; text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                            <div style="font-size: 2rem; font-weight: bold;" id="trackingNotSignedIn">0</div>
                            <div>Not Signed In</div>
                            <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;">Click to view</div>
                        </div>
                        <div onclick="showStaffList('not_working')" style="background: #dc2626; color: white; padding: 1.5rem; border-radius: 8px; text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                            <div style="font-size: 2rem; font-weight: bold;" id="trackingNotWorking">0</div>
                            <div>Not Working</div>
                            <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;">Click to view</div>
                        </div>
                        <div id="standbyCardDiv" onclick="showStandbyModal()" style="display: none; background: #92400e; color: white; padding: 1.5rem; border-radius: 8px; text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                            <div style="font-size: 2rem; font-weight: bold;" id="trackingStandbyCount">0</div>
                            <div>Standby</div>
                            <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;">Click to view</div>
                        </div>
                        <div style="background: #8b5cf6; color: white; padding: 1.5rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold;" id="trackingTotalHours">0</div>
                            <div>Total Hours Today</div>
                            <div style="font-size: 1.1rem; font-weight: bold; margin-top: 0.5rem; color: #fbbf24;" id="trackingTotalValue">R0.00</div>
                        </div>
                    </div>

                    <!-- Currently Signed In -->
                    <h3 style="margin-bottom: 1rem; color: #10b981;">üü¢ Currently Signed In</h3>
                    <table style="margin-bottom: 2rem;">
                        <thead>
                            <tr>
                                <th>Staff Name</th>
                                <th>Site</th>
                                <th>Signed In At</th>
                                <th>Hours So Far</th>
                                <th>GPS Verified</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="trackingSignedInTable">
                            <tr><td colspan="6" style="text-align: center;">Loading...</td></tr>
                        </tbody>
                    </table>

                    <!-- Today's Activity -->
                    <h3 style="margin-bottom: 1rem; color: #6b7280;">üìã Today's Activity (Completed Shifts)</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Staff Name</th>
                                <th>Site</th>
                                <th>Sign In</th>
                                <th>Sign Out</th>
                                <th>Hours</th>
                                <th>GPS</th>
                            </tr>
                        </thead>
                        <tbody id="trackingCompletedTable">
                            <tr><td colspan="6" style="text-align: center;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Attendance Reminders Section -->
                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-header">
                        <h2>üì± Attendance SMS Reminders</h2>
                        <button class="btn btn-primary btn-small" onclick="loadReminderStatus()" style="background: #f59e0b;">üîÑ Refresh</button>
                    </div>

                    <!-- Reminder Summary (Clickable) -->
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                        <div onclick="showReminderList('responded')" style="background: #10b981; color: white; padding: 1rem; border-radius: 8px; text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                            <div style="font-size: 1.5rem; font-weight: bold;" id="reminderResponded">0</div>
                            <div style="font-size: 0.875rem;">Responded</div>
                            <div style="font-size: 0.7rem; opacity: 0.8; margin-top: 0.25rem;">Click to view</div>
                        </div>
                        <div onclick="showReminderList('awaiting')" style="background: #f59e0b; color: white; padding: 1rem; border-radius: 8px; text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                            <div style="font-size: 1.5rem; font-weight: bold;" id="reminderPending">0</div>
                            <div style="font-size: 0.875rem;">Awaiting Response</div>
                            <div style="font-size: 0.7rem; opacity: 0.8; margin-top: 0.25rem;">Click to view</div>
                        </div>
                        <div onclick="showReminderList('not_working')" style="background: #6366f1; color: white; padding: 1rem; border-radius: 8px; text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                            <div style="font-size: 1.5rem; font-weight: bold;" id="reminderNotWorking">0</div>
                            <div style="font-size: 0.875rem;">Not Working</div>
                            <div style="font-size: 0.7rem; opacity: 0.8; margin-top: 0.25rem;">Click to view</div>
                        </div>
                        <div onclick="showReminderList('no_response')" style="background: #ef4444; color: white; padding: 1rem; border-radius: 8px; text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                            <div style="font-size: 1.5rem; font-weight: bold;" id="reminderNoResponse">0</div>
                            <div style="font-size: 0.875rem;">No Response</div>
                            <div style="font-size: 0.7rem; opacity: 0.8; margin-top: 0.25rem;">Click to view</div>
                        </div>
                        <div onclick="showReminderList('late')" style="background: #8b5cf6; color: white; padding: 1rem; border-radius: 8px; text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                            <div style="font-size: 1.5rem; font-weight: bold;" id="reminderLate">0</div>
                            <div style="font-size: 0.875rem;">Late Today</div>
                            <div style="font-size: 0.7rem; opacity: 0.8; margin-top: 0.25rem;">Click to view</div>
                        </div>
                    </div>

                    <!-- Today's Reminders Table -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="color: #f59e0b; margin: 0;">Today's Reminders</h3>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <select id="reminderStatusFilter" onchange="filterReminderTable()" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #d1d5db;">
                                <option value="all">All Status</option>
                                <option value="responded">‚úÖ Responded</option>
                                <option value="not_working">üè† Not Working</option>
                                <option value="no_response">‚ùå No Response</option>
                                <option value="escalated">‚ö†Ô∏è Escalated</option>
                                <option value="sent">üì§ Sent</option>
                                <option value="on_leave">üèñÔ∏è On Leave</option>
                            </select>
                            <select id="reminderSiteFilter" onchange="filterReminderTable()" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #d1d5db;">
                                <option value="all">All Sites</option>
                            </select>
                            <select id="reminderTypeFilter" onchange="filterReminderTable()" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #d1d5db;">
                                <option value="all">All Types</option>
                                <option value="clockin">üü¢ Clock In</option>
                                <option value="clockout">üî¥ Clock Out</option>
                            </select>
                            <button onclick="resendAllNotResponded()" class="btn" style="background: #f59e0b; color: white; padding: 0.5rem 1rem; font-size: 0.875rem;">
                                üì§ Resend All Not Responded
                            </button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Staff Name</th>
                                <th>Mobile</th>
                                <th>Site</th>
                                <th>Type</th>
                                <th>First SMS</th>
                                <th>Escalation</th>
                                <th>Status</th>
                                <th>Wait (min)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reminderTable">
                            <tr><td colspan="9" style="text-align: center;">Loading...</td></tr>
                        </tbody>
                    </table>

                    <!-- Manual Reminder -->
                    <div style="margin-top: 1.5rem; padding: 1rem; background: #f3f4f6; border-radius: 8px;">
                        <h4 style="margin-bottom: 0.5rem;">Send Manual Reminder</h4>
                        <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                            <select id="manualReminderSite" onchange="filterManualReminderStaff()" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                                <option value="">All Sites</option>
                            </select>
                            <select id="manualReminderStaff" style="flex: 1; min-width: 200px; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                                <option value="">Select staff member...</option>
                            </select>
                            <select id="manualReminderType" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                                <option value="clockin">Clock In</option>
                                <option value="clockout">Clock Out</option>
                            </select>
                            <button class="btn btn-primary" onclick="sendManualReminder()" style="background: #f59e0b;">Send SMS</button>
                        </div>
                    </div>

                    <!-- General Bulk SMS -->
                    <div style="margin-top: 1.5rem; padding: 1rem; background: #dbeafe; border-radius: 8px; border: 2px solid #3b82f6;">
                        <h4 style="margin-bottom: 0.5rem; color: #1e40af;">üì¢ Send General SMS to Staff</h4>
                        <div style="display: flex; gap: 1rem; align-items: flex-start; flex-wrap: wrap;">
                            <select id="bulkSmsSite" onchange="updateBulkSmsCount()" style="padding: 0.5rem; border: 1px solid #3b82f6; border-radius: 4px; min-width: 150px;">
                                <option value="">All Sites</option>
                            </select>
                            <div style="flex: 1; min-width: 300px;">
                                <textarea id="bulkSmsMessage" placeholder="Type your message here... (e.g., Merry Xmas - half day tomorrow - full pay)"
                                    style="width: 100%; padding: 0.5rem; border: 1px solid #3b82f6; border-radius: 4px; min-height: 60px; resize: vertical;"></textarea>
                                <div style="display: flex; justify-content: space-between; margin-top: 0.25rem; font-size: 0.8rem; color: #6b7280;">
                                    <span id="bulkSmsCharCount">0 / 160 chars</span>
                                    <span id="bulkSmsRecipientCount">Recipients: 0</span>
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="sendBulkSms()" style="background: #3b82f6; min-width: 120px;">üì§ Send to All</button>
                        </div>
                    </div>
                </div>

                <!-- Recent Location Requests -->
                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-header">
                        <h2>üìç Today's Whereabouts Checks</h2>
                        <button class="btn btn-primary btn-small" onclick="loadTracking()" style="background: #0ea5e9;">üîÑ Refresh</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Staff Name</th>
                                <th>Cell No</th>
                                <th>Requested</th>
                                <th>Reason</th>
                                <th>Status</th>
                                <th>Location</th>
                            </tr>
                        </thead>
                        <tbody id="trackingLocationTable">
                            <tr><td colspan="6" style="text-align: center;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- LEAVE TAB -->
            <div id="leaveTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2>üìÖ Leave Management</h2>
                        <button class="btn btn-primary" onclick="showBookLeaveModal()">+ Book Leave</button>
                    </div>

                    <!-- Summary Cards -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div class="summary-card" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 1.5rem; border-radius: 12px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700;" id="leaveOnLeaveToday">0</div>
                            <div style="font-size: 0.9rem; opacity: 0.9;">On Leave Today</div>
                        </div>
                        <div class="summary-card" style="background: linear-gradient(135deg, #06b6d4, #0891b2); color: white; padding: 1.5rem; border-radius: 12px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700;" id="leaveUpcoming">0</div>
                            <div style="font-size: 0.9rem; opacity: 0.9;">Upcoming (30 days)</div>
                        </div>
                        <div class="summary-card" style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 1.5rem; border-radius: 12px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700;" id="leaveBookedYear">0</div>
                            <div style="font-size: 0.9rem; opacity: 0.9;">Booked (L) This Year</div>
                        </div>
                        <div class="summary-card" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 1.5rem; border-radius: 12px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700;" id="leaveSickYear">0</div>
                            <div style="font-size: 0.9rem; opacity: 0.9;">Sick (S) This Year</div>
                        </div>
                    </div>

                    <!-- On Leave Today -->
                    <div style="margin-bottom: 2rem;">
                        <h3 style="color: #8b5cf6; margin-bottom: 1rem;">üè† On Leave Today</h3>
                        <div id="leaveToday" style="background: #f8fafc; border-radius: 8px; padding: 1rem;">
                            <p style="color: #6b7280; text-align: center;">Loading...</p>
                        </div>
                    </div>

                    <!-- Upcoming Leave -->
                    <div style="margin-bottom: 2rem;">
                        <h3 style="color: #06b6d4; margin-bottom: 1rem;">üìÖ Upcoming Leave (Next 30 Days)</h3>
                        <div id="leaveUpcomingList" style="background: #f8fafc; border-radius: 8px; padding: 1rem;">
                            <p style="color: #6b7280; text-align: center;">Loading...</p>
                        </div>
                    </div>

                    <!-- Leave History -->
                    <div>
                        <h3 style="color: #374151; margin-bottom: 1rem;">üìã Leave History</h3>
                        <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                            <select id="leaveFilterSite" onchange="filterLeaveBysite()" style="padding: 0.5rem; border-radius: 6px; border: 1px solid #d1d5db;">
                                <option value="">All Sites</option>
                            </select>
                            <select id="leaveFilterStaff" onchange="loadLeaveHistory()" style="padding: 0.5rem; border-radius: 6px; border: 1px solid #d1d5db;">
                                <option value="">All Staff</option>
                            </select>
                            <select id="leaveFilterType" onchange="loadLeaveHistory()" style="padding: 0.5rem; border-radius: 6px; border: 1px solid #d1d5db;">
                                <option value="">All Types</option>
                                <option value="L">Booked Leave (L)</option>
                                <option value="S">Sick Leave (S)</option>
                            </select>
                            <input type="month" id="leaveFilterMonth" onchange="loadLeaveHistory()" style="padding: 0.5rem; border-radius: 6px; border: 1px solid #d1d5db;">
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Staff</th>
                                    <th>Site</th>
                                    <th>Type</th>
                                    <th>Reason</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="leaveHistoryTable">
                                <tr><td colspan="6" style="text-align: center;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Book Leave Modal -->
            <div id="bookLeaveModal" class="modal">
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h2>Book Leave</h2>
                        <button class="close-btn" onclick="closeModal('bookLeaveModal')">CLOSE</button>
                    </div>
                    <form id="bookLeaveForm">
                        <div class="form-group">
                            <label>Staff Member *</label>
                            <select id="leaveStaffSelect" required>
                                <option value="">Select staff...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Leave Type *</label>
                            <select id="leaveTypeSelect" required>
                                <option value="L">Booked Leave (L)</option>
                                <option value="S">Sick Leave (S)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Leave Date(s) *</label>
                            <input type="date" id="leaveDateStart" required>
                            <div style="margin-top: 0.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="leaveMultipleDays" onchange="toggleLeaveDateRange()">
                                    Multiple days
                                </label>
                            </div>
                            <div id="leaveDateEndGroup" style="display: none; margin-top: 0.5rem;">
                                <label>End Date</label>
                                <input type="date" id="leaveDateEnd">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Reason (optional)</label>
                            <input type="text" id="leaveReason" placeholder="e.g., Family vacation, Medical appointment">
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">Book Leave</button>
                    </form>
                </div>
            </div>

            <!-- CONFIG TAB -->
            <div id="configTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2>‚öôÔ∏è System Configuration</h2>
                    </div>

                    <div style="max-width: 600px;">
                        <h3 style="margin-bottom: 1rem; color: #667eea;">Admin Details</h3>
                        <p style="margin-bottom: 1.5rem; color: #6b7280;">These details are used for SMS notifications and system alerts.</p>

                        <form id="configForm">
                            <div class="form-group">
                                <label>Admin Name</label>
                                <input type="text" id="configAdminName" placeholder="e.g., Bruce">
                            </div>
                            <div class="form-group">
                                <label>Admin Email</label>
                                <input type="email" id="configAdminEmail" placeholder="e.g., bruce@company.com">
                            </div>
                            <div class="form-group">
                                <label>Admin Mobile (for SMS alerts)</label>
                                <input type="text" id="configAdminMobile" placeholder="e.g., 0826000859">
                            </div>
                            <div class="form-group">
                                <label>Company Name</label>
                                <input type="text" id="configCompanyName" placeholder="e.g., Levendig">
                            </div>
                            <div class="form-group">
                                <label>SMS Notifications</label>
                                <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="configNotifySignin" checked style="width: 18px; height: 18px;">
                                        Notify on Staff Sign-In
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="configNotifySignout" checked style="width: 18px; height: 18px;">
                                        Notify on Staff Sign-Out
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="configNotifyLocation" checked style="width: 18px; height: 18px;">
                                        Notify on Location Response
                                    </label>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">üíæ Save Configuration</button>
                        </form>
                    </div>
                </div>

                <!-- Public URL Config -->
                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-header">
                        <h2>üåê Public URL Settings</h2>
                    </div>
                    <div style="max-width: 600px;">
                        <p style="margin-bottom: 1rem; color: #6b7280;">The public URL is used for SMS location request links. Update when using ngrok.</p>
                        <div class="form-group">
                            <label>Public URL</label>
                            <input type="text" id="configPublicUrl" placeholder="e.g., https://your-ngrok-url.ngrok-free.dev">
                        </div>
                        <button class="btn btn-primary" onclick="savePublicUrl()">üíæ Save URL</button>
                    </div>
                </div>

                <!-- Time Window Settings -->
                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-header">
                        <h2>Clock-In/Out Time Windows</h2>
                    </div>
                    <div style="max-width: 600px;">
                        <p style="margin-bottom: 1rem; color: #6b7280;">Control when workers can clock in and out. Outside these windows, workers must provide a reason.</p>

                        <h4 style="margin-bottom: 0.75rem; color: #16a34a;">Clock-In Settings</h4>
                        <div style="display: flex; gap: 1rem; margin-bottom: 0.75rem;">
                            <div class="form-group" style="flex: 1;">
                                <label>Expected Clock-In</label>
                                <input type="time" id="configClockinTime" value="07:20" title="Default clock-in time shown to workers">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>Window Start</label>
                                <input type="time" id="configClockinStart" value="07:00">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>Window End</label>
                                <input type="time" id="configClockinEnd" value="09:00">
                            </div>
                        </div>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-bottom: 1.5rem;">
                            <input type="checkbox" id="configEnforceClockin" checked style="width: 18px; height: 18px;">
                            Enforce Clock-In Window (require reason outside window)
                        </label>

                        <h4 style="margin-bottom: 0.75rem; color: #dc2626;">Clock-Out Settings</h4>
                        <div style="display: flex; gap: 1rem; margin-bottom: 0.75rem;">
                            <div class="form-group" style="flex: 1;">
                                <label>Expected Clock-Out</label>
                                <input type="time" id="configClockoutTime" value="16:30" title="Default clock-out time shown to workers">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>Window Start</label>
                                <input type="time" id="configClockoutStart" value="16:15">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label>Window End</label>
                                <input type="time" id="configClockoutEnd" value="16:45">
                            </div>
                        </div>
                        <p style="font-size: 0.85rem; color: #6b7280; margin-bottom: 0.75rem;">
                            Clock-out after Window End = Overtime (requires justification)
                        </p>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-bottom: 1.5rem;">
                            <input type="checkbox" id="configEnforceClockout" checked style="width: 18px; height: 18px;">
                            Enforce Clock-Out Window (require reason outside window)
                        </label>

                        <button class="btn btn-primary" onclick="saveTimeWindows()">Save Time Windows</button>
                    </div>
                </div>
            </div>

            <!-- ADMIN TAB -->
            <div id="adminTab" class="tab-content">
                <!-- Quick Links -->
                <div class="card" style="margin-bottom: 1.5rem; padding: 1rem;">
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <a href="/progress-pictures" class="btn btn-primary" style="background: #8b5cf6; text-decoration: none;">üì∏ Progress Pictures</a>
                        <a href="/face-enroll" class="btn btn-primary" style="background: #10b981; text-decoration: none;">üë§ Face Enrollment</a>
                        <a href="/kiosk" target="_blank" class="btn btn-primary" style="background: #f59e0b; text-decoration: none;">üì± Kiosk Mode</a>
                    </div>
                </div>

                <!-- Users Management -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <h2>üë• Users</h2>
                        <button class="btn btn-primary btn-small" onclick="showAddUserModal()">+ Add User</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr><td colspan="7" style="text-align: center;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Rewards & Penalties Management -->
                <div class="card">
                    <div class="card-header">
                        <h2>üèÜ Staff Rewards & Penalties</h2>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary btn-small" onclick="showModal('addRewardPenaltyModal')" style="background: #10b981;">+ Add New</button>
                            <button class="btn btn-primary btn-small" onclick="loadRewardsPenalties()" style="background: #dc2626;">Refresh</button>
                        </div>
                    </div>

                    <!-- Summary Stats -->
                    <div id="rewardsPenaltiesSummary" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; padding: 1rem; background: #f9fafb; border-radius: 8px;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #10b981;" id="summaryTotalRewards">0</div>
                            <div style="font-size: 0.875rem; color: #6b7280;">Total Rewards</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #dc2626;" id="summaryTotalPenalties">0</div>
                            <div style="font-size: 0.875rem; color: #6b7280;">Total Penalties</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #f59e0b;" id="summaryPendingCount">0</div>
                            <div style="font-size: 0.875rem; color: #6b7280;">Pending Approval</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #667eea;" id="summaryNetPoints">0</div>
                            <div style="font-size: 0.875rem; color: #6b7280;">Net Points (Period)</div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 150px;">
                            <select id="rpFilterStatus" onchange="loadRewardsPenalties()" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                                <option value="">Active (excl. Cancelled)</option>
                                <option value="pending">Pending</option>
                                <option value="approved">Approved</option>
                                <option value="applied">Applied</option>
                                <option value="cancelled">Cancelled (History)</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 150px;">
                            <select id="rpFilterType" onchange="loadRewardsPenalties()" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                                <option value="">Rewards & Penalties</option>
                                <option value="reward">Rewards Only</option>
                                <option value="penalty">Penalties Only</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 150px;">
                            <select id="rpFilterSite" onchange="onRPSiteFilterChange()" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                                <option value="">All Sites</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 150px;">
                            <select id="rpFilterStaff" onchange="loadRewardsPenalties()" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                                <option value="">All Staff</option>
                            </select>
                        </div>
                    </div>

                    <!-- Rewards/Penalties Table -->
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Staff/Site</th>
                                <th>Category</th>
                                <th>Points</th>
                                <th>Hours Equiv</th>
                                <th>Source</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="rewardsPenaltiesTable">
                            <tr><td colspan="8" style="text-align: center;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- No Work Days Section (moved from Tracking) -->
                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-header">
                        <h2>üìÖ No Work Days</h2>
                        <button class="btn btn-primary btn-small" onclick="loadNoWorkDays()" style="background: #dc2626;">Refresh</button>
                    </div>

                    <!-- Create New No Work Day -->
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px;">
                        <h4 style="margin-bottom: 1rem; color: #dc2626;">Create No Work Day Alert</h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.25rem; font-weight: 500;">Date(s)</label>
                                <input type="date" id="noWorkDate" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                                <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">Hold Ctrl/Cmd to select multiple dates</div>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.25rem; font-weight: 500;">Site</label>
                                <select id="noWorkSite" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                                    <option value="">All Sites (Company-wide)</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.25rem; font-weight: 500;">Type</label>
                                <select id="noWorkType" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                                    <option value="public_holiday">Public Holiday</option>
                                    <option value="company_closure">Company Closure</option>
                                    <option value="wage_weekend">Wage Weekend</option>
                                    <option value="weather">Weather</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.25rem; font-weight: 500;">Reason (required)</label>
                                <input type="text" id="noWorkReason" placeholder="e.g., Christmas Day, Load shedding..." style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.25rem; font-weight: 500;">Additional Message (optional)</label>
                                <input type="text" id="noWorkMessage" placeholder="e.g., Enjoy the holiday!" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="noWorkSendSMS" checked style="width: 1rem; height: 1rem;">
                                <span>Send SMS notification to staff</span>
                            </label>
                            <button class="btn btn-primary" onclick="createNoWorkDay()" style="background: #dc2626; margin-left: auto;">Create No Work Day</button>
                        </div>
                    </div>

                    <!-- Standby Rate Setting -->
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px;">
                        <h4 style="margin-bottom: 0.75rem; color: #92400e;">Standby Allowance Rate</h4>
                        <p style="font-size: 0.85rem; color: #78350f; margin-bottom: 0.75rem;">Daily rate paid to standby staff on no-work days. If they work, this converts to regular wages.</p>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <label style="font-weight: 500;">R</label>
                                <input type="number" id="configStandbyDailyRate" step="0.01" min="0" placeholder="150.00" style="width: 120px; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                            </div>
                            <button class="btn btn-primary btn-small" onclick="saveStandbyConfig()" style="background: #92400e;">Save Rate</button>
                            <span id="currentStandbyRate" style="color: #78350f; font-size: 0.85rem;"></span>
                        </div>
                    </div>

                    <!-- Existing No Work Days -->
                    <h3 style="margin-bottom: 1rem; color: #dc2626;">Upcoming No Work Days</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Site</th>
                                <th>Type</th>
                                <th>Reason</th>
                                <th>SMS Sent</th>
                                <th>Acknowledged</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="noWorkDaysTable">
                            <tr><td colspan="7" style="text-align: center;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Points Configuration Section (at bottom - least used) -->
                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-header">
                        <h2>Points Configuration</h2>
                        <button class="btn btn-primary btn-small" onclick="loadPointsConfig()" style="background: #6b7280;">Refresh</button>
                    </div>
                    <p style="margin-bottom: 1rem; color: #6b7280;">Configure reward/penalty point values and conversion rates.</p>

                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                        <div class="form-group">
                            <label>Points per Hour</label>
                            <input type="number" id="configPointsPerHour" step="1" min="1" placeholder="e.g., 10">
                            <small style="color: #6b7280;">10 pts = 1 hour of staff's pay rate</small>
                        </div>
                        <div class="form-group">
                            <label>Perfect Attendance Points</label>
                            <input type="number" id="configPerfectAttendance" min="0" placeholder="e.g., 10">
                        </div>
                        <div class="form-group">
                            <label>Timely Clock-In Points</label>
                            <input type="number" id="configTimelyClockIn" min="0" placeholder="e.g., 5">
                        </div>
                        <div class="form-group">
                            <label>Early Arrival Points</label>
                            <input type="number" id="configEarlyArrival" min="0" placeholder="e.g., 3">
                        </div>
                        <div class="form-group">
                            <label>Late Clock-In Penalty</label>
                            <input type="number" id="configLateClockIn" min="0" placeholder="e.g., -5">
                            <small style="color: #dc2626;">Negative value</small>
                        </div>
                        <div class="form-group">
                            <label>Absenteeism Penalty</label>
                            <input type="number" id="configAbsenteeism" min="0" placeholder="e.g., -10">
                            <small style="color: #dc2626;">Negative value</small>
                        </div>
                        <div class="form-group">
                            <label>Early Departure Penalty</label>
                            <input type="number" id="configEarlyDeparture" min="0" placeholder="e.g., -5">
                            <small style="color: #dc2626;">Negative value</small>
                        </div>
                        <div class="form-group">
                            <label>Late Minutes Threshold</label>
                            <input type="number" id="configLateThreshold" min="0" placeholder="e.g., 15">
                            <small style="color: #6b7280;">Minutes after window to count as late</small>
                        </div>
                        <div class="form-group">
                            <label>Auto-Generate Points</label>
                            <select id="configAutoGenerate">
                                <option value="true">Yes - Auto-generate from attendance</option>
                                <option value="false">No - Manual only</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="savePointsConfig()">üíæ Save Points Configuration</button>
                </div>
            </div>
        </div>

        <!-- PRODUCTIVITY TAB -->
        <div id="productivityTab" class="tab-content" style="max-width: 1200px; margin: 0 auto;">
            <div class="card">
                <div class="card-header">
                    <h2>üìä Project Productivity</h2>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <button class="btn btn-primary btn-small" onclick="loadProductivityData()" style="background: #059669;">üîÑ Refresh</button>
                        <button class="btn btn-primary btn-small" onclick="exportProductivityCSV()" style="background: #3b82f6;">üì• Export CSV</button>
                    </div>
                </div>

                <!-- Filters -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; padding: 1rem; background: #f9fafb; border-radius: 8px;">
                    <div>
                        <label style="display: block; margin-bottom: 0.25rem; font-weight: 500; font-size: 0.875rem;">Time Period</label>
                        <select id="prodPeriod" onchange="onProductivityPeriodChange()" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                            <option value="today">Today</option>
                            <option value="yesterday">Yesterday</option>
                            <option value="week" selected>This Week</option>
                            <option value="lastweek">Last Week</option>
                            <option value="month">This Month</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.25rem; font-weight: 500; font-size: 0.875rem;">Project</label>
                        <select id="prodProject" onchange="loadProductivityData()" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                            <option value="">All Projects</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.25rem; font-weight: 500; font-size: 0.875rem;">Staff Member</label>
                        <select id="prodStaff" onchange="loadProductivityData()" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                            <option value="">All Staff</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.25rem; font-weight: 500; font-size: 0.875rem;">Group By</label>
                        <select id="prodGroupBy" onchange="loadProductivityData()" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                            <option value="project">Project</option>
                            <option value="staff">Staff Member</option>
                            <option value="day">Day</option>
                        </select>
                    </div>
                </div>

                <!-- Custom Date Range (hidden by default) -->
                <div id="prodCustomDates" style="display: none; margin-bottom: 1rem; padding: 1rem; background: #fef3c7; border-radius: 8px;">
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; font-weight: 500; font-size: 0.875rem;">From</label>
                            <input type="date" id="prodDateFrom" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; font-weight: 500; font-size: 0.875rem;">To</label>
                            <input type="date" id="prodDateTo" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                        </div>
                        <button class="btn btn-primary btn-small" onclick="loadProductivityData()" style="margin-top: 1.25rem;">Apply</button>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div id="productivitySummary" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                    <div style="background: linear-gradient(135deg, #059669, #047857); padding: 1.25rem; border-radius: 12px; color: white;">
                        <div style="font-size: 0.875rem; opacity: 0.9;">Total Hours</div>
                        <div style="font-size: 2rem; font-weight: bold;" id="prodTotalHours">0</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #3b82f6, #2563eb); padding: 1.25rem; border-radius: 12px; color: white;">
                        <div style="font-size: 0.875rem; opacity: 0.9;">Labour Cost</div>
                        <div style="font-size: 2rem; font-weight: bold;" id="prodTotalCost">R0</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f59e0b, #d97706); padding: 1.25rem; border-radius: 12px; color: white;">
                        <div style="font-size: 0.875rem; opacity: 0.9;">Projects Worked</div>
                        <div style="font-size: 2rem; font-weight: bold;" id="prodProjectCount">0</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); padding: 1.25rem; border-radius: 12px; color: white;">
                        <div style="font-size: 0.875rem; opacity: 0.9;">Staff Active</div>
                        <div style="font-size: 2rem; font-weight: bold;" id="prodStaffCount">0</div>
                    </div>
                </div>

                <!-- Productivity Table -->
                <div style="overflow-x: auto;">
                    <table id="productivityTable">
                        <thead>
                            <tr>
                                <th>Project/Staff</th>
                                <th>Hours</th>
                                <th>Labour Cost</th>
                                <th>Avg Hourly Rate</th>
                                <th>Staff Count</th>
                                <th>Days Worked</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="productivityTableBody">
                            <tr><td colspan="7" style="text-align: center; padding: 2rem; color: #6b7280;">Select filters and click Refresh to load data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Detailed Breakdown Card -->
            <div class="card" style="margin-top: 1.5rem;" id="productivityDetails" style="display: none;">
                <div class="card-header">
                    <h2 id="productivityDetailsTitle">üìã Detailed Breakdown</h2>
                </div>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Staff</th>
                                <th>Project</th>
                                <th>Task</th>
                                <th>Hours</th>
                                <th>Cost</th>
                            </tr>
                        </thead>
                        <tbody id="productivityDetailsBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->

    <!-- Add Reward/Penalty Modal -->
    <div id="addRewardPenaltyModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Add Reward/Penalty</h2>
                <button class="close-btn" onclick="closeModal('addRewardPenaltyModal')">CLOSE</button>
            </div>
            <form id="addRewardPenaltyForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Target Type *</label>
                        <select id="rpTargetType" required onchange="updateRPTargetOptions()">
                            <option value="individual">Individual Staff</option>
                            <option value="site">Entire Site</option>
                            <option value="company">Company-wide</option>
                        </select>
                    </div>
                    <div class="form-group" id="rpStaffGroup">
                        <label>Staff Member *</label>
                        <select id="rpStaffSelect" required>
                            <option value="">Select staff...</option>
                        </select>
                    </div>
                    <div class="form-group" id="rpSiteGroup" style="display: none;">
                        <label>Site *</label>
                        <select id="rpSiteSelect">
                            <option value="">Select site...</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Pay Period *</label>
                    <select id="rpPayPeriod" required>
                        <option value="">Select pay period...</option>
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>Category *</label>
                        <select id="rpCategory" required onchange="updateRPPointsPreview()">
                            <optgroup label="Rewards (Positive Points)">
                                <option value="perfect_attendance">Perfect Attendance</option>
                                <option value="timely_clockin">Timely Clock-In</option>
                                <option value="early_arrival">Early Arrival</option>
                                <option value="special_achievement">Special Achievement</option>
                                <option value="safety_bonus">Safety Bonus</option>
                                <option value="other_reward">Other Reward</option>
                            </optgroup>
                            <optgroup label="Penalties (Negative Points)">
                                <option value="late_clockin">Late Clock-In</option>
                                <option value="absenteeism">Absenteeism</option>
                                <option value="early_departure">Early Departure</option>
                                <option value="negligence">Negligence</option>
                                <option value="misconduct">Misconduct</option>
                                <option value="other_penalty">Other Penalty</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Points * <span id="rpPointsSign" style="font-weight: bold; color: #10b981;">(+)</span></label>
                        <input type="number" id="rpPoints" required min="1" placeholder="e.g., 10" oninput="updateRPPointsPreview()">
                        <small id="rpPointsHint" style="color: #10b981;">This is a REWARD - points will be added</small>
                    </div>
                </div>
                <div class="form-group">
                    <label>Description / Reason</label>
                    <textarea id="rpDescription" rows="2" placeholder="Reason for this reward/penalty..."></textarea>
                </div>
                <div class="form-group">
                    <label>Reference Count (optional)</label>
                    <input type="number" id="rpReferenceCount" placeholder="e.g., Number of late days">
                    <small style="color: #6b7280;">For tracking, e.g., number of occurrences</small>
                </div>
                <div style="display: flex; gap: 1rem; align-items: center; margin-top: 1rem; padding: 1rem; background: #f9fafb; border-radius: 8px;">
                    <div>
                        <strong>Hours Equivalent:</strong>
                        <span id="rpHoursPreview" style="font-size: 1.25rem; font-weight: bold; color: #667eea;">0 hr</span>
                    </div>
                    <small style="color: #6b7280;">(10 pts = 1 hr of staff's pay rate)</small>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">Add Reward/Penalty</button>
            </form>
        </div>
    </div>

    <!-- Add Site Modal -->
    <div id="addSiteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Site</h2>
                <button class="close-btn" onclick="closeModal('addSiteModal')">CLOSE</button>
            </div>
            <form id="addSiteForm">
                <div class="form-group">
                    <label>Site Name *</label>
                    <input type="text" id="siteName" required>
                </div>
                <div class="form-group">
                    <label>Code</label>
                    <input type="text" id="siteCode" placeholder="e.g., FRM, HOM">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="siteDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <textarea id="siteAddress" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>Bank Name</label>
                    <input type="text" id="siteBankName" placeholder="e.g., ABSA, Standard Bank">
                </div>
                <div class="form-group">
                    <label>Account Number</label>
                    <input type="text" id="siteAccountNumber" placeholder="e.g., 1234567890">
                </div>
                <button type="submit" class="btn btn-primary">Create Site</button>
            </form>
        </div>
    </div>

    <!-- Add Staff Modal -->
    <div id="addStaffModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Add New Staff Member</h2>
                <button class="close-btn" onclick="closeModal('addStaffModal')">CLOSE</button>
            </div>
            <form id="addStaffForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>First Name *</label>
                        <input type="text" id="staffFirstName" required>
                    </div>
                    <div class="form-group">
                        <label>Last Name *</label>
                        <input type="text" id="staffLastName" required>
                    </div>
                    <div class="form-group">
                        <label>ID Number</label>
                        <input type="text" id="staffIdNumber">
                    </div>
                    <div class="form-group">
                        <label>Site *</label>
                        <select id="staffSite" required>
                            <option value="">Select Site</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Position</label>
                        <select id="staffPositionSelect" onchange="handlePositionChange('staff')">
                            <option value="">Select Position</option>
                            <option value="__OTHER__">Other (type below)</option>
                        </select>
                        <input type="text" id="staffPositionOther" placeholder="Enter position" style="margin-top: 0.5rem; display: none;">
                    </div>
                    <div class="form-group">
                        <label>Employment Type</label>
                        <select id="staffEmploymentType">
                            <option value="casual">Casual</option>
                            <option value="full_time">Full Time</option>
                            <option value="part_time">Part Time</option>
                            <option value="contract">Contract</option>
                            <option value="seasonal">Seasonal</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Daily Rate (R)</label>
                        <input type="number" id="staffDailyRate" step="0.01" min="0" oninput="updateHourlyFromDaily('staff')">
                    </div>
                    <div class="form-group">
                        <label>Hourly Rate (R)</label>
                        <input type="number" id="staffHourlyRate" step="0.01" min="0" oninput="updateDailyFromHourly('staff')">
                    </div>
                    <div class="form-group">
                        <label>Mobile (for SMS/Clock-in)</label>
                        <input type="tel" id="staffMobile" placeholder="e.g., 0821234567">
                    </div>
                    <div class="form-group">
                        <label>Phone (alt)</label>
                        <input type="tel" id="staffPhone">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="staffEmail">
                    </div>
                    <div class="form-group">
                        <label>Bank Name</label>
                        <input type="text" id="staffBankName" placeholder="e.g., ABSA, FNB, Standard Bank">
                    </div>
                    <div class="form-group">
                        <label>Account Number</label>
                        <input type="text" id="staffBankAccount" placeholder="Bank account number">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Create Staff Member</button>
            </form>
        </div>
    </div>

    <!-- Edit Staff Modal -->
    <div id="editStaffModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Edit Staff Member</h2>
                <button class="close-btn" onclick="closeModal('editStaffModal')">CLOSE</button>
            </div>
            <form id="editStaffForm">
                <input type="hidden" id="editStaffId">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>First Name *</label>
                        <input type="text" id="editStaffFirstName" required>
                    </div>
                    <div class="form-group">
                        <label>Last Name *</label>
                        <input type="text" id="editStaffLastName" required>
                    </div>
                    <div class="form-group">
                        <label>ID Number</label>
                        <input type="text" id="editStaffIdNumber">
                    </div>
                    <div class="form-group">
                        <label>Site *</label>
                        <select id="editStaffSite" required>
                            <option value="">Select Site</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Position</label>
                        <select id="editStaffPositionSelect" onchange="handlePositionChange('editStaff')">
                            <option value="">Select Position</option>
                            <option value="__OTHER__">Other (type below)</option>
                        </select>
                        <input type="text" id="editStaffPositionOther" placeholder="Enter position" style="margin-top: 0.5rem; display: none;">
                    </div>
                    <div class="form-group">
                        <label>Employment Type</label>
                        <select id="editStaffEmploymentType">
                            <option value="casual">Casual</option>
                            <option value="full_time">Full Time</option>
                            <option value="part_time">Part Time</option>
                            <option value="contract">Contract</option>
                            <option value="seasonal">Seasonal</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Daily Rate (R)</label>
                        <input type="number" id="editStaffDailyRate" step="0.01" min="0" oninput="updateHourlyFromDaily('editStaff')">
                    </div>
                    <div class="form-group">
                        <label>Hourly Rate (R)</label>
                        <input type="number" id="editStaffHourlyRate" step="0.01" min="0" oninput="updateDailyFromHourly('editStaff')">
                    </div>
                    <div class="form-group">
                        <label>Mobile (for SMS/Clock-in)</label>
                        <input type="tel" id="editStaffMobile" placeholder="e.g., 0821234567">
                    </div>
                    <div class="form-group">
                        <label>Phone (alt)</label>
                        <input type="tel" id="editStaffPhone">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="editStaffEmail">
                    </div>
                    <div class="form-group">
                        <label>Bank Name</label>
                        <input type="text" id="editStaffBankName" placeholder="e.g., ABSA, FNB, Standard Bank">
                    </div>
                    <div class="form-group">
                        <label>Account Number</label>
                        <input type="text" id="editStaffBankAccount" placeholder="Bank account number">
                    </div>
                </div>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <button type="submit" class="btn btn-primary">Update Staff Member</button>
                    <button type="button" id="deactivateStaffBtn" class="btn" style="background: #dc2626; color: white;" onclick="deactivateStaff()">Deactivate Staff</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Pay Period Modal -->
    <div id="addPeriodModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>New Pay Period</h2>
                <button class="close-btn" onclick="closeModal('addPeriodModal')">CLOSE</button>
            </div>
            <form id="addPeriodForm">
                <div class="form-group">
                    <label>Year *</label>
                    <input type="number" id="periodYear" required value="2025">
                </div>
                <div class="form-group">
                    <label>Start Date *</label>
                    <input type="date" id="periodStartDate" required>
                </div>
                <div class="form-group">
                    <label>End Date *</label>
                    <input type="date" id="periodEndDate" required>
                </div>
                <button type="submit" class="btn btn-primary">Create Pay Period</button>
            </form>
        </div>
    </div>

    <!-- Edit Days Modal -->
    <div id="editDaysModal" class="modal">
        <div class="modal-content" style="max-width: 650px;">
            <div class="modal-header">
                <h2>Edit Days Worked - Fortnight</h2>
                <button class="close-btn" onclick="closeModal('editDaysModal')">CLOSE</button>
            </div>
            <div style="background: #f9fafb; padding: 1rem; margin-bottom: 1rem; border-radius: 8px;">
                <strong id="editDaysStaffName" style="font-size: 1.1rem;"></strong>
            </div>

            <!-- Rate Explanation -->
            <div style="background: #dbeafe; padding: 0.75rem; margin-bottom: 1rem; border-radius: 6px; font-size: 0.875rem;">
                <strong>Weekend Rate Rule:</strong> Weekend days get <strong>1.5x</strong> rate if <strong>3+ weekdays</strong> worked in that week, otherwise <strong>1.0x</strong>
            </div>

            <!-- Quick Actions -->
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                <button type="button" class="btn btn-small" onclick="autoFillFromAttendance()" style="background: #2563eb; color: white; font-weight: 600;">Auto-Fill from Attendance</button>
                <button type="button" class="btn btn-small" onclick="selectAllDays()" style="background: #10b981; color: white;">‚úì Select All Days</button>
                <button type="button" class="btn btn-small" onclick="clearAllDays()" style="background: #ef4444; color: white;">‚úó Clear All Days</button>
            </div>

            <form id="editDaysForm">
                <input type="hidden" id="editDaysPayslipId">

                <!-- Week 1 -->
                <div class="week-section">
                    <div class="week-header week-1-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>WEEK 1</span>
                        <span id="week1Multiplier" style="font-size: 0.9rem; font-weight: 600; color: #92400e;"></span>
                    </div>
                    <div id="week1Days"></div>
                </div>

                <!-- Week 2 -->
                <div class="week-section">
                    <div class="week-header week-2-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>WEEK 2</span>
                        <span id="week2Multiplier" style="font-size: 0.9rem; font-weight: 600; color: #92400e;"></span>
                    </div>
                    <div id="week2Days"></div>
                </div>

                <!-- Summary -->
                <div id="daysSummary" style="background: #f0fdf4; padding: 1rem; margin: 1rem 0; border-radius: 8px; border: 1px solid #86efac;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.9rem;">
                        <div><strong>Week 1 Weekdays:</strong> <span id="w1WeekdayCount">0</span></div>
                        <div><strong>Week 2 Weekdays:</strong> <span id="w2WeekdayCount">0</span></div>
                        <div><strong>Week 1 Weekends:</strong> <span id="w1WeekendCount">0</span> <span id="w1Rate" style="color: #92400e; font-weight: 600;"></span></div>
                        <div><strong>Week 2 Weekends:</strong> <span id="w2WeekendCount">0</span> <span id="w2Rate" style="color: #92400e; font-weight: 600;"></span></div>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Manage Loans Modal -->
    <div id="loansModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 id="loansModalTitle">Manage Loans</h2>
                <button class="close-btn" onclick="closeModal('loansModal')">CLOSE</button>
            </div>
            <input type="hidden" id="loansStaffId">
            <button class="btn btn-primary btn-small" onclick="showAddLoanForm()" style="margin-bottom: 1rem;">+ New Loan</button>
            <div id="loansContainer"></div>
        </div>
    </div>

    <!-- Add Loan Form Modal -->
    <div id="addLoanModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>New Loan</h2>
                <button class="close-btn" onclick="closeModal('addLoanModal')">CLOSE</button>
            </div>
            <form id="addLoanForm">
                <input type="hidden" id="loanStaffId">
                <div class="form-group">
                    <label>Description *</label>
                    <input type="text" id="loanDescription" required placeholder="e.g., Cash advance">
                </div>
                <div class="form-group">
                    <label>Total Amount (R) *</label>
                    <input type="number" id="loanTotalAmount" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Installment Amount (R) *</label>
                    <input type="number" id="loanInstallment" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Loan Date</label>
                    <input type="date" id="loanDate">
                </div>
                <div class="form-group">
                    <label>Start Deduction Date</label>
                    <input type="date" id="loanStartDate">
                </div>
                <button type="submit" class="btn btn-primary">Create Loan</button>
            </form>
        </div>
    </div>

    <!-- Manage Deductions Modal -->
    <div id="deductionsModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 id="deductionsModalTitle">Manage Deductions</h2>
                <button class="close-btn" onclick="closeModal('deductionsModal')">CLOSE</button>
            </div>
            <input type="hidden" id="deductionsStaffId">
            <button class="btn btn-primary btn-small" onclick="showAddDeductionForm()" style="margin-bottom: 1rem;">+ New Deduction</button>
            <div id="deductionsContainer"></div>
        </div>
    </div>

    <!-- Add Deduction Form Modal -->
    <div id="addDeductionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>New Deduction</h2>
                <button class="close-btn" onclick="closeModal('addDeductionModal')">CLOSE</button>
            </div>
            <form id="addDeductionForm">
                <input type="hidden" id="deductionStaffId">
                <div class="form-group">
                    <label>Description *</label>
                    <input type="text" id="deductionDescription" required placeholder="e.g., Medical Aid, UIF">
                </div>
                <div class="form-group">
                    <label>Type *</label>
                    <select id="deductionType" required onchange="toggleDeductionFields()">
                        <option value="fixed">Fixed Amount (Recurring)</option>
                        <option value="percentage">Percentage of Gross Pay</option>
                        <option value="once_off">Once Off</option>
                    </select>
                </div>
                <div class="form-group" id="fixedAmountGroup">
                    <label>Fixed Amount (R)</label>
                    <input type="number" id="deductionFixed" step="0.01" min="0">
                </div>
                <div class="form-group hidden" id="percentageGroup">
                    <label>Percentage (%)</label>
                    <input type="number" id="deductionPercentage" step="0.1" min="0" max="100">
                </div>
                <button type="submit" class="btn btn-primary">Create Deduction</button>
            </form>
        </div>
    </div>

    <!-- Biometrics Modal -->
    <div id="biometricsModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 id="biometricsModalTitle">Biometrics</h2>
                <button class="close-btn" onclick="closeModal('biometricsModal')">CLOSE</button>
            </div>
            <input type="hidden" id="biometricsStaffId">
            <div id="biometricsContent" style="padding: 1rem;">
                <!-- Content filled by JS -->
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New User</h2>
                <button class="close-btn" onclick="closeModal('addUserModal')">CLOSE</button>
            </div>
            <form id="addUserForm">
                <div class="form-group">
                    <label>Username *</label>
                    <input type="text" id="userUsername" required>
                </div>
                <div class="form-group">
                    <label>Password *</label>
                    <input type="password" id="userPassword" required minlength="6">
                </div>
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" id="userFullName" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="userEmail">
                </div>
                <div class="form-group">
                    <label>Role *</label>
                    <select id="userRole" required>
                        <option value="viewer">Viewer</option>
                        <option value="manager">Manager</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary">Create User</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addUserModal')">Close</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit User</h2>
                <button class="close-btn" onclick="closeModal('editUserModal')">CLOSE</button>
            </div>
            <form id="editUserForm">
                <input type="hidden" id="editUserId">
                <div class="form-group">
                    <label>Username *</label>
                    <input type="text" id="editUserUsername" required>
                </div>
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" id="editUserFullName" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="editUserEmail">
                </div>
                <div class="form-group">
                    <label>Role *</label>
                    <select id="editUserRole" required>
                        <option value="viewer">Viewer</option>
                        <option value="manager">Manager</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary">Update User</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editUserModal')">Close</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Change Password</h2>
                <button class="close-btn" onclick="closeModal('changePasswordModal')">CLOSE</button>
            </div>
            <form id="changePasswordForm">
                <input type="hidden" id="passwordUserId">
                <div class="form-group">
                    <label>New Password *</label>
                    <input type="password" id="newPassword" required minlength="6">
                </div>
                <div class="form-group">
                    <label>Confirm Password *</label>
                    <input type="password" id="confirmPassword" required minlength="6">
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary">Change Password</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('changePasswordModal')">Close</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Site Modal -->
    <div id="editSiteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Site</h2>
                <button class="close-btn" onclick="closeModal('editSiteModal')">CLOSE</button>
            </div>
            <form id="editSiteForm">
                <input type="hidden" id="editSiteId">
                <div class="form-group">
                    <label>Site Name *</label>
                    <input type="text" id="editSiteName" required>
                </div>
                <div class="form-group">
                    <label>Code</label>
                    <input type="text" id="editSiteCode" placeholder="e.g., FRM, HOM">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="editSiteDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <textarea id="editSiteAddress" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>Bank Name</label>
                    <input type="text" id="editSiteBankName" placeholder="e.g., ABSA, Standard Bank">
                </div>
                <div class="form-group">
                    <label>Account Number</label>
                    <input type="text" id="editSiteAccountNumber" placeholder="e.g., 1234567890">
                </div>
                <div style="background: #fef2f2; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #fca5a5;">
                    <h4 style="margin-bottom: 0.75rem; color: #dc2626;">üìç GPS Settings (for Clock-In)</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.75rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Latitude</label>
                            <input type="number" step="any" id="editSiteLatitude" placeholder="-26.123456">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Longitude</label>
                            <input type="number" step="any" id="editSiteLongitude" placeholder="28.123456">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Radius (m)</label>
                            <input type="number" id="editSiteRadius" placeholder="100" value="100">
                        </div>
                    </div>
                </div>
                <div style="background: #faf5ff; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #c4b5fd;">
                    <h4 style="margin-bottom: 0.75rem; color: #7c3aed;">üõ°Ô∏è Standby Person (No-Work Days)</h4>
                    <p style="font-size: 0.85rem; color: #6b7280; margin-bottom: 0.75rem;">
                        This person receives standby allowance on company no-work days. If they clock in, standby converts to regular hours.
                    </p>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Standby Staff Member</label>
                        <select id="editSiteStandbyStaff">
                            <option value="">None (no standby for this site)</option>
                        </select>
                    </div>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary">Update Site</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editSiteModal')">Close</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Force Delete Period Confirmation Modal -->
    <div id="forceDeleteModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background: #dc2626; color: white;">
                <h2 style="color: white;">‚ö†Ô∏è FORCE DELETE PERIOD</h2>
                <button class="close-btn" onclick="closeModal('forceDeleteModal')" style="background: rgba(255,255,255,0.2);">CLOSE</button>
            </div>
            <div style="padding: 1.5rem;">
                <div style="background: #fef2f2; border: 2px solid #dc2626; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                    <h3 style="color: #dc2626; margin-top: 0;">‚ö†Ô∏è CRITICAL WARNING</h3>
                    <p style="margin: 0.5rem 0; font-weight: 600;">This period is LOCKED. PDFs have been generated.</p>
                    <p style="margin: 0.5rem 0; font-size: 0.95rem;">Force deleting will:</p>
                    <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: #dc2626;">
                        <li><strong>DELETE ALL PDF PAYSLIPS</strong> (<span id="forceDeletePdfCount">0</span> files)</li>
                        <li><strong>DELETE THE PAY PERIOD</strong></li>
                        <li><strong>DELETE ALL PAYSLIPS AND TRANSACTIONS</strong></li>
                    </ul>
                    <p style="margin: 0.5rem 0; font-size: 0.95rem; color: #991b1b;">
                        <strong>THIS CANNOT BE UNDONE!</strong>
                    </p>
                </div>
                <p style="font-weight: 600; margin-bottom: 0.5rem;">Period: <span id="forceDeletePeriodInfo" style="color: #dc2626;"></span></p>
                <p style="font-size: 0.9rem; color: #6b7280; margin-bottom: 1.5rem;">
                    This operation requires <strong>ADMIN</strong> privileges and password re-authentication.
                </p>
                <form id="forceDeleteForm">
                    <div class="form-group">
                        <label style="font-weight: 600;">Admin Password * <span style="color: #dc2626;">(Required)</span></label>
                        <input type="password" id="forceDeletePassword" required placeholder="Enter your admin password" style="border: 2px solid #dc2626;">
                    </div>
                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                        <button type="submit" class="btn" style="background: #dc2626; color: white; flex: 1;">
                            üóëÔ∏è FORCE DELETE
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('forceDeleteModal')" style="flex: 1;">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Payment Summary Modal -->
    <div id="paymentSummaryModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header" style="background: #0284c7; color: white;">
                <h2 style="color: white; font-size: 1.2rem;">üìä Payment Summary - <span id="summaryPeriodInfo"></span></h2>
                <button class="close-btn" onclick="closeModal('paymentSummaryModal')" style="background: rgba(255,255,255,0.2);">CLOSE</button>
            </div>
            <div style="padding: 1.5rem;">
                <div id="paymentSummaryContent">
                    <!-- Summary tables will be inserted here -->
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-primary" onclick="printPaymentSummary()" style="background: #059669;">
                        üñ®Ô∏è Print Summary
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('paymentSummaryModal')">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Staff Payslip History Modal -->
    <div id="staffHistoryModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header" style="background: #0284c7; color: white;">
                <h2 style="color: white; font-size: 1.2rem;">üìã Staff History - <span id="historyStaffName"></span></h2>
                <button class="close-btn" onclick="closeModal('staffHistoryModal')" style="background: rgba(255,255,255,0.2);">CLOSE</button>
            </div>
            <div style="padding: 1.5rem;">
                <!-- Tabs for Payslip History and SMS Log -->
                <div style="display: flex; gap: 0; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb;">
                    <button id="tabPayslipHistory" onclick="switchHistoryTab('payslip')" style="padding: 0.75rem 1.5rem; border: none; background: #0284c7; color: white; font-weight: 600; cursor: pointer; border-radius: 6px 6px 0 0;">
                        üí∞ Payslip History
                    </button>
                    <button id="tabSmsLog" onclick="switchHistoryTab('sms')" style="padding: 0.75rem 1.5rem; border: none; background: #f1f5f9; color: #64748b; font-weight: 600; cursor: pointer; border-radius: 6px 6px 0 0;">
                        üì± SMS Log
                    </button>
                </div>

                <!-- Payslip History Section -->
                <div id="payslipHistorySection">
                    <div style="margin-bottom: 1rem; display: flex; align-items: center; gap: 1rem;">
                        <label for="historyPeriodFilter" style="font-weight: 600;">Filter by Period:</label>
                        <select id="historyPeriodFilter" onchange="filterHistoryByPeriod()" style="padding: 0.5rem; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.875rem; min-width: 200px;">
                            <option value="">All Periods</option>
                        </select>
                    </div>
                    <div id="staffHistoryContent">
                        <div style="text-align: center; padding: 2rem; color: #94a3b8;">
                            Loading history...
                        </div>
                    </div>
                </div>

                <!-- SMS Log Section (hidden by default) -->
                <div id="smsLogSection" style="display: none;">
                    <div style="margin-bottom: 1rem; display: flex; align-items: center; gap: 1rem;">
                        <label for="smsLogFilter" style="font-weight: 600;">Filter:</label>
                        <select id="smsLogFilter" onchange="loadSmsLog()" style="padding: 0.5rem; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.875rem; min-width: 150px;">
                            <option value="week">Last Week</option>
                            <option value="month">Last Month</option>
                            <option value="all">All Time</option>
                        </select>
                        <span id="smsLogCount" style="color: #64748b; font-size: 0.875rem;"></span>
                    </div>
                    <div id="smsLogContent">
                        <div style="text-align: center; padding: 2rem; color: #94a3b8;">
                            Loading SMS log...
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('staffHistoryModal')">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Loans Modal -->
    <div id="manageLoansModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>Manage Loans - <span id="loanStaffName"></span></h2>
                <button class="close-btn" onclick="closeModal('manageLoansModal')">CLOSE</button>
            </div>

            <input type="hidden" id="loanStaffId">

            <!-- Summary Cards -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                <div style="background: #fef3c7; border: 2px solid #fbbf24; border-radius: 8px; padding: 1rem; text-align: center;">
                    <div style="font-size: 0.75rem; color: #92400e; font-weight: 600; margin-bottom: 0.25rem;">CURRENT BALANCE</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #92400e;" id="loanCurrentBalance">R0.00</div>
                </div>
                <div style="background: #fee2e2; border: 2px solid #f87171; border-radius: 8px; padding: 1rem; text-align: center;">
                    <div style="font-size: 0.75rem; color: #991b1b; font-weight: 600; margin-bottom: 0.25rem;">TOTAL BORROWED</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #991b1b;" id="loanTotalBorrowed">R0.00</div>
                </div>
                <div style="background: #d1fae5; border: 2px solid #34d399; border-radius: 8px; padding: 1rem; text-align: center;">
                    <div style="font-size: 0.75rem; color: #065f46; font-weight: 600; margin-bottom: 0.25rem;">TOTAL REPAID</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #065f46;" id="loanTotalRepaid">R0.00</div>
                </div>
                <div style="background: #fce7f3; border: 2px solid #f472b6; border-radius: 8px; padding: 1rem; text-align: center;">
                    <div style="font-size: 0.75rem; color: #831843; font-weight: 600; margin-bottom: 0.25rem;">MAX LOAN AMOUNT</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #831843;" id="loanMaxAmount">R0.00</div>
                </div>
                <div style="background: #dbeafe; border: 2px solid #60a5fa; border-radius: 8px; padding: 1rem; text-align: center;">
                    <div style="font-size: 0.75rem; color: #1e40af; font-weight: 600; margin-bottom: 0.25rem;">ACTIVE LOANS</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #1e40af;" id="loanActiveCount">0</div>
                </div>
                <div style="background: #e0e7ff; border: 2px solid #818cf8; border-radius: 8px; padding: 1rem; text-align: center;">
                    <div style="font-size: 0.75rem; color: #3730a3; font-weight: 600; margin-bottom: 0.25rem;">NEXT DEDUCTION</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #3730a3;" id="loanNextDeduction">R0.00</div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem;">
                <button class="btn" onclick="showNewLoanModal()" style="background: #7c3aed;">+ New Loan</button>
                <button class="btn btn-secondary" onclick="showManualRepaymentModal()">Record Manual Repayment</button>
            </div>

            <!-- Active Loans Section -->
            <div style="margin-bottom: 1.5rem;">
                <h3 style="margin-bottom: 1rem; font-size: 1.1rem; color: #1f2937;">Active Loans</h3>
                <div id="activeLoansContainer"></div>
            </div>

            <!-- Transaction History Section -->
            <div>
                <h3 style="margin-bottom: 1rem; font-size: 1.1rem; color: #1f2937;">Recent Transactions (Last 20)</h3>
                <div id="loanTransactionsContainer" style="overflow-x: auto;"></div>
            </div>
        </div>
    </div>

    <!-- New Loan Modal -->
    <div id="newLoanModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>New Loan - <span id="newLoanStaffName"></span></h2>
                <button class="close-btn" onclick="closeModal('newLoanModal')">CLOSE</button>
            </div>

            <form id="newLoanForm">
                <div class="form-group">
                    <label>Description *</label>
                    <input type="text" id="newLoanDescription" required placeholder="e.g., Cash Advance, Equipment Purchase">
                </div>

                <div class="form-group">
                    <label>Total Amount (R) *</label>
                    <input type="number" id="newLoanAmount" step="0.01" min="0.01" required placeholder="0.00">
                </div>

                <div class="form-group">
                    <label>Installment Amount per Period (R) *</label>
                    <input type="number" id="newLoanInstallment" step="0.01" min="0.01" required placeholder="0.00">
                </div>

                <div class="form-group">
                    <label>Start Deduction Date *</label>
                    <input type="date" id="newLoanStartDate" required>
                </div>

                <div class="form-group">
                    <label>Notes (Optional)</label>
                    <textarea id="newLoanNotes" rows="3" placeholder="Additional notes..."></textarea>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn" style="background: #7c3aed;">Create Loan</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('newLoanModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Manual Repayment Modal -->
    <div id="manualRepaymentModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Record Manual Repayment</h2>
                <button class="close-btn" onclick="closeModal('manualRepaymentModal')">CLOSE</button>
            </div>

            <form id="manualRepaymentForm">
                <div class="form-group">
                    <label>Select Loan *</label>
                    <select id="repaymentLoanId" required>
                        <option value="">-- Select Loan --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Payment Amount (R) *</label>
                    <input type="number" id="repaymentAmount" step="0.01" min="0.01" required placeholder="0.00">
                </div>

                <div class="form-group">
                    <label>Notes (Optional)</label>
                    <textarea id="repaymentNotes" rows="3" placeholder="Repayment notes..."></textarea>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-success">Record Repayment</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('manualRepaymentModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Manage Savings Modal -->
    <div id="savingsModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 id="savingsModalTitle">Manage Savings</h2>
                <button class="close-btn" onclick="closeModal('savingsModal')">CLOSE</button>
            </div>
            <input type="hidden" id="savingsStaffId">

            <!-- Current Balance -->
            <div style="background: #f0fdf4; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 2px solid #86efac;">
                <div style="font-size: 0.875rem; color: #059669; margin-bottom: 0.25rem;">Current Balance</div>
                <div style="font-size: 2rem; font-weight: 700; color: #059669;" id="currentBalance">R 0.00</div>
            </div>

            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                <button class="btn btn-primary btn-small" onclick="showAddSavingsTransaction('deposit')">+ Deposit</button>
                <button class="btn btn-secondary btn-small" onclick="showAddSavingsTransaction('withdrawal')">- Withdraw</button>
            </div>

            <h3 style="margin-bottom: 0.5rem;">Transaction History</h3>
            <div id="savingsTransactionsContainer"></div>
        </div>
    </div>

    <!-- Add Savings Transaction Modal -->
    <div id="addSavingsTransactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="savingsTransactionTitle">New Transaction</h2>
                <button class="close-btn" onclick="closeModal('addSavingsTransactionModal')">CLOSE</button>
            </div>
            <form id="addSavingsTransactionForm">
                <input type="hidden" id="savingsTransactionStaffId">
                <input type="hidden" id="savingsTransactionType">
                <div class="form-group">
                    <label>Amount (R) *</label>
                    <input type="number" id="savingsAmount" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="savingsDescription" placeholder="Optional description">
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary">Save Transaction</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addSavingsTransactionModal')">Close</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Staff List Modal -->
    <div id="staffListModal" class="modal">
        <div class="modal-content" style="max-width: 950px;">
            <div class="modal-header">
                <h2 id="staffListTitle">Staff List</h2>
                <button class="close-btn" onclick="closeModal('staffListModal')">CLOSE</button>
            </div>
            <div id="staffListContent" style="max-height: 60vh; overflow-y: auto;">
                <table>
                    <thead id="staffListTableHead">
                        <tr>
                            <th>Staff Name</th>
                            <th>Site</th>
                            <th>Mobile</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="staffListTableBody">
                        <tr><td colspan="4" style="text-align: center;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Reminder List Modal -->
    <div id="reminderListModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 id="reminderListTitle">Reminder List</h2>
                <button class="close-btn" onclick="closeModal('reminderListModal')">CLOSE</button>
            </div>
            <div id="reminderListContent" style="max-height: 60vh; overflow-y: auto;">
                <table>
                    <thead id="reminderListTableHead">
                        <tr>
                            <th>Staff Name</th>
                            <th>Site</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="reminderListTableBody">
                        <tr><td colspan="5" style="text-align: center;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Whereabouts Request Modal -->
    <div id="whereaboutsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìç Request Whereabouts</h2>
                <button class="close-btn" onclick="closeModal('whereaboutsModal')">CLOSE</button>
            </div>
            <form id="whereaboutsForm">
                <div class="form-group">
                    <label>Filter by Site</label>
                    <select id="whereaboutsSite" onchange="filterWhereaboutsStaff()">
                        <option value="">All Sites</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Select Staff Member *</label>
                    <select id="whereaboutsStaff" required>
                        <option value="">Select staff...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Reason (optional)</label>
                    <input type="text" id="whereaboutsReason" placeholder="e.g., Location check">
                </div>
                <p style="margin-bottom: 1rem; color: #6b7280; font-size: 0.875rem;">
                    An SMS will be sent to the staff member with a link to share their location.
                </p>
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary">üì± Send SMS</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('whereaboutsModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let authToken = null;
        let currentUser = null;
        let allSites = [];
        let allStaff = [];
        let payPeriods = [];
        let currentPayPeriod = null;
        let currentPayslips = [];
        let trackingData = null;  // Store tracking data for staff list modal
        let reminderData = null;  // Store reminder data for reminder list modal

        // Authentication
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, password})
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.token;
                    currentUser = data.user;
                    localStorage.setItem('wagepro_token', authToken);
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    document.getElementById('userName').textContent = currentUser.full_name;
                    loadInitialData();
                } else {
                    document.getElementById('loginError').textContent = data.error;
                    document.getElementById('loginError').classList.remove('hidden');
                }
            } catch (error) {
                document.getElementById('loginError').textContent = 'Login failed';
                document.getElementById('loginError').classList.remove('hidden');
            }
        });

        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('wagepro_token');
            location.reload();
        }

        // Format date as dd/mm/yyyy
        function formatDateDMY(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Helper function for API calls
        async function apiCall(url, options = {}) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                }
            };
            const response = await fetch(url, {...defaultOptions, ...options});
            if (response.status === 401) {
                logout();
                return;
            }
            return response;
        }

        // Tab navigation
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Find and activate the correct tab button
            const tabButton = document.querySelector(`.tab-${tabName}`);
            if (tabButton) {
                tabButton.classList.add('active');
            }

            document.getElementById(tabName + 'Tab').classList.add('active');

            if (tabName === 'sites') loadSites();
            if (tabName === 'staff') loadStaff();
            if (tabName === 'payroll') loadPayPeriods();
            if (tabName === 'tracking') loadTracking();
            if (tabName === 'leave') loadLeave();
            if (tabName === 'config') loadConfig();
            if (tabName === 'admin') loadAdmin();  // Users now loaded as part of Admin
            if (tabName === 'productivity') loadProductivity();
        }

        // Modal functions
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('active');
            modal.style.display = '';  // Clear inline style to let CSS take over
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('active');
            modal.style.display = 'none';
        }

        // Load initial data
        async function loadInitialData() {
            await loadSites();
            await loadStaff();
            await loadPayPeriods();

            // Check for saved tab or URL hash, default to tracking
            const savedTab = localStorage.getItem('wagepro_tab');
            const hashTab = window.location.hash.replace('#', '');
            const targetTab = hashTab || savedTab || 'tracking';

            // Clear saved tab after using it
            localStorage.removeItem('wagepro_tab');

            showTab(targetTab);
        }

        // ===== SITES =====
        async function loadSites() {
            const response = await apiCall('/api/sites');
            allSites = await response.json();

            const showInactive = document.getElementById('sitesShowInactive')?.checked || false;
            const filteredSites = showInactive ? allSites : allSites.filter(site => site.is_active);

            const tbody = document.getElementById('sitesTableBody');
            if (filteredSites.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No sites found</td></tr>';
                return;
            }

            tbody.innerHTML = filteredSites.map(site => {
                const gpsIcon = site.gps_latitude ? 'üìç' : '';
                const standbyIcon = site.standby_staff ? 'üõ°Ô∏è' : '';
                const standbyInfo = site.standby_staff ? `<br><small style="color: #7c3aed;">Standby: ${site.standby_staff.name}</small>` : '';
                return `
                <tr>
                    <td><strong>${gpsIcon}${standbyIcon} ${site.name}</strong>${standbyInfo}</td>
                    <td>${site.code || '-'}</td>
                    <td>${site.description || '-'}</td>
                    <td><span class="badge ${site.is_active ? 'badge-success' : 'badge-danger'}">${site.is_active ? 'Active' : 'Inactive'}</span></td>
                    <td>
                        <button class="btn btn-small btn-secondary" onclick="showEditSiteModal(${site.id})">Edit</button>
                        <button class="btn btn-small ${site.is_active ? 'btn-warning' : 'btn-success'}" onclick="toggleSiteActive(${site.id})">
                            ${site.is_active ? 'Deactivate' : 'Activate'}
                        </button>
                    </td>
                </tr>
            `}).join('');

            // Update site dropdowns (only active sites)
            updateSiteDropdowns();
        }

        function updateSiteDropdowns() {
            const siteSelects = ['staffSite', 'editStaffSite'];
            const activeSites = allSites.filter(site => site.is_active);
            siteSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Select Site</option>' +
                        activeSites.map(site => `<option value="${site.id}">${site.name}</option>`).join('');
                }
            });
        }

        function updatePositionDropdowns() {
            // Get unique positions from existing staff
            const positions = [...new Set(allStaff.map(s => s.position).filter(p => p && p.trim()))].sort();

            const positionSelects = ['staffPositionSelect', 'editStaffPositionSelect'];
            positionSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Select Position</option>' +
                        positions.map(pos => `<option value="${pos}">${pos.toUpperCase()}</option>`).join('') +
                        '<option value="__OTHER__">Other (type below)</option>';
                }
            });
        }

        function handlePositionChange(prefix) {
            const select = document.getElementById(`${prefix}PositionSelect`);
            const otherInput = document.getElementById(`${prefix}PositionOther`);
            if (select.value === '__OTHER__') {
                otherInput.style.display = 'block';
                otherInput.focus();
            } else {
                otherInput.style.display = 'none';
                otherInput.value = '';
            }
        }

        function getSelectedPosition(prefix) {
            const select = document.getElementById(`${prefix}PositionSelect`);
            const otherInput = document.getElementById(`${prefix}PositionOther`);
            if (select.value === '__OTHER__') {
                return otherInput.value.trim() || null;
            }
            return select.value || null;
        }

        function updateHourlyFromDaily(prefix) {
            const dailyRate = parseFloat(document.getElementById(`${prefix}DailyRate`).value);
            if (dailyRate && dailyRate > 0) {
                const hourlyRate = (dailyRate / 8).toFixed(2);
                document.getElementById(`${prefix}HourlyRate`).value = hourlyRate;
            }
        }

        function updateDailyFromHourly(prefix) {
            const hourlyRate = parseFloat(document.getElementById(`${prefix}HourlyRate`).value);
            if (hourlyRate && hourlyRate > 0) {
                const dailyRate = (hourlyRate * 8).toFixed(2);
                document.getElementById(`${prefix}DailyRate`).value = dailyRate;
            }
        }

        function showAddSiteModal() {
            document.getElementById('addSiteForm').reset();
            showModal('addSiteModal');
        }

        document.getElementById('addSiteForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                name: document.getElementById('siteName').value,
                code: document.getElementById('siteCode').value,
                description: document.getElementById('siteDescription').value,
                address: document.getElementById('siteAddress').value,
                bank_name: document.getElementById('siteBankName').value,
                account_number: document.getElementById('siteAccountNumber').value
            };

            const response = await apiCall('/api/sites', {
                method: 'POST',
                body: JSON.stringify(data)
            });

            if (response.ok) {
                closeModal('addSiteModal');
                loadSites();
            }
        });

        // ===== STAFF =====
        async function loadStaff() {
            const response = await apiCall('/api/staff');
            allStaff = await response.json();

            const tbody = document.getElementById('staffTableBody');
            if (allStaff.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No staff members found</td></tr>';
                return;
            }

            // Group staff by site
            const bySite = {};
            allStaff.forEach(staff => {
                const siteName = staff.site_name || 'No Site';
                if (!bySite[siteName]) {
                    bySite[siteName] = [];
                }
                bySite[siteName].push(staff);
            });

            // Sort sites alphabetically, then staff within each site
            const sortedSites = Object.keys(bySite).sort();

            let html = '';
            sortedSites.forEach(siteName => {
                // Sort staff within site - highest daily rate first, then alphabetically
                bySite[siteName].sort((a, b) => {
                    const aRate = a.daily_rate || 0;
                    const bRate = b.daily_rate || 0;
                    if (bRate !== aRate) return bRate - aRate;  // Highest rate first
                    return a.full_name.localeCompare(b.full_name);
                });

                // Add site header row
                html += `
                    <tr style="background: #059669; color: white;">
                        <td colspan="4" style="padding: 0.75rem; font-weight: 700; font-size: 1rem;">
                            ${siteName} (${bySite[siteName].length} staff)
                        </td>
                    </tr>
                `;

                // Add staff rows for this site
                html += bySite[siteName].map(staff => {
                    const cellNo = staff.mobile || staff.phone || 'NO NUMBER';
                    const hasPhone = staff.mobile || staff.phone;
                    const locateBtn = hasPhone ? `<button onclick="quickLocate(${staff.id}, '${staff.full_name}')" style="background: none; border: none; cursor: pointer; font-size: 1.1rem; padding: 0 4px;" title="Request whereabouts">üìç</button>` : '';

                    return `
                    <tr>
                        <td><strong>${staff.full_name}</strong></td>
                        <td style="color: #dc2626; font-weight: 700;">${locateBtn}${cellNo}</td>
                        <td>R ${staff.daily_rate ? staff.daily_rate.toFixed(2) : '0.00'}</td>
                        <td>
                            <button class="btn btn-small" style="background: #3b82f6; color: white;" onclick='showEditStaffModal(${JSON.stringify(staff)})'>Edit</button>
                            <button class="btn btn-small" style="background: #0284c7; color: white;" onclick="showStaffHistory(${staff.id}, '${staff.full_name}')">History</button>
                            <button class="btn btn-small" style="background: #7c3aed; color: white;" onclick="manageLoans(${staff.id}, '${staff.full_name}')">Loans</button>
                            <button class="btn btn-small" style="background: #f59e0b; color: white;" onclick="manageDeductions(${staff.id}, '${staff.full_name}')">Deductions</button>
                            <button class="btn btn-small bio-btn" data-staff-id="${staff.id}" style="background: ${staff.face_enrolled ? '#10b981' : '#6b7280'}; color: white;">Bio</button>
                        </td>
                    </tr>
                `;
                }).join('');
            });

            tbody.innerHTML = html;

            // Add click handlers for Bio buttons
            document.querySelectorAll('.bio-btn').forEach(btn => {
                btn.addEventListener('click', () => openBiometrics(parseInt(btn.dataset.staffId)));
            });

            // Populate site filter dropdown
            populateStaffSiteFilter();
        }

        function populateStaffSiteFilter() {
            const filter = document.getElementById('staffSiteFilter');
            const uniqueSites = [...new Set(allStaff.map(s => s.site_name).filter(Boolean))].sort();

            filter.innerHTML = '<option value="">All Sites</option>';
            uniqueSites.forEach(siteName => {
                const option = document.createElement('option');
                option.value = siteName;
                option.textContent = siteName;
                filter.appendChild(option);
            });
        }

        function filterStaffBySite() {
            const selectedSite = document.getElementById('staffSiteFilter').value;
            const showCasuals = document.getElementById('staffShowCasuals').checked;
            const tbody = document.getElementById('staffTableBody');

            // Filter staff
            let filteredStaff = allStaff;
            if (selectedSite) {
                filteredStaff = filteredStaff.filter(s => s.site_name === selectedSite);
            }
            if (!showCasuals) {
                filteredStaff = filteredStaff.filter(s => s.employment_type !== 'casual');
            }

            if (filteredStaff.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No staff found for this site</td></tr>';
                return;
            }

            // Group by site
            const bySite = {};
            filteredStaff.forEach(staff => {
                const siteName = staff.site_name || 'No Site';
                if (!bySite[siteName]) {
                    bySite[siteName] = [];
                }
                bySite[siteName].push(staff);
            });

            // Sort and build HTML
            const sortedSites = Object.keys(bySite).sort();
            let html = '';
            sortedSites.forEach(siteName => {
                // Sort staff - highest daily rate first, then alphabetically
                bySite[siteName].sort((a, b) => {
                    const aRate = a.daily_rate || 0;
                    const bRate = b.daily_rate || 0;
                    if (bRate !== aRate) return bRate - aRate;
                    return a.full_name.localeCompare(b.full_name);
                });

                html += `
                    <tr style="background: #059669; color: white;">
                        <td colspan="4" style="padding: 0.75rem; font-weight: 700; font-size: 1rem;">
                            ${siteName} (${bySite[siteName].length} staff)
                        </td>
                    </tr>
                `;

                html += bySite[siteName].map(staff => {
                    const cellNo = staff.mobile || staff.phone || 'NO NUMBER';
                    const hasPhone = staff.mobile || staff.phone;
                    const locateBtn = hasPhone ? `<button onclick="quickLocate(${staff.id}, '${staff.full_name}')" style="background: none; border: none; cursor: pointer; font-size: 1.1rem; padding: 0 4px;" title="Request whereabouts">üìç</button>` : '';

                    return `
                    <tr>
                        <td><strong>${staff.full_name}</strong></td>
                        <td style="color: #dc2626; font-weight: 700;">${locateBtn}${cellNo}</td>
                        <td>R ${staff.daily_rate ? staff.daily_rate.toFixed(2) : '0.00'}</td>
                        <td>
                            <button class="btn btn-small" style="background: #3b82f6; color: white;" onclick='showEditStaffModal(${JSON.stringify(staff)})'>Edit</button>
                            <button class="btn btn-small" style="background: #0284c7; color: white;" onclick="showStaffHistory(${staff.id}, '${staff.full_name}')">History</button>
                            <button class="btn btn-small" style="background: #7c3aed; color: white;" onclick="manageLoans(${staff.id}, '${staff.full_name}')">Loans</button>
                            <button class="btn btn-small" style="background: #f59e0b; color: white;" onclick="manageDeductions(${staff.id}, '${staff.full_name}')">Deductions</button>
                            <button class="btn btn-small bio-btn" data-staff-id="${staff.id}" style="background: ${staff.face_enrolled ? '#10b981' : '#6b7280'}; color: white;">Bio</button>
                        </td>
                    </tr>
                `;
                }).join('');
            });

            tbody.innerHTML = html;

            // Add click handlers for Bio buttons
            document.querySelectorAll('.bio-btn').forEach(btn => {
                btn.addEventListener('click', () => openBiometrics(parseInt(btn.dataset.staffId)));
            });
        }

        function showAddStaffModal() {
            document.getElementById('addStaffForm').reset();
            updateSiteDropdowns();
            updatePositionDropdowns();
            document.getElementById('staffPositionOther').style.display = 'none';
            showModal('addStaffModal');
        }

        document.getElementById('addStaffForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                first_name: document.getElementById('staffFirstName').value,
                last_name: document.getElementById('staffLastName').value,
                id_number: document.getElementById('staffIdNumber').value || null,
                site_id: document.getElementById('staffSite').value || null,
                position: getSelectedPosition('staff'),
                employment_type: document.getElementById('staffEmploymentType').value,
                daily_rate: document.getElementById('staffDailyRate').value || 0,
                hourly_rate: document.getElementById('staffHourlyRate').value || 0,
                mobile: document.getElementById('staffMobile').value || null,
                phone: document.getElementById('staffPhone').value || null,
                email: document.getElementById('staffEmail').value || null,
                bank_name: document.getElementById('staffBankName').value || null,
                bank_account: document.getElementById('staffBankAccount').value || null,
                hire_date: new Date().toISOString()
            };

            const response = await apiCall('/api/staff', {
                method: 'POST',
                body: JSON.stringify(data)
            });

            if (response.ok) {
                closeModal('addStaffModal');
                loadStaff();
            }
        });

        let currentEditingStaff = null;

        function showEditStaffModal(staff) {
            currentEditingStaff = staff;
            document.getElementById('editStaffId').value = staff.id;
            document.getElementById('editStaffFirstName').value = staff.first_name;
            document.getElementById('editStaffLastName').value = staff.last_name;

            // Update deactivate button based on staff status
            const deactivateBtn = document.getElementById('deactivateStaffBtn');
            if (staff.is_active) {
                deactivateBtn.textContent = 'Deactivate Staff';
                deactivateBtn.style.background = '#dc2626';
            } else {
                deactivateBtn.textContent = 'Reactivate Staff';
                deactivateBtn.style.background = '#10b981';
            }
            document.getElementById('editStaffIdNumber').value = staff.id_number || '';
            document.getElementById('editStaffEmploymentType').value = staff.employment_type;
            document.getElementById('editStaffDailyRate').value = staff.daily_rate || '';
            document.getElementById('editStaffHourlyRate').value = staff.hourly_rate || '';
            document.getElementById('editStaffMobile').value = staff.mobile || '';
            document.getElementById('editStaffPhone').value = staff.phone || '';
            document.getElementById('editStaffEmail').value = staff.email || '';
            document.getElementById('editStaffBankName').value = staff.bank_name || '';
            document.getElementById('editStaffBankAccount').value = staff.bank_account || '';

            updateSiteDropdowns();
            document.getElementById('editStaffSite').value = staff.site_id || '';

            // Set position dropdown
            updatePositionDropdowns();
            const positionSelect = document.getElementById('editStaffPositionSelect');
            const positionOther = document.getElementById('editStaffPositionOther');
            const currentPosition = staff.position || '';

            // Check if current position exists in dropdown options
            const existsInDropdown = [...positionSelect.options].some(opt => opt.value === currentPosition);
            if (currentPosition && !existsInDropdown) {
                // Position is custom - show Other field
                positionSelect.value = '__OTHER__';
                positionOther.value = currentPosition;
                positionOther.style.display = 'block';
            } else {
                positionSelect.value = currentPosition;
                positionOther.value = '';
                positionOther.style.display = 'none';
            }

            showModal('editStaffModal');
        }

        document.getElementById('editStaffForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const staffId = document.getElementById('editStaffId').value;
            const data = {
                first_name: document.getElementById('editStaffFirstName').value,
                last_name: document.getElementById('editStaffLastName').value,
                id_number: document.getElementById('editStaffIdNumber').value || null,
                site_id: document.getElementById('editStaffSite').value || null,
                position: getSelectedPosition('editStaff'),
                employment_type: document.getElementById('editStaffEmploymentType').value,
                daily_rate: document.getElementById('editStaffDailyRate').value || 0,
                hourly_rate: document.getElementById('editStaffHourlyRate').value || 0,
                mobile: document.getElementById('editStaffMobile').value || null,
                phone: document.getElementById('editStaffPhone').value || null,
                email: document.getElementById('editStaffEmail').value || null,
                bank_name: document.getElementById('editStaffBankName').value || null,
                bank_account: document.getElementById('editStaffBankAccount').value || null
            };

            const response = await apiCall(`/api/staff/${staffId}`, {
                method: 'PUT',
                body: JSON.stringify(data)
            });

            if (response.ok) {
                closeModal('editStaffModal');
                loadStaff();
                alert('Staff member updated successfully');
            } else {
                const errorData = await response.json();
                alert('Error updating staff: ' + (errorData.error || 'Unknown error'));
            }
        });

        async function deactivateStaff() {
            if (!currentEditingStaff) return;

            const action = currentEditingStaff.is_active ? 'deactivate' : 'reactivate';
            const newStatus = !currentEditingStaff.is_active;

            try {
                const response = await apiCall(`/api/staff/${currentEditingStaff.id}`, {
                    method: 'PUT',
                    body: JSON.stringify({ is_active: newStatus })
                });

                if (response.ok) {
                    closeModal('editStaffModal');
                    loadStaff();
                } else {
                    const data = await response.json();
                    alert('Error: ' + (data.error || `Failed to ${action} staff`));
                }
            } catch (error) {
                alert(`Error ${action}ing staff: ` + error.message);
            }
        }

        // ===== PAY PERIODS =====
        async function loadPayPeriods() {
            const response = await apiCall('/api/pay-periods');
            payPeriods = await response.json();

            const select = document.getElementById('payPeriodSelect');
            select.innerHTML = '<option value="">Select a pay period...</option>' +
                payPeriods.map(p => `
                    <option value="${p.id}">Period ${p.period_number} - ${p.year} (${formatDateDMY(p.start_date)} to ${formatDateDMY(p.end_date)})</option>
                `).join('');
        }

        function showAddPeriodModal() {
            document.getElementById('addPeriodForm').reset();

            // Calculate suggested dates based on last period
            let suggestedStartDate = new Date();
            let suggestedEndDate = new Date();

            if (payPeriods && payPeriods.length > 0) {
                // Get the most recent period (sorted by end_date descending)
                const sortedPeriods = [...payPeriods].sort((a, b) => new Date(b.end_date) - new Date(a.end_date));
                const lastPeriod = sortedPeriods[0];

                // Start date = day after last period ends
                suggestedStartDate = new Date(lastPeriod.end_date);
                suggestedStartDate.setDate(suggestedStartDate.getDate() + 1);

                // End date = 13 days after start (14-day period inclusive)
                suggestedEndDate = new Date(suggestedStartDate);
                suggestedEndDate.setDate(suggestedEndDate.getDate() + 13);
            } else {
                // No previous periods - suggest next Saturday as start
                const today = new Date();
                const dayOfWeek = today.getDay(); // 0=Sunday, 6=Saturday
                const daysUntilSaturday = (6 - dayOfWeek + 7) % 7 || 7; // Days until next Saturday

                suggestedStartDate.setDate(today.getDate() + daysUntilSaturday);

                // End date = 13 days later (Friday)
                suggestedEndDate = new Date(suggestedStartDate);
                suggestedEndDate.setDate(suggestedEndDate.getDate() + 13);
            }

            // Format dates as YYYY-MM-DD for input fields
            const formatDate = (date) => date.toISOString().split('T')[0];

            // Set year to current year
            document.getElementById('periodYear').value = suggestedStartDate.getFullYear();

            // Pre-fill dates
            document.getElementById('periodStartDate').value = formatDate(suggestedStartDate);
            document.getElementById('periodEndDate').value = formatDate(suggestedEndDate);

            showModal('addPeriodModal');
        }

        document.getElementById('addPeriodForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                year: parseInt(document.getElementById('periodYear').value),
                start_date: document.getElementById('periodStartDate').value,
                end_date: document.getElementById('periodEndDate').value
            };

            const response = await apiCall('/api/pay-periods', {
                method: 'POST',
                body: JSON.stringify(data)
            });

            if (response.ok) {
                closeModal('addPeriodModal');
                loadPayPeriods();
            }
        });

        // Force Delete Form Handler
        document.getElementById('forceDeleteForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const password = document.getElementById('forceDeletePassword').value;
            const periodId = window.forceDeletePeriodId;

            if (!periodId || !password) {
                alert('Missing period ID or password');
                return;
            }

            // Second confirmation - final warning before force delete
            if (!confirm('‚ö†Ô∏è FINAL CONFIRMATION ‚ö†Ô∏è\n\nAre you ABSOLUTELY SURE you want to FORCE DELETE this locked period?\n\nAll PDFs, payslips, and transactions will be PERMANENTLY DELETED.\n\nClick OK to proceed with FORCE DELETE.')) {
                return;
            }

            try {
                // Step 1: Verify admin password
                const verifyResponse = await apiCall('/api/auth/verify-password', {
                    method: 'POST',
                    body: JSON.stringify({ password })
                });

                if (!verifyResponse) {
                    alert('‚ùå Authentication error. Please log in again.');
                    return;
                }

                if (!verifyResponse.ok) {
                    const error = await verifyResponse.json();
                    alert('‚ùå Password verification failed: ' + (error.error || 'Invalid password'));
                    return;
                }

                // Step 2: Perform force delete with force=true parameter
                const deleteResponse = await apiCall(`/api/pay-periods/${periodId}?force=true`, {
                    method: 'DELETE'
                });

                if (!deleteResponse) {
                    alert('‚ùå Authentication error. Please log in again.');
                    return;
                }

                if (deleteResponse.ok) {
                    const result = await deleteResponse.json();
                    closeModal('forceDeleteModal');
                    alert('‚úÖ ' + result.message + '\n\n' + (result.pdfs_deleted ? 'PDFs were deleted.' : 'No PDFs found.'));
                    document.getElementById('payPeriodSelect').value = '';
                    document.getElementById('deletePeriodBtn').style.display = 'none';
                    document.getElementById('payslipsCard').classList.add('hidden');
                    loadPayPeriods();
                } else {
                    const error = await deleteResponse.json();
                    alert('‚ùå Force delete failed: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        });

        async function deleteCurrentPeriod() {
            const periodId = document.getElementById('payPeriodSelect').value;
            if (!periodId) {
                alert('Please select a pay period first');
                return;
            }

            const period = payPeriods.find(p => p.id == periodId);

            // First confirmation - standard delete warning
            if (!confirm(`Delete pay period ${period.year}-${period.period_number}?\n\nThis will delete:\n- The pay period\n- All payslips\n\nThis CANNOT be undone!`)) {
                return;
            }

            const response = await apiCall(`/api/pay-periods/${periodId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                const result = await response.json();
                alert(result.message);
                document.getElementById('payPeriodSelect').value = '';
                document.getElementById('deletePeriodBtn').style.display = 'none';
                document.getElementById('payslipsCard').classList.add('hidden');
                loadPayPeriods();
            } else {
                const error = await response.json();
                if (error.locked) {
                    // Period is locked - offer force delete option (admin only)
                    if (currentUser && currentUser.role === 'admin') {
                        // Show force delete modal with password confirmation
                        showForceDeleteModal(period, error.pdf_count || 0);
                    } else {
                        alert('‚ö†Ô∏è PERIOD IS LOCKED\n\n' + error.error + '\n\nPDFs have been generated for this period, so it cannot be deleted.\n\nThis protects your finalized payroll data.\n\nOnly ADMIN users can force delete locked periods.');
                    }
                } else {
                    alert('Error: ' + (error.error || 'Failed to delete period'));
                }
            }
        }

        function showForceDeleteModal(period, pdfCount) {
            // Populate modal with period info
            document.getElementById('forceDeletePeriodInfo').textContent = `${period.year}-${period.period_number}`;
            document.getElementById('forceDeletePdfCount').textContent = pdfCount;
            document.getElementById('forceDeletePassword').value = '';

            // Store period ID for later use
            window.forceDeletePeriodId = period.id;

            // Show modal
            document.getElementById('forceDeleteModal').style.display = 'flex';
        }

        // ===== PAYSLIPS =====
        async function loadPayslips() {
            const periodId = document.getElementById('payPeriodSelect').value;
            const deleteBtn = document.getElementById('deletePeriodBtn');

            if (!periodId) {
                document.getElementById('payslipsCard').classList.add('hidden');
                deleteBtn.style.display = 'none';
                return;
            }

            // Show delete button when a period is selected
            deleteBtn.style.display = 'block';

            currentPayPeriod = payPeriods.find(p => p.id == periodId);

            const response = await apiCall(`/api/payslips?pay_period_id=${periodId}`);
            currentPayslips = await response.json();

            // Get staff not in payslips yet
            const staffInPayslips = currentPayslips.map(p => p.staff_id);
            const staffNotInPayslips = allStaff.filter(s => !staffInPayslips.includes(s.id) && s.is_active);

            const container = document.getElementById('payslipsContainer');

            let html = '';

            // Existing payslips
            if (currentPayslips.length > 0) {
                html += '<h3 style="margin-bottom: 1rem;">Staff Payslips</h3>';

                // Filter by selected site and casuals checkbox
                const selectedSite = document.getElementById('payslipSiteFilter')?.value;
                const showCasuals = document.getElementById('payslipShowCasuals')?.checked ?? true;
                let filteredPayslips = currentPayslips;
                if (selectedSite) {
                    filteredPayslips = filteredPayslips.filter(p => p.staff_site_name === selectedSite);
                }
                if (!showCasuals) {
                    filteredPayslips = filteredPayslips.filter(p => p.staff_employment_type !== 'casual');
                }

                // Group payslips by site
                const bySite = {};
                filteredPayslips.forEach(payslip => {
                    const siteName = payslip.staff_site_name || 'No Site';
                    if (!bySite[siteName]) {
                        bySite[siteName] = [];
                    }
                    bySite[siteName].push(payslip);
                });

                // Sort sites alphabetically, then payslips within each site
                const sortedSites = Object.keys(bySite).sort();

                sortedSites.forEach(siteName => {
                    // Sort payslips within site - highest daily rate first, then alphabetically
                    bySite[siteName].sort((a, b) => {
                        const aRate = a.staff_daily_rate || 0;
                        const bRate = b.staff_daily_rate || 0;
                        if (bRate !== aRate) return bRate - aRate;
                        return a.staff_name.localeCompare(b.staff_name);
                    });

                    // Add site header row
                    html += `
                        <div style="background: #059669; color: white; padding: 0.75rem; font-weight: 700; font-size: 1rem; margin-bottom: 0.5rem; border-radius: 8px;">
                            ${siteName} (${bySite[siteName].length} payslips)
                        </div>
                    `;

                    // Add payslip cards for this site
                    bySite[siteName].forEach(payslip => {
                    // Calculate multipliers
                    const w1Weekdays = ['w1_monday', 'w1_tuesday', 'w1_wednesday', 'w1_thursday', 'w1_friday'];
                    const w2Weekdays = ['w2_monday', 'w2_tuesday', 'w2_wednesday', 'w2_thursday', 'w2_friday'];
                    const w1WeekdaysWorked = w1Weekdays.filter(d => payslip[d]).length;
                    const w2WeekdaysWorked = w2Weekdays.filter(d => payslip[d]).length;
                    const w1Multiplier = w1WeekdaysWorked >= 3 ? 1.5 : 1.0;
                    const w2Multiplier = w2WeekdaysWorked >= 3 ? 1.5 : 1.0;

                    // Build 14-day display
                    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                    let daysHtml = '<div style="display: grid; grid-template-columns: auto repeat(7, 1fr); gap: 0.25rem; margin: 1rem 0; font-size: 0.85rem;">';

                    // Week 1
                    daysHtml += '<div style="font-weight: 600; padding: 0.25rem; font-size: 0.9rem;">W1</div>';
                    days.forEach(day => {
                        const dayValue = payslip[`w1_${day}`] || 0;  // 0.0, 0.5, or 1.0
                        const isWorked = dayValue > 0;
                        const isHalfDay = dayValue === 0.5;
                        const isFullDay = dayValue === 1.0;
                        const isWeekend = day === 'saturday' || day === 'sunday';
                        const gets15x = isFullDay && isWeekend && w1Multiplier === 1.5;
                        const bgColor = isWorked ? (isWeekend ? '#fef3c7' : '#dbeafe') : '#f3f4f6';
                        // Show: ¬Ω for half day, ‚úì* for weekend with 1.5x, ‚úì for full day
                        const checkMark = isHalfDay ? '¬Ω' : (isFullDay ? (gets15x ? '‚úì*' : '‚úì') : '');
                        daysHtml += `<div style="background: ${bgColor}; padding: 0.35rem; text-align: center; border-radius: 4px; border: 1px solid #e5e7eb; font-weight: 500;">
                            ${checkMark}
                        </div>`;
                    });

                    // Week 2
                    daysHtml += '<div style="font-weight: 600; padding: 0.25rem; font-size: 0.9rem;">W2</div>';
                    days.forEach(day => {
                        const dayValue = payslip[`w2_${day}`] || 0;  // 0.0, 0.5, or 1.0
                        const isWorked = dayValue > 0;
                        const isHalfDay = dayValue === 0.5;
                        const isFullDay = dayValue === 1.0;
                        const isWeekend = day === 'saturday' || day === 'sunday';
                        const gets15x = isFullDay && isWeekend && w2Multiplier === 1.5;
                        const bgColor = isWorked ? (isWeekend ? '#fef3c7' : '#dbeafe') : '#f3f4f6';
                        // Show: ¬Ω for half day, ‚úì* for weekend with 1.5x, ‚úì for full day
                        const checkMark = isHalfDay ? '¬Ω' : (isFullDay ? (gets15x ? '‚úì*' : '‚úì') : '');
                        daysHtml += `<div style="background: ${bgColor}; padding: 0.35rem; text-align: center; border-radius: 4px; border: 1px solid #e5e7eb; font-weight: 500;">
                            ${checkMark}
                        </div>`;
                    });

                    // Day labels
                    daysHtml += '<div></div>';
                    ['M', 'T', 'W', 'T', 'F', 'S', 'S'].forEach(label => {
                        daysHtml += `<div style="color: #6b7280; text-align: center; font-weight: 500; font-size: 0.8rem;">${label}</div>`;
                    });

                    daysHtml += '</div>';

                    // Weekend rates info
                    const ratesHtml = `<div style="font-size: 0.8rem; color: #92400e; margin-bottom: 0.5rem;">
                        Weekend rates: W1 ${w1Multiplier}x, W2 ${w2Multiplier}x
                    </div>`;

                    html += `
                        <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong style="font-size: 1.1rem;">${payslip.staff_name}</strong>
                                    <div style="color: #6b7280; font-size: 0.9rem;">${payslip.staff_position || ''}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 1.1rem; white-space: nowrap; font-weight: 600;">
                                        <span style="color: #dc2626;">GROSS R ${payslip.gross_pay.toFixed(2)}</span>
                                        <span style="color: #6b7280; margin: 0 0.5rem;">-</span>
                                        <span style="color: #7c3aed;">LOANS R ${(payslip.loan_deduction || 0).toFixed(2)}</span>
                                        <span style="color: #6b7280; margin: 0 0.5rem;">-</span>
                                        <span style="color: #059669;">SAVINGS R ${(payslip.savings_deduction || 0).toFixed(2)}</span>
                                        <span style="color: #6b7280; margin: 0 0.5rem;">-</span>
                                        <span style="color: #f59e0b;">DEDUCTIONS R ${(payslip.other_deductions || 0).toFixed(2)}</span>
                                        <span style="color: #6b7280; margin: 0 0.5rem;">=</span>
                                        <span style="color: #059669;">NETT R ${payslip.net_pay.toFixed(2)}</span>
                                    </div>
                                </div>
                            </div>
                            ${daysHtml}
                            ${ratesHtml}
                            <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                                <button class="btn btn-small" style="background: #3b82f6; color: white;" onclick="editDays(${payslip.id}, '${payslip.staff_name}')">Edit Days</button>
                                <button class="btn btn-small" style="background: #7c3aed; color: white;" onclick="manageLoans(${payslip.staff_id}, '${payslip.staff_name}')">Loans</button>
                                <button class="btn btn-small" style="background: #059669; color: white;" onclick="manageSavings(${payslip.staff_id}, '${payslip.staff_name}')">Savings</button>
                                <button class="btn btn-small" style="background: #f59e0b; color: white;" onclick="manageDeductions(${payslip.staff_id}, '${payslip.staff_name}')">Deductions</button>
                                <button class="btn btn-small" style="background: ${payslip.payment_method === 'CASH' ? '#dc2626' : '#0891b2'}; color: white;" onclick="event.stopPropagation(); togglePaymentMethod(${payslip.id}, '${payslip.payment_method || 'BANK'}')">
                                    PMNT: ${payslip.payment_method || 'BANK'}
                                </button>
                                <button class="btn btn-small" style="background: ${payslip.is_approved ? '#10b981' : '#6b7280'}; color: white;" onclick="approvePayslip(${payslip.id})">
                                    ${payslip.is_approved ? '‚úì Approved' : 'Approve'}
                                </button>
                            </div>
                        </div>
                    `;
                    });
                });
            }

            // Staff without payslips
            if (staffNotInPayslips.length > 0) {
                html += '<h3 style="margin-top: 2rem; margin-bottom: 1rem;">Add Payslips</h3>';

                // Group staff without payslips by site
                const staffBySite = {};
                staffNotInPayslips.forEach(staff => {
                    const siteName = staff.site_name || 'No Site';
                    if (!staffBySite[siteName]) {
                        staffBySite[siteName] = [];
                    }
                    staffBySite[siteName].push(staff);
                });

                // Sort sites alphabetically, then staff within each site
                const sortedStaffSites = Object.keys(staffBySite).sort();

                sortedStaffSites.forEach(siteName => {
                    // Sort staff within site - highest daily rate first, then alphabetically
                    staffBySite[siteName].sort((a, b) => {
                        const aRate = a.daily_rate || 0;
                        const bRate = b.daily_rate || 0;
                        if (bRate !== aRate) return bRate - aRate;
                        return a.full_name.localeCompare(b.full_name);
                    });

                    // Add site header row
                    html += `
                        <div style="background: #059669; color: white; padding: 0.75rem; font-weight: 700; font-size: 1rem; margin-bottom: 0.5rem; border-radius: 8px;">
                            ${siteName} (${staffBySite[siteName].length} staff)
                        </div>
                    `;

                    // Add staff cards for this site
                    staffBySite[siteName].forEach(staff => {
                        html += `
                            <div style="border: 1px dashed #d1d5db; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${staff.full_name}</strong>
                                        <div style="color: #6b7280; font-size: 0.9rem;">${staff.position || ''}</div>
                                    </div>
                                    <button class="btn btn-primary btn-small" onclick="createPayslip(${staff.id})">Add to Payroll</button>
                                </div>
                            </div>
                        `;
                    });
                });
            }

            container.innerHTML = html;
            document.getElementById('payslipsCard').classList.remove('hidden');

            // Control button visibility
            const addAllBtn = document.getElementById('addAllToPayrollBtn');
            const paymentSummaryBtn = document.getElementById('paymentSummaryBtn');
            const generatePDFsBtn = document.getElementById('generatePDFsBtn');

            // Show "Add All to Payroll" button if there are staff not yet added
            if (staffNotInPayslips.length > 0) {
                addAllBtn.style.display = 'block';
            } else {
                addAllBtn.style.display = 'none';
            }

            // Show "Payment Summary" button if there are any payslips
            if (currentPayslips.length > 0) {
                paymentSummaryBtn.style.display = 'block';
            } else {
                paymentSummaryBtn.style.display = 'none';
            }

            // Show "Generate PDFs" and "Send SMS" buttons only if:
            // 1. There are payslips
            // 2. At least one payslip is approved
            const hasApprovedPayslips = currentPayslips.some(p => p.is_approved);
            const sendSMSBtn = document.getElementById('sendSMSBtn');
            if (currentPayslips.length > 0 && hasApprovedPayslips) {
                generatePDFsBtn.style.display = 'block';
                sendSMSBtn.style.display = 'block';
            } else {
                generatePDFsBtn.style.display = 'none';
                sendSMSBtn.style.display = 'none';
            }

            // Populate payslip site filter
            populatePayslipSiteFilter();
        }

        function populatePayslipSiteFilter() {
            const filter = document.getElementById('payslipSiteFilter');
            const uniqueSites = [...new Set(currentPayslips.map(p => p.staff_site_name).filter(Boolean))].sort();

            filter.innerHTML = '<option value="">All Sites</option>';
            uniqueSites.forEach(siteName => {
                const option = document.createElement('option');
                option.value = siteName;
                option.textContent = siteName;
                filter.appendChild(option);
            });
        }

        function filterPayslipsBySite() {
            // Simplified: Just reload payslips which will respect the current filter
            loadPayslips();
        }

        async function createPayslip(staffId) {
            const data = {
                staff_id: staffId,
                pay_period_id: currentPayPeriod.id,
                w1_monday: 1.0,
                w1_tuesday: 1.0,
                w1_wednesday: 1.0,
                w1_thursday: 1.0,
                w1_friday: 1.0,
                w1_saturday: 1.0,
                w1_sunday: 1.0,
                w2_monday: 1.0,
                w2_tuesday: 1.0,
                w2_wednesday: 1.0,
                w2_thursday: 1.0,
                w2_friday: 1.0,
                w2_saturday: 1.0,
                w2_sunday: 1.0
            };

            const response = await apiCall('/api/payslips', {
                method: 'POST',
                body: JSON.stringify(data)
            });

            if (response.ok) {
                loadPayslips();
            }
        }

        async function addAllToPayroll() {
            // Get staff not in payslips yet
            const staffInPayslips = currentPayslips.map(p => p.staff_id);
            const staffNotInPayslips = allStaff.filter(s => !staffInPayslips.includes(s.id) && s.is_active);

            if (staffNotInPayslips.length === 0) {
                return;
            }

            // Create payslips for all staff
            for (const staff of staffNotInPayslips) {
                await createPayslip(staff.id);
            }
        }

        function showPaymentSummary() {
            if (!currentPayPeriod || !currentPayslips || currentPayslips.length === 0) {
                alert('No payslips available for this period.');
                return;
            }

            // Set period info
            document.getElementById('summaryPeriodInfo').textContent =
                `${currentPayPeriod.year}-Period-${currentPayPeriod.period_number} (${formatDateDMY(currentPayPeriod.start_date)} to ${formatDateDMY(currentPayPeriod.end_date)})`;

            // Group payslips by site
            const bySite = {};
            let grandGross = 0;
            let grandDeductions = 0;
            let grandNet = 0;

            currentPayslips.forEach(p => {
                const siteName = p.staff_site_name || 'No Site';
                if (!bySite[siteName]) {
                    bySite[siteName] = {
                        payslips: [],
                        totalGross: 0,
                        totalDeductions: 0,
                        totalNet: 0
                    };
                }

                bySite[siteName].payslips.push(p);
                bySite[siteName].totalGross += p.gross_pay || 0;
                bySite[siteName].totalDeductions += p.total_deductions || 0;
                bySite[siteName].totalNet += p.net_pay || 0;

                grandGross += p.gross_pay || 0;
                grandDeductions += p.total_deductions || 0;
                grandNet += p.net_pay || 0;
            });

            // Build HTML
            let html = '';

            // Summary by site
            Object.keys(bySite).sort().forEach(siteName => {
                const site = bySite[siteName];
                html += `
                    <div style="border: 2px solid #0284c7; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; background: #f0f9ff;">
                        <h3 style="margin: 0 0 1rem 0; color: #0284c7;">${siteName} (${site.payslips.length} staff)</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #0284c7; color: white;">
                                    <th style="padding: 0.5rem; text-align: left; border: 1px solid #0369a1;">Staff Member</th>
                                    <th style="padding: 0.5rem; text-align: right; border: 1px solid #0369a1;">Gross Pay</th>
                                    <th style="padding: 0.5rem; text-align: right; border: 1px solid #0369a1;">Deductions</th>
                                    <th style="padding: 0.5rem; text-align: right; border: 1px solid #0369a1;">Nett Pay</th>
                                    <th style="padding: 0.5rem; text-align: center; border: 1px solid #0369a1;">Payment</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${site.payslips.map((p, idx) => `
                                    <tr style="background: ${idx % 2 === 0 ? 'white' : '#f8fafc'};">
                                        <td style="padding: 0.5rem; border: 1px solid #e2e8f0;">${p.staff_name}</td>
                                        <td style="padding: 0.5rem; text-align: right; border: 1px solid #e2e8f0;">R${(p.gross_pay || 0).toFixed(2)}</td>
                                        <td style="padding: 0.5rem; text-align: right; border: 1px solid #e2e8f0;">R${(p.total_deductions || 0).toFixed(2)}</td>
                                        <td style="padding: 0.5rem; text-align: right; border: 1px solid #e2e8f0; font-weight: 600;">R${(p.net_pay || 0).toFixed(2)}</td>
                                        <td style="padding: 0.5rem; text-align: center; border: 1px solid #e2e8f0;"><span style="padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600; background: ${(p.payment_method || 'BANK') === 'CASH' ? '#fee2e2' : '#dbeafe'}; color: ${(p.payment_method || 'BANK') === 'CASH' ? '#991b1b' : '#1e40af'};">${p.payment_method || 'BANK'}</span></td>
                                    </tr>
                                `).join('')}
                                <tr style="background: #0c4a6e; color: white; font-weight: 700;">
                                    <td style="padding: 0.5rem; border: 1px solid #0369a1;">SITE TOTAL</td>
                                    <td style="padding: 0.5rem; text-align: right; border: 1px solid #0369a1;">R${site.totalGross.toFixed(2)}</td>
                                    <td style="padding: 0.5rem; text-align: right; border: 1px solid #0369a1;">R${site.totalDeductions.toFixed(2)}</td>
                                    <td style="padding: 0.5rem; text-align: right; border: 1px solid #0369a1;" colspan="2">R${site.totalNet.toFixed(2)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            });

            // Group by SITE first, then by bank account for payment totals
            const bySiteThenBank = {};
            currentPayslips.forEach(p => {
                const staff = allStaff.find(s => s.id === p.staff_id);
                const site = allSites.find(s => s.name === p.staff_site_name);
                const siteName = p.staff_site_name || 'Unknown Site';
                const paymentMethod = p.payment_method || 'BANK';

                // Create site group if it doesn't exist
                if (!bySiteThenBank[siteName]) {
                    bySiteThenBank[siteName] = {};
                }

                let bankKey, bankName, accountNo;
                if (paymentMethod === 'CASH') {
                    // CASH payment - use SITE bank details (to draw cash from)
                    if (site?.bank_name && site?.account_number) {
                        bankName = `${site.bank_name} (CASH)`;
                        accountNo = site.account_number;
                        bankKey = `${site.bank_name} - ${site.account_number} - CASH`;
                    } else {
                        // Fallback if site has no bank details
                        bankName = 'CASH TO DRAW';
                        accountNo = 'N/A';
                        bankKey = 'CASH TO DRAW';
                    }
                } else {
                    // BANK payment - use individual STAFF bank details (for direct deposit)
                    if (staff?.bank_name && staff?.bank_account) {
                        bankName = `${staff.bank_name} (EFT)`;
                        accountNo = staff.bank_account;
                        bankKey = `${staff.bank_name} - ${staff.bank_account} - EFT`;
                    } else {
                        // Fallback if staff has no bank details
                        bankName = 'CASH TO DRAW';
                        accountNo = 'N/A';
                        bankKey = 'CASH TO DRAW';
                    }
                }

                if (!bySiteThenBank[siteName][bankKey]) {
                    bySiteThenBank[siteName][bankKey] = {
                        bankName: bankName,
                        accountNo: accountNo,
                        totalNet: 0,
                        count: 0,
                        staffNames: []
                    };
                }

                bySiteThenBank[siteName][bankKey].totalNet += p.net_pay || 0;
                bySiteThenBank[siteName][bankKey].count += 1;
                bySiteThenBank[siteName][bankKey].staffNames.push(p.staff_name);
            });

            // Grand total
            html += `
                <div style="border: 3px solid #059669; border-radius: 8px; padding: 1.5rem; background: #ecfdf5;">
                    <h2 style="margin: 0 0 1rem 0; color: #059669;">GRAND TOTAL (All Sites)</h2>
                    <table style="width: 100%; border-collapse: collapse; font-size: 1.1rem;">
                        <thead>
                            <tr style="background: #059669; color: white;">
                                <th style="padding: 0.75rem; text-align: left; border: 1px solid #047857;">Description</th>
                                <th style="padding: 0.75rem; text-align: right; border: 1px solid #047857;">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="background: white;">
                                <td style="padding: 0.75rem; border: 1px solid #d1d5db; font-weight: 600;">Total Gross Pay</td>
                                <td style="padding: 0.75rem; text-align: right; border: 1px solid #d1d5db; font-weight: 700;">R${grandGross.toFixed(2)}</td>
                            </tr>
                            <tr style="background: #f8fafc;">
                                <td style="padding: 0.75rem; border: 1px solid #d1d5db; font-weight: 600;">Total Deductions</td>
                                <td style="padding: 0.75rem; text-align: right; border: 1px solid #d1d5db; font-weight: 700;">R${grandDeductions.toFixed(2)}</td>
                            </tr>
                            <tr style="background: #047857; color: white; font-size: 1.3rem;">
                                <td style="padding: 0.75rem; border: 1px solid #059669; font-weight: 700;">NETT PAYOUT</td>
                                <td style="padding: 0.75rem; text-align: right; border: 1px solid #059669; font-weight: 700;">R${grandNet.toFixed(2)}</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3 style="margin: 2rem 0 1rem 0; color: #059669;">BANK ACCOUNT BREAKDOWN BY SITE</h3>
                    ${Object.keys(bySiteThenBank).sort().map(siteName => {
                        const siteAccounts = bySiteThenBank[siteName];
                        return `
                            <h4 style="margin: 1.5rem 0 0.5rem 0; color: #0284c7;">${siteName}</h4>
                            <table style="width: 100%; border-collapse: collapse; font-size: 1rem; margin-bottom: 1.5rem;">
                                <thead>
                                    <tr style="background: #10b981; color: white;">
                                        <th style="padding: 0.75rem; text-align: left; border: 1px solid #047857;">Bank</th>
                                        <th style="padding: 0.75rem; text-align: left; border: 1px solid #047857;">Account Number</th>
                                        <th style="padding: 0.75rem; text-align: left; border: 1px solid #047857;">Staff Names</th>
                                        <th style="padding: 0.75rem; text-align: center; border: 1px solid #047857;">Staff Count</th>
                                        <th style="padding: 0.75rem; text-align: right; border: 1px solid #047857;">Total Nett Pay</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Object.keys(siteAccounts).sort().map((key, idx) => {
                                        const bank = siteAccounts[key];
                                        return `
                                            <tr style="background: ${idx % 2 === 0 ? 'white' : '#f0fdf4'};">
                                                <td style="padding: 0.75rem; border: 1px solid #d1d5db; font-weight: 600;">${bank.bankName}</td>
                                                <td style="padding: 0.75rem; border: 1px solid #d1d5db; font-family: monospace;">${bank.accountNo}</td>
                                                <td style="padding: 0.75rem; border: 1px solid #d1d5db;">${bank.staffNames.join(', ')}</td>
                                                <td style="padding: 0.75rem; text-align: center; border: 1px solid #d1d5db;">${bank.count}</td>
                                                <td style="padding: 0.75rem; text-align: right; border: 1px solid #d1d5db; font-weight: 700; font-size: 1.1rem;">R${bank.totalNet.toFixed(2)}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        `;
                    }).join('')}
                </div>
            `;

            document.getElementById('paymentSummaryContent').innerHTML = html;
            showModal('paymentSummaryModal');
        }

        function printPaymentSummary() {
            const periodInfo = document.getElementById('summaryPeriodInfo').textContent;

            // Group payslips by site (rebuild for print)
            const bySite = {};
            let grandGross = 0;
            let grandDeductions = 0;
            let grandNet = 0;

            currentPayslips.forEach(p => {
                const siteName = p.staff_site_name || 'No Site';
                if (!bySite[siteName]) {
                    bySite[siteName] = {
                        payslips: [],
                        totalGross: 0,
                        totalDeductions: 0,
                        totalNet: 0
                    };
                }

                bySite[siteName].payslips.push(p);
                bySite[siteName].totalGross += p.gross_pay || 0;
                bySite[siteName].totalDeductions += p.total_deductions || 0;
                bySite[siteName].totalNet += p.net_pay || 0;

                grandGross += p.gross_pay || 0;
                grandDeductions += p.total_deductions || 0;
                grandNet += p.net_pay || 0;
            });

            // Build HTML with page breaks between sites
            let printContent = '';

            // Each site gets its own page
            Object.keys(bySite).sort().forEach((siteName, index) => {
                const site = bySite[siteName];

                printContent += `
                    <div class="site-page">
                        <h1 style="text-align: center; color: #0284c7; margin-bottom: 0.25rem; font-size: 12pt;">WAGEPRO Payment Summary</h1>
                        <h2 style="text-align: center; color: #64748b; margin-top: 0; margin-bottom: 1rem; font-size: 10pt;">${periodInfo}</h2>
                        <h2 style="color: #0284c7; margin-bottom: 0.5rem; font-size: 10pt;">${siteName} (${site.payslips.length} staff)</h2>
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 1rem; font-size: 8pt;">
                            <thead>
                                <tr style="background: #0284c7; color: white;">
                                    <th style="padding: 0.3rem; text-align: left; border: 1px solid #0369a1;">Staff Member</th>
                                    <th style="padding: 0.3rem; text-align: right; border: 1px solid #0369a1;">Gross Pay</th>
                                    <th style="padding: 0.3rem; text-align: right; border: 1px solid #0369a1;">Deductions</th>
                                    <th style="padding: 0.3rem; text-align: right; border: 1px solid #0369a1;">Nett Pay</th>
                                    <th style="padding: 0.3rem; text-align: center; border: 1px solid #0369a1;">Payment</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${site.payslips.map((p, idx) => `
                                    <tr style="background: ${idx % 2 === 0 ? 'white' : '#f8fafc'};">
                                        <td style="padding: 0.2rem 0.3rem; border: 1px solid #475569;">${p.staff_name}</td>
                                        <td style="padding: 0.2rem 0.3rem; text-align: right; border: 1px solid #475569;">R${(p.gross_pay || 0).toFixed(2)}</td>
                                        <td style="padding: 0.2rem 0.3rem; text-align: right; border: 1px solid #475569;">R${(p.total_deductions || 0).toFixed(2)}</td>
                                        <td style="padding: 0.2rem 0.3rem; text-align: right; border: 1px solid #475569; font-weight: 600;">R${(p.net_pay || 0).toFixed(2)}</td>
                                        <td style="padding: 0.2rem 0.3rem; text-align: center; border: 1px solid #475569;"><span style="padding: 0.1rem 0.25rem; border-radius: 3px; font-weight: 600; font-size: 7pt; background: ${(p.payment_method || 'BANK') === 'CASH' ? '#fee2e2' : '#dbeafe'}; color: ${(p.payment_method || 'BANK') === 'CASH' ? '#991b1b' : '#1e40af'};">${p.payment_method || 'BANK'}</span></td>
                                    </tr>
                                `).join('')}
                                <tr style="background: #0c4a6e; color: white; font-weight: 700; font-size: 9pt;">
                                    <td style="padding: 0.3rem; border: 1px solid #0369a1;">SITE TOTAL</td>
                                    <td style="padding: 0.3rem; text-align: right; border: 1px solid #0369a1;">R${site.totalGross.toFixed(2)}</td>
                                    <td style="padding: 0.3rem; text-align: right; border: 1px solid #0369a1;">R${site.totalDeductions.toFixed(2)}</td>
                                    <td style="padding: 0.3rem; text-align: right; border: 1px solid #0369a1;" colspan="2">R${site.totalNet.toFixed(2)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            });

            // Grand total on its own page
            printContent += `
                <div class="summary-page">
                    <h1 style="text-align: center; color: #0284c7; margin-bottom: 0.25rem; font-size: 12pt;">WAGEPRO Payment Summary</h1>
                    <h2 style="text-align: center; color: #64748b; margin-top: 0; margin-bottom: 1rem; font-size: 10pt;">${periodInfo}</h2>
                    <h2 style="color: #059669; margin-bottom: 0.5rem; font-size: 10pt;">GRAND TOTAL (All Sites)</h2>
                    <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                        <thead>
                            <tr style="background: #059669; color: white;">
                                <th style="padding: 0.4rem; text-align: left; border: 1px solid #047857;">Description</th>
                                <th style="padding: 0.4rem; text-align: right; border: 1px solid #047857;">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="background: white;">
                                <td style="padding: 0.4rem; border: 1px solid #d1d5db; font-weight: 600;">Total Gross Pay</td>
                                <td style="padding: 0.4rem; text-align: right; border: 1px solid #d1d5db; font-weight: 700; font-size: 10pt;">R${grandGross.toFixed(2)}</td>
                            </tr>
                            <tr style="background: #f8fafc;">
                                <td style="padding: 0.4rem; border: 1px solid #d1d5db; font-weight: 600;">Total Deductions</td>
                                <td style="padding: 0.4rem; text-align: right; border: 1px solid #d1d5db; font-weight: 700; font-size: 10pt;">R${grandDeductions.toFixed(2)}</td>
                            </tr>
                            <tr style="background: #047857; color: white; font-size: 10pt;">
                                <td style="padding: 0.4rem; border: 1px solid #059669; font-weight: 700;">NETT PAYOUT</td>
                                <td style="padding: 0.4rem; text-align: right; border: 1px solid #059669; font-weight: 700; font-size: 11pt;">R${grandNet.toFixed(2)}</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3 style="margin: 1rem 0 0.5rem 0; color: #059669; font-size: 10pt;">BANK ACCOUNT BREAKDOWN BY SITE</h3>
                    ${(() => {
                        // Group by SITE first, then by bank account for payment totals
                        const bySiteThenBank = {};
                        currentPayslips.forEach(p => {
                            const staff = allStaff.find(s => s.id === p.staff_id);
                            const site = allSites.find(s => s.name === p.staff_site_name);
                            const siteName = p.staff_site_name || 'Unknown Site';
                            const paymentMethod = p.payment_method || 'BANK';

                            // Create site group if it doesn't exist
                            if (!bySiteThenBank[siteName]) {
                                bySiteThenBank[siteName] = {};
                            }

                            let bankKey, bankName, accountNo;
                            if (paymentMethod === 'CASH') {
                                // CASH payment - use SITE bank details (to draw cash from)
                                if (site?.bank_name && site?.account_number) {
                                    bankName = `${site.bank_name} (CASH)`;
                                    accountNo = site.account_number;
                                    bankKey = `${site.bank_name} - ${site.account_number} - CASH`;
                                } else {
                                    // Fallback if site has no bank details
                                    bankName = 'CASH TO DRAW';
                                    accountNo = 'N/A';
                                    bankKey = 'CASH TO DRAW';
                                }
                            } else {
                                // BANK payment - use individual STAFF bank details (for direct deposit)
                                if (staff?.bank_name && staff?.bank_account) {
                                    bankName = `${staff.bank_name} (EFT)`;
                                    accountNo = staff.bank_account;
                                    bankKey = `${staff.bank_name} - ${staff.bank_account} - EFT`;
                                } else {
                                    // Fallback if staff has no bank details
                                    bankName = 'CASH TO DRAW';
                                    accountNo = 'N/A';
                                    bankKey = 'CASH TO DRAW';
                                }
                            }

                            if (!bySiteThenBank[siteName][bankKey]) {
                                bySiteThenBank[siteName][bankKey] = {
                                    bankName: bankName,
                                    accountNo: accountNo,
                                    totalNet: 0,
                                    count: 0,
                                    staffNames: []
                                };
                            }

                            bySiteThenBank[siteName][bankKey].totalNet += p.net_pay || 0;
                            bySiteThenBank[siteName][bankKey].count += 1;
                            bySiteThenBank[siteName][bankKey].staffNames.push(p.staff_name);
                        });

                        return Object.keys(bySiteThenBank).sort().map(siteName => {
                            const siteAccounts = bySiteThenBank[siteName];

                            // Color-code sites: RUSPLAAS = purple, THE PADDOCK = orange
                            const siteColor = siteName.includes('RUSPLAAS') ? '#9333ea' :
                                            siteName.includes('PADDOCK') ? '#ea580c' : '#0284c7';
                            const siteBgColor = siteName.includes('RUSPLAAS') ? '#f3e8ff' :
                                              siteName.includes('PADDOCK') ? '#ffedd5' : '#f0f9ff';

                            return `
                                <h4 style="margin: 0.75rem 0 0.25rem 0; color: ${siteColor}; font-weight: 700; font-size: 9pt;">${siteName}</h4>
                                <table style="width: 100%; border-collapse: collapse; font-size: 7pt; margin-bottom: 0.75rem; border: 1px solid ${siteColor};">
                                    <thead>
                                        <tr style="background: ${siteColor}; color: white;">
                                            <th style="padding: 0.25rem; text-align: left; border: 1px solid #475569;">Bank</th>
                                            <th style="padding: 0.25rem; text-align: left; border: 1px solid #475569;">Account Number</th>
                                            <th style="padding: 0.25rem; text-align: left; border: 1px solid #475569;">Staff Names</th>
                                            <th style="padding: 0.25rem; text-align: center; border: 1px solid #475569;">Count</th>
                                            <th style="padding: 0.25rem; text-align: right; border: 1px solid #475569;">Total Nett</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${Object.keys(siteAccounts).sort().map((key, idx) => {
                                            const bank = siteAccounts[key];
                                            return `
                                                <tr style="background: ${idx % 2 === 0 ? 'white' : siteBgColor};">
                                                    <td style="padding: 0.2rem 0.25rem; border: 1px solid #475569; font-weight: 600;">${bank.bankName}</td>
                                                    <td style="padding: 0.2rem 0.25rem; border: 1px solid #475569; font-family: monospace;">${bank.accountNo}</td>
                                                    <td style="padding: 0.2rem 0.25rem; border: 1px solid #475569;">${bank.staffNames.join(', ')}</td>
                                                    <td style="padding: 0.2rem 0.25rem; text-align: center; border: 1px solid #475569;">${bank.count}</td>
                                                    <td style="padding: 0.2rem 0.25rem; text-align: right; border: 1px solid #475569; font-weight: 700; font-size: 8pt;">R${bank.totalNet.toFixed(2)}</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            `;
                        }).join('');
                    })()}

                    <p style="text-align: center; margin-top: 1.5rem; color: #64748b; font-style: italic; font-size: 7pt;">
                        Printed: ${new Date().toLocaleString('en-ZA')}
                    </p>
                </div>
            `;

            const printWindow = window.open('', '', 'width=900,height=700');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Payment Summary - ${periodInfo}</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            padding: 10px;
                            margin: 0;
                            font-size: 8pt;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                        }
                        th, td {
                            padding: 3px;
                            border: 1px solid #ddd;
                        }
                        h1, h2, h3 {
                            margin-top: 0;
                        }
                        .site-page {
                            page-break-after: always;
                            padding: 10px;
                        }
                        .summary-page {
                            padding: 10px;
                        }
                        @media print {
                            body { padding: 0; font-size: 8pt; }
                            .site-page {
                                padding: 15px;
                                page-break-after: always;
                            }
                            .summary-page {
                                padding: 15px;
                                page-break-after: avoid;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${printContent}
                    <script>
                        window.onload = function() {
                            window.print();
                            window.close();
                        };
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        let currentStaffHistoryData = null;  // Store full history data

        async function showStaffHistory(staffId, staffName) {
            // Set staff name in modal
            document.getElementById('historyStaffName').textContent = staffName;

            // Store staff ID for SMS log
            currentHistoryStaffId = staffId;

            // Reset to payslip tab
            switchHistoryTab('payslip');

            // Show modal with loading message
            showModal('staffHistoryModal');

            try {
                const response = await fetch(`/api/staff/${staffId}/payslip-history`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch staff history');
                }

                currentStaffHistoryData = await response.json();

                // Populate period dropdown
                const periodFilter = document.getElementById('historyPeriodFilter');
                periodFilter.innerHTML = '<option value="">All Periods</option>';
                const periods = currentStaffHistoryData.payslips.map(p => p.period);
                const uniquePeriods = [...new Set(periods)];
                uniquePeriods.forEach(period => {
                    const option = document.createElement('option');
                    option.value = period;
                    option.textContent = period;
                    periodFilter.appendChild(option);
                });

                // Render all periods initially
                renderStaffHistory(currentStaffHistoryData.payslips);

            } catch (error) {
                console.error('Error fetching staff history:', error);
                document.getElementById('staffHistoryContent').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #ef4444;">
                        <p>Failed to load staff history.</p>
                        <p style="font-size: 0.875rem;">${error.message}</p>
                    </div>
                `;
            }
        }

        function filterHistoryByPeriod() {
            const selectedPeriod = document.getElementById('historyPeriodFilter').value;
            if (!currentStaffHistoryData) return;

            let filteredPayslips = currentStaffHistoryData.payslips;
            if (selectedPeriod) {
                filteredPayslips = currentStaffHistoryData.payslips.filter(p => p.period === selectedPeriod);
            }

            renderStaffHistory(filteredPayslips);
        }

        function renderStaffHistory(payslips) {
            // Build history table
                let html = `
                    <div style="margin-bottom: 1rem; padding: 1rem; background: #f1f5f9; border-radius: 8px;">
                        <p style="margin: 0;"><strong>Staff:</strong> ${currentStaffHistoryData.staff_name}</p>
                        <p style="margin: 0.5rem 0 0 0;"><strong>Position:</strong> ${currentStaffHistoryData.staff_position || 'N/A'}</p>
                        <p style="margin: 0.5rem 0 0 0;"><strong>Site:</strong> ${currentStaffHistoryData.staff_site || 'N/A'}</p>
                        <p style="margin: 0.5rem 0 0 0;"><strong>Showing:</strong> ${payslips.length} of ${currentStaffHistoryData.payslips.length} payslips</p>
                    </div>

                    <div style="max-height: 500px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                            <thead style="background: #0284c7; color: white; position: sticky; top: 0;">
                                <tr>
                                    <th style="padding: 0.5rem; text-align: left; border: 1px solid #0369a1;">Period</th>
                                    <th style="padding: 0.5rem; text-align: right; border: 1px solid #0369a1;">Gross Pay</th>
                                    <th style="padding: 0.5rem; text-align: right; border: 1px solid #0369a1;">Deductions</th>
                                    <th style="padding: 0.5rem; text-align: right; border: 1px solid #0369a1;">Net Pay</th>
                                    <th style="padding: 0.5rem; text-align: center; border: 1px solid #0369a1;">Payment</th>
                                    <th style="padding: 0.5rem; text-align: center; border: 1px solid #0369a1;">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                if (payslips.length === 0) {
                    html += `
                        <tr>
                            <td colspan="6" style="padding: 2rem; text-align: center; color: #94a3b8;">
                                No payslip history found for the selected period.
                            </td>
                        </tr>
                    `;
                } else {
                    payslips.forEach((p, idx) => {
                        const statusBadge = p.is_paid
                            ? '<span style="padding: 0.25rem 0.5rem; background: #d1fae5; color: #065f46; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">PAID</span>'
                            : p.is_approved
                                ? '<span style="padding: 0.25rem 0.5rem; background: #dbeafe; color: #1e40af; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">APPROVED</span>'
                                : '<span style="padding: 0.25rem 0.5rem; background: #fef3c7; color: #92400e; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">PENDING</span>';

                        const paymentBadge = (p.payment_method || 'BANK') === 'CASH'
                            ? '<span style="padding: 0.25rem 0.5rem; background: #fee2e2; color: #991b1b; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">CASH</span>'
                            : '<span style="padding: 0.25rem 0.5rem; background: #dbeafe; color: #1e40af; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">BANK</span>';

                        // Build deductions tooltip
                        let deductionsDetail = 'Total Deductions: R' + (p.total_deductions || 0).toFixed(2);
                        if (p.loans && p.loans.length > 0) {
                            deductionsDetail += '\\n\\nLoans:';
                            p.loans.forEach(loan => {
                                deductionsDetail += `\\n  - ${loan.description}: R${loan.amount.toFixed(2)}`;
                            });
                        }

                        html += `
                            <tr style="background: ${idx % 2 === 0 ? 'white' : '#f8fafc'};">
                                <td style="padding: 0.5rem; border: 1px solid #e2e8f0;">
                                    <strong>${p.period}</strong><br>
                                    <span style="font-size: 0.75rem; color: #64748b;">${p.period_start} to ${p.period_end}</span>
                                </td>
                                <td style="padding: 0.5rem; text-align: right; border: 1px solid #e2e8f0;">
                                    <strong>R${(p.gross_pay || 0).toFixed(2)}</strong><br>
                                    <span style="font-size: 0.75rem; color: #64748b;">
                                        Weekday: R${(p.weekday_pay || 0).toFixed(2)}<br>
                                        Weekend: R${(p.weekend_pay || 0).toFixed(2)}<br>
                                        ${(p.overtime_pay || 0) > 0 ? 'OT: R' + (p.overtime_pay || 0).toFixed(2) + '<br>' : ''}
                                        ${(p.bonus || 0) > 0 ? 'Bonus: R' + (p.bonus || 0).toFixed(2) : ''}
                                    </span>
                                </td>
                                <td style="padding: 0.5rem; text-align: right; border: 1px solid #e2e8f0;" title="${deductionsDetail}">
                                    <strong>R${(p.total_deductions || 0).toFixed(2)}</strong><br>
                                    <span style="font-size: 0.75rem; color: #64748b;">
                                        ${p.loans && p.loans.length > 0 ? 'Loans: R' + (p.loan_deduction || 0).toFixed(2) + '<br>' : ''}
                                        ${(p.other_deductions || 0) > 0 ? 'Other: R' + (p.other_deductions || 0).toFixed(2) : ''}
                                    </span>
                                </td>
                                <td style="padding: 0.5rem; text-align: right; border: 1px solid #e2e8f0; font-weight: 700; color: #059669; font-size: 1rem;">
                                    R${(p.net_pay || 0).toFixed(2)}
                                </td>
                                <td style="padding: 0.5rem; text-align: center; border: 1px solid #e2e8f0;">
                                    ${paymentBadge}
                                </td>
                                <td style="padding: 0.5rem; text-align: center; border: 1px solid #e2e8f0;">
                                    ${statusBadge}
                                </td>
                            </tr>
                        `;
                    });
                }

                html += `
                            </tbody>
                        </table>
                    </div>
                `;

                document.getElementById('staffHistoryContent').innerHTML = html;
        }

        let currentHistoryStaffId = null;  // Track current staff ID for SMS log

        function switchHistoryTab(tab) {
            const tabPayslip = document.getElementById('tabPayslipHistory');
            const tabSms = document.getElementById('tabSmsLog');
            const payslipSection = document.getElementById('payslipHistorySection');
            const smsSection = document.getElementById('smsLogSection');

            if (tab === 'payslip') {
                tabPayslip.style.background = '#0284c7';
                tabPayslip.style.color = 'white';
                tabSms.style.background = '#f1f5f9';
                tabSms.style.color = '#64748b';
                payslipSection.style.display = 'block';
                smsSection.style.display = 'none';
            } else {
                tabPayslip.style.background = '#f1f5f9';
                tabPayslip.style.color = '#64748b';
                tabSms.style.background = '#0284c7';
                tabSms.style.color = 'white';
                payslipSection.style.display = 'none';
                smsSection.style.display = 'block';
                // Load SMS log when switching to that tab
                loadSmsLog();
            }
        }

        async function loadSmsLog() {
            if (!currentHistoryStaffId) return;

            const filterPeriod = document.getElementById('smsLogFilter').value;
            const contentDiv = document.getElementById('smsLogContent');

            contentDiv.innerHTML = '<div style="text-align: center; padding: 2rem; color: #94a3b8;">Loading SMS log...</div>';

            try {
                const response = await fetch(`/api/staff/${currentHistoryStaffId}/sms-history?period=${filterPeriod}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch SMS history');
                }

                const data = await response.json();

                // Update count display
                document.getElementById('smsLogCount').textContent = `(${data.sms_count} messages)`;

                if (data.sms_logs.length === 0) {
                    contentDiv.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #94a3b8; background: #f8fafc; border-radius: 8px;">
                            <p style="font-size: 2rem; margin-bottom: 0.5rem;">üì±</p>
                            <p style="margin: 0;">No SMS messages found for this period.</p>
                        </div>
                    `;
                    return;
                }

                // Build SMS log table
                let html = `
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                            <thead style="background: #7c3aed; color: white; position: sticky; top: 0;">
                                <tr>
                                    <th style="padding: 0.5rem; text-align: left; border: 1px solid #6d28d9;">Date/Time</th>
                                    <th style="padding: 0.5rem; text-align: left; border: 1px solid #6d28d9;">Type</th>
                                    <th style="padding: 0.5rem; text-align: left; border: 1px solid #6d28d9;">Message</th>
                                    <th style="padding: 0.5rem; text-align: center; border: 1px solid #6d28d9;">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                data.sms_logs.forEach((sms, idx) => {
                    // Get friendly type label
                    const typeLabels = {
                        'clockin_reminder': '‚è∞ Clock-In Reminder',
                        'clockout_reminder': 'üîî Clock-Out Reminder',
                        'location_check': 'üìç Location Check',
                        'signin_notification': '‚úÖ Sign-In Notice',
                        'signout_notification': 'üö™ Sign-Out Notice',
                        'bulk_message': 'üì¢ Announcement',
                        'no_work_day': 'üè† No Work Day',
                        'other': 'üì± Other'
                    };
                    const typeLabel = typeLabels[sms.sms_type] || 'üì± ' + sms.sms_type;

                    const statusBadge = sms.status === 'sent'
                        ? '<span style="padding: 0.25rem 0.5rem; background: #d1fae5; color: #065f46; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">SENT</span>'
                        : sms.status === 'failed'
                            ? '<span style="padding: 0.25rem 0.5rem; background: #fee2e2; color: #991b1b; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">FAILED</span>'
                            : '<span style="padding: 0.25rem 0.5rem; background: #fef3c7; color: #92400e; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">PENDING</span>';

                    html += `
                        <tr style="background: ${idx % 2 === 0 ? 'white' : '#f8fafc'};">
                            <td style="padding: 0.5rem; border: 1px solid #e2e8f0; white-space: nowrap;">
                                ${sms.sent_at || 'N/A'}
                            </td>
                            <td style="padding: 0.5rem; border: 1px solid #e2e8f0; white-space: nowrap;">
                                ${typeLabel}
                            </td>
                            <td style="padding: 0.5rem; border: 1px solid #e2e8f0; max-width: 400px; word-wrap: break-word;">
                                ${sms.message}
                            </td>
                            <td style="padding: 0.5rem; text-align: center; border: 1px solid #e2e8f0;">
                                ${statusBadge}
                            </td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;

                contentDiv.innerHTML = html;

            } catch (error) {
                console.error('Error fetching SMS history:', error);
                contentDiv.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #ef4444;">
                        <p>Failed to load SMS history.</p>
                        <p style="font-size: 0.875rem;">${error.message}</p>
                    </div>
                `;
            }
        }

        function editDays(payslipId, staffName) {
            const payslip = currentPayslips.find(p => p.id === payslipId);
            if (!payslip) return;

            document.getElementById('editDaysPayslipId').value = payslipId;
            document.getElementById('editDaysStaffName').textContent = staffName;

            // Calculate dates for the 14-day period
            const startDate = new Date(currentPayPeriod.start_date);
            const getDayDate = (dayIndex) => {
                const date = new Date(startDate);
                date.setDate(date.getDate() + dayIndex);
                return date.toISOString().split('T')[0]; // YYYY-MM-DD format
            };

            // Reorder days: Saturday to Friday (work week order)
            const days = ['Saturday', 'Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];

            // Build Week 1
            let week1Html = '';
            days.forEach((day, index) => {
                const fieldName = `w1_${day.toLowerCase()}`;
                const isWeekend = day === 'Saturday' || day === 'Sunday';
                const dateStr = getDayDate(index);
                // Convert float to dropdown value: 0.0->none, 0.5->half, 1.0->full
                const dayValue = payslip[fieldName] || 0;
                const currentValue = dayValue === 0 ? 'none' : (dayValue === 0.5 ? 'half' : 'full');

                week1Html += `
                    <div class="day-row ${isWeekend ? 'weekend' : ''}" style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; margin-bottom: 0.25rem; border-radius: 4px;">
                        <span style="font-weight: 500; flex: 1;">${day} <span style="color: #6b7280; font-weight: 400; font-size: 0.85rem;">(${dateStr})</span></span>
                        <select id="edit_${fieldName}" onchange="updateDaysSummary()" style="padding: 0.3rem 0.6rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem; min-width: 130px;">
                            <option value="none" ${currentValue === 'none' ? 'selected' : ''}>Not Worked</option>
                            <option value="half" ${currentValue === 'half' ? 'selected' : ''}>Half Day (0.5)</option>
                            <option value="full" ${currentValue === 'full' ? 'selected' : ''}>Full Day (1.0)</option>
                        </select>
                    </div>
                `;
            });

            // Build Week 2
            let week2Html = '';
            days.forEach((day, index) => {
                const fieldName = `w2_${day.toLowerCase()}`;
                const isWeekend = day === 'Saturday' || day === 'Sunday';
                const dateStr = getDayDate(index + 7); // Week 2 starts at day 7
                // Convert float to dropdown value: 0.0->none, 0.5->half, 1.0->full
                const dayValue = payslip[fieldName] || 0;
                const currentValue = dayValue === 0 ? 'none' : (dayValue === 0.5 ? 'half' : 'full');

                week2Html += `
                    <div class="day-row ${isWeekend ? 'weekend' : ''}" style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; margin-bottom: 0.25rem; border-radius: 4px;">
                        <span style="font-weight: 500; flex: 1;">${day} <span style="color: #6b7280; font-weight: 400; font-size: 0.85rem;">(${dateStr})</span></span>
                        <select id="edit_${fieldName}" onchange="updateDaysSummary()" style="padding: 0.3rem 0.6rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem; min-width: 130px;">
                            <option value="none" ${currentValue === 'none' ? 'selected' : ''}>Not Worked</option>
                            <option value="half" ${currentValue === 'half' ? 'selected' : ''}>Half Day (0.5)</option>
                            <option value="full" ${currentValue === 'full' ? 'selected' : ''}>Full Day (1.0)</option>
                        </select>
                    </div>
                `;
            });

            document.getElementById('week1Days').innerHTML = week1Html;
            document.getElementById('week2Days').innerHTML = week2Html;

            // Initialize summary
            updateDaysSummary();

            showModal('editDaysModal');
        }

        async function autoFillFromAttendance() {
            const payslipId = document.getElementById('editDaysPayslipId').value;
            if (!payslipId) {
                alert('No payslip selected');
                return;
            }

            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'Loading...';
            btn.disabled = true;

            try {
                const response = await fetch(`/api/payslips/${payslipId}/autofill`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Failed to auto-fill');
                }

                // Map numeric values to dropdown values
                const mapValue = (val) => {
                    if (val >= 1.0) return 'full';
                    if (val >= 0.5) return 'half';
                    return 'none';
                };

                // Update Week 1 dropdowns
                const w1Days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                w1Days.forEach(day => {
                    const key = `w1_${day}`;
                    const el = document.getElementById(`edit_${key}`);
                    if (el && result.days && result.days[key] !== undefined) {
                        el.value = mapValue(result.days[key]);
                    }
                });

                // Update Week 2 dropdowns
                const w2Days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                w2Days.forEach(day => {
                    const key = `w2_${day}`;
                    const el = document.getElementById(`edit_${key}`);
                    if (el && result.days && result.days[key] !== undefined) {
                        el.value = mapValue(result.days[key]);
                    }
                });

                // Refresh the summary
                updateDaysSummary();

                // Show success message
                const summary = result.summary || {};
                const totalDays = (summary.total_full_days || 0) + (summary.total_half_days || 0) * 0.5;
                alert(`Auto-filled from attendance!\n\nFull days: ${summary.total_full_days || 0}\nHalf days: ${summary.total_half_days || 0}\nLeave days: ${summary.leave_days || 0}\nNo attendance: ${summary.no_attendance_days || 0}\n\nTotal: ${totalDays} days`);

            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        function selectAllDays() {
            // Set all dropdowns to "Full Day"
            const allSelects = document.querySelectorAll('#editDaysForm select');
            allSelects.forEach(select => {
                select.value = 'full';
            });
            updateDaysSummary();
        }

        function clearAllDays() {
            // Set all dropdowns to "Not Worked"
            const allSelects = document.querySelectorAll('#editDaysForm select');
            allSelects.forEach(select => {
                select.value = 'none';
            });
            updateDaysSummary();
        }

        function updateDaysSummary() {
            // Count Week 1 days (with half-day support)
            const w1Weekdays = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
            const w1Weekends = ['saturday', 'sunday'];
            let w1WeekdayCount = 0;
            let w1WeekendCount = 0;

            w1Weekdays.forEach(day => {
                const value = document.getElementById(`edit_w1_${day}`)?.value;
                if (value === 'full') w1WeekdayCount += 1;
                if (value === 'half') w1WeekdayCount += 0.5;
            });
            w1Weekends.forEach(day => {
                const value = document.getElementById(`edit_w1_${day}`)?.value;
                if (value === 'full') w1WeekendCount += 1;
                if (value === 'half') w1WeekendCount += 0.5;
            });

            // Count Week 2 days (with half-day support)
            const w2Weekdays = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
            const w2Weekends = ['saturday', 'sunday'];
            let w2WeekdayCount = 0;
            let w2WeekendCount = 0;

            w2Weekdays.forEach(day => {
                const value = document.getElementById(`edit_w2_${day}`)?.value;
                if (value === 'full') w2WeekdayCount += 1;
                if (value === 'half') w2WeekdayCount += 0.5;
            });
            w2Weekends.forEach(day => {
                const value = document.getElementById(`edit_w2_${day}`)?.value;
                if (value === 'full') w2WeekendCount += 1;
                if (value === 'half') w2WeekendCount += 0.5;
            });

            // Calculate multipliers (3+ weekdays = 1.5x, else 1.0x)
            const w1Multiplier = w1WeekdayCount >= 3 ? 1.5 : 1.0;
            const w2Multiplier = w2WeekdayCount >= 3 ? 1.5 : 1.0;

            // Update display (show decimals if half days present)
            document.getElementById('w1WeekdayCount').textContent = w1WeekdayCount % 1 === 0 ? w1WeekdayCount : w1WeekdayCount.toFixed(1);
            document.getElementById('w2WeekdayCount').textContent = w2WeekdayCount % 1 === 0 ? w2WeekdayCount : w2WeekdayCount.toFixed(1);
            document.getElementById('w1WeekendCount').textContent = w1WeekendCount % 1 === 0 ? w1WeekendCount : w1WeekendCount.toFixed(1);
            document.getElementById('w2WeekendCount').textContent = w2WeekendCount % 1 === 0 ? w2WeekendCount : w2WeekendCount.toFixed(1);

            document.getElementById('w1Rate').textContent = w1WeekendCount > 0 ? `(${w1Multiplier}x)` : '';
            document.getElementById('w2Rate').textContent = w2WeekendCount > 0 ? `(${w2Multiplier}x)` : '';

            document.getElementById('week1Multiplier').textContent = w1WeekendCount > 0 ? `Weekend Rate: ${w1Multiplier}x` : '';
            document.getElementById('week2Multiplier').textContent = w2WeekendCount > 0 ? `Weekend Rate: ${w2Multiplier}x` : '';
        }

        document.getElementById('editDaysForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const payslipId = document.getElementById('editDaysPayslipId').value;

            // Convert dropdown values to decimal: none->0.0, half->0.5, full->1.0
            const getValue = (id) => {
                const val = document.getElementById(id)?.value;
                if (val === 'none') return 0.0;
                if (val === 'half') return 0.5;
                if (val === 'full') return 1.0;
                return 0.0;  // Default to not worked
            };

            const data = {
                w1_monday: getValue('edit_w1_monday'),
                w1_tuesday: getValue('edit_w1_tuesday'),
                w1_wednesday: getValue('edit_w1_wednesday'),
                w1_thursday: getValue('edit_w1_thursday'),
                w1_friday: getValue('edit_w1_friday'),
                w1_saturday: getValue('edit_w1_saturday'),
                w1_sunday: getValue('edit_w1_sunday'),
                w2_monday: getValue('edit_w2_monday'),
                w2_tuesday: getValue('edit_w2_tuesday'),
                w2_wednesday: getValue('edit_w2_wednesday'),
                w2_thursday: getValue('edit_w2_thursday'),
                w2_friday: getValue('edit_w2_friday'),
                w2_saturday: getValue('edit_w2_saturday'),
                w2_sunday: getValue('edit_w2_sunday')
            };

            const response = await apiCall(`/api/payslips/${payslipId}`, {
                method: 'PUT',
                body: JSON.stringify(data)
            });

            if (response.ok) {
                closeModal('editDaysModal');
                loadPayslips();
            }
        });

        // ===== LOANS =====
        // (manageLoans function moved to line 3014 - removed duplicate)

        function showAddLoanForm() {
            const staffId = document.getElementById('loansStaffId').value;
            document.getElementById('loanStaffId').value = staffId;
            document.getElementById('addLoanForm').reset();

            // Set default dates
            document.getElementById('loanDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('loanStartDate').value = new Date().toISOString().split('T')[0];

            showModal('addLoanModal');
        }

        document.getElementById('addLoanForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                staff_id: document.getElementById('loanStaffId').value,
                description: document.getElementById('loanDescription').value,
                total_amount: document.getElementById('loanTotalAmount').value,
                installment_amount: document.getElementById('loanInstallment').value,
                loan_date: document.getElementById('loanDate').value,
                start_deduction_date: document.getElementById('loanStartDate').value
            };

            const response = await apiCall('/api/loans', {
                method: 'POST',
                body: JSON.stringify(data)
            });

            if (response.ok) {
                // Reset form for next entry
                document.getElementById('addLoanForm').reset();
                // Set default dates again
                document.getElementById('loanDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('loanStartDate').value = new Date().toISOString().split('T')[0];

                // Refresh loans display without closing modal
                const staffId = document.getElementById('loansStaffId').value;
                const staffName = document.getElementById('loansModalTitle').textContent.replace('Loans - ', '');

                // Reload loans list in background
                const loansResponse = await apiCall(`/api/loans?staff_id=${staffId}`);
                const loans = await loansResponse.json();

                const container = document.getElementById('loansContainer');
                if (loans.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #6b7280;">No loans found</p>';
                } else {
                    container.innerHTML = loans.map(loan => `
                        <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between;">
                                <div>
                                    <strong>${loan.description}</strong>
                                    <div style="font-size: 0.9rem; color: #6b7280;">
                                        Total: R${loan.total_amount.toFixed(2)} |
                                        Paid: R${loan.amount_paid.toFixed(2)} |
                                        Remaining: R${loan.amount_remaining.toFixed(2)}
                                    </div>
                                    <div style="font-size: 0.9rem; color: #6b7280;">
                                        Installment: R${loan.installment_amount.toFixed(2)}
                                    </div>
                                </div>
                                <div>
                                    <span style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; ${loan.is_active ? 'background: #d1fae5; color: #065f46;' : 'background: #fee2e2; color: #991b1b;'}">
                                        ${loan.is_active ? 'Active' : 'Completed'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }

                // Close the add loan modal
                closeModal('addLoanModal');

                // Update the main loans modal list
                const loansListResponse = await apiCall(`/api/loans?staff_id=${staffId}`);
                const updatedLoans = await loansListResponse.json();

                const mainContainer = document.getElementById('loansContainer');
                if (updatedLoans.length === 0) {
                    mainContainer.innerHTML = '<p style="text-align: center; color: #6b7280;">No loans found</p>';
                } else {
                    mainContainer.innerHTML = updatedLoans.map(loan => `
                        <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between;">
                                <div>
                                    <strong>${loan.description}</strong>
                                    <div style="font-size: 0.9rem; color: #6b7280;">
                                        Total: R${loan.total_amount.toFixed(2)} |
                                        Paid: R${loan.amount_paid.toFixed(2)} |
                                        Remaining: R${loan.amount_remaining.toFixed(2)}
                                    </div>
                                    <div style="font-size: 0.9rem; color: #6b7280;">
                                        Installment: R${loan.installment_amount.toFixed(2)}
                                    </div>
                                </div>
                                <div>
                                    <span style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; ${loan.is_active ? 'background: #d1fae5; color: #065f46;' : 'background: #fee2e2; color: #991b1b;'}">
                                        ${loan.is_active ? 'Active' : 'Completed'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }

                alert('‚úÖ Loan created successfully!');

                // Automatically reopen the add loan form for the next entry
                showAddLoanForm();
            }
        });

        // ===== DEDUCTIONS =====
        async function manageDeductions(staffId, staffName) {
            document.getElementById('deductionsStaffId').value = staffId;
            document.getElementById('deductionsModalTitle').textContent = `Deductions - ${staffName}`;

            const response = await apiCall(`/api/deductions?staff_id=${staffId}`);
            const deductions = await response.json();

            const container = document.getElementById('deductionsContainer');

            if (deductions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280;">No deductions found</p>';
            } else {
                container.innerHTML = deductions.map(d => `
                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between;">
                            <div>
                                <strong>${d.description}</strong>
                                <div style="font-size: 0.9rem; color: #6b7280;">
                                    ${d.deduction_type === 'percentage' ? `${d.percentage}% of gross pay` : `R${d.fixed_amount.toFixed(2)} fixed`}
                                    ${d.deduction_type === 'once_off' ? ' (Once Off)' : ''}
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-small ${d.is_active ? 'btn-secondary' : 'btn-primary'}"
                                        onclick="toggleDeduction(${d.id})">
                                    ${d.is_active ? 'Deactivate' : 'Activate'}
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            showModal('deductionsModal');
        }

        function showAddDeductionForm() {
            const staffId = document.getElementById('deductionsStaffId').value;
            document.getElementById('deductionStaffId').value = staffId;
            document.getElementById('addDeductionForm').reset();
            toggleDeductionFields();
            showModal('addDeductionModal');
        }

        function toggleDeductionFields() {
            const type = document.getElementById('deductionType').value;
            const fixedGroup = document.getElementById('fixedAmountGroup');
            const percentageGroup = document.getElementById('percentageGroup');

            if (type === 'percentage') {
                fixedGroup.classList.add('hidden');
                percentageGroup.classList.remove('hidden');
            } else {
                fixedGroup.classList.remove('hidden');
                percentageGroup.classList.add('hidden');
            }
        }

        document.getElementById('addDeductionForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const type = document.getElementById('deductionType').value;
            const data = {
                staff_id: document.getElementById('deductionStaffId').value,
                description: document.getElementById('deductionDescription').value,
                deduction_type: type,
                percentage: type === 'percentage' ? document.getElementById('deductionPercentage').value : null,
                fixed_amount: type !== 'percentage' ? document.getElementById('deductionFixed').value : null
            };

            const response = await apiCall('/api/deductions', {
                method: 'POST',
                body: JSON.stringify(data)
            });

            if (response.ok) {
                closeModal('addDeductionModal');
                // Refresh deductions display
                const staffId = document.getElementById('deductionsStaffId').value;
                const staffName = document.getElementById('deductionsModalTitle').textContent.replace('Deductions - ', '');
                manageDeductions(staffId, staffName);
            }
        });

        async function toggleDeduction(deductionId) {
            const response = await apiCall(`/api/deductions/${deductionId}/toggle`, {
                method: 'POST'
            });

            if (response.ok) {
                // Refresh deductions display
                const staffId = document.getElementById('deductionsStaffId').value;
                const staffName = document.getElementById('deductionsModalTitle').textContent.replace('Deductions - ', '');
                manageDeductions(staffId, staffName);
            }
        }

        // ===== BIOMETRICS =====
        function openBiometrics(staffId) {
            // Find staff in allStaff array
            const staff = allStaff.find(s => s.id === staffId);
            if (!staff) {
                alert('Staff not found');
                return;
            }

            const staffName = staff.full_name;
            const faceEnrolled = staff.face_enrolled || false;
            const faceEnrolledAt = staff.face_enrolled_at;
            const gpsExempt = staff.gps_exempt || false;

            document.getElementById('biometricsStaffId').value = staffId;
            document.getElementById('biometricsModalTitle').textContent = 'Biometrics - ' + staffName;

            const enrolledDate = faceEnrolledAt ? new Date(faceEnrolledAt).toLocaleDateString('en-ZA', {
                year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
            }) : null;

            const content = document.getElementById('biometricsContent');

            let html = '<div style="margin-bottom: 1.5rem;">';
            html += '<h3 style="margin-bottom: 1rem; color: #374151;">Face Recognition</h3>';
            html += '<div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: ' + (faceEnrolled ? '#ecfdf5' : '#fef3c7') + '; border-radius: 8px; margin-bottom: 1rem;">';
            html += '<div style="font-size: 2rem;">' + (faceEnrolled ? '‚úÖ' : '‚ö†Ô∏è') + '</div>';
            html += '<div>';
            html += '<div style="font-weight: 600; color: ' + (faceEnrolled ? '#047857' : '#92400e') + ';">';
            html += faceEnrolled ? 'Face Enrolled' : 'Not Enrolled';
            html += '</div>';
            if (faceEnrolled) {
                html += '<div style="font-size: 0.9rem; color: #6b7280;">Enrolled: ' + enrolledDate + '</div>';
            } else {
                html += '<div style="font-size: 0.9rem; color: #6b7280;">Face not yet registered</div>';
            }
            html += '</div></div>';
            html += '<div style="display: flex; gap: 0.5rem;">';
            html += '<a href="/face-enroll?staff=' + staffId + '" target="_blank" class="btn btn-primary" style="flex: 1; text-align: center; text-decoration: none;">';
            html += faceEnrolled ? 'Re-Enroll Face' : 'Enroll Face';
            html += '</a>';
            if (faceEnrolled) {
                html += '<button class="btn btn-secondary" style="background: #dc2626;" onclick="unenrollFace(' + staffId + ')">Remove</button>';
            }
            html += '</div></div>';

            html += '<div>';
            html += '<h3 style="margin-bottom: 1rem; color: #374151;">GPS Settings</h3>';
            html += '<div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: ' + (gpsExempt ? '#dbeafe' : '#f3f4f6') + '; border-radius: 8px;">';
            html += '<div style="font-size: 2rem;">' + (gpsExempt ? 'üåê' : 'üìç') + '</div>';
            html += '<div style="flex: 1;">';
            html += '<div style="font-weight: 600; color: ' + (gpsExempt ? '#1d4ed8' : '#374151') + ';">';
            html += gpsExempt ? 'GPS Exempt' : 'GPS Required';
            html += '</div>';
            html += '<div style="font-size: 0.9rem; color: #6b7280;">';
            html += gpsExempt ? 'Can clock in from any location' : 'Must be at assigned site to clock in';
            html += '</div></div></div></div>';

            content.innerHTML = html;
            showModal('biometricsModal');
        }

        async function unenrollFace(staffId) {
            const staff = allStaff.find(s => s.id === staffId);
            const staffName = staff ? staff.full_name : 'this staff member';
            if (!confirm('Remove face enrollment for ' + staffName + '?')) return;

            const response = await apiCall(`/api/kiosk/unenroll/${staffId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                alert('Face enrollment removed');
                closeModal('biometricsModal');
                loadStaff(); // Refresh staff list
            } else {
                const error = await response.json();
                alert('Error: ' + (error.error || 'Failed to remove enrollment'));
            }
        }

        // ===== LOANS =====
        async function manageLoans(staffId, staffName) {
            try {
                const response = await apiCall(`/api/loans/staff/${staffId}`);
                const loanData = await response.json();

                // Show loan management modal
                document.getElementById('loanStaffName').textContent = staffName;
                document.getElementById('loanStaffId').value = staffId;

                // Display summary
                document.getElementById('loanCurrentBalance').textContent = `R${loanData.summary.current_balance.toFixed(2)}`;
                document.getElementById('loanTotalBorrowed').textContent = `R${loanData.summary.total_borrowed.toFixed(2)}`;
                document.getElementById('loanTotalRepaid').textContent = `R${loanData.summary.total_repaid.toFixed(2)}`;
                document.getElementById('loanMaxAmount').textContent = `R${(loanData.summary.max_loan_amount || 0).toFixed(2)}`;
                document.getElementById('loanActiveCount').textContent = loanData.summary.active_loans_count;
                document.getElementById('loanNextDeduction').textContent = `R${loanData.summary.next_deduction.toFixed(2)}`;

                // Display active loans
                const activeLoansContainer = document.getElementById('activeLoansContainer');
                if (loanData.active_loans.length === 0) {
                    activeLoansContainer.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 1rem;">No active loans</p>';
                } else {
                    activeLoansContainer.innerHTML = loanData.active_loans.map(loan => `
                        <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 0.5rem;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 0.5rem;">${loan.description}</div>
                                    <div style="font-size: 0.875rem; color: #6b7280;">
                                        Started: ${formatDateDMY(loan.loan_date)}
                                    </div>
                                    <div style="font-size: 0.875rem; color: #6b7280;">
                                        Installment: R${loan.installment_amount.toFixed(2)}/period
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 0.875rem; color: #6b7280;">Remaining</div>
                                    <div style="font-size: 1.25rem; font-weight: 700; color: #ef4444;">R${loan.amount_remaining.toFixed(2)}</div>
                                    <div style="font-size: 0.875rem; color: #059669;">R${loan.amount_paid.toFixed(2)} paid</div>
                                </div>
                            </div>
                            <div style="margin-top: 0.5rem;">
                                <div style="background: #e5e7eb; height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div style="background: #059669; height: 100%; width: ${loan.progress_percentage}%;"></div>
                                </div>
                                <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                                    ${loan.payments_made} of ${loan.total_installments} payments (${loan.progress_percentage.toFixed(0)}%)
                                </div>
                            </div>
                        </div>
                    `).join('');
                }

                // Display transaction history
                const transactionsContainer = document.getElementById('loanTransactionsContainer');
                if (loanData.recent_transactions.length === 0) {
                    transactionsContainer.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 1rem;">No transactions</p>';
                } else {
                    transactionsContainer.innerHTML = `
                        <table style="width: 100%; font-size: 0.875rem;">
                            <thead>
                                <tr style="border-bottom: 2px solid #e5e7eb;">
                                    <th style="text-align: left; padding: 0.5rem; color: #6b7280;">Date</th>
                                    <th style="text-align: left; padding: 0.5rem; color: #6b7280;">Type</th>
                                    <th style="text-align: left; padding: 0.5rem; color: #6b7280;">Description</th>
                                    <th style="text-align: right; padding: 0.5rem; color: #6b7280;">Amount</th>
                                    <th style="text-align: right; padding: 0.5rem; color: #6b7280;">Balance</th>
                                    <th style="text-align: center; padding: 0.5rem; color: #6b7280;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${loanData.recent_transactions.map(txn => `
                                    <tr style="border-bottom: 1px solid #f3f4f6;">
                                        <td style="padding: 0.5rem;">${formatDateDMY(txn.transaction_date)}</td>
                                        <td style="padding: 0.5rem;">
                                            <span style="background: ${txn.transaction_type === 'disbursement' ? '#fef3c7' : '#d1fae5'}; color: ${txn.transaction_type === 'disbursement' ? '#92400e' : '#065f46'}; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">
                                                ${txn.transaction_type.toUpperCase()}
                                            </span>
                                        </td>
                                        <td style="padding: 0.5rem;">${txn.description}</td>
                                        <td style="padding: 0.5rem; text-align: right; font-weight: 600; color: ${txn.transaction_type === 'disbursement' ? '#ef4444' : '#059669'};">
                                            ${txn.transaction_type === 'disbursement' ? '+' : '-'}R${txn.amount.toFixed(2)}
                                        </td>
                                        <td style="padding: 0.5rem; text-align: right;">R${txn.balance_after.toFixed(2)}</td>
                                        <td style="padding: 0.5rem; text-align: center;">
                                            <button onclick="deleteLoanTransaction(${txn.id}, ${txn.loan_id})" style="background: #dc2626; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;" title="Delete">X</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }

                showModal('manageLoansModal');
            } catch (error) {
                alert('Error loading loan data: ' + error.message);
            }
        }

        // Delete loan transaction
        async function deleteLoanTransaction(transactionId, loanId) {
            if (!confirm('Are you sure you want to delete this transaction? This will recalculate the loan balance.')) {
                return;
            }

            try {
                const response = await fetch(`/api/loans/transactions/${transactionId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete transaction');
                }

                // Refresh the loans modal
                const staffId = document.getElementById('loanStaffId').value;
                const staffName = document.getElementById('loanStaffName').textContent;
                manageLoans(staffId, staffName);

                // Also refresh payslips
                loadPayslips();
            } catch (error) {
                alert('Error deleting transaction: ' + error.message);
            }
        }

        // Show new loan modal
        function showNewLoanModal() {
            const staffId = document.getElementById('loanStaffId').value;
            const staffName = document.getElementById('loanStaffName').textContent;
            document.getElementById('newLoanStaffName').textContent = staffName;
            document.getElementById('newLoanForm').reset();

            // Set default start date to today
            document.getElementById('newLoanStartDate').valueAsDate = new Date();

            document.getElementById('manageLoansModal').classList.remove('active');
            document.getElementById('newLoanModal').classList.add('active');
        }

        // Handle new loan form submission
        document.getElementById('newLoanForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const staffId = document.getElementById('loanStaffId').value;
            const description = document.getElementById('newLoanDescription').value;
            const totalAmount = parseFloat(document.getElementById('newLoanAmount').value);
            const installmentAmount = parseFloat(document.getElementById('newLoanInstallment').value);
            const startDate = document.getElementById('newLoanStartDate').value;
            const notes = document.getElementById('newLoanNotes').value;

            // Validation
            if (installmentAmount > totalAmount) {
                alert('Installment amount cannot exceed total amount!');
                return;
            }

            // Check max loan amount
            const maxLoanAmount = parseFloat(document.getElementById('loanMaxAmount').textContent.replace('R', ''));
            const currentBalance = parseFloat(document.getElementById('loanCurrentBalance').textContent.replace('R', ''));
            const totalOutstanding = currentBalance + totalAmount;

            if (maxLoanAmount > 0 && totalOutstanding > maxLoanAmount) {
                const proceed = confirm(
                    `WARNING: Total outstanding loans (R${totalOutstanding.toFixed(2)}) will exceed max loan amount (R${maxLoanAmount.toFixed(2)})!\n\n` +
                    `Current balance: R${currentBalance.toFixed(2)}\n` +
                    `New loan: R${totalAmount.toFixed(2)}\n\n` +
                    `Do you want to proceed anyway?`
                );
                if (!proceed) {
                    return;
                }
            }

            try {
                await apiCall('/api/loans', {
                    method: 'POST',
                    body: JSON.stringify({
                        staff_id: parseInt(staffId),
                        description,
                        total_amount: totalAmount,
                        installment_amount: installmentAmount,
                        start_deduction_date: startDate,
                        notes
                    })
                });

                alert('Loan created successfully!');
                closeModal('newLoanModal');

                // Refresh loans display
                const staffName = document.getElementById('loanStaffName').textContent;
                manageLoans(staffId, staffName);
            } catch (error) {
                alert('Error creating loan: ' + error.message);
            }
        });

        // Show manual repayment modal
        async function showManualRepaymentModal() {
            const staffId = document.getElementById('loanStaffId').value;

            try {
                // Populate loan dropdown with active loans
                const response = await apiCall(`/api/loans/staff/${staffId}`);
                const loanData = await response.json();
                const loanSelect = document.getElementById('repaymentLoanId');
                loanSelect.innerHTML = '<option value="">-- Select Loan --</option>';

                const activeLoans = loanData.active_loans || [];
                if (activeLoans.length === 0) {
                    alert('No active loans to repay');
                    return;
                }

                activeLoans.forEach(loan => {
                    loanSelect.innerHTML += `
                        <option value="${loan.id}">
                            ${loan.description} - R${loan.amount_remaining.toFixed(2)} remaining
                        </option>
                    `;
                });

                document.getElementById('manualRepaymentForm').reset();
                closeModal('manageLoansModal');
                showModal('manualRepaymentModal');
            } catch (error) {
                console.error('Error loading loans:', error);
                alert('Error loading loans: ' + error.message);
            }
        }

        // Handle manual repayment form submission
        document.getElementById('manualRepaymentForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const loanId = document.getElementById('repaymentLoanId').value;
            const amount = parseFloat(document.getElementById('repaymentAmount').value);
            const notes = document.getElementById('repaymentNotes').value;

            try {
                await apiCall(`/api/loans/${loanId}/repayment`, {
                    method: 'POST',
                    body: JSON.stringify({
                        amount,
                        notes
                    })
                });

                alert('Repayment recorded successfully!');
                closeModal('manualRepaymentModal');

                // Refresh loans display
                const staffId = document.getElementById('loanStaffId').value;
                const staffName = document.getElementById('loanStaffName').textContent;
                manageLoans(staffId, staffName);
            } catch (error) {
                alert('Error recording repayment: ' + error.message);
            }
        });

        // ===== SAVINGS =====
        async function manageSavings(staffId, staffName) {
            document.getElementById('savingsStaffId').value = staffId;
            document.getElementById('savingsModalTitle').textContent = `Savings - ${staffName}`;

            const response = await apiCall(`/api/savings/staff/${staffId}`);
            const data = await response.json();

            // Display current balance
            const balance = data.account ? data.account.total_balance : 0;
            document.getElementById('currentBalance').textContent = `R ${balance.toFixed(2)}`;

            // Display transactions
            const container = document.getElementById('savingsTransactionsContainer');

            if (data.transactions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280;">No transactions yet</p>';
            } else {
                container.innerHTML = data.transactions.map(t => `
                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span class="badge ${t.transaction_type === 'deposit' ? 'badge-success' : 'badge-warning'}">
                                        ${t.transaction_type.toUpperCase()}
                                    </span>
                                    <span style="font-weight: 600; font-size: 1.1rem;">R ${t.amount.toFixed(2)}</span>
                                </div>
                                <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">
                                    ${t.description || ''}
                                </div>
                                <div style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.25rem;">
                                    ${formatDateDMY(t.transaction_date)} - Balance after: R${t.balance_after.toFixed(2)}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            showModal('savingsModal');
        }

        function showAddSavingsTransaction(type) {
            const staffId = document.getElementById('savingsStaffId').value;
            document.getElementById('savingsTransactionStaffId').value = staffId;
            document.getElementById('savingsTransactionType').value = type;
            document.getElementById('savingsTransactionTitle').textContent = type === 'deposit' ? 'Deposit Savings' : 'Withdraw Savings';
            document.getElementById('addSavingsTransactionForm').reset();
            showModal('addSavingsTransactionModal');
        }

        document.getElementById('addSavingsTransactionForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                staff_id: parseInt(document.getElementById('savingsTransactionStaffId').value),
                transaction_type: document.getElementById('savingsTransactionType').value,
                amount: parseFloat(document.getElementById('savingsAmount').value),
                description: document.getElementById('savingsDescription').value
            };

            const response = await apiCall('/api/savings', {
                method: 'POST',
                body: JSON.stringify(data)
            });

            if (response.ok) {
                closeModal('addSavingsTransactionModal');
                // Refresh savings display
                const staffId = document.getElementById('savingsStaffId').value;
                const staffName = document.getElementById('savingsModalTitle').textContent.replace('Savings - ', '');
                manageSavings(staffId, staffName);
            }
        });

        // ===== USERS MANAGEMENT =====
        async function loadUsers() {
            const response = await apiCall('/api/users');
            const users = await response.json();

            const tbody = document.getElementById('usersTableBody');

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No users found</td></tr>';
            } else {
                tbody.innerHTML = users.map(u => `
                    <tr>
                        <td>${u.username}</td>
                        <td>${u.full_name}</td>
                        <td>${u.email || '-'}</td>
                        <td><span class="badge badge-info">${u.role.toUpperCase()}</span></td>
                        <td><span class="badge ${u.is_active ? 'badge-success' : 'badge-danger'}">${u.is_active ? 'Active' : 'Inactive'}</span></td>
                        <td>${u.last_login ? new Date(u.last_login).toLocaleString() : 'Never'}</td>
                        <td>
                            <button class="btn btn-small btn-secondary" onclick="showEditUserModal(${u.id}, '${u.username}', '${u.full_name}', '${u.email || ''}', '${u.role}')">Edit</button>
                            <button class="btn btn-small btn-secondary" onclick="showChangePasswordModal(${u.id})">Change PW</button>
                            <button class="btn btn-small ${u.is_active ? 'btn-warning' : 'btn-success'}" onclick="toggleUserActive(${u.id})">
                                ${u.is_active ? 'Deactivate' : 'Activate'}
                            </button>
                        </td>
                    </tr>
                `).join('');
            }
        }

        function showAddUserModal() {
            document.getElementById('addUserForm').reset();
            showModal('addUserModal');
        }

        function showEditUserModal(id, username, fullName, email, role) {
            document.getElementById('editUserId').value = id;
            document.getElementById('editUserUsername').value = username;
            document.getElementById('editUserFullName').value = fullName;
            document.getElementById('editUserEmail').value = email;
            document.getElementById('editUserRole').value = role;
            showModal('editUserModal');
        }

        function showChangePasswordModal(userId) {
            document.getElementById('passwordUserId').value = userId;
            document.getElementById('changePasswordForm').reset();
            showModal('changePasswordModal');
        }

        document.getElementById('addUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                username: document.getElementById('userUsername').value,
                password: document.getElementById('userPassword').value,
                full_name: document.getElementById('userFullName').value,
                email: document.getElementById('userEmail').value || null,
                role: document.getElementById('userRole').value
            };

            const response = await apiCall('/api/users', {
                method: 'POST',
                body: JSON.stringify(data)
            });

            if (response.ok) {
                closeModal('addUserModal');
                loadUsers();
            }
        });

        document.getElementById('editUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const userId = document.getElementById('editUserId').value;
            const data = {
                username: document.getElementById('editUserUsername').value,
                full_name: document.getElementById('editUserFullName').value,
                email: document.getElementById('editUserEmail').value || null,
                role: document.getElementById('editUserRole').value
            };

            const response = await apiCall(`/api/users/${userId}`, {
                method: 'PUT',
                body: JSON.stringify(data)
            });

            if (response.ok) {
                closeModal('editUserModal');
                loadUsers();
            }
        });

        document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                alert('Passwords do not match!');
                return;
            }

            const userId = document.getElementById('passwordUserId').value;
            const data = { new_password: newPassword };

            const response = await apiCall(`/api/users/${userId}/change-password`, {
                method: 'POST',
                body: JSON.stringify(data)
            });

            if (response.ok) {
                closeModal('changePasswordModal');
                alert('Password changed successfully');
            }
        });

        async function toggleUserActive(userId) {
            const response = await apiCall(`/api/users/${userId}/toggle-active`, {
                method: 'POST'
            });

            if (response.ok) {
                loadUsers();
            }
        }

        // ===== SITES MANAGEMENT (UPDATE) =====
        function showEditSiteModal(siteId) {
            // Find the site from allSites array
            const site = allSites.find(s => s.id === siteId);
            if (!site) {
                alert('Site not found');
                return;
            }

            document.getElementById('editSiteId').value = site.id;
            document.getElementById('editSiteName').value = site.name;
            document.getElementById('editSiteCode').value = site.code || '';
            document.getElementById('editSiteDescription').value = site.description || '';
            document.getElementById('editSiteAddress').value = site.address || '';
            document.getElementById('editSiteBankName').value = site.bank_name || '';
            document.getElementById('editSiteAccountNumber').value = site.account_number || '';
            document.getElementById('editSiteLatitude').value = site.gps_latitude || '';
            document.getElementById('editSiteLongitude').value = site.gps_longitude || '';
            document.getElementById('editSiteRadius').value = site.gps_radius_meters || 100;

            // Populate standby staff dropdown with staff from this site
            const standbySelect = document.getElementById('editSiteStandbyStaff');
            const siteStaff = allStaff.filter(s => s.is_active && s.site_id === siteId);
            standbySelect.innerHTML = '<option value="">None (no standby for this site)</option>' +
                siteStaff.map(s => `<option value="${s.id}">${s.full_name}</option>`).join('');
            standbySelect.value = site.standby_staff_id || '';

            showModal('editSiteModal');
        }

        document.getElementById('editSiteForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const siteId = document.getElementById('editSiteId').value;
            const latVal = document.getElementById('editSiteLatitude').value;
            const lngVal = document.getElementById('editSiteLongitude').value;
            const radiusVal = document.getElementById('editSiteRadius').value;
            const standbyStaffId = document.getElementById('editSiteStandbyStaff').value;

            const data = {
                name: document.getElementById('editSiteName').value,
                code: document.getElementById('editSiteCode').value,
                description: document.getElementById('editSiteDescription').value,
                address: document.getElementById('editSiteAddress').value,
                bank_name: document.getElementById('editSiteBankName').value,
                account_number: document.getElementById('editSiteAccountNumber').value,
                gps_latitude: latVal ? parseFloat(latVal) : null,
                gps_longitude: lngVal ? parseFloat(lngVal) : null,
                gps_radius_meters: radiusVal ? parseInt(radiusVal) : 100
            };

            const response = await apiCall(`/api/sites/${siteId}`, {
                method: 'PUT',
                body: JSON.stringify(data)
            });

            if (response.ok) {
                // Also update standby person
                await apiCall(`/api/admin/sites/${siteId}/standby`, {
                    method: 'POST',
                    body: JSON.stringify({ staff_id: standbyStaffId ? parseInt(standbyStaffId) : null })
                });

                closeModal('editSiteModal');
                loadSites();
            }
        });

        async function toggleSiteActive(siteId) {
            const response = await apiCall(`/api/sites/${siteId}/toggle-active`, {
                method: 'POST'
            });

            if (response.ok) {
                loadSites();
            }
        }

        // ===== PAYMENT METHOD TOGGLE =====
        async function togglePaymentMethod(payslipId, currentMethod) {
            const newMethod = currentMethod === 'BANK' ? 'CASH' : 'BANK';

            const response = await apiCall(`/api/payslips/${payslipId}`, {
                method: 'PUT',
                body: JSON.stringify({ payment_method: newMethod })
            });

            if (response && response.ok) {
                loadPayslips();
            } else {
                alert('Failed to update payment method');
            }
        }

        // ===== PAYSLIP APPROVAL & PDF GENERATION =====
        async function approvePayslip(payslipId) {
            const response = await apiCall(`/api/payslips/${payslipId}/approve`, {
                method: 'POST'
            });

            if (response.ok) {
                loadPayslips();
            }
        }

        async function generatePDFs() {
            const periodId = document.getElementById('payPeriodSelect').value;

            if (!periodId) {
                alert('Please select a pay period first');
                return;
            }
            const response = await apiCall(`/api/payslips/generate-pdfs/${periodId}`, {
                method: 'POST'
            });
            console.log('API response:', response);

            if (response.ok) {
                const result = await response.json();
                let message = `PDF Generation Complete!\n\n`;
                message += `Generated: ${result.generated}\n`;
                message += `Not Approved: ${result.not_approved}\n`;
                message += `Errors: ${result.errors}\n\n`;
                message += `PDFs saved to:\n${result.output_dir}\n\n`;
                if (result.pdf_files && result.pdf_files.length > 0) {
                    message += `Files:\n${result.pdf_files.join('\n')}`;
                }
                alert(message);
            } else {
                const error = await response.json();
                alert(`Error: ${error.error || 'Failed to generate PDFs'}`);
            }
        }

        async function sendPayslipSMS() {
            const periodId = document.getElementById('payPeriodSelect').value;

            if (!periodId) {
                alert('Please select a pay period first');
                return;
            }

            // Count staff with phone/mobile numbers
            const approvedPayslips = currentPayslips.filter(p => p.is_approved);
            const withMobile = approvedPayslips.filter(p => {
                const staff = allStaff.find(s => s.id === p.staff_id);
                const phone = staff?.mobile || staff?.phone;
                return staff && phone && phone.trim();
            });

            if (withMobile.length === 0) {
                alert('No approved staff have phone numbers recorded.');
                return;
            }

            // Warning confirmation
            if (!confirm(`Send SMS notifications to ${withMobile.length} staff members?\n\nThis will send payslip details via SMS to all approved staff with mobile numbers.\n\nContinue?`)) {
                return;
            }

            const response = await apiCall(`/api/payslips/send-sms/${periodId}`, {
                method: 'POST'
            });

            if (response.ok) {
                const result = await response.json();
                let message = `SMS Notifications Sent!\n\n`;
                message += `Sent to: ${result.sent_count} staff\n`;
                message += `No mobile: ${result.no_mobile_count} staff\n\n`;
                message += `${result.upload_message}`;
                alert(message);
            } else {
                const error = await response.json();
                alert(`Error: ${error.error || 'Failed to send SMS notifications'}`);
            }
        }

        // Check for existing token on page load
        window.addEventListener('load', () => {
            const token = localStorage.getItem('wagepro_token');
            if (token) {
                authToken = token;
                // Verify token is still valid
                fetch('/api/auth/me', {
                    headers: {'Authorization': `Bearer ${token}`}
                }).then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('Token invalid');
                    }
                }).then(data => {
                    currentUser = data;
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    document.getElementById('userName').textContent = currentUser.full_name;
                    loadInitialData();
                }).catch(() => {
                    localStorage.removeItem('wagepro_token');
                });
            }
        });

        // ===== TRACKING =====
        let trackingDataFull = null; // Store full tracking data for filtering

        async function loadTracking() {
            try {
                const response = await apiCall('/api/tracking/today');
                const data = await response.json();

                // Store full tracking data for filtering
                trackingDataFull = data;

                // Populate site filter dropdown
                const siteFilter = document.getElementById('trackingSiteFilter');
                const currentSiteValue = siteFilter.value;
                const allSites = new Set();
                if (data.signed_in) data.signed_in.forEach(a => a.site_name && allSites.add(a.site_name));
                if (data.completed) data.completed.forEach(a => a.site_name && allSites.add(a.site_name));
                if (data.not_signed_in) data.not_signed_in.forEach(a => a.site_name && allSites.add(a.site_name));
                const uniqueSites = [...allSites].sort();
                siteFilter.innerHTML = '<option value="">All Sites</option>' +
                    uniqueSites.map(site => '<option value="' + site + '">' + site + '</option>').join('');
                siteFilter.value = currentSiteValue;

                // Apply site filter
                renderTrackingData(data, currentSiteValue);

                // Load location requests
                await loadLocationRequests();

                // Load reminder status
                await loadReminderStatus();
            loadNoWorkDays();

            } catch (error) {
                console.error('Error loading tracking:', error);
            }
        }

        function filterTrackingBySite() {
            const selectedSite = document.getElementById('trackingSiteFilter').value;
            if (trackingDataFull) {
                renderTrackingData(trackingDataFull, selectedSite);
            }
        }

        function renderTrackingData(data, siteFilter) {
            // Filter data by site if selected
            let signedIn = data.signed_in || [];
            let completed = data.completed || [];
            let notSignedIn = data.not_signed_in || [];

            if (siteFilter) {
                signedIn = signedIn.filter(a => a.site_name === siteFilter);
                completed = completed.filter(a => a.site_name === siteFilter);
                notSignedIn = notSignedIn.filter(a => a.site_name === siteFilter);
            }

            // Store filtered tracking data for staff list modal
            trackingData = {
                signed_in: signedIn,
                signed_in_count: signedIn.length,
                completed: completed,
                signed_out_count: completed.length,
                not_signed_in: notSignedIn,
                not_signed_in_count: notSignedIn.length,
                not_working: data.not_working || [],
                not_working_count: (data.not_working || []).length,
                total_hours: signedIn.reduce((sum, a) => sum + (a.hours_so_far || 0), 0) +
                             completed.reduce((sum, a) => sum + (a.hours_worked || 0), 0),
                total_value: data.total_value || 0,
                standby_staff: data.standby_staff || [],
                is_no_work_day: data.is_no_work_day || false
            };

            // Update summary cards
            document.getElementById('trackingSignedIn').textContent = signedIn.length;
            document.getElementById('trackingSignedOut').textContent = completed.length;
            document.getElementById('trackingNotSignedIn').textContent = notSignedIn.length;
            document.getElementById('trackingNotWorking').textContent = (trackingData.not_working || []).length;
            document.getElementById('trackingStandbyCount').textContent = (trackingData.standby_staff || []).length;

            // Show/hide Standby card based on whether today is a No Work Day
            const standbyCardDiv = document.getElementById('standbyCardDiv');
            if (trackingData.is_no_work_day) {
                standbyCardDiv.style.display = 'block';
            } else {
                standbyCardDiv.style.display = 'none';
            }

            document.getElementById('trackingTotalHours').textContent = trackingData.total_hours.toFixed(1);
            console.log('DEBUG: total_value from API =', trackingData.total_value);
            document.getElementById('trackingTotalValue').textContent = 'R' + (trackingData.total_value || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

            // Update signed in table
            const signedInTable = document.getElementById('trackingSignedInTable');
            if (signedIn.length > 0) {
                signedInTable.innerHTML = signedIn.map(a => `
                    <tr>
                        <td><strong>${a.staff_name}</strong></td>
                        <td>${a.site_name || 'No Site'}</td>
                        <td>${a.signin_time}</td>
                        <td>${a.hours_so_far.toFixed(1)}h</td>
                        <td>${a.gps_verified ? '<span style="color: #10b981;">‚úì Yes</span>' : '<span style="color: #ef4444;">‚úó No</span>'}</td>
                        <td>
                            <button class="btn btn-small" style="background: #8b5cf6; color: white;" onclick="requestWhereabouts(${a.staff_id}, '${a.staff_name}')">üìç Locate</button>
                        </td>
                    </tr>
                `).join('');
            } else {
                signedInTable.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #6b7280;">No staff currently signed in</td></tr>';
            }

            // Update completed shifts table
            const completedTable = document.getElementById('trackingCompletedTable');
            if (completed.length > 0) {
                completedTable.innerHTML = completed.map(a => `
                    <tr>
                        <td>${a.staff_name}</td>
                        <td>${a.site_name || 'No Site'}</td>
                        <td>${a.signin_time}</td>
                        <td>${a.signout_time}</td>
                        <td><strong>${a.hours_worked.toFixed(1)}h</strong></td>
                        <td>${a.gps_verified ? '<span style="color: #10b981;">‚úì</span>' : '<span style="color: #ef4444;">‚úó</span>'}</td>
                    </tr>
                `).join('');
            } else {
                completedTable.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #6b7280;">No completed shifts today</td></tr>';
            }
        }

        // ===== ATTENDANCE REMINDERS =====
        async function loadReminderStatus() {
            try {
                // Load summary
                const summaryResponse = await apiCall('/api/reminders/summary');
                const summary = await summaryResponse.json();

                document.getElementById('reminderResponded').textContent = summary.clockin_responded || 0;
                document.getElementById('reminderPending').textContent = (summary.clockin_reminders_sent - summary.clockin_responded - summary.clockin_no_response - (summary.clockin_not_working || 0)) || 0;
                document.getElementById('reminderNotWorking').textContent = summary.clockin_not_working || 0;
                document.getElementById('reminderNoResponse').textContent = summary.clockin_no_response || 0;
                document.getElementById('reminderLate').textContent = summary.late_workers || 0;

                // Load today's reminders
                const remindersResponse = await apiCall('/api/reminders/today');
                const reminders = await remindersResponse.json();

                // Store reminder data for modal
                reminderData = {
                    reminders: reminders || [],
                    summary: summary
                };

                const reminderTable = document.getElementById('reminderTable');
                if (reminders && reminders.length > 0) {
                    reminderTable.innerHTML = reminders.map(r => {
                        let statusBadge = '';
                        // Check if on leave first - takes priority over other statuses
                        if (r.on_leave) {
                            const leaveLabel = r.leave_type === 'L' ? 'LEAVE' : 'SICK';
                            statusBadge = `<span style="background: #7c3aed; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; white-space: nowrap;">üèñÔ∏è ON ${leaveLabel}</span>`;
                        } else if (r.status === 'responded') {
                            statusBadge = '<span style="background: #10b981; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Responded</span>';
                        } else if (r.status === 'not_working') {
                            statusBadge = '<span style="background: #6366f1; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">üè† Not Working</span>';
                        } else if (r.status === 'escalated') {
                            statusBadge = '<span style="background: #f59e0b; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Escalated</span>';
                        } else if (r.status === 'no_response') {
                            statusBadge = '<span style="background: #ef4444; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">No Response</span>';
                        } else {
                            statusBadge = '<span style="background: #3b82f6; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Sent</span>';
                        }

                        const typeLabel = r.reminder_type === 'clockin' ? 'üåÖ Clock In' : 'üåÜ Clock Out';
                        const firstSms = r.first_sms_sent_at ? new Date(r.first_sms_sent_at).toLocaleTimeString('en-ZA', {hour: '2-digit', minute: '2-digit'}) : '-';
                        const secondSms = r.second_sms_sent_at ? new Date(r.second_sms_sent_at).toLocaleTimeString('en-ZA', {hour: '2-digit', minute: '2-digit'}) : '-';

                        // Calculate wait minutes - show elapsed time for non-responded, or final time for responded
                        let waitMinsHtml = '-';
                        if (r.first_sms_sent_at && !r.on_leave) {
                            const sentTime = new Date(r.first_sms_sent_at);
                            let elapsedMins;

                            if (r.status === 'responded' && r.responded_at) {
                                // For responded - show time it took to respond (static) with green checkmark
                                const respondedTime = new Date(r.responded_at);
                                elapsedMins = Math.floor((respondedTime - sentTime) / 60000);
                                waitMinsHtml = `<span style="color: #10b981; font-weight: bold;">‚úì ${elapsedMins}</span>`;
                            } else if (r.status === 'no_response') {
                                // For no_response - show red X (locked out)
                                elapsedMins = Math.floor((new Date() - sentTime) / 60000);
                                waitMinsHtml = `<span style="color: #dc2626; font-weight: bold; font-size: 1.1rem;">‚úó ${elapsedMins}</span>`;
                            } else if (r.status !== 'responded') {
                                // For pending/escalated - calculate from now (will be updated by timer)
                                elapsedMins = Math.floor((new Date() - sentTime) / 60000);
                                // Color coding: green (0-10), orange (11-20), red (21+)
                                let color = '#10b981'; // green
                                if (elapsedMins > 20) {
                                    color = '#dc2626'; // red
                                } else if (elapsedMins > 10) {
                                    color = '#f59e0b'; // orange
                                }
                                waitMinsHtml = `<span class="wait-mins" data-sent="${r.first_sms_sent_at}" style="color: ${color}; font-weight: bold; font-size: 1.1rem;">${elapsedMins}</span>`;
                            }
                        }

                        return `
                            <tr data-reminder-id="${r.id}" data-status="${r.status}"${r.on_leave ? ' style="background: #f3e8ff;"' : ''}>
                                <td><strong>${r.staff_name}</strong></td>
                                <td style="font-size: 0.85rem; color: #6b7280;">${r.mobile || '-'}</td>
                                <td>${r.site_name}</td>
                                <td>${typeLabel}</td>
                                <td>${firstSms}</td>
                                <td>${secondSms}</td>
                                <td>${statusBadge}</td>
                                <td>${waitMinsHtml}</td>
                                <td>
                                    <button class="btn btn-small" style="background: #8b5cf6; color: white; font-size: 0.75rem;" onclick="requestWhereabouts(${r.staff_id}, '${r.staff_name}')">üìç Locate</button>
                                    <button class="btn btn-small" style="background: #f59e0b; color: white; font-size: 0.75rem; margin-left: 4px;" onclick="resendReminder(${r.id}, '${r.staff_name}')"${r.on_leave ? ' disabled title="Staff is on leave"' : ''}>üîÑ Resend</button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    reminderTable.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #6b7280;">No reminders sent today</td></tr>';
                }

                // Populate manual reminder site dropdown
                const manualSiteSelect = document.getElementById('manualReminderSite');
                manualSiteSelect.innerHTML = '<option value="">All Sites</option>' +
                    allSites.map(site => `<option value="${site.id}">${site.name}</option>`).join('');

                // Populate reminder table site filter dropdown
                const reminderSiteFilter = document.getElementById('reminderSiteFilter');
                if (reminderSiteFilter) {
                    reminderSiteFilter.innerHTML = '<option value="all">All Sites</option>' +
                        allSites.map(site => `<option value="${site.name}">${site.name}</option>`).join('');
                }

                // Populate bulk SMS site dropdown
                const bulkSmsSiteSelect = document.getElementById('bulkSmsSite');
                if (bulkSmsSiteSelect) {
                    bulkSmsSiteSelect.innerHTML = '<option value="">All Sites</option>' +
                        allSites.map(site => `<option value="${site.id}">${site.name}</option>`).join('');
                    updateBulkSmsCount();
                }

                // Populate manual reminder staff dropdown
                filterManualReminderStaff();

                // Apply any existing filter
                filterReminderTable();

            } catch (error) {
                console.error('Error loading reminder status:', error);
            }
        }

        async function sendManualReminder() {
            const staffId = document.getElementById('manualReminderStaff').value;
            const reminderType = document.getElementById('manualReminderType').value;
            const siteId = document.getElementById('manualReminderSite').value;

            if (!staffId) {
                alert('Please select a staff member');
                return;
            }

            // Handle ALL STAFF
            if (staffId === 'ALL') {
                let filteredStaff = allStaff.filter(s => s.is_active && (s.mobile || s.phone));
                if (siteId) {
                    filteredStaff = filteredStaff.filter(s => s.site_id == siteId);
                }

                const siteName = siteId ? allSites.find(s => s.id == siteId)?.name : 'ALL SITES';
                if (!confirm(`Send ${reminderType === 'clockin' ? 'clock-in' : 'clock-out'} reminder to ALL ${filteredStaff.length} staff at ${siteName}?`)) {
                    return;
                }

                let successCount = 0;
                let failCount = 0;

                for (const staff of filteredStaff) {
                    try {
                        const response = await apiCall('/api/reminders/send-manual', {
                            method: 'POST',
                            body: JSON.stringify({
                                staff_id: staff.id,
                                reminder_type: reminderType
                            })
                        });
                        const data = await response.json();
                        if (data.success) {
                            successCount++;
                        } else {
                            failCount++;
                        }
                    } catch (e) {
                        failCount++;
                    }
                }

                alert(`Sent ${successCount} SMS reminders${failCount > 0 ? ` (${failCount} failed)` : ''}`);
                loadReminderStatus();
                loadNoWorkDays();
                return;
            }

            const staff = allStaff.find(s => s.id == staffId);
            if (!confirm(`Send ${reminderType === 'clockin' ? 'clock-in' : 'clock-out'} reminder to ${staff?.full_name}?`)) {
                return;
            }

            try {
                const response = await apiCall('/api/reminders/send-manual', {
                    method: 'POST',
                    body: JSON.stringify({
                        staff_id: parseInt(staffId),
                        reminder_type: reminderType
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert(`SMS sent to ${data.message}`);
                    loadReminderStatus();
                    loadNoWorkDays();
                } else {
                    alert('Error: ' + (data.error || 'Failed to send reminder'));
                }
            } catch (error) {
                alert('Error sending reminder: ' + error.message);
            }
        }

        async function resendReminder(reminderId, staffName) {
            try {
                const response = await apiCall(`/api/reminders/resend/${reminderId}`, {
                    method: 'POST'
                });

                const data = await response.json();
                if (data.success) {
                    // Silent success - just refresh the list
                    loadReminderStatus();
                    loadNoWorkDays();
                } else {
                    alert('Error: ' + (data.error || 'Failed to resend reminder'));
                }
            } catch (error) {
                alert('Error resending reminder: ' + error.message);
            }
        }

        async function resendAllNotResponded() {
            // Get all reminders that haven't responded (status != 'responded')
            if (!reminderData || !reminderData.reminders) {
                alert('Please wait for reminder data to load');
                return;
            }

            const notResponded = reminderData.reminders.filter(r => r.status !== 'responded');
            if (notResponded.length === 0) {
                alert('No pending reminders to resend');
                return;
            }

            if (!confirm(`Resend reminders to ${notResponded.length} staff who haven't responded?`)) {
                return;
            }

            let successCount = 0;
            let failCount = 0;

            for (const reminder of notResponded) {
                try {
                    const response = await apiCall(`/api/reminders/resend/${reminder.id}`, {
                        method: 'POST'
                    });
                    const data = await response.json();
                    if (data.success) {
                        successCount++;
                    } else {
                        failCount++;
                    }
                } catch (error) {
                    failCount++;
                }
            }

            // Refresh the list
            loadReminderStatus();
            loadNoWorkDays();

            alert(`Resent ${successCount} reminders${failCount > 0 ? `, ${failCount} failed` : ''}`);
        }

        async function loadLocationRequests() {
            try {
                const response = await apiCall('/api/location/requests');
                const data = await response.json();

                const locationTable = document.getElementById('trackingLocationTable');
                if (data.requests && data.requests.length > 0) {
                    locationTable.innerHTML = data.requests.map(r => {
                        let statusBadge = '';
                        let locationLink = '-';

                        if (r.status === 'received') {
                            statusBadge = '<span style="background: #10b981; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Received</span>';
                            if (r.latitude && r.longitude) {
                                locationLink = `<a href="https://maps.google.com/?q=${r.latitude},${r.longitude}" target="_blank" style="color: #0ea5e9;">üìç View Map</a>`;
                            }
                        } else if (r.status === 'pending') {
                            statusBadge = '<span style="background: #f59e0b; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Pending</span>';
                        } else {
                            statusBadge = '<span style="background: #6b7280; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Expired</span>';
                        }

                        return `
                            <tr>
                                <td><strong>${r.staff_name}</strong></td>
                                <td style="color: #dc2626; font-weight: 700;">${r.staff_phone || '-'}</td>
                                <td>${r.requested_at}</td>
                                <td>${r.reason || '-'}</td>
                                <td>${statusBadge}</td>
                                <td>${locationLink}</td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    locationTable.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #6b7280;">No recent whereabouts checks</td></tr>';
                }
            } catch (error) {
                console.error('Error loading location requests:', error);
            }
        }

        async function quickLocate(staffId, staffName) {
            if (!confirm(`Send whereabouts request SMS to ${staffName}?`)) return;

            try {
                const response = await apiCall('/api/location/request', {
                    method: 'POST',
                    body: JSON.stringify({
                        staff_id: staffId,
                        reason: 'Whereabouts check'
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert(`üìç SMS sent to ${staffName}`);
                } else {
                    alert('Error: ' + (data.error || 'Failed to send SMS'));
                }
            } catch (error) {
                alert('Error sending whereabouts request');
            }
        }

        function showWhereaboutsModal() {
            // Populate site dropdown
            const siteSelect = document.getElementById('whereaboutsSite');
            siteSelect.innerHTML = '<option value="">All Sites</option>' +
                allSites.map(site => `<option value="${site.id}">${site.name}</option>`).join('');

            // Populate staff dropdown (all staff initially)
            filterWhereaboutsStaff();

            document.getElementById('whereaboutsReason').value = '';
            showModal('whereaboutsModal');
        }

        function filterWhereaboutsStaff() {
            const siteId = document.getElementById('whereaboutsSite').value;
            const select = document.getElementById('whereaboutsStaff');

            let filteredStaff = allStaff.filter(s => s.is_active && (s.mobile || s.phone));
            if (siteId) {
                filteredStaff = filteredStaff.filter(s => s.site_id == siteId);
            }

            select.innerHTML = '<option value="">Select staff...</option>' +
                filteredStaff.map(s =>
                    `<option value="${s.id}">${s.full_name} (${s.mobile || s.phone})</option>`
                ).join('');
        }

        function filterManualReminderStaff() {
            const siteId = document.getElementById('manualReminderSite').value;
            const select = document.getElementById('manualReminderStaff');

            let filteredStaff = allStaff.filter(s => s.is_active && (s.mobile || s.phone));
            if (siteId) {
                filteredStaff = filteredStaff.filter(s => s.site_id == siteId);
            }

            select.innerHTML = '<option value="">Select staff member...</option>' +
                '<option value="ALL" style="font-weight: bold; background: #fef3c7;">üì¢ ALL STAFF (' + filteredStaff.length + ')</option>' +
                filteredStaff.map(s =>
                    `<option value="${s.id}">${s.full_name} (${s.mobile || s.phone})</option>`
                ).join('');
        }

        // Filter reminder table by status and site
        function filterReminderTable() {
            const statusFilter = document.getElementById('reminderStatusFilter')?.value || 'all';
            const siteFilter = document.getElementById('reminderSiteFilter')?.value || 'all';
            const typeFilter = document.getElementById('reminderTypeFilter')?.value || 'all';
            const table = document.getElementById('reminderTable');
            if (!table) return;

            const rows = table.querySelectorAll('tr');
            rows.forEach(row => {
                const siteTd = row.querySelector('td:nth-child(3)');
                const typeTd = row.querySelector('td:nth-child(4)');
                const statusTd = row.querySelector('td:nth-child(7)');
                if (!siteTd || !statusTd) return;

                const siteName = siteTd.textContent.trim();
                const typeText = typeTd ? typeTd.textContent.trim().toLowerCase() : '';
                const statusHtml = statusTd.innerHTML.toLowerCase();

                let showBySite = (siteFilter === 'all') || (siteName === siteFilter);
                let showByStatus = true;
                let showByType = true;

                // Type filter
                if (typeFilter !== 'all') {
                    if (typeFilter === 'clockin') {
                        showByType = typeText.includes('clock in');
                    } else if (typeFilter === 'clockout') {
                        showByType = typeText.includes('clock out');
                    }
                }

                if (statusFilter !== 'all') {
                    if (statusFilter === 'on_leave') {
                        showByStatus = statusHtml.includes('on leave') || statusHtml.includes('on sick');
                    } else if (statusFilter === 'responded') {
                        showByStatus = statusHtml.includes('>responded<') && !statusHtml.includes('on leave');
                    } else if (statusFilter === 'no_response') {
                        showByStatus = statusHtml.includes('no response') && !statusHtml.includes('on leave');
                    } else if (statusFilter === 'escalated') {
                        showByStatus = statusHtml.includes('>escalated<') && !statusHtml.includes('on leave');
                    } else if (statusFilter === 'sent') {
                        showByStatus = statusHtml.includes('>sent<') && !statusHtml.includes('on leave');
                    }
                }

                row.style.display = (showBySite && showByStatus && showByType) ? '' : 'none';
            });
        }

        // Update wait minutes in reminder table (called every 30 seconds)
        function updateWaitMinutes() {
            const waitSpans = document.querySelectorAll('.wait-mins');
            waitSpans.forEach(span => {
                const sentTime = new Date(span.dataset.sent);
                const elapsedMins = Math.floor((new Date() - sentTime) / 60000);

                // Update the display
                span.textContent = elapsedMins;

                // Update color based on wait time
                if (elapsedMins > 20) {
                    span.style.color = '#dc2626'; // red
                } else if (elapsedMins > 10) {
                    span.style.color = '#f59e0b'; // orange
                } else {
                    span.style.color = '#10b981'; // green
                }
            });
        }

        // Start timer to update wait minutes every 30 seconds
        setInterval(updateWaitMinutes, 30000);

        // Bulk SMS functions
        function updateBulkSmsCount() {
            const siteId = document.getElementById('bulkSmsSite').value;
            let filteredStaff = allStaff.filter(s => s.is_active && (s.mobile || s.phone));
            if (siteId) {
                filteredStaff = filteredStaff.filter(s => s.site_id == siteId);
            }
            document.getElementById('bulkSmsRecipientCount').textContent = `Recipients: ${filteredStaff.length}`;
        }

        // Character count for bulk SMS
        document.addEventListener('DOMContentLoaded', function() {
            const textarea = document.getElementById('bulkSmsMessage');
            if (textarea) {
                textarea.addEventListener('input', function() {
                    const count = this.value.length;
                    const charSpan = document.getElementById('bulkSmsCharCount');
                    charSpan.textContent = `${count} / 160 chars`;
                    charSpan.style.color = count > 160 ? '#ef4444' : '#6b7280';
                });
            }
        });

        async function sendBulkSms() {
            const siteId = document.getElementById('bulkSmsSite').value;
            const message = document.getElementById('bulkSmsMessage').value.trim();

            if (!message) {
                alert('Please enter a message to send');
                return;
            }

            let filteredStaff = allStaff.filter(s => s.is_active && (s.mobile || s.phone));
            if (siteId) {
                filteredStaff = filteredStaff.filter(s => s.site_id == siteId);
            }

            if (filteredStaff.length === 0) {
                alert('No staff members with mobile numbers found');
                return;
            }

            const siteName = siteId ? allSites.find(s => s.id == siteId)?.name : 'ALL SITES';
            if (!confirm(`Send this message to ${filteredStaff.length} staff at ${siteName}?\n\n"${message}"`)) {
                return;
            }

            try {
                const response = await apiCall('/api/sms/bulk', {
                    method: 'POST',
                    body: JSON.stringify({
                        site_id: siteId ? parseInt(siteId) : null,
                        message: message
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert(`SMS sent to ${data.sent_count} staff members`);
                    document.getElementById('bulkSmsMessage').value = '';
                    document.getElementById('bulkSmsCharCount').textContent = '0 / 160 chars';
                } else {
                    alert('Error: ' + (data.error || 'Failed to send SMS'));
                }
            } catch (error) {
                alert('Error sending SMS: ' + error.message);
            }
        }

        // Show standby staff modal
        function showStandbyModal() {
            if (!trackingData) {
                alert('Please wait for tracking data to load');
                return;
            }

            const standbyStaff = trackingData.standby_staff || [];
            const emergencyStaff = (trackingData.not_signed_in || []).filter(s => s.allow_emergency_clock);

            const title = document.getElementById('staffListTitle');
            const tableHead = document.getElementById('staffListTableHead');
            const tableBody = document.getElementById('staffListTableBody');

            title.textContent = `üõ°Ô∏è Standby & Emergency Staff`;
            title.style.color = '#92400e';

            tableHead.innerHTML = `
                <tr>
                    <th>Type</th>
                    <th>Staff Name</th>
                    <th>Site</th>
                    <th>Status</th>
                </tr>
            `;

            let rows = [];

            // Add standby staff
            standbyStaff.forEach(s => {
                rows.push(`
                    <tr style="background: #fef3c7;">
                        <td><span style="background: #92400e; color: white; padding: 2px 8px; border-radius: 4px;">üè† Standby</span></td>
                        <td><strong>${s.staff_name}</strong></td>
                        <td>${s.site_name}</td>
                        <td><span style="color: #92400e;">Receives R${(window.standbyRate || 150).toFixed(2)} on no-work days</span></td>
                    </tr>
                `);
            });

            // Add emergency-allowed staff
            emergencyStaff.forEach(s => {
                rows.push(`
                    <tr style="background: #d1fae5;">
                        <td><span style="background: #059669; color: white; padding: 2px 8px; border-radius: 4px;">üö® Emergency</span></td>
                        <td><strong>${s.full_name}</strong></td>
                        <td>${s.site_name || 'No Site'}</td>
                        <td><span style="color: #059669;">Can clock in on no-work days</span></td>
                    </tr>
                `);
            });

            if (rows.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #6b7280;">No standby or emergency staff configured</td></tr>';
            } else {
                tableBody.innerHTML = rows.join('');
            }

            showModal('staffListModal');
        }

        // Show staff list modal for clicked summary card
        function showStaffList(listType) {
            if (!trackingData) {
                alert('Please wait for tracking data to load');
                return;
            }

            const title = document.getElementById('staffListTitle');
            const tableHead = document.getElementById('staffListTableHead');
            const tableBody = document.getElementById('staffListTableBody');
            let staffList = [];
            let titleText = '';
            let titleColor = '';

            switch(listType) {
                case 'signed_in':
                    staffList = trackingData.signed_in || [];
                    titleText = `üü¢ Currently Signed In (${staffList.length})`;
                    titleColor = '#10b981';
                    tableHead.innerHTML = `
                        <tr>
                            <th>Staff Name</th>
                            <th>Site</th>
                            <th>Signed In At</th>
                            <th>Hours So Far</th>
                            <th>Actions</th>
                        </tr>
                    `;
                    if (staffList.length > 0) {
                        tableBody.innerHTML = staffList.map(s => `
                            <tr>
                                <td><strong>${s.staff_name}</strong></td>
                                <td>${s.site_name || 'No Site'}</td>
                                <td>${s.signin_time}</td>
                                <td>${s.hours_so_far.toFixed(1)}h</td>
                                <td>
                                    <button class="btn btn-small" style="background: #8b5cf6; color: white; margin-right: 4px;" onclick="requestWhereabouts(${s.staff_id}, '${s.staff_name}')">üìç Locate</button>
                                    <button class="btn btn-small" style="background: #f59e0b; color: white;" onclick="signOutOnBehalf(${s.staff_id}, '${s.staff_name.replace(/'/g, "\\'")}')">üö™ Sign Out</button>
                                </td>
                            </tr>
                        `).join('');
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #6b7280;">No staff currently signed in</td></tr>';
                    }
                    break;

                case 'signed_out':
                    staffList = trackingData.completed || [];
                    titleText = `‚ö™ Signed Out Today (${staffList.length})`;
                    titleColor = '#6b7280';
                    tableHead.innerHTML = `
                        <tr>
                            <th>Staff Name</th>
                            <th>Site</th>
                            <th>Sign In</th>
                            <th>Sign Out</th>
                            <th>Hours Worked</th>
                        </tr>
                    `;
                    if (staffList.length > 0) {
                        tableBody.innerHTML = staffList.map(s => `
                            <tr>
                                <td><strong>${s.staff_name}</strong></td>
                                <td>${s.site_name || 'No Site'}</td>
                                <td>${s.signin_time}</td>
                                <td>${s.signout_time}</td>
                                <td><strong>${s.hours_worked.toFixed(1)}h</strong></td>
                            </tr>
                        `).join('');
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #6b7280;">No completed shifts today</td></tr>';
                    }
                    break;

                case 'not_signed_in':
                    staffList = trackingData.not_signed_in || [];
                    titleText = `üü† Not Signed In (${staffList.length})`;
                    titleColor = '#f59e0b';

                    // Build standby/emergency indicator
                    const standbyStaff = trackingData.standby_staff || [];
                    const emergencyStaff = staffList.filter(s => s.allow_emergency_clock);
                    let indicatorHtml = '';

                    if (standbyStaff.length > 0 || emergencyStaff.length > 0) {
                        indicatorHtml = '<div style="margin-bottom: 1rem; padding: 0.75rem; background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px;">';
                        if (standbyStaff.length > 0) {
                            indicatorHtml += '<div style="margin-bottom: 0.5rem;"><strong style="color: #92400e;">üè† Standby:</strong> ';
                            indicatorHtml += standbyStaff.map(s => `<span style="background: #fde68a; padding: 2px 8px; border-radius: 4px; margin-right: 4px;">${s.staff_name} (${s.site_name})</span>`).join('');
                            indicatorHtml += '</div>';
                        }
                        if (emergencyStaff.length > 0) {
                            indicatorHtml += '<div><strong style="color: #059669;">üö® Emergency Allowed:</strong> ';
                            indicatorHtml += emergencyStaff.map(s => `<span style="background: #d1fae5; padding: 2px 8px; border-radius: 4px; margin-right: 4px;">${s.full_name}</span>`).join('');
                            indicatorHtml += '</div>';
                        }
                        indicatorHtml += '</div>';
                    }

                    tableHead.innerHTML = indicatorHtml + `
                        <tr>
                            <th>Staff Name</th>
                            <th>Site</th>
                            <th>Mobile</th>
                            <th>Emergency</th>
                            <th>Actions</th>
                        </tr>
                    `;
                    if (staffList.length > 0) {
                        // Check if today is a no-work day - emergency column only relevant on no-work days
                        const isNoWorkDay = trackingData.is_no_work_day || false;
                        tableBody.innerHTML = staffList.map(s => {
                            const hasPhone = s.mobile || s.phone;
                            const phoneDisplay = hasPhone || 'No number';
                            // Actions: Locate (if has phone) + Sign In button for all
                            let actionsHtml = '';
                            if (hasPhone) {
                                actionsHtml += `<button class="btn btn-small" style="background: #8b5cf6; color: white; margin-right: 4px;" onclick="requestWhereabouts(${s.id}, '${s.full_name}')">üìç Locate</button>`;
                            }
                            // Always show Sign In button for not-signed-in staff
                            actionsHtml += `<button class="btn btn-small" style="background: #10b981; color: white;" onclick="signInOnBehalf(${s.id}, '${s.full_name.replace(/'/g, "\\'")}')">‚úÖ Sign In</button>`;

                            // Emergency column: show N/A on normal working days, show status on no-work days
                            let emergencyDisplay;
                            if (isNoWorkDay) {
                                const emergencyAllowed = s.allow_emergency_clock;
                                emergencyDisplay = emergencyAllowed ?
                                    `<button class="btn btn-small" style="background: #10b981; color: white;" onclick="toggleEmergencyClock(${s.id}, false)" title="Click to disable">‚úÖ Allowed</button>` :
                                    `<button class="btn btn-small" style="background: #6b7280; color: white;" onclick="toggleEmergencyClock(${s.id}, true)" title="Click to allow clock-in on no-work days">‚ùå Not Allowed</button>`;
                            } else {
                                emergencyDisplay = '<span style="color: #9ca3af;">N/A</span>';
                            }
                            return `
                                <tr>
                                    <td><strong>${s.full_name}</strong></td>
                                    <td>${s.site_name || 'No Site'}</td>
                                    <td>${phoneDisplay}</td>
                                    <td>${emergencyDisplay}</td>
                                    <td>${actionsHtml}</td>
                                </tr>
                            `;
                        }).join('');
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #6b7280;">All staff have signed in today!</td></tr>';
                    }
                    break;

                case 'not_working':
                    staffList = trackingData.not_working || [];
                    titleText = `üî¥ Confirmed Not Working (${staffList.length})`;
                    titleColor = '#dc2626';
                    tableHead.innerHTML = `
                        <tr>
                            <th>Staff Name</th>
                            <th>Site</th>
                            <th>Reason</th>
                            <th>Time</th>
                        </tr>
                    `;
                    if (staffList.length > 0) {
                        tableBody.innerHTML = staffList.map(s => `
                            <tr style="background: #fef2f2;">
                                <td><strong>${s.full_name}</strong></td>
                                <td>${s.site_name || 'No Site'}</td>
                                <td><span style="color: #dc2626;">${s.reason}</span></td>
                                <td>${s.time}</td>
                            </tr>
                        `).join('');
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #6b7280;">No staff have confirmed not working today</td></tr>';
                    }
                    break;
            }

            title.textContent = titleText;
            title.style.color = titleColor;
            showModal('staffListModal');
        }

        // Show reminder list modal for clicked summary card
        function showReminderList(listType) {
            if (!reminderData) {
                alert('Please wait for reminder data to load');
                return;
            }

            const title = document.getElementById('reminderListTitle');
            const tableHead = document.getElementById('reminderListTableHead');
            const tableBody = document.getElementById('reminderListTableBody');
            let filteredList = [];
            let titleText = '';
            let titleColor = '';

            const allReminders = reminderData.reminders || [];

            switch(listType) {
                case 'responded':
                    filteredList = allReminders.filter(r => r.status === 'responded');
                    titleText = `üü¢ Responded (${filteredList.length})`;
                    titleColor = '#10b981';
                    tableHead.innerHTML = `
                        <tr>
                            <th>Staff Name</th>
                            <th>Site</th>
                            <th>Type</th>
                            <th>Sent At</th>
                            <th>Responded At</th>
                            <th>Took</th>
                        </tr>
                    `;
                    if (filteredList.length > 0) {
                        tableBody.innerHTML = filteredList.map(r => {
                            const typeLabel = r.reminder_type === 'clockin' ? 'üåÖ Clock In' : 'üåÜ Clock Out';
                            const sentTime = r.first_sms_sent_at ? new Date(r.first_sms_sent_at).toLocaleTimeString('en-ZA', {hour: '2-digit', minute: '2-digit'}) : '-';
                            const respondedTime = r.responded_at ? new Date(r.responded_at).toLocaleTimeString('en-ZA', {hour: '2-digit', minute: '2-digit'}) : '-';

                            // Calculate response time
                            let tookHtml = '-';
                            if (r.first_sms_sent_at && r.responded_at) {
                                const sent = new Date(r.first_sms_sent_at);
                                const responded = new Date(r.responded_at);
                                const mins = Math.floor((responded - sent) / 60000);
                                tookHtml = `<span style="color: #10b981; font-weight: bold;">‚úì ${mins} min</span>`;
                            }

                            return `
                                <tr>
                                    <td><strong>${r.staff_name}</strong></td>
                                    <td>${r.site_name || 'No Site'}</td>
                                    <td>${typeLabel}</td>
                                    <td>${sentTime}</td>
                                    <td><span style="color: #10b981; font-weight: bold;">${respondedTime}</span></td>
                                    <td>${tookHtml}</td>
                                </tr>
                            `;
                        }).join('');
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #6b7280;">No responded reminders</td></tr>';
                    }
                    break;

                case 'awaiting':
                    filteredList = allReminders.filter(r => (r.status === 'sent' || r.status === 'escalated') && !r.on_leave);
                    titleText = `üü† Awaiting Response (${filteredList.length})`;
                    titleColor = '#f59e0b';
                    tableHead.innerHTML = `
                        <tr>
                            <th>Staff Name</th>
                            <th>Site</th>
                            <th>Type</th>
                            <th>First SMS</th>
                            <th>Escalation</th>
                            <th>Wait</th>
                            <th>Actions</th>
                        </tr>
                    `;
                    if (filteredList.length > 0) {
                        tableBody.innerHTML = filteredList.map(r => {
                            const typeLabel = r.reminder_type === 'clockin' ? 'üåÖ Clock In' : 'üåÜ Clock Out';
                            const firstSms = r.first_sms_sent_at ? new Date(r.first_sms_sent_at).toLocaleTimeString('en-ZA', {hour: '2-digit', minute: '2-digit'}) : '-';
                            const secondSms = r.second_sms_sent_at ? new Date(r.second_sms_sent_at).toLocaleTimeString('en-ZA', {hour: '2-digit', minute: '2-digit'}) : '-';

                            // Calculate wait minutes with color coding
                            let waitHtml = '-';
                            if (r.first_sms_sent_at) {
                                const sentTime = new Date(r.first_sms_sent_at);
                                const elapsedMins = Math.floor((new Date() - sentTime) / 60000);
                                let color = '#10b981'; // green
                                if (elapsedMins > 20) {
                                    color = '#dc2626'; // red
                                } else if (elapsedMins > 10) {
                                    color = '#f59e0b'; // orange
                                }
                                waitHtml = `<span class="wait-mins" data-sent="${r.first_sms_sent_at}" style="color: ${color}; font-weight: bold; font-size: 1.1rem;">${elapsedMins}</span>`;
                            }

                            return `
                                <tr>
                                    <td><strong>${r.staff_name}</strong></td>
                                    <td>${r.site_name || 'No Site'}</td>
                                    <td>${typeLabel}</td>
                                    <td>${firstSms}</td>
                                    <td>${secondSms}</td>
                                    <td>${waitHtml}</td>
                                    <td>
                                        <button class="btn btn-small" style="background: #8b5cf6; color: white;" onclick="requestWhereabouts(${r.staff_id}, '${r.staff_name}')">üìç Locate</button>
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #6b7280;">No reminders awaiting response</td></tr>';
                    }
                    break;

                case 'not_working':
                    filteredList = allReminders.filter(r => r.status === 'not_working' && !r.on_leave);
                    titleText = `üè† Not Working (${filteredList.length})`;
                    titleColor = '#6366f1';
                    tableHead.innerHTML = `
                        <tr>
                            <th>Staff Name</th>
                            <th>Site</th>
                            <th>Type</th>
                            <th>Reported At</th>
                            <th>Reason</th>
                        </tr>
                    `;
                    if (filteredList.length > 0) {
                        tableBody.innerHTML = filteredList.map(r => {
                            const typeLabel = r.reminder_type === 'clockin' ? 'üåÖ Clock In' : 'üåÜ Clock Out';
                            const reportedAt = r.responded_at ? new Date(r.responded_at).toLocaleTimeString('en-ZA', {hour: '2-digit', minute: '2-digit'}) : '-';
                            const reason = r.notes || 'No reason provided';

                            return `
                                <tr style="background: #eef2ff;">
                                    <td><strong style="color: #6366f1;">${r.staff_name}</strong></td>
                                    <td>${r.site_name || 'No Site'}</td>
                                    <td>${typeLabel}</td>
                                    <td>${reportedAt}</td>
                                    <td>${reason}</td>
                                </tr>
                            `;
                        }).join('');
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #6b7280;">No staff reported not working</td></tr>';
                    }
                    break;

                case 'no_response':
                    filteredList = allReminders.filter(r => r.status === 'no_response' && !r.on_leave);
                    titleText = `üî¥ No Response (${filteredList.length})`;
                    titleColor = '#ef4444';
                    tableHead.innerHTML = `
                        <tr>
                            <th>Staff Name</th>
                            <th>Site</th>
                            <th>Type</th>
                            <th>First SMS</th>
                            <th>Escalation</th>
                            <th>Wait</th>
                            <th>Actions</th>
                        </tr>
                    `;
                    if (filteredList.length > 0) {
                        tableBody.innerHTML = filteredList.map(r => {
                            const typeLabel = r.reminder_type === 'clockin' ? 'üåÖ Clock In' : 'üåÜ Clock Out';
                            const firstSms = r.first_sms_sent_at ? new Date(r.first_sms_sent_at).toLocaleTimeString('en-ZA', {hour: '2-digit', minute: '2-digit'}) : '-';
                            const secondSms = r.second_sms_sent_at ? new Date(r.second_sms_sent_at).toLocaleTimeString('en-ZA', {hour: '2-digit', minute: '2-digit'}) : '-';

                            // Calculate wait minutes - always red with X for no_response (locked out)
                            let waitHtml = '-';
                            if (r.first_sms_sent_at) {
                                const sentTime = new Date(r.first_sms_sent_at);
                                const elapsedMins = Math.floor((new Date() - sentTime) / 60000);
                                waitHtml = `<span style="color: #dc2626; font-weight: bold; font-size: 1.1rem;">‚úó ${elapsedMins}</span>`;
                            }

                            return `
                                <tr style="background: #fef2f2;">
                                    <td><strong style="color: #dc2626;">${r.staff_name}</strong></td>
                                    <td>${r.site_name || 'No Site'}</td>
                                    <td>${typeLabel}</td>
                                    <td>${firstSms}</td>
                                    <td>${secondSms}</td>
                                    <td>${waitHtml}</td>
                                    <td>
                                        <button class="btn btn-small" style="background: #8b5cf6; color: white;" onclick="requestWhereabouts(${r.staff_id}, '${r.staff_name}')">üìç Locate</button>
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #6b7280;">No unresponsive reminders</td></tr>';
                    }
                    break;

                case 'late':
                    filteredList = allReminders.filter(r => r.late_minutes > 0);
                    titleText = `üü£ Late Today (${filteredList.length})`;
                    titleColor = '#8b5cf6';
                    tableHead.innerHTML = `
                        <tr>
                            <th>Staff Name</th>
                            <th>Site</th>
                            <th>Type</th>
                            <th>Late (minutes)</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    `;
                    if (filteredList.length > 0) {
                        tableBody.innerHTML = filteredList.map(r => {
                            const typeLabel = r.reminder_type === 'clockin' ? 'üåÖ Clock In' : 'üåÜ Clock Out';
                            let statusBadge = '';
                            if (r.status === 'responded') {
                                statusBadge = '<span style="background: #10b981; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Responded</span>';
                            } else if (r.status === 'no_response') {
                                statusBadge = '<span style="background: #ef4444; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">No Response</span>';
                            } else {
                                statusBadge = '<span style="background: #f59e0b; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Awaiting</span>';
                            }
                            return `
                                <tr>
                                    <td><strong>${r.staff_name}</strong></td>
                                    <td>${r.site_name || 'No Site'}</td>
                                    <td>${typeLabel}</td>
                                    <td><span style="color: #dc2626; font-weight: bold; font-size: 1.1rem;">${r.late_minutes} min</span></td>
                                    <td>${statusBadge}</td>
                                    <td>
                                        <button class="btn btn-small" style="background: #8b5cf6; color: white;" onclick="requestWhereabouts(${r.staff_id}, '${r.staff_name}')">üìç Locate</button>
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #6b7280;">No late workers today</td></tr>';
                    }
                    break;
            }

            title.textContent = titleText;
            title.style.color = titleColor;
            showModal('reminderListModal');
        }

        async function requestWhereabouts(staffId, staffName) {
            try {
                const response = await apiCall('/api/location/request', {
                    method: 'POST',
                    body: JSON.stringify({
                        staff_id: staffId,
                        reason: 'Location check from tracking'
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert(`SMS sent to ${staffName}`);
                    loadTracking();
                } else {
                    alert('Error: ' + (data.error || 'Failed to send SMS'));
                }
            } catch (error) {
                alert('Error sending whereabouts request');
            }
        }

        async function toggleEmergencyClock(staffId, allow) {
            try {
                const response = await apiCall(`/api/admin/staff/${staffId}/emergency-clock`, {
                    method: 'POST',
                    body: JSON.stringify({ allow: allow })
                });

                const data = await response.json();
                if (data.success) {
                    alert(data.message);
                    // Refresh the staff list modal
                    loadTracking();
                    setTimeout(() => showStaffList('not_signed_in'), 500);
                } else {
                    alert('Error: ' + (data.error || 'Failed to toggle emergency permission'));
                }
            } catch (error) {
                alert('Error toggling emergency permission: ' + error.message);
            }
        }

        async function signInOnBehalf(staffId, staffName) {
            if (!confirm(`Sign in ${staffName} now?`)) return;

            try {
                const response = await apiCall('/api/admin/signin-on-behalf', {
                    method: 'POST',
                    body: JSON.stringify({ staff_id: staffId })
                });

                const data = await response.json();
                if (data.success) {
                    alert(data.message);
                    loadTracking();
                    closeModal('staffListModal');
                } else {
                    alert('Error: ' + (data.error || 'Failed to sign in'));
                }
            } catch (error) {
                alert('Error signing in: ' + error.message);
            }
        }

        async function signOutOnBehalf(staffId, staffName) {
            try {
                const response = await apiCall('/api/admin/signout-on-behalf', {
                    method: 'POST',
                    body: JSON.stringify({ staff_id: staffId })
                });

                const data = await response.json();
                if (data.success) {
                    // Silent success - just refresh
                    loadTracking();
                    closeModal('staffListModal');
                } else {
                    alert('Error: ' + (data.error || 'Failed to sign out'));
                }
            } catch (error) {
                alert('Error signing out: ' + error.message);
            }
        }

        if (document.getElementById('whereaboutsForm')) {
            document.getElementById('whereaboutsForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const staffId = document.getElementById('whereaboutsStaff').value;
                const reason = document.getElementById('whereaboutsReason').value;

                try {
                    const response = await apiCall('/api/location/request', {
                        method: 'POST',
                        body: JSON.stringify({
                            staff_id: parseInt(staffId),
                            reason: reason || 'Whereabouts check'
                        })
                    });

                    const data = await response.json();
                    if (data.success) {
                        alert('SMS sent successfully!');
                        closeModal('whereaboutsModal');
                        loadTracking();
                    } else {
                        alert('Error: ' + (data.error || 'Failed to send SMS'));
                    }
                } catch (error) {
                    alert('Error sending whereabouts request');
                }
            });
        }

        // ===== LEAVE =====
        async function loadLeave() {
            // Load all leave data in parallel
            const [todayRes, upcomingRes, statsRes] = await Promise.all([
                apiCall('/api/leave/today'),
                apiCall('/api/leave/upcoming'),
                apiCall('/api/leave/stats')
            ]);

            const today = await todayRes.json();
            const upcoming = await upcomingRes.json();
            const stats = await statsRes.json();

            // Update summary cards
            document.getElementById('leaveOnLeaveToday').textContent = today.length;
            document.getElementById('leaveUpcoming').textContent = upcoming.length;
            document.getElementById('leaveBookedYear').textContent = stats.booked_leave_days || 0;
            document.getElementById('leaveSickYear').textContent = stats.sick_leave_days || 0;

            // Render today's leave
            const todayContainer = document.getElementById('leaveToday');
            if (today.length === 0) {
                todayContainer.innerHTML = '<p style="color: #6b7280; text-align: center;">No one on leave today</p>';
            } else {
                todayContainer.innerHTML = today.map(r => {
                    const typeLabel = r.leave_type === 'L' ? 'Booked Leave' : 'Sick Leave';
                    const typeColor = r.leave_type === 'L' ? '#10b981' : '#f59e0b';
                    return '<div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: white; border-radius: 6px; margin-bottom: 0.5rem;">' +
                        '<div><strong>' + r.staff_name + '</strong> <span style="color: #6b7280;">(' + (r.site_name || 'No Site') + ')</span></div>' +
                        '<div style="display: flex; align-items: center; gap: 0.5rem;">' +
                        '<span style="background: ' + typeColor + '; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem;">' + typeLabel + '</span>' +
                        (r.reason ? '<span style="color: #6b7280; font-size: 0.9rem;">' + r.reason + '</span>' : '') +
                        '</div></div>';
                }).join('');
            }

            // Render upcoming leave
            const upcomingContainer = document.getElementById('leaveUpcomingList');
            if (upcoming.length === 0) {
                upcomingContainer.innerHTML = '<p style="color: #6b7280; text-align: center;">No upcoming leave booked</p>';
            } else {
                upcomingContainer.innerHTML = upcoming.map(r => {
                    const leaveDate = new Date(r.leave_date);
                    const dateStr = leaveDate.toLocaleDateString('en-ZA', { weekday: 'short', day: 'numeric', month: 'short' });
                    const typeLabel = r.leave_type === 'L' ? 'L' : 'S';
                    const typeColor = r.leave_type === 'L' ? '#10b981' : '#f59e0b';
                    return '<div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: white; border-radius: 6px; margin-bottom: 0.5rem;">' +
                        '<div><strong>' + dateStr + '</strong> - ' + r.staff_name + ' <span style="color: #6b7280;">(' + (r.site_name || 'No Site') + ')</span></div>' +
                        '<div style="display: flex; align-items: center; gap: 0.5rem;">' +
                        '<span style="background: ' + typeColor + '; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem;">' + typeLabel + '</span>' +
                        '<button class="btn btn-small" style="background: #dc2626; color: white;" onclick="cancelLeave(' + r.id + ')">Cancel</button>' +
                        '</div></div>';
                }).join('');
            }

            // Populate site filter dropdown
            const siteFilter = document.getElementById('leaveFilterSite');
            const currentSiteValue = siteFilter.value;
            const uniqueSites = [...new Set(allStaff.map(s => s.site_name).filter(Boolean))].sort();
            siteFilter.innerHTML = '<option value="">All Sites</option>' +
                uniqueSites.map(site => '<option value="' + site + '">' + site + '</option>').join('');
            siteFilter.value = currentSiteValue;

            // Populate staff filter dropdown (show all for history search)
            const staffFilter = document.getElementById('leaveFilterStaff');
            const currentValue = staffFilter.value;
            const selectedSite = siteFilter.value;
            const filteredStaff = selectedSite ? allStaff.filter(s => s.site_name === selectedSite) : allStaff;
            staffFilter.innerHTML = '<option value="">All Staff</option>' +
                filteredStaff.map(s => '<option value="' + s.id + '">' + s.full_name + (s.is_active ? '' : ' (Inactive)') + '</option>').join('');
            staffFilter.value = currentValue;

            // Populate staff dropdown in modal (active only for new bookings)
            const staffSelect = document.getElementById('leaveStaffSelect');
            staffSelect.innerHTML = '<option value="">Select staff...</option>' +
                allStaff.filter(s => s.is_active).map(s => '<option value="' + s.id + '">' + s.full_name + '</option>').join('');

            // Load history
            loadLeaveHistory();
        }

        async function loadLeaveHistory() {
            const siteFilter = document.getElementById('leaveFilterSite').value;
            const staffId = document.getElementById('leaveFilterStaff').value;
            const leaveType = document.getElementById('leaveFilterType').value;
            const month = document.getElementById('leaveFilterMonth').value;

            let url = '/api/leave?';
            if (staffId) url += 'staff_id=' + staffId + '&';
            if (leaveType) url += 'leave_type=' + leaveType + '&';
            if (month) {
                const [year, monthNum] = month.split('-');
                const startDate = year + '-' + monthNum + '-01';
                const endDate = new Date(year, monthNum, 0).toISOString().split('T')[0];
                url += 'start_date=' + startDate + '&end_date=' + endDate + '&';
            }

            const response = await apiCall(url);
            let records = await response.json();

            // Filter by site client-side
            if (siteFilter) {
                records = records.filter(r => r.site_name === siteFilter);
            }

            const tbody = document.getElementById('leaveHistoryTable');
            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #6b7280;">No leave records found</td></tr>';
            } else {
                tbody.innerHTML = records.map(r => {
                    const leaveDate = new Date(r.leave_date);
                    const dateStr = leaveDate.toLocaleDateString('en-ZA', { day: 'numeric', month: 'short', year: 'numeric' });
                    const typeLabel = r.leave_type === 'L' ? 'Booked' : 'Sick';
                    const typeColor = r.leave_type === 'L' ? '#10b981' : '#f59e0b';
                    const statusBadge = r.status === 'cancelled' ? '<span style="background: #dc2626; color: white; padding: 0.1rem 0.3rem; border-radius: 3px; font-size: 0.7rem; margin-left: 0.5rem;">Cancelled</span>' : '';

                    return '<tr>' +
                        '<td>' + dateStr + '</td>' +
                        '<td>' + r.staff_name + '</td>' +
                        '<td>' + (r.site_name || '-') + '</td>' +
                        '<td><span style="background: ' + typeColor + '; color: white; padding: 0.2rem 0.5rem; border-radius: 4px;">' + typeLabel + '</span>' + statusBadge + '</td>' +
                        '<td>' + (r.reason || '-') + '</td>' +
                        '<td>' + (r.status !== 'cancelled' ? '<button class="btn btn-small" style="background: #dc2626; color: white;" onclick="cancelLeave(' + r.id + ')">Cancel</button>' : '') + '</td>' +
                        '</tr>';
                }).join('');
            }
        }

        function filterLeaveBysite() {
            // Update staff dropdown based on selected site
            const selectedSite = document.getElementById('leaveFilterSite').value;
            const staffFilter = document.getElementById('leaveFilterStaff');
            const filteredStaff = selectedSite ? allStaff.filter(s => s.site_name === selectedSite) : allStaff;
            staffFilter.innerHTML = '<option value="">All Staff</option>' +
                filteredStaff.map(s => '<option value="' + s.id + '">' + s.full_name + (s.is_active ? '' : ' (Inactive)') + '</option>').join('');
            // Reload history with new filter
            loadLeaveHistory();
        }

        function showBookLeaveModal() {
            document.getElementById('bookLeaveForm').reset();
            document.getElementById('leaveDateEndGroup').style.display = 'none';
            // Set default date to today
            document.getElementById('leaveDateStart').value = new Date().toISOString().split('T')[0];
            showModal('bookLeaveModal');
        }

        function toggleLeaveDateRange() {
            const isMultiple = document.getElementById('leaveMultipleDays').checked;
            document.getElementById('leaveDateEndGroup').style.display = isMultiple ? 'block' : 'none';
            if (isMultiple) {
                document.getElementById('leaveDateEnd').value = document.getElementById('leaveDateStart').value;
            }
        }

        document.getElementById('bookLeaveForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const staffId = document.getElementById('leaveStaffSelect').value;
            const leaveType = document.getElementById('leaveTypeSelect').value;
            const startDate = document.getElementById('leaveDateStart').value;
            const isMultiple = document.getElementById('leaveMultipleDays').checked;
            const endDate = isMultiple ? document.getElementById('leaveDateEnd').value : startDate;
            const reason = document.getElementById('leaveReason').value;

            // Generate array of dates
            const leaveDates = [];
            let currentDate = new Date(startDate);
            const lastDate = new Date(endDate);

            while (currentDate <= lastDate) {
                leaveDates.push(currentDate.toISOString().split('T')[0]);
                currentDate.setDate(currentDate.getDate() + 1);
            }

            const response = await apiCall('/api/leave', {
                method: 'POST',
                body: JSON.stringify({
                    staff_id: staffId,
                    leave_type: leaveType,
                    leave_dates: leaveDates,
                    reason: reason
                })
            });

            const result = await response.json();

            if (response.ok) {
                closeModal('bookLeaveModal');
                alert('Leave booked: ' + result.created.length + ' day(s)' + (result.skipped.length > 0 ? ' (' + result.skipped.length + ' already booked)' : ''));
                loadLeave();
            } else {
                alert('Error: ' + (result.error || 'Failed to book leave'));
            }
        });

        async function cancelLeave(leaveId) {
            if (!confirm('Cancel this leave record?')) return;

            const response = await apiCall('/api/leave/' + leaveId, {
                method: 'DELETE'
            });

            if (response.ok) {
                loadLeave();
            } else {
                alert('Error cancelling leave');
            }
        }

        // ===== CONFIG =====
        async function loadConfig() {
            try {
                const response = await apiCall('/api/config');
                const data = await response.json();

                document.getElementById('configAdminName').value = data.admin_name || '';
                document.getElementById('configAdminEmail').value = data.admin_email || '';
                document.getElementById('configAdminMobile').value = data.admin_mobile || '';
                document.getElementById('configCompanyName').value = data.company_name || '';
                document.getElementById('configPublicUrl').value = data.public_url || '';
                document.getElementById('configNotifySignin').checked = data.notify_signin !== false;
                document.getElementById('configNotifySignout').checked = data.notify_signout !== false;
                document.getElementById('configNotifyLocation').checked = data.notify_location !== false;

                // Time window settings
                document.getElementById('configClockinTime').value = data.clockin_time || '07:20';
                document.getElementById('configClockinStart').value = data.clockin_window_start || '07:00';
                document.getElementById('configClockinEnd').value = data.clockin_window_end || '09:00';
                document.getElementById('configEnforceClockin').checked = data.enforce_clockin_window !== false;
                document.getElementById('configClockoutTime').value = data.clockout_time || '16:30';
                document.getElementById('configClockoutStart').value = data.clockout_window_start || '16:15';
                document.getElementById('configClockoutEnd').value = data.clockout_window_end || '16:45';
                document.getElementById('configEnforceClockout').checked = data.enforce_clockout_window !== false;
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }

        async function saveTimeWindows() {
            try {
                const response = await apiCall('/api/config', {
                    method: 'POST',
                    body: JSON.stringify({
                        clockin_time: document.getElementById('configClockinTime').value,
                        clockin_window_start: document.getElementById('configClockinStart').value,
                        clockin_window_end: document.getElementById('configClockinEnd').value,
                        enforce_clockin_window: document.getElementById('configEnforceClockin').checked,
                        clockout_time: document.getElementById('configClockoutTime').value,
                        clockout_window_start: document.getElementById('configClockoutStart').value,
                        clockout_window_end: document.getElementById('configClockoutEnd').value,
                        enforce_clockout_window: document.getElementById('configEnforceClockout').checked
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert('Time windows saved!');
                } else {
                    alert('Error: ' + (data.error || 'Failed to save'));
                }
            } catch (error) {
                alert('Error saving time windows');
            }
        }

        if (document.getElementById('configForm')) {
            document.getElementById('configForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                try {
                    const response = await apiCall('/api/config', {
                        method: 'POST',
                        body: JSON.stringify({
                            admin_name: document.getElementById('configAdminName').value,
                            admin_email: document.getElementById('configAdminEmail').value,
                            admin_mobile: document.getElementById('configAdminMobile').value,
                            company_name: document.getElementById('configCompanyName').value,
                            notify_signin: document.getElementById('configNotifySignin').checked,
                            notify_signout: document.getElementById('configNotifySignout').checked,
                            notify_location: document.getElementById('configNotifyLocation').checked
                        })
                    });

                    const data = await response.json();
                    if (data.success) {
                        alert('Configuration saved successfully!');
                    } else {
                        alert('Error: ' + (data.error || 'Failed to save'));
                    }
                } catch (error) {
                    alert('Error saving configuration');
                }
            });
        }

        async function savePublicUrl() {
            try {
                const response = await apiCall('/api/config/public-url', {
                    method: 'POST',
                    body: JSON.stringify({
                        public_url: document.getElementById('configPublicUrl').value
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert('Public URL saved successfully!');
                } else {
                    alert('Error: ' + (data.error || 'Failed to save'));
                }
            } catch (error) {
                alert('Error saving public URL');
            }
        }


        // ===== ADMIN TAB FUNCTIONS =====

        // Store points config globally for calculations
        // Fair system: 10 points = 1 hour of individual's pay rate
        let pointsPerHour = 10;

        async function loadAdmin() {
            // Load all admin tab data (including Users)
            await Promise.all([
                loadUsers(),
                loadPointsConfig(),
                loadStandbyConfig(),
                loadRewardsPenalties(),
                loadNoWorkDays(),
                loadAdminSiteDropdown(),
                loadAllStaffForRPFilter(),
                loadPayPeriodsForRP()
            ]);
        }

        // Load pay periods for Reward/Penalty form
        async function loadPayPeriodsForRP() {
            const token = localStorage.getItem('wagepro_token');
            if (!token) return;

            const select = document.getElementById('rpPayPeriod');
            if (!select) return;

            try {
                const response = await fetch('/api/pay-periods', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const periods = await response.json();

                select.innerHTML = '<option value="">Select pay period...</option>';

                if (Array.isArray(periods)) {
                    // Sort by start_date descending (most recent first)
                    periods.sort((a, b) => new Date(b.start_date) - new Date(a.start_date));

                    periods.forEach(period => {
                        const startDate = new Date(period.start_date).toLocaleDateString();
                        const endDate = new Date(period.end_date).toLocaleDateString();
                        const status = period.status || 'unknown';
                        const isCurrent = status === 'active' || status === 'draft';

                        const opt = document.createElement('option');
                        opt.value = period.id;
                        opt.textContent = `${startDate} - ${endDate}${isCurrent ? ' (CURRENT)' : ''}`;
                        if (isCurrent) opt.selected = true;
                        select.appendChild(opt);
                    });
                }
            } catch (error) {
                console.error('Failed to load pay periods:', error);
            }
        }

        async function loadAdminSiteDropdown() {
            const token = localStorage.getItem('wagepro_token');
            if (!token) return;

            try {
                const response = await fetch('/api/sites?active_only=true', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const sites = await response.json();

                // Populate filter dropdown
                const filterSelect = document.getElementById('rpFilterSite');
                if (filterSelect && Array.isArray(sites)) {
                    filterSelect.innerHTML = '<option value="">All Sites</option>';
                    sites.forEach(site => {
                        filterSelect.innerHTML += `<option value="${site.id}">${site.name}</option>`;
                    });
                }

                // Populate modal dropdowns
                const rpSiteSelect = document.getElementById('rpSiteSelect');
                if (rpSiteSelect && Array.isArray(sites)) {
                    rpSiteSelect.innerHTML = '<option value="">Select site...</option>';
                    sites.forEach(site => {
                        rpSiteSelect.innerHTML += `<option value="${site.id}">${site.name}</option>`;
                    });
                }

                // Load staff for modal
                const staffResponse = await fetch('/api/staff', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const staffData = await staffResponse.json();
                const rpStaffSelect = document.getElementById('rpStaffSelect');
                if (rpStaffSelect && Array.isArray(staffData)) {
                    rpStaffSelect.innerHTML = '<option value="">Select staff...</option>';
                    staffData.forEach(s => {
                        rpStaffSelect.innerHTML += `<option value="${s.id}">${s.first_name} ${s.last_name} (${s.site_name || 'No site'})</option>`;
                    });
                }
            } catch (error) {
                console.error('Failed to load admin dropdowns:', error);
            }
        }

        async function loadPointsConfig() {
            const token = localStorage.getItem('wagepro_token');
            if (!token) return;

            try {
                const response = await fetch('/api/admin/points-config', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.success && data.config) {
                    const config = data.config;

                    // Helper to get value from nested config object
                    const getValue = (key, defaultVal = '') => {
                        if (config[key] && config[key].value !== undefined) {
                            return config[key].value;
                        }
                        return defaultVal;
                    };

                    // Store points per hour globally (default: 10 points = 1 hour)
                    pointsPerHour = parseFloat(getValue('points_per_hour', '10')) || 10;

                    // Populate form fields with actual saved values
                    document.getElementById('configPointsPerHour').value = getValue('points_per_hour', '10');
                    document.getElementById('configPerfectAttendance').value = getValue('perfect_attendance_points', '');
                    document.getElementById('configTimelyClockIn').value = getValue('timely_clockin_points', '');
                    document.getElementById('configEarlyArrival').value = getValue('early_arrival_points', '');
                    document.getElementById('configLateClockIn').value = getValue('late_clockin_points', '');
                    document.getElementById('configAbsenteeism').value = getValue('absenteeism_points', '');
                    document.getElementById('configEarlyDeparture').value = getValue('early_departure_points', '');
                    document.getElementById('configLateThreshold').value = getValue('late_threshold_minutes', '');
                    document.getElementById('configAutoGenerate').value = getValue('auto_generate_points', 'true');

                    console.log('Points config loaded:', config);
                }
            } catch (error) {
                console.error('Failed to load points config:', error);
            }
        }

        async function savePointsConfig() {
            const token = localStorage.getItem('wagepro_token');
            if (!token) {
                alert('Please log in first');
                return;
            }

            const config = {
                points_per_hour: document.getElementById('configPointsPerHour').value,
                perfect_attendance_points: document.getElementById('configPerfectAttendance').value,
                timely_clockin_points: document.getElementById('configTimelyClockIn').value,
                early_arrival_points: document.getElementById('configEarlyArrival').value,
                late_clockin_points: document.getElementById('configLateClockIn').value,
                absenteeism_points: document.getElementById('configAbsenteeism').value,
                early_departure_points: document.getElementById('configEarlyDeparture').value,
                late_threshold_minutes: document.getElementById('configLateThreshold').value,
                auto_generate_points: document.getElementById('configAutoGenerate').value
            };

            try {
                const response = await fetch('/api/admin/points-config', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                const data = await response.json();
                if (data.success) {
                    alert('Points configuration saved successfully!');
                    pointsToRandRate = parseFloat(config.points_to_rand_rate) || 5.0;
                } else {
                    alert('Failed to save: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to save points config:', error);
                alert('Failed to save configuration');
            }
        }

        // Standby config functions
        async function loadStandbyConfig() {
            const token = localStorage.getItem('wagepro_token');
            if (!token) return;

            try {
                const response = await fetch('/api/admin/standby-config', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.success) {
                    document.getElementById('configStandbyDailyRate').value = data.standby_daily_rate || 150;
                    document.getElementById('currentStandbyRate').textContent = `Current: R${parseFloat(data.standby_daily_rate || 150).toFixed(2)}`;
                }
            } catch (error) {
                console.error('Failed to load standby config:', error);
            }
        }

        async function saveStandbyConfig() {
            const token = localStorage.getItem('wagepro_token');
            if (!token) {
                alert('Please log in first');
                return;
            }

            const rate = parseFloat(document.getElementById('configStandbyDailyRate').value);
            if (isNaN(rate) || rate < 0) {
                alert('Please enter a valid rate');
                return;
            }

            try {
                const response = await fetch('/api/admin/standby-config', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ standby_daily_rate: rate })
                });

                const data = await response.json();
                if (data.success) {
                    document.getElementById('currentStandbyRate').textContent = `Current: R${rate.toFixed(2)}`;
                    alert('Standby rate saved: R' + rate.toFixed(2));
                } else {
                    alert('Failed to save: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to save standby config:', error);
                alert('Failed to save configuration');
            }
        }

        // Handle site filter change - load staff for selected site (or all staff)
        async function onRPSiteFilterChange() {
            const token = localStorage.getItem('wagepro_token');
            const siteId = document.getElementById('rpFilterSite')?.value || '';
            const staffSelect = document.getElementById('rpFilterStaff');

            // Reset staff dropdown
            staffSelect.innerHTML = '<option value="">All Staff</option>';

            try {
                let url = siteId ? `/api/sites/${siteId}/staff` : '/api/staff';
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                // Handle both response formats
                const staffList = data.staff || data;
                if (Array.isArray(staffList)) {
                    staffList.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s.id;
                        opt.textContent = s.name || s.full_name;
                        staffSelect.appendChild(opt);
                    });
                }
            } catch (error) {
                console.error('Failed to load staff:', error);
            }

            // Reload the rewards/penalties with new filters
            loadRewardsPenalties();
        }

        // Load all staff on Admin tab init
        async function loadAllStaffForRPFilter() {
            const token = localStorage.getItem('wagepro_token');
            const staffSelect = document.getElementById('rpFilterStaff');
            if (!staffSelect) return;

            staffSelect.innerHTML = '<option value="">All Staff</option>';

            try {
                const response = await fetch('/api/staff', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (Array.isArray(data)) {
                    data.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s.id;
                        opt.textContent = s.name || s.full_name;
                        staffSelect.appendChild(opt);
                    });
                }
            } catch (error) {
                console.error('Failed to load all staff:', error);
            }
        }

        async function loadRewardsPenalties() {
            const token = localStorage.getItem('wagepro_token');
            if (!token) return;

            const status = document.getElementById('rpFilterStatus')?.value || '';
            const type = document.getElementById('rpFilterType')?.value || '';
            const siteId = document.getElementById('rpFilterSite')?.value || '';
            const staffId = document.getElementById('rpFilterStaff')?.value || '';

            let url = '/api/admin/rewards-penalties?';
            if (status) url += `status=${status}&`;
            if (type) url += `type=${type}&`;
            if (siteId) url += `site_id=${siteId}&`;
            if (staffId) url += `staff_id=${staffId}&`;

            try {
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                const tbody = document.getElementById('rewardsPenaltiesTable');
                if (!data.success || !data.items || data.items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #6b7280;">No rewards or penalties found</td></tr>';
                    updateRewardsPenaltiesSummary([]);
                    return;
                }

                // Filter out cancelled items unless specifically filtering for cancelled
                let displayItems = data.items;
                if (!status || status !== 'cancelled') {
                    displayItems = data.items.filter(item => item.status !== 'cancelled');
                }

                if (displayItems.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #6b7280;">No active rewards or penalties found</td></tr>';
                    updateRewardsPenaltiesSummary([]);
                    return;
                }

                tbody.innerHTML = displayItems.map(item => {
                    const isReward = item.points > 0;
                    const pointsColor = isReward ? '#10b981' : '#dc2626';
                    // Fair system: points / pointsPerHour = hours equivalent
                    const hoursEquiv = (Math.abs(item.points) / pointsPerHour).toFixed(1);
                    const statusBadge = getStatusBadge(item.status);
                    const targetName = item.staff_name || item.site_name || 'Company-wide';
                    const categoryDisplay = item.category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

                    return `
                        <tr>
                            <td>${new Date(item.created_at).toLocaleDateString()}</td>
                            <td>${targetName}</td>
                            <td>${categoryDisplay}</td>
                            <td style="color: ${pointsColor}; font-weight: bold;">${item.points > 0 ? '+' : ''}${item.points}</td>
                            <td style="color: ${pointsColor};">${isReward ? '+' : '-'}${hoursEquiv} hr</td>
                            <td><span style="background: ${item.source === 'system' ? '#dbeafe' : '#fef3c7'}; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">${item.source}</span></td>
                            <td>${statusBadge}</td>
                            <td>
                                ${item.status === 'pending' ? `
                                    <button class="btn btn-small" onclick="approveRewardPenalty(${item.id})" style="background: #10b981; color: white; padding: 4px 8px; font-size: 0.75rem;">Approve</button>
                                    <button class="btn btn-small" onclick="cancelRewardPenalty(${item.id})" style="background: #dc2626; color: white; padding: 4px 8px; font-size: 0.75rem;">Cancel</button>
                                ` : item.status === 'approved' ? `
                                    <button class="btn btn-small" onclick="cancelRewardPenalty(${item.id})" style="background: #6b7280; color: white; padding: 4px 8px; font-size: 0.75rem;">Cancel</button>
                                ` : '-'}
                            </td>
                        </tr>
                    `;
                }).join('');

                updateRewardsPenaltiesSummary(displayItems);

            } catch (error) {
                console.error('Failed to load rewards/penalties:', error);
                document.getElementById('rewardsPenaltiesTable').innerHTML = '<tr><td colspan="8" style="text-align: center; color: #dc2626;">Failed to load</td></tr>';
            }
        }

        function getStatusBadge(status) {
            const styles = {
                pending: 'background: #fef3c7; color: #92400e;',
                approved: 'background: #d1fae5; color: #065f46;',
                cancelled: 'background: #fee2e2; color: #991b1b;',
                applied: 'background: #dbeafe; color: #1e40af;'
            };
            return `<span style="${styles[status] || ''}; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem;">${status}</span>`;
        }

        function updateRewardsPenaltiesSummary(items) {
            let totalRewards = 0;
            let totalPenalties = 0;
            let pendingCount = 0;
            let netPoints = 0;

            // Only count non-cancelled items
            items.forEach(item => {
                if (item.status === 'cancelled') return; // Skip cancelled

                if (item.points > 0) {
                    totalRewards += item.points;
                } else {
                    totalPenalties += Math.abs(item.points);
                }
                if (item.status === 'pending') pendingCount++;
                if (item.status === 'approved' || item.status === 'applied') {
                    netPoints += item.points;
                }
            });

            document.getElementById('summaryTotalRewards').textContent = totalRewards;
            document.getElementById('summaryTotalPenalties').textContent = totalPenalties;
            document.getElementById('summaryPendingCount').textContent = pendingCount;
            document.getElementById('summaryNetPoints').textContent = netPoints >= 0 ? `+${netPoints}` : netPoints;
        }

        async function approveRewardPenalty(id) {
            const token = localStorage.getItem('wagepro_token');
            if (!confirm('Approve this reward/penalty?')) return;

            try {
                const response = await fetch(`/api/admin/rewards-penalties/${id}/approve`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (data.success) {
                    loadRewardsPenalties();
                } else {
                    alert('Failed to approve: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to approve:', error);
                alert('Failed to approve');
            }
        }

        async function cancelRewardPenalty(id) {
            const token = localStorage.getItem('wagepro_token');
            if (!confirm('Cancel this reward/penalty?')) return;

            try {
                const response = await fetch(`/api/admin/rewards-penalties/${id}/cancel`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (data.success) {
                    loadRewardsPenalties();
                } else {
                    alert('Failed to cancel: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to cancel:', error);
                alert('Failed to cancel');
            }
        }

        function updateRPTargetOptions() {
            const targetType = document.getElementById('rpTargetType').value;
            const staffGroup = document.getElementById('rpStaffGroup');
            const siteGroup = document.getElementById('rpSiteGroup');
            const staffSelect = document.getElementById('rpStaffSelect');
            const siteSelect = document.getElementById('rpSiteSelect');

            if (targetType === 'individual') {
                staffGroup.style.display = 'block';
                siteGroup.style.display = 'none';
                staffSelect.required = true;
                siteSelect.required = false;
            } else if (targetType === 'site') {
                staffGroup.style.display = 'none';
                siteGroup.style.display = 'block';
                staffSelect.required = false;
                siteSelect.required = true;
            } else {
                // company-wide
                staffGroup.style.display = 'none';
                siteGroup.style.display = 'none';
                staffSelect.required = false;
                siteSelect.required = false;
            }
        }

        // Penalty categories (negative points)
        const penaltyCategories = ['late_clockin', 'absenteeism', 'early_departure', 'negligence', 'misconduct', 'other_penalty'];

        function updateRPPointsPreview() {
            const category = document.getElementById('rpCategory')?.value || '';
            const isPenalty = penaltyCategories.includes(category);
            const points = parseInt(document.getElementById('rpPoints')?.value) || 0;

            // Update UI to show reward vs penalty
            const signSpan = document.getElementById('rpPointsSign');
            const hintSpan = document.getElementById('rpPointsHint');

            if (isPenalty) {
                signSpan.textContent = '(-)';
                signSpan.style.color = '#dc2626';
                hintSpan.textContent = 'This is a PENALTY - points will be deducted';
                hintSpan.style.color = '#dc2626';
            } else {
                signSpan.textContent = '(+)';
                signSpan.style.color = '#10b981';
                hintSpan.textContent = 'This is a REWARD - points will be added';
                hintSpan.style.color = '#10b981';
            }

            // Fair system: points / pointsPerHour = hours equivalent
            const hoursEquiv = (Math.abs(points) / pointsPerHour).toFixed(1);
            const prefix = isPenalty ? '-' : '+';
            document.getElementById('rpHoursPreview').textContent = `${prefix}${hoursEquiv} hr`;
            document.getElementById('rpHoursPreview').style.color = isPenalty ? '#dc2626' : '#10b981';
        }

        // Add event listener for points input
        document.addEventListener('DOMContentLoaded', function() {
            const rpPointsInput = document.getElementById('rpPoints');
            if (rpPointsInput) {
                rpPointsInput.addEventListener('input', updateRPPointsPreview);
            }
        });

        // Handle Add Reward/Penalty form submission
        document.getElementById('addRewardPenaltyForm')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            const token = localStorage.getItem('wagepro_token');
            if (!token) {
                alert('Please log in first');
                return;
            }

            const targetType = document.getElementById('rpTargetType').value;
            const category = document.getElementById('rpCategory').value;
            const isPenalty = penaltyCategories.includes(category);
            let points = Math.abs(parseInt(document.getElementById('rpPoints').value) || 0);

            // Auto-apply negative sign for penalties
            if (isPenalty) {
                points = -points;
            }

            const payPeriodId = document.getElementById('rpPayPeriod').value;
            if (!payPeriodId) {
                alert('Please select a pay period');
                return;
            }

            const payload = {
                category: category,
                points: points,
                pay_period_id: parseInt(payPeriodId),
                description: document.getElementById('rpDescription').value,
                reference_count: document.getElementById('rpReferenceCount').value || null
            };

            if (targetType === 'individual') {
                payload.staff_id = parseInt(document.getElementById('rpStaffSelect').value);
            } else if (targetType === 'site') {
                payload.site_id = parseInt(document.getElementById('rpSiteSelect').value);
            }
            // For company-wide, both staff_id and site_id are null

            try {
                const response = await fetch('/api/admin/rewards-penalties', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                if (data.success) {
                    alert('Reward/Penalty added successfully!');
                    closeModal('addRewardPenaltyModal');
                    document.getElementById('addRewardPenaltyForm').reset();
                    loadRewardsPenalties();
                } else {
                    alert('Failed to add: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to add reward/penalty:', error);
                alert('Failed to add reward/penalty');
            }
        });


        // ===== NO WORK DAYS MANAGEMENT =====

        async function loadNoWorkDays() {
            const token = localStorage.getItem('wagepro_token');
            if (!token) {
                console.error('No token for loadNoWorkDays');
                return;
            }

            try {
                // Load sites for dropdown (only active sites)
                const sitesResponse = await fetch('/api/sites?active_only=true', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const sitesData = await sitesResponse.json();
                // API returns array directly, not {sites: [...]}
                if (Array.isArray(sitesData) && sitesData.length > 0) {
                    const siteSelect = document.getElementById('noWorkSite');
                    siteSelect.innerHTML = '<option value="">All Sites (Company-wide)</option>';
                    sitesData.forEach(site => {
                        siteSelect.innerHTML += `<option value="${site.id}">${site.name}</option>`;
                    });
                }

                // Load no work days
                const response = await fetch('/api/admin/no-work-days', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                const tbody = document.getElementById('noWorkDaysTable');

                if (!data.success || !data.no_work_days || data.no_work_days.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #10b981;">No upcoming no-work days</td></tr>';
                    return;
                }

                tbody.innerHTML = data.no_work_days.map(day => {
                    const ackPct = day.total_staff > 0 ? Math.round((day.acknowledgments / day.total_staff) * 100) : 0;
                    const ackColor = ackPct === 100 ? '#10b981' : (ackPct > 50 ? '#f59e0b' : '#ef4444');

                    // SMS status display
                    let smsStatus;
                    if (day.sms_scheduled_for) {
                        // Extract just the time (HH:MM) from scheduled datetime
                        const schedTime = day.sms_scheduled_for.split(' ')[1] || '07:00';
                        smsStatus = `<span style="color:#f59e0b;" title="Scheduled for ${day.sms_scheduled_for}">Scheduled ${schedTime}</span>`;
                    } else if (day.sms_sent) {
                        smsStatus = '<span style="color:#10b981;">Sent</span>';
                    } else {
                        smsStatus = '<span style="color:#ef4444;">No</span>';
                    }

                    return `<tr>
                        <td><strong>${day.date}</strong></td>
                        <td>${day.site_name}</td>
                        <td><span style="background: #fef2f2; color: #dc2626; padding: 2px 8px; border-radius: 4px; font-size: 0.8em;">${day.day_type}</span></td>
                        <td>${day.reason}</td>
                        <td>${smsStatus}</td>
                        <td style="color: ${ackColor};">${day.acknowledgments}/${day.total_staff} (${ackPct}%)</td>
                        <td>
                            <button onclick="viewAcknowledgments(${day.id})" class="btn btn-small" style="background: #3b82f6; margin-right: 5px;">View</button>
                            <button onclick="deleteNoWorkDay(${day.id})" class="btn btn-small" style="background: #ef4444;">Cancel</button>
                        </td>
                    </tr>`;
                }).join('');

            } catch (error) {
                console.error('Failed to load no-work days:', error);
                document.getElementById('noWorkDaysTable').innerHTML = '<tr><td colspan="7" style="text-align: center; color: #ef4444;">Failed to load</td></tr>';
            }
        }

        async function createNoWorkDay() {
            const token = localStorage.getItem('wagepro_token');
            if (!token) {
                alert('Not logged in. Please refresh and log in again.');
                return;
            }

            const date = document.getElementById('noWorkDate').value;
            const siteId = document.getElementById('noWorkSite').value;
            const dayType = document.getElementById('noWorkType').value;
            const reason = document.getElementById('noWorkReason').value;
            const message = document.getElementById('noWorkMessage').value;
            const sendSms = document.getElementById('noWorkSendSMS').checked;

            if (!date) {
                alert('Please select a date');
                return;
            }
            if (!reason) {
                alert('Please enter a reason');
                return;
            }

            try {
                const response = await fetch('/api/admin/no-work-days', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        dates: [date],
                        site_id: siteId ? parseInt(siteId) : null,
                        day_type: dayType,
                        reason: reason,
                        message: message,
                        send_sms: sendSms
                    })
                });

                const data = await response.json();

                if (data.success) {
                    let msg = `No-work day created for ${date}`;
                    if (sendSms) {
                        msg += `\n\nSMS sent to ${data.sms_sent} staff members`;
                        if (data.sms_failed > 0) {
                            msg += ` (${data.sms_failed} failed)`;
                        }
                    }
                    alert(msg);

                    // Clear form
                    document.getElementById('noWorkDate').value = '';
                    document.getElementById('noWorkReason').value = '';
                    document.getElementById('noWorkMessage').value = '';

                    // Reload list
                    loadNoWorkDays();
                } else {
                    alert('Failed to create: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to create no-work day:', error);
                alert('Error creating no-work day');
            }
        }

        async function deleteNoWorkDay(id) {
            if (!confirm('Are you sure you want to cancel this no-work day?')) return;

            const token = localStorage.getItem('wagepro_token');
            if (!token) {
                alert('Not logged in. Please refresh and log in again.');
                return;
            }

            try {
                const response = await fetch(`/api/admin/no-work-days/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (data.success) {
                    alert('No-work day cancelled');
                    loadNoWorkDays();
                } else {
                    alert('Failed to cancel: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to cancel no-work day:', error);
                alert('Error cancelling no-work day');
            }
        }

        async function viewAcknowledgments(id) {
            const token = localStorage.getItem('wagepro_token');
            if (!token) {
                alert('Not logged in. Please refresh and log in again.');
                return;
            }

            try {
                const response = await fetch(`/api/admin/no-work-days/${id}/acknowledgments`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (!data.success) {
                    alert('Failed to load acknowledgments');
                    return;
                }

                let msg = `No Work Day: ${data.no_work_day.date}\n`;
                msg += `Reason: ${data.no_work_day.reason}\n\n`;
                msg += `=== ACKNOWLEDGED (${data.summary.acknowledged}/${data.summary.total}) ===\n`;

                if (data.acknowledged.length > 0) {
                    data.acknowledged.forEach(s => {
                        msg += `‚úì ${s.name}\n`;
                    });
                } else {
                    msg += '(none)\n';
                }

                msg += `\n=== NOT YET ACKNOWLEDGED (${data.summary.pending}) ===\n`;

                if (data.not_acknowledged.length > 0) {
                    data.not_acknowledged.forEach(s => {
                        msg += `‚úó ${s.name} (${s.phone || 'no phone'})\n`;
                    });
                } else {
                    msg += '(all acknowledged!)\n';
                }

                alert(msg);

            } catch (error) {
                console.error('Failed to load acknowledgments:', error);
                alert('Error loading acknowledgments');
            }
        }

        // ===== PRODUCTIVITY TAB =====
        let productivityData = null;

        async function loadProductivity() {
            // Populate dropdowns
            await populateProductivityFilters();
            // Load data
            await loadProductivityData();
        }

        async function populateProductivityFilters() {
            // Populate project dropdown
            try {
                const response = await apiCall('/api/productivity/projects');
                const data = await response.json();
                const projectSelect = document.getElementById('prodProject');
                projectSelect.innerHTML = '<option value="">All Projects</option>';
                (data.projects || []).forEach(p => {
                    projectSelect.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                });
            } catch (err) {
                console.error('Error loading projects:', err);
            }

            // Populate staff dropdown (reuse existing allStaff)
            const staffSelect = document.getElementById('prodStaff');
            staffSelect.innerHTML = '<option value="">All Staff</option>';
            allStaff.forEach(s => {
                if (s.is_active) {
                    staffSelect.innerHTML += `<option value="${s.id}">${s.full_name}</option>`;
                }
            });
        }

        function onProductivityPeriodChange() {
            const period = document.getElementById('prodPeriod').value;
            document.getElementById('prodCustomDates').style.display = period === 'custom' ? 'block' : 'none';
            if (period !== 'custom') {
                loadProductivityData();
            }
        }

        async function loadProductivityData() {
            const period = document.getElementById('prodPeriod').value;
            const projectId = document.getElementById('prodProject').value;
            const staffId = document.getElementById('prodStaff').value;
            const groupBy = document.getElementById('prodGroupBy').value;

            let url = `/api/productivity?period=${period}&group_by=${groupBy}`;
            if (projectId) url += `&project_id=${projectId}`;
            if (staffId) url += `&staff_id=${staffId}`;

            if (period === 'custom') {
                const dateFrom = document.getElementById('prodDateFrom').value;
                const dateTo = document.getElementById('prodDateTo').value;
                if (dateFrom && dateTo) {
                    url += `&date_from=${dateFrom}&date_to=${dateTo}`;
                }
            }

            try {
                const response = await apiCall(url);
                const data = await response.json();

                if (data.error) {
                    console.error('Productivity API error:', data.error);
                    return;
                }

                productivityData = data;
                renderProductivityData(data);
            } catch (err) {
                console.error('Error loading productivity data:', err);
            }
        }

        function renderProductivityData(data) {
            // Update summary cards
            document.getElementById('prodTotalHours').textContent = data.totals.hours.toFixed(1);
            document.getElementById('prodTotalCost').textContent = 'R' + data.totals.cost.toLocaleString('en-ZA', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('prodProjectCount').textContent = data.totals.project_count;
            document.getElementById('prodStaffCount').textContent = data.totals.staff_count;

            // Render table
            const tbody = document.getElementById('productivityTableBody');
            const groupBy = document.getElementById('prodGroupBy').value;

            if (!data.summary || data.summary.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: #6b7280;">No productivity data found for the selected filters</td></tr>';
                return;
            }

            tbody.innerHTML = data.summary.map(row => `
                <tr>
                    <td style="font-weight: 600;">${row.name}</td>
                    <td>${row.hours.toFixed(1)} hrs</td>
                    <td style="color: #059669; font-weight: 600;">R${row.cost.toLocaleString('en-ZA', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td>R${row.avg_hourly_rate.toFixed(2)}/hr</td>
                    <td>${row.staff_count}</td>
                    <td>${row.days_worked}</td>
                    <td>
                        <button class="btn btn-primary btn-small" onclick="showProductivityDetails('${row.name.replace(/'/g, "\\'")}')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">View</button>
                    </td>
                </tr>
            `).join('');

            // Render details table
            renderProductivityDetails(data.details);
        }

        function renderProductivityDetails(details) {
            const tbody = document.getElementById('productivityDetailsBody');

            if (!details || details.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #6b7280;">No details available</td></tr>';
                return;
            }

            // Sort by date descending, then by staff name
            details.sort((a, b) => {
                if (a.date !== b.date) return b.date.localeCompare(a.date);
                return a.staff_name.localeCompare(b.staff_name);
            });

            tbody.innerHTML = details.map(d => `
                <tr>
                    <td>${formatDate(d.date)}</td>
                    <td>${d.staff_name}</td>
                    <td>${d.project_name}</td>
                    <td>${d.task_name || '-'}</td>
                    <td>${d.hours.toFixed(1)} hrs</td>
                    <td style="color: #059669;">R${d.cost.toFixed(2)}</td>
                </tr>
            `).join('');
        }

        function showProductivityDetails(filterName) {
            if (!productivityData || !productivityData.details) return;

            const groupBy = document.getElementById('prodGroupBy').value;
            let filtered;

            if (groupBy === 'project') {
                filtered = productivityData.details.filter(d => d.project_name === filterName);
            } else if (groupBy === 'staff') {
                filtered = productivityData.details.filter(d => d.staff_name === filterName);
            } else {
                filtered = productivityData.details.filter(d => d.date === filterName);
            }

            document.getElementById('productivityDetailsTitle').textContent = `üìã Details: ${filterName}`;
            renderProductivityDetails(filtered);

            // Scroll to details section
            document.getElementById('productivityDetails').scrollIntoView({ behavior: 'smooth' });
        }

        function formatDate(dateStr) {
            const d = new Date(dateStr);
            return d.toLocaleDateString('en-ZA', { weekday: 'short', day: 'numeric', month: 'short' });
        }

        function exportProductivityCSV() {
            if (!productivityData || !productivityData.details || productivityData.details.length === 0) {
                alert('No data to export');
                return;
            }

            const headers = ['Date', 'Staff', 'Project', 'Task', 'Hours', 'Cost', 'Hourly Rate'];
            const rows = productivityData.details.map(d => [
                d.date,
                d.staff_name,
                d.project_name,
                d.task_name || '',
                d.hours.toFixed(2),
                d.cost.toFixed(2),
                d.hourly_rate.toFixed(2)
            ]);

            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
            });

            // Add totals row
            csv += `\n"TOTALS","","","",${productivityData.totals.hours.toFixed(2)},${productivityData.totals.cost.toFixed(2)},""\n`;

            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `productivity_${document.getElementById('prodPeriod').value}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

    </script>
</body>
</html>
