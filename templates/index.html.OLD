<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WAGEPRO - Payroll Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Login Screen */
        #loginScreen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .login-box {
            background: white;
            padding: 3rem;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
        }

        .login-box h1 {
            text-align: center;
            margin-bottom: 2rem;
            color: #667eea;
            font-size: 2.5rem;
            font-weight: 900;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .cell-number {
            color: #dc2626 !important;
            font-weight: 700 !important;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            width: auto !important;
            flex-shrink: 0;
        }

        /* Dashboard */
        #dashboard {
            display: none;
        }

        .header {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2rem;
            font-weight: 900;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .tab {
            padding: 1rem 2rem;
            background: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .tab.active {
            opacity: 1;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
        }

        .tab:not(.active) {
            opacity: 0.7;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .card-header h2 {
            color: #1f2937;
            font-size: 1.5rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f9fafb;
        }

        th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        tr:hover {
            background: #f9fafb;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .modal-header h2 {
            color: #1f2937;
        }

        .close-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .close-btn:hover {
            background: #dc2626;
        }

        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .hidden {
            display: none;
        }

        /* Fortnight Days Grid */
        .week-section {
            margin-bottom: 1.5rem;
        }

        .week-header {
            padding: 0.5rem 1rem;
            border-radius: 6px 6px 0 0;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .week-1-header {
            background: #e0f2fe;
            color: #0c4a6e;
        }

        .week-2-header {
            background: #ddd6fe;
            color: #4c1d95;
        }

        .day-row {
            display: grid;
            grid-template-columns: 130px 1fr;
            gap: 0.5rem;
            align-items: center;
            padding: 0.5rem;
            background: white;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }

        .day-row.weekend {
            background: #fef3c7;
            border: 1px solid #fbbf24;
        }

        .day-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .day-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .ot-input {
            width: 70px;
            padding: 0.25rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-box">
            <h1>WAGEPRO</h1>
            <div id="loginError" class="alert alert-error hidden"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="loginUsername" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-primary">Login</button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <h1>WAGEPRO</h1>
                <div class="user-info">
                    <span id="userName"></span>
                    <button class="btn btn-secondary btn-small" onclick="logout()">Logout</button>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab tab-payroll active" onclick="showTab('payroll')" style="background: white; color: #667eea; border: 2px solid #667eea;">Payroll</button>
                <button class="tab tab-staff" onclick="showTab('staff')" style="background: #10b981; color: white;">Staff</button>
                <button class="tab tab-sites" onclick="showTab('sites')" style="background: #f59e0b; color: white;">Sites</button>
                <button class="tab tab-users" onclick="showTab('users')" style="background: #ef4444; color: white;">Users</button>
                <button class="tab tab-tracking" onclick="showTab('tracking')" style="background: #0ea5e9; color: white;">üìç Tracking</button>
                <button class="tab tab-config" onclick="showTab('config')" style="background: #6366f1; color: white;">‚öôÔ∏è Config</button>
            </div>

            <!-- Tab Content -->

            <!-- SITES TAB -->
            <div id="sitesTab" class="tab-content active">
                <div class="card">
                    <div class="card-header">
                        <h2>Sites</h2>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 600;">
                                <input type="checkbox" id="sitesShowInactive" onchange="loadSites()" style="width: 18px; height: 18px; cursor: pointer;">
                                Show Inactive
                            </label>
                            <button class="btn btn-primary btn-small" onclick="showAddSiteModal()">+ Add Site</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Code</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sitesTableBody">
                            <tr><td colspan="5" style="text-align: center;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- STAFF TAB -->
            <div id="staffTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2>Staff Members</h2>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <label for="staffSiteFilter" style="font-weight: 600;">Filter by Site:</label>
                            <select id="staffSiteFilter" onchange="filterStaffBySite()" style="padding: 0.5rem; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.875rem; min-width: 150px;">
                                <option value="">All Sites</option>
                            </select>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 600;">
                                <input type="checkbox" id="staffShowCasuals" onchange="filterStaffBySite()" checked style="width: 18px; height: 18px; cursor: pointer;">
                                Show Casuals
                            </label>
                            <button class="btn btn-primary btn-small" onclick="showAddStaffModal()">+ Add Staff</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Cell No</th>
                                <th>Daily Rate</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="staffTableBody">
                            <tr><td colspan="4" style="text-align: center;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- PAYROLL TAB -->
            <div id="payrollTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2>Pay Periods</h2>
                        <button class="btn btn-primary btn-small" onclick="showAddPeriodModal()">+ New Pay Period</button>
                    </div>
                    <div id="payPeriodSelector" style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 1rem;">
                        <select id="payPeriodSelect" class="form-group" onchange="loadPayslips()" style="flex: 1; max-width: 400px; font-size: 1rem; font-weight: 500; padding: 0.75rem; margin: 0;">
                            <option value="">Select a pay period...</option>
                        </select>
                        <button id="deletePeriodBtn" class="btn btn-small" style="background: #ef4444; color: white; display: none;" onclick="deleteCurrentPeriod()">Delete Period</button>
                    </div>
                </div>

                <div id="payslipsCard" class="card hidden">
                    <div class="card-header">
                        <h2>Payslips</h2>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <label for="payslipSiteFilter" style="font-weight: 600;">Filter by Site:</label>
                            <select id="payslipSiteFilter" onchange="filterPayslipsBySite()" style="padding: 0.5rem; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.875rem; min-width: 150px;">
                                <option value="">All Sites</option>
                            </select>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 600;">
                                <input type="checkbox" id="payslipShowCasuals" onchange="filterPayslipsBySite()" checked style="width: 18px; height: 18px; cursor: pointer;">
                                Show Casuals
                            </label>
                            <button id="addAllToPayrollBtn" class="btn btn-primary btn-small" onclick="addAllToPayroll()" style="background: #7c3aed; display: none;">‚ûï Add All to Payroll</button>
                            <button id="paymentSummaryBtn" class="btn btn-primary btn-small" onclick="showPaymentSummary()" style="background: #0284c7; display: none;">üìä Payment Summary</button>
                            <button id="generatePDFsBtn" class="btn btn-primary btn-small" onclick="generatePDFs()" style="background: #059669; display: none;">Generate PDFs</button>
                            <button id="sendSMSBtn" class="btn btn-primary btn-small" onclick="sendPayslipSMS()" style="background: #f59e0b; display: none;">üì± Send SMS</button>
                        </div>
                    </div>
                    <div id="payslipsContainer"></div>
                </div>
            </div>

            <!-- USERS TAB -->
            <div id="usersTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2>Users</h2>
                        <button class="btn btn-primary btn-small" onclick="showAddUserModal()">+ Add User</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr><td colspan="7" style="text-align: center;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TRACKING TAB -->
            <div id="trackingTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2>üìç Staff Tracking</h2>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <button class="btn btn-primary btn-small" onclick="loadTracking()" style="background: #0ea5e9;">üîÑ Refresh</button>
                            <button class="btn btn-primary btn-small" onclick="showWhereaboutsModal()" style="background: #8b5cf6;">üìç Request Whereabouts</button>
                        </div>
                    </div>

                    <!-- Summary Cards -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="background: #10b981; color: white; padding: 1.5rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold;" id="trackingSignedIn">0</div>
                            <div>Signed In</div>
                        </div>
                        <div style="background: #6b7280; color: white; padding: 1.5rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold;" id="trackingSignedOut">0</div>
                            <div>Signed Out</div>
                        </div>
                        <div style="background: #f59e0b; color: white; padding: 1.5rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold;" id="trackingNotSignedIn">0</div>
                            <div>Not Signed In</div>
                        </div>
                        <div style="background: #8b5cf6; color: white; padding: 1.5rem; border-radius: 8px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold;" id="trackingTotalHours">0</div>
                            <div>Total Hours Today</div>
                        </div>
                    </div>

                    <!-- Currently Signed In -->
                    <h3 style="margin-bottom: 1rem; color: #10b981;">üü¢ Currently Signed In</h3>
                    <table style="margin-bottom: 2rem;">
                        <thead>
                            <tr>
                                <th>Staff Name</th>
                                <th>Site</th>
                                <th>Signed In At</th>
                                <th>Hours So Far</th>
                                <th>GPS Verified</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="trackingSignedInTable">
                            <tr><td colspan="6" style="text-align: center;">Loading...</td></tr>
                        </tbody>
                    </table>

                    <!-- Today's Activity -->
                    <h3 style="margin-bottom: 1rem; color: #6b7280;">üìã Today's Activity (Completed Shifts)</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Staff Name</th>
                                <th>Site</th>
                                <th>Sign In</th>
                                <th>Sign Out</th>
                                <th>Hours</th>
                                <th>GPS</th>
                            </tr>
                        </thead>
                        <tbody id="trackingCompletedTable">
                            <tr><td colspan="6" style="text-align: center;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Recent Location Requests -->
                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-header">
                        <h2>üìç Recent Whereabouts Checks</h2>
                        <button class="btn btn-primary btn-small" onclick="loadTracking()" style="background: #0ea5e9;">üîÑ Refresh</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Staff Name</th>
                                <th>Cell No</th>
                                <th>Requested</th>
                                <th>Reason</th>
                                <th>Status</th>
                                <th>Location</th>
                            </tr>
                        </thead>
                        <tbody id="trackingLocationTable">
                            <tr><td colspan="6" style="text-align: center;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- CONFIG TAB -->
            <div id="configTab" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2>‚öôÔ∏è System Configuration</h2>
                    </div>

                    <div style="max-width: 600px;">
                        <h3 style="margin-bottom: 1rem; color: #667eea;">Admin Details</h3>
                        <p style="margin-bottom: 1.5rem; color: #6b7280;">These details are used for SMS notifications and system alerts.</p>

                        <form id="configForm">
                            <div class="form-group">
                                <label>Admin Name</label>
                                <input type="text" id="configAdminName" placeholder="e.g., Bruce">
                            </div>
                            <div class="form-group">
                                <label>Admin Email</label>
                                <input type="email" id="configAdminEmail" placeholder="e.g., bruce@company.com">
                            </div>
                            <div class="form-group">
                                <label>Admin Mobile (for SMS alerts)</label>
                                <input type="text" id="configAdminMobile" placeholder="e.g., 0826000859">
                            </div>
                            <div class="form-group">
                                <label>Company Name</label>
                                <input type="text" id="configCompanyName" placeholder="e.g., Levendig">
                            </div>
                            <div class="form-group">
                                <label>SMS Notifications</label>
                                <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="configNotifySignin" checked style="width: 18px; height: 18px;">
                                        Notify on Staff Sign-In
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="configNotifySignout" checked style="width: 18px; height: 18px;">
                                        Notify on Staff Sign-Out
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="checkbox" id="configNotifyLocation" checked style="width: 18px; height: 18px;">
                                        Notify on Location Response
                                    </label>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">üíæ Save Configuration</button>
                        </form>
                    </div>
                </div>

                <!-- Public URL Config -->
                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-header">
                        <h2>üåê Public URL Settings</h2>
                    </div>
                    <div style="max-width: 600px;">
                        <p style="margin-bottom: 1rem; color: #6b7280;">The public URL is used for SMS location request links. Update when using ngrok.</p>
                        <div class="form-group">
                            <label>Public URL</label>
                            <input type="text" id="configPublicUrl" placeholder="e.g., https://your-ngrok-url.ngrok-free.dev">
                        </div>
                        <button class="btn btn-primary" onclick="savePublicUrl()">üíæ Save URL</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->

    <!-- Add Site Modal -->
    <div id="addSiteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Site</h2>
                <button class="close-btn" onclick="closeModal('addSiteModal')">CLOSE</button>
            </div>
            <form id="addSiteForm">
                <div class="form-group">
                    <label>Site Name *</label>
                    <input type="text" id="siteName" required>
                </div>
                <div class="form-group">
                    <label>Code</label>
                    <input type="text" id="siteCode" placeholder="e.g., FRM, HOM">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="siteDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <textarea id="siteAddress" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>Bank Name</label>
                    <input type="text" id="siteBankName" placeholder="e.g., ABSA, Standard Bank">
                </div>
                <div class="form-group">
                    <label>Account Number</label>
                    <input type="text" id="siteAccountNumber" placeholder="e.g., 1234567890">
                </div>
                <button type="submit" class="btn btn-primary">Create Site</button>
            </form>
        </div>
    </div>

    <!-- Add Staff Modal -->
    <div id="addStaffModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Add New Staff Member</h2>
                <button class="close-btn" onclick="closeModal('addStaffModal')">CLOSE</button>
            </div>
            <form id="addStaffForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>First Name *</label>
                        <input type="text" id="staffFirstName" required>
                    </div>
                    <div class="form-group">
                        <label>Last Name *</label>
                        <input type="text" id="staffLastName" required>
                    </div>
                    <div class="form-group">
                        <label>ID Number</label>
                        <input type="text" id="staffIdNumber">
                    </div>
                    <div class="form-group">
                        <label>Site *</label>
                        <select id="staffSite" required>
                            <option value="">Select Site</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Position</label>
                        <select id="staffPositionSelect" onchange="handlePositionChange('staff')">
                            <option value="">Select Position</option>
                            <option value="__OTHER__">Other (type below)</option>
                        </select>
                        <input type="text" id="staffPositionOther" placeholder="Enter position" style="margin-top: 0.5rem; display: none;">
                    </div>
                    <div class="form-group">
                        <label>Employment Type</label>
                        <select id="staffEmploymentType">
                            <option value="casual">Casual</option>
                            <option value="full_time">Full Time</option>
                            <option value="part_time">Part Time</option>
                            <option value="contract">Contract</option>
                            <option value="seasonal">Seasonal</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Daily Rate (R)</label>
                        <input type="number" id="staffDailyRate" step="0.01" min="0" oninput="updateHourlyFromDaily('staff')">
                    </div>
                    <div class="form-group">
                        <label>Hourly Rate (R)</label>
                        <input type="number" id="staffHourlyRate" step="0.01" min="0" oninput="updateDailyFromHourly('staff')">
                    </div>
                    <div class="form-group">
                        <label>Mobile (for SMS/Clock-in)</label>
                        <input type="tel" id="staffMobile" placeholder="e.g., 0821234567">
                    </div>
                    <div class="form-group">
                        <label>Phone (alt)</label>
                        <input type="tel" id="staffPhone">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="staffEmail">
                    </div>
                    <div class="form-group">
                        <label>Bank Name</label>
                        <input type="text" id="staffBankName" placeholder="e.g., ABSA, FNB, Standard Bank">
                    </div>
                    <div class="form-group">
                        <label>Account Number</label>
                        <input type="text" id="staffBankAccount" placeholder="Bank account number">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Create Staff Member</button>
            </form>
        </div>
    </div>

    <!-- Edit Staff Modal -->
    <div id="editStaffModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Edit Staff Member</h2>
                <button class="close-btn" onclick="closeModal('editStaffModal')">CLOSE</button>
            </div>
            <form id="editStaffForm">
                <input type="hidden" id="editStaffId">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label>First Name *</label>
                        <input type="text" id="editStaffFirstName" required>
                    </div>
                    <div class="form-group">
                        <label>Last Name *</label>
                        <input type="text" id="editStaffLastName" required>
                    </div>
                    <div class="form-group">
                        <label>ID Number</label>
                        <input type="text" id="editStaffIdNumber">
                    </div>
                    <div class="form-group">
                        <label>Site *</label>
                        <select id="editStaffSite" required>
                            <option value="">Select Site</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Position</label>
                        <select id="editStaffPositionSelect" onchange="handlePositionChange('editStaff')">
                            <option value="">Select Position</option>
                            <option value="__OTHER__">Other (type below)</option>
                        </select>
                        <input type="text" id="editStaffPositionOther" placeholder="Enter position" style="margin-top: 0.5rem; display: none;">
                    </div>
                    <div class="form-group">
                        <label>Employment Type</label>
                        <select id="editStaffEmploymentType">
                            <option value="casual">Casual</option>
                            <option value="full_time">Full Time</option>
                            <option value="part_time">Part Time</option>
                            <option value="contract">Contract</option>
                            <option value="seasonal">Seasonal</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Daily Rate (R)</label>
                        <input type="number" id="editStaffDailyRate" step="0.01" min="0" oninput="updateHourlyFromDaily('editStaff')">
                    </div>
                    <div class="form-group">
                        <label>Hourly Rate (R)</label>
                        <input type="number" id="editStaffHourlyRate" step="0.01" min="0" oninput="updateDailyFromHourly('editStaff')">
                    </div>
                    <div class="form-group">
                        <label>Mobile (for SMS/Clock-in)</label>
                        <input type="tel" id="editStaffMobile" placeholder="e.g., 0821234567">
                    </div>
                    <div class="form-group">
                        <label>Phone (alt)</label>
                        <input type="tel" id="editStaffPhone">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="editStaffEmail">
                    </div>
                    <div class="form-group">
                        <label>Bank Name</label>
                        <input type="text" id="editStaffBankName" placeholder="e.g., ABSA, FNB, Standard Bank">
                    </div>
                    <div class="form-group">
                        <label>Account Number</label>
                        <input type="text" id="editStaffBankAccount" placeholder="Bank account number">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Update Staff Member</button>
            </form>
        </div>
    </div>

    <!-- Add Pay Period Modal -->
    <div id="addPeriodModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>New Pay Period</h2>
                <button class="close-btn" onclick="closeModal('addPeriodModal')">CLOSE</button>
            </div>
            <form id="addPeriodForm">
                <div class="form-group">
                    <label>Year *</label>
                    <input type="number" id="periodYear" required value="2025">
                </div>
                <div class="form-group">
                    <label>Start Date *</label>
                    <input type="date" id="periodStartDate" required>
                </div>
                <div class="form-group">
                    <label>End Date *</label>
                    <input type="date" id="periodEndDate" required>
                </div>
                <button type="submit" class="btn btn-primary">Create Pay Period</button>
            </form>
        </div>
    </div>

    <!-- Edit Days Modal -->
    <div id="editDaysModal" class="modal">
        <div class="modal-content" style="max-width: 650px;">
            <div class="modal-header">
                <h2>Edit Days Worked - Fortnight</h2>
                <button class="close-btn" onclick="closeModal('editDaysModal')">CLOSE</button>
            </div>
            <div style="background: #f9fafb; padding: 1rem; margin-bottom: 1rem; border-radius: 8px;">
                <strong id="editDaysStaffName" style="font-size: 1.1rem;"></strong>
            </div>

            <!-- Rate Explanation -->
            <div style="background: #dbeafe; padding: 0.75rem; margin-bottom: 1rem; border-radius: 6px; font-size: 0.875rem;">
                <strong>Weekend Rate Rule:</strong> Weekend days get <strong>1.5x</strong> rate if <strong>3+ weekdays</strong> worked in that week, otherwise <strong>1.0x</strong>
            </div>

            <!-- Quick Actions -->
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                <button type="button" class="btn btn-small" onclick="selectAllDays()" style="background: #10b981; color: white;">‚úì Select All Days</button>
                <button type="button" class="btn btn-small" onclick="clearAllDays()" style="background: #ef4444; color: white;">‚úó Clear All Days</button>
            </div>

            <form id="editDaysForm">
                <input type="hidden" id="editDaysPayslipId">

                <!-- Week 1 -->
                <div class="week-section">
                    <div class="week-header week-1-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>WEEK 1</span>
                        <span id="week1Multiplier" style="font-size: 0.9rem; font-weight: 600; color: #92400e;"></span>
                    </div>
                    <div id="week1Days"></div>
                </div>

                <!-- Week 2 -->
                <div class="week-section">
                    <div class="week-header week-2-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>WEEK 2</span>
                        <span id="week2Multiplier" style="font-size: 0.9rem; font-weight: 600; color: #92400e;"></span>
                    </div>
                    <div id="week2Days"></div>
                </div>

                <!-- Summary -->
                <div id="daysSummary" style="background: #f0fdf4; padding: 1rem; margin: 1rem 0; border-radius: 8px; border: 1px solid #86efac;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.9rem;">
                        <div><strong>Week 1 Weekdays:</strong> <span id="w1WeekdayCount">0</span></div>
                        <div><strong>Week 2 Weekdays:</strong> <span id="w2WeekdayCount">0</span></div>
                        <div><strong>Week 1 Weekends:</strong> <span id="w1WeekendCount">0</span> <span id="w1Rate" style="color: #92400e; font-weight: 600;"></span></div>
                        <div><strong>Week 2 Weekends:</strong> <span id="w2WeekendCount">0</span> <span id="w2Rate" style="color: #92400e; font-weight: 600;"></span></div>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Manage Loans Modal -->
    <div id="loansModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 id="loansModalTitle">Manage Loans</h2>
                <button class="close-btn" onclick="closeModal('loansModal')">CLOSE</button>
            </div>
            <input type="hidden" id="loansStaffId">
            <button class="btn btn-primary btn-small" onclick="showAddLoanForm()" style="margin-bottom: 1rem;">+ New Loan</button>
            <div id="loansContainer"></div>
        </div>
    </div>

    <!-- Add Loan Form Modal -->
    <div id="addLoanModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>New Loan</h2>
                <button class="close-btn" onclick="closeModal('addLoanModal')">CLOSE</button>
            </div>
            <form id="addLoanForm">
                <input type="hidden" id="loanStaffId">
                <div class="form-group">
                    <label>Description *</label>
                    <input type="text" id="loanDescription" required placeholder="e.g., Cash advance">
                </div>
                <div class="form-group">
                    <label>Total Amount (R) *</label>
                    <input type="number" id="loanTotalAmount" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Installment Amount (R) *</label>
                    <input type="number" id="loanInstallment" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Loan Date</label>
                    <input type="date" id="loanDate">
                </div>
                <div class="form-group">
                    <label>Start Deduction Date</label>
                    <input type="date" id="loanStartDate">
                </div>
                <button type="submit" class="btn btn-primary">Create Loan</button>
            </form>
        </div>
    </div>

    <!-- Manage Deductions Modal -->
    <div id="deductionsModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 id="deductionsModalTitle">Manage Deductions</h2>
                <button class="close-btn" onclick="closeModal('deductionsModal')">CLOSE</button>
            </div>
            <input type="hidden" id="deductionsStaffId">
            <button class="btn btn-primary btn-small" onclick="showAddDeductionForm()" style="margin-bottom: 1rem;">+ New Deduction</button>
            <div id="deductionsContainer"></div>
        </div>
    </div>

    <!-- Add Deduction Form Modal -->
    <div id="addDeductionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>New Deduction</h2>
                <button class="close-btn" onclick="closeModal('addDeductionModal')">CLOSE</button>
            </div>
            <form id="addDeductionForm">
                <input type="hidden" id="deductionStaffId">
                <div class="form-group">
                    <label>Description *</label>
                    <input type="text" id="deductionDescription" required placeholder="e.g., Medical Aid, UIF">
                </div>
                <div class="form-group">
                    <label>Type *</label>
                    <select id="deductionType" required onchange="toggleDeductionFields()">
                        <option value="fixed">Fixed Amount (Recurring)</option>
                        <option value="percentage">Percentage of Gross Pay</option>
                        <option value="once_off">Once Off</option>
                    </select>
                </div>
                <div class="form-group" id="fixedAmountGroup">
                    <label>Fixed Amount (R)</label>
                    <input type="number" id="deductionFixed" step="0.01" min="0">
                </div>
                <div class="form-group hidden" id="percentageGroup">
                    <label>Percentage (%)</label>
                    <input type="number" id="deductionPercentage" step="0.1" min="0" max="100">
                </div>
                <button type="submit" class="btn btn-primary">Create Deduction</button>
            </form>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New User</h2>
                <button class="close-btn" onclick="closeModal('addUserModal')">CLOSE</button>
            </div>
            <form id="addUserForm">
                <div class="form-group">
                    <label>Username *</label>
                    <input type="text" id="userUsername" required>
                </div>
                <div class="form-group">
                    <label>Password *</label>
                    <input type="password" id="userPassword" required minlength="6">
                </div>
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" id="userFullName" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="userEmail">
                </div>
                <div class="form-group">
                    <label>Role *</label>
                    <select id="userRole" required>
                        <option value="viewer">Viewer</option>
                        <option value="manager">Manager</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary">Create User</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addUserModal')">Close</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit User</h2>
                <button class="close-btn" onclick="closeModal('editUserModal')">CLOSE</button>
            </div>
            <form id="editUserForm">
                <input type="hidden" id="editUserId">
                <div class="form-group">
                    <label>Username *</label>
                    <input type="text" id="editUserUsername" required>
                </div>
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" id="editUserFullName" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="editUserEmail">
                </div>
                <div class="form-group">
                    <label>Role *</label>
                    <select id="editUserRole" required>
                        <option value="viewer">Viewer</option>
                        <option value="manager">Manager</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary">Update User</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editUserModal')">Close</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Change Password</h2>
                <button class="close-btn" onclick="closeModal('changePasswordModal')">CLOSE</button>
            </div>
            <form id="changePasswordForm">
                <input type="hidden" id="passwordUserId">
                <div class="form-group">
                    <label>New Password *</label>
                    <input type="password" id="newPassword" required minlength="6">
                </div>
                <div class="form-group">
                    <label>Confirm Password *</label>
                    <input type="password" id="confirmPassword" required minlength="6">
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary">Change Password</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('changePasswordModal')">Close</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Site Modal -->
    <div id="editSiteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Site</h2>
                <button class="close-btn" onclick="closeModal('editSiteModal')">CLOSE</button>
            </div>
            <form id="editSiteForm">
                <input type="hidden" id="editSiteId">
                <div class="form-group">
                    <label>Site Name *</label>
                    <input type="text" id="editSiteName" required>
                </div>
                <div class="form-group">
                    <label>Code</label>
                    <input type="text" id="editSiteCode" placeholder="e.g., FRM, HOM">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="editSiteDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <textarea id="editSiteAddress" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>Bank Name</label>
                    <input type="text" id="editSiteBankName" placeholder="e.g., ABSA, Standard Bank">
                </div>
                <div class="form-group">
                    <label>Account Number</label>
                    <input type="text" id="editSiteAccountNumber" placeholder="e.g., 1234567890">
                </div>
                <div style="background: #f0f9ff; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <h4 style="margin-bottom: 0.75rem; color: #0369a1;">üìç GPS Settings (for Clock-In)</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.75rem;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Latitude</label>
                            <input type="number" step="any" id="editSiteLatitude" placeholder="-26.123456">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Longitude</label>
                            <input type="number" step="any" id="editSiteLongitude" placeholder="28.123456">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Radius (m)</label>
                            <input type="number" id="editSiteRadius" placeholder="100" value="100">
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary">Update Site</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editSiteModal')">Close</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Force Delete Period Confirmation Modal -->
    <div id="forceDeleteModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background: #dc2626; color: white;">
                <h2 style="color: white;">‚ö†Ô∏è FORCE DELETE PERIOD</h2>
                <button class="close-btn" onclick="closeModal('forceDeleteModal')" style="background: rgba(255,255,255,0.2);">CLOSE</button>
            </div>
            <div style="padding: 1.5rem;">
                <div style="background: #fef2f2; border: 2px solid #dc2626; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                    <h3 style="color: #dc2626; margin-top: 0;">‚ö†Ô∏è CRITICAL WARNING</h3>
                    <p style="margin: 0.5rem 0; font-weight: 600;">This period is LOCKED. PDFs have been generated.</p>
                    <p style="margin: 0.5rem 0; font-size: 0.95rem;">Force deleting will:</p>
                    <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: #dc2626;">
                        <li><strong>DELETE ALL PDF PAYSLIPS</strong> (<span id="forceDeletePdfCount">0</span> files)</li>
                        <li><strong>DELETE THE PAY PERIOD</strong></li>
                        <li><strong>DELETE ALL PAYSLIPS AND TRANSACTIONS</strong></li>
                    </ul>
                    <p style="margin: 0.5rem 0; font-size: 0.95rem; color: #991b1b;">
                        <strong>THIS CANNOT BE UNDONE!</strong>
                    </p>
                </div>
                <p style="font-weight: 600; margin-bottom: 0.5rem;">Period: <span id="forceDeletePeriodInfo" style="color: #dc2626;"></span></p>
                <p style="font-size: 0.9rem; color: #6b7280; margin-bottom: 1.5rem;">
                    This operation requires <strong>ADMIN</strong> privileges and password re-authentication.
                </p>
                <form id="forceDeleteForm">
                    <div class="form-group">
                        <label style="font-weight: 600;">Admin Password * <span style="color: #dc2626;">(Required)</span></label>
                        <input type="password" id="forceDeletePassword" required placeholder="Enter your admin password" style="border: 2px solid #dc2626;">
                    </div>
                    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                        <button type="submit" class="btn" style="background: #dc2626; color: white; flex: 1;">
                            üóëÔ∏è FORCE DELETE
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal('forceDeleteModal')" style="flex: 1;">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Payment Summary Modal -->
    <div id="paymentSummaryModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header" style="background: #0284c7; color: white;">
                <h2 style="color: white; font-size: 1.2rem;">üìä Payment Summary - <span id="summaryPeriodInfo"></span></h2>
                <button class="close-btn" onclick="closeModal('paymentSummaryModal')" style="background: rgba(255,255,255,0.2);">CLOSE</button>
            </div>
            <div style="padding: 1.5rem;">
                <div id="paymentSummaryContent">
                    <!-- Summary tables will be inserted here -->
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-primary" onclick="printPaymentSummary()" style="background: #059669;">
                        üñ®Ô∏è Print Summary
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('paymentSummaryModal')">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Staff Payslip History Modal -->
    <div id="staffHistoryModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header" style="background: #0284c7; color: white;">
                <h2 style="color: white; font-size: 1.2rem;">üìã Payslip History - <span id="historyStaffName"></span></h2>
                <button class="close-btn" onclick="closeModal('staffHistoryModal')" style="background: rgba(255,255,255,0.2);">CLOSE</button>
            </div>
            <div style="padding: 1.5rem;">
                <div style="margin-bottom: 1rem; display: flex; align-items: center; gap: 1rem;">
                    <label for="historyPeriodFilter" style="font-weight: 600;">Filter by Period:</label>
                    <select id="historyPeriodFilter" onchange="filterHistoryByPeriod()" style="padding: 0.5rem; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.875rem; min-width: 200px;">
                        <option value="">All Periods</option>
                    </select>
                </div>
                <div id="staffHistoryContent">
                    <div style="text-align: center; padding: 2rem; color: #94a3b8;">
                        Loading history...
                    </div>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('staffHistoryModal')">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Loans Modal -->
    <div id="manageLoansModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>Manage Loans - <span id="loanStaffName"></span></h2>
                <button class="close-btn" onclick="closeModal('manageLoansModal')">CLOSE</button>
            </div>

            <input type="hidden" id="loanStaffId">

            <!-- Summary Cards -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                <div style="background: #fef3c7; border: 2px solid #fbbf24; border-radius: 8px; padding: 1rem; text-align: center;">
                    <div style="font-size: 0.75rem; color: #92400e; font-weight: 600; margin-bottom: 0.25rem;">CURRENT BALANCE</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #92400e;" id="loanCurrentBalance">R0.00</div>
                </div>
                <div style="background: #fee2e2; border: 2px solid #f87171; border-radius: 8px; padding: 1rem; text-align: center;">
                    <div style="font-size: 0.75rem; color: #991b1b; font-weight: 600; margin-bottom: 0.25rem;">TOTAL BORROWED</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #991b1b;" id="loanTotalBorrowed">R0.00</div>
                </div>
                <div style="background: #d1fae5; border: 2px solid #34d399; border-radius: 8px; padding: 1rem; text-align: center;">
                    <div style="font-size: 0.75rem; color: #065f46; font-weight: 600; margin-bottom: 0.25rem;">TOTAL REPAID</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #065f46;" id="loanTotalRepaid">R0.00</div>
                </div>
                <div style="background: #fce7f3; border: 2px solid #f472b6; border-radius: 8px; padding: 1rem; text-align: center;">
                    <div style="font-size: 0.75rem; color: #831843; font-weight: 600; margin-bottom: 0.25rem;">MAX LOAN AMOUNT</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #831843;" id="loanMaxAmount">R0.00</div>
                </div>
                <div style="background: #dbeafe; border: 2px solid #60a5fa; border-radius: 8px; padding: 1rem; text-align: center;">
                    <div style="font-size: 0.75rem; color: #1e40af; font-weight: 600; margin-bottom: 0.25rem;">ACTIVE LOANS</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #1e40af;" id="loanActiveCount">0</div>
                </div>
                <div style="background: #e0e7ff; border: 2px solid #818cf8; border-radius: 8px; padding: 1rem; text-align: center;">
                    <div style="font-size: 0.75rem; color: #3730a3; font-weight: 600; margin-bottom: 0.25rem;">NEXT DEDUCTION</div>
                    <div style="font-size: 1.5rem; font-weight: 700; color: #3730a3;" id="loanNextDeduction">R0.00</div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem;">
                <button class="btn" onclick="showNewLoanModal()" style="background: #7c3aed;">+ New Loan</button>
                <button class="btn btn-secondary" onclick="showManualRepaymentModal()">Record Manual Repayment</button>
            </div>

            <!-- Active Loans Section -->
            <div style="margin-bottom: 1.5rem;">
                <h3 style="margin-bottom: 1rem; font-size: 1.1rem; color: #1f2937;">Active Loans</h3>
                <div id="activeLoansContainer"></div>
            </div>

            <!-- Transaction History Section -->
            <div>
                <h3 style="margin-bottom: 1rem; font-size: 1.1rem; color: #1f2937;">Recent Transactions (Last 20)</h3>
                <div id="loanTransactionsContainer" style="overflow-x: auto;"></div>
            </div>
        </div>
    </div>

    <!-- New Loan Modal -->
    <div id="newLoanModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>New Loan - <span id="newLoanStaffName"></span></h2>
                <button class="close-btn" onclick="closeModal('newLoanModal')">CLOSE</button>
            </div>

            <form id="newLoanForm">
                <div class="form-group">
                    <label>Description *</label>
                    <input type="text" id="newLoanDescription" required placeholder="e.g., Cash Advance, Equipment Purchase">
                </div>

                <div class="form-group">
                    <label>Total Amount (R) *</label>
                    <input type="number" id="newLoanAmount" step="0.01" min="0.01" required placeholder="0.00">
                </div>

                <div class="form-group">
                    <label>Installment Amount per Period (R) *</label>
                    <input type="number" id="newLoanInstallment" step="0.01" min="0.01" required placeholder="0.00">
                </div>

                <div class="form-group">
                    <label>Start Deduction Date *</label>
                    <input type="date" id="newLoanStartDate" required>
                </div>

                <div class="form-group">
                    <label>Notes (Optional)</label>
                    <textarea id="newLoanNotes" rows="3" placeholder="Additional notes..."></textarea>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn" style="background: #7c3aed;">Create Loan</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('newLoanModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Manual Repayment Modal -->
    <div id="manualRepaymentModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Record Manual Repayment</h2>
                <button class="close-btn" onclick="closeModal('manualRepaymentModal')">CLOSE</button>
            </div>

            <form id="manualRepaymentForm">
                <div class="form-group">
                    <label>Select Loan *</label>
                    <select id="repaymentLoanId" required>
                        <option value="">-- Select Loan --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Payment Amount (R) *</label>
                    <input type="number" id="repaymentAmount" step="0.01" min="0.01" required placeholder="0.00">
                </div>

                <div class="form-group">
                    <label>Notes (Optional)</label>
                    <textarea id="repaymentNotes" rows="3" placeholder="Repayment notes..."></textarea>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-success">Record Repayment</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('manualRepaymentModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Manage Savings Modal -->
    <div id="savingsModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 id="savingsModalTitle">Manage Savings</h2>
                <button class="close-btn" onclick="closeModal('savingsModal')">CLOSE</button>
            </div>
            <input type="hidden" id="savingsStaffId">

            <!-- Current Balance -->
            <div style="background: #f0fdf4; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 2px solid #86efac;">
                <div style="font-size: 0.875rem; color: #059669; margin-bottom: 0.25rem;">Current Balance</div>
                <div style="font-size: 2rem; font-weight: 700; color: #059669;" id="currentBalance">R 0.00</div>
            </div>

            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                <button class="btn btn-primary btn-small" onclick="showAddSavingsTransaction('deposit')">+ Deposit</button>
                <button class="btn btn-secondary btn-small" onclick="showAddSavingsTransaction('withdrawal')">- Withdraw</button>
            </div>

            <h3 style="margin-bottom: 0.5rem;">Transaction History</h3>
            <div id="savingsTransactionsContainer"></div>
        </div>
    </div>

    <!-- Add Savings Transaction Modal -->
    <div id="addSavingsTransactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="savingsTransactionTitle">New Transaction</h2>
                <button class="close-btn" onclick="closeModal('addSavingsTransactionModal')">CLOSE</button>
            </div>
            <form id="addSavingsTransactionForm">
                <input type="hidden" id="savingsTransactionStaffId">
                <input type="hidden" id="savingsTransactionType">
                <div class="form-group">
                    <label>Amount (R) *</label>
                    <input type="number" id="savingsAmount" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="savingsDescription" placeholder="Optional description">
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary">Save Transaction</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addSavingsTransactionModal')">Close</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Whereabouts Request Modal -->
    <div id="whereaboutsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìç Request Whereabouts</h2>
                <button class="close-btn" onclick="closeModal('whereaboutsModal')">CLOSE</button>
            </div>
            <form id="whereaboutsForm">
                <div class="form-group">
                    <label>Select Staff Member *</label>
                    <select id="whereaboutsStaff" required>
                        <option value="">Select staff...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Reason (optional)</label>
                    <input type="text" id="whereaboutsReason" placeholder="e.g., Location check">
                </div>
                <p style="margin-bottom: 1rem; color: #6b7280; font-size: 0.875rem;">
                    An SMS will be sent to the staff member with a link to share their location.
                </p>
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-primary">üì± Send SMS</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('whereaboutsModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let authToken = null;
        let currentUser = null;
        let allSites = [];
        let allStaff = [];
        let payPeriods = [];
        let currentPayPeriod = null;
        let currentPayslips = [];

        // Authentication
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, password})
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.token;
                    currentUser = data.user;
                    localStorage.setItem('wagepro_token', authToken);
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    document.getElementById('userName').textContent = currentUser.full_name;
                    loadInitialData();
                } else {
                    document.getElementById('loginError').textContent = data.error;
                    document.getElementById('loginError').classList.remove('hidden');
                }
            } catch (error) {
                document.getElementById('loginError').textContent = 'Login failed';
                document.getElementById('loginError').classList.remove('hidden');
            }
        });

        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('wagepro_token');
            location.reload();
        }

        // Format date as dd/mm/yyyy
        function formatDateDMY(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Helper function for API calls
        async function apiCall(url, options = {}) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                }
            };
            const response = await fetch(url, {...defaultOptions, ...options});
            if (response.status === 401) {
                logout();
                return;
            }
            return response;
        }

        // Tab navigation
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Find and activate the correct tab button
            const tabButton = document.querySelector(`.tab-${tabName}`);
            if (tabButton) {
                tabButton.classList.add('active');
            }

            document.getElementById(tabName + 'Tab').classList.add('active');

            if (tabName === 'sites') loadSites();
            if (tabName === 'staff') loadStaff();
            if (tabName === 'payroll') loadPayPeriods();
            if (tabName === 'users') loadUsers();
            if (tabName === 'tracking') loadTracking();
            if (tabName === 'config') loadConfig();
        }

        // Modal functions
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('active');
            modal.style.display = '';  // Clear inline style to let CSS take over
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('active');
            modal.style.display = 'none';
        }

        // Load initial data
        async function loadInitialData() {
            await loadSites();
            await loadStaff();
            await loadPayPeriods();
            // Show payroll tab by default
            showTab('payroll');
        }

        // ===== SITES =====
        async function loadSites() {
            const response = await apiCall('/api/sites');
            allSites = await response.json();

            const showInactive = document.getElementById('sitesShowInactive')?.checked || false;
            const filteredSites = showInactive ? allSites : allSites.filter(site => site.is_active);

            const tbody = document.getElementById('sitesTableBody');
            if (filteredSites.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No sites found</td></tr>';
                return;
            }

            tbody.innerHTML = filteredSites.map(site => {
                const gpsIcon = site.gps_latitude ? 'üìç' : '';
                return `
                <tr>
                    <td><strong>${gpsIcon} ${site.name}</strong></td>
                    <td>${site.code || '-'}</td>
                    <td>${site.description || '-'}</td>
                    <td><span class="badge ${site.is_active ? 'badge-success' : 'badge-danger'}">${site.is_active ? 'Active' : 'Inactive'}</span></td>
                    <td>
                        <button class="btn btn-small btn-secondary" onclick="showEditSiteModal(${site.id}, '${site.name}', '${site.code || ''}', '${(site.description || '').replace(/'/g, "\\'")}', '${(site.address || '').replace(/'/g, "\\'")}', '${site.bank_name || ''}', '${site.account_number || ''}', ${site.gps_latitude || 'null'}, ${site.gps_longitude || 'null'}, ${site.gps_radius_meters || 100})">Edit</button>
                        <button class="btn btn-small ${site.is_active ? 'btn-warning' : 'btn-success'}" onclick="toggleSiteActive(${site.id})">
                            ${site.is_active ? 'Deactivate' : 'Activate'}
                        </button>
                    </td>
                </tr>
            `}).join('');

            // Update site dropdowns (only active sites)
            updateSiteDropdowns();
        }

        function updateSiteDropdowns() {
            const siteSelects = ['staffSite', 'editStaffSite'];
            const activeSites = allSites.filter(site => site.is_active);
            siteSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Select Site</option>' +
                        activeSites.map(site => `<option value="${site.id}">${site.name}</option>`).join('');
                }
            });
        }

        function updatePositionDropdowns() {
            // Get unique positions from existing staff
            const positions = [...new Set(allStaff.map(s => s.position).filter(p => p && p.trim()))].sort();

            const positionSelects = ['staffPositionSelect', 'editStaffPositionSelect'];
            positionSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Select Position</option>' +
                        positions.map(pos => `<option value="${pos}">${pos.toUpperCase()}</option>`).join('') +
                        '<option value="__OTHER__">Other (type below)</option>';
                }
            });
        }

        function handlePositionChange(prefix) {
            const select = document.getElementById(`${prefix}PositionSelect`);
            const otherInput = document.getElementById(`${prefix}PositionOther`);
            if (select.value === '__OTHER__') {
                otherInput.style.display = 'block';
                otherInput.focus();
            } else {
                otherInput.style.display = 'none';
                otherInput.value = '';
            }
        }

        function getSelectedPosition(prefix) {
            const select = document.getElementById(`${prefix}PositionSelect`);
            const otherInput = document.getElementById(`${prefix}PositionOther`);
            if (select.value === '__OTHER__') {
                return otherInput.value.trim() || null;
            }
            return select.value || null;
        }

        function updateHourlyFromDaily(prefix) {
            const dailyRate = parseFloat(document.getElementById(`${prefix}DailyRate`).value);
            if (dailyRate && dailyRate > 0) {
                const hourlyRate = (dailyRate / 8).toFixed(2);
                document.getElementById(`${prefix}HourlyRate`).value = hourlyRate;
            }
        }

        function updateDailyFromHourly(prefix) {
            const hourlyRate = parseFloat(document.getElementById(`${prefix}HourlyRate`).value);
            if (hourlyRate && hourlyRate > 0) {
                const dailyRate = (hourlyRate * 8).toFixed(2);
                document.getElementById(`${prefix}DailyRate`).value = dailyRate;
            }
        }

        function showAddSiteModal() {
            document.getElementById('addSiteForm').reset();
            showModal('addSiteModal');
        }

        document.getElementById('addSiteForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                name: document.getElementById('siteName').value,
                code: document.getElementById('siteCode').value,
                description: document.getElementById('siteDescription').value,
                address: document.getElementById('siteAddress').value,
                bank_name: document.getElementById('siteBankName').value,
                account_number: document.getElementById('siteAccountNumber').value
            };

            const response = await apiCall('/api/sites', {
                method: 'POST',
                body: JSON.stringify(data)
            });

            if (response.ok) {
                closeModal('addSiteModal');
                loadSites();
            }
        });

        // ===== STAFF =====
        async function loadStaff() {
            const response = await apiCall('/api/staff');
            allStaff = await response.json();

            const tbody = document.getElementById('staffTableBody');
            if (allStaff.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No staff members found</td></tr>';
                return;
            }

            // Group staff by site
            const bySite = {};
            allStaff.forEach(staff => {
                const siteName = staff.site_name || 'No Site';
                if (!bySite[siteName]) {
                    bySite[siteName] = [];
                }
                bySite[siteName].push(staff);
            });

            // Sort sites alphabetically, then staff within each site
            const sortedSites = Object.keys(bySite).sort();

            let html = '';
            sortedSites.forEach(siteName => {
                // Sort staff within site - highest daily rate first, then alphabetically
                bySite[siteName].sort((a, b) => {
                    const aRate = a.daily_rate || 0;
                    const bRate = b.daily_rate || 0;
                    if (bRate !== aRate) return bRate - aRate;  // Highest rate first
                    return a.full_name.localeCompare(b.full_name);
                });

                // Add site header row
                html += `
                    <tr style="background: #059669; color: white;">
                        <td colspan="4" style="padding: 0.75rem; font-weight: 700; font-size: 1rem;">
                            ${siteName} (${bySite[siteName].length} staff)
                        </td>
                    </tr>
                `;

                // Add staff rows for this site
                html += bySite[siteName].map(staff => {
                    const cellNo = staff.mobile || staff.phone || 'NO NUMBER';
                    const hasPhone = staff.mobile || staff.phone;
                    const locateBtn = hasPhone ? `<button onclick="quickLocate(${staff.id}, '${staff.full_name}')" style="background: none; border: none; cursor: pointer; font-size: 1.1rem; padding: 0 4px;" title="Request whereabouts">üìç</button>` : '';

                    return `
                    <tr>
                        <td><strong>${staff.full_name}</strong></td>
                        <td style="color: #dc2626; font-weight: 700;">${locateBtn}${cellNo}</td>
                        <td>R ${staff.daily_rate ? staff.daily_rate.toFixed(2) : '0.00'}</td>
                        <td>
                            <button class="btn btn-small" style="background: #3b82f6; color: white;" onclick='showEditStaffModal(${JSON.stringify(staff)})'>Edit</button>
                            <button class="btn btn-small" style="background: #0284c7; color: white;" onclick="showStaffHistory(${staff.id}, '${staff.full_name}')">History</button>
                            <button class="btn btn-small" style="background: #7c3aed; color: white;" onclick="manageLoans(${staff.id}, '${staff.full_name}')">Loans</button>
                            <button class="btn btn-small" style="background: #f59e0b; color: white;" onclick="manageDeductions(${staff.id}, '${staff.full_name}')">Deductions</button>
                        </td>
                    </tr>
                `;
                }).join('');
            });

            tbody.innerHTML = html;

            // Populate site filter dropdown
            populateStaffSiteFilter();
        }

        function populateStaffSiteFilter() {
            const filter = document.getElementById('staffSiteFilter');
            const uniqueSites = [...new Set(allStaff.map(s => s.site_name).filter(Boolean))].sort();

            filter.innerHTML = '<option value="">All Sites</option>';
            uniqueSites.forEach(siteName => {
                const option = document.createElement('option');
                option.value = siteName;
                option.textContent = siteName;
                filter.appendChild(option);
            });
        }

        function filterStaffBySite() {
            const selectedSite = document.getElementById('staffSiteFilter').value;
            const showCasuals = document.getElementById('staffShowCasuals').checked;
            const tbody = document.getElementById('staffTableBody');

            // Filter staff
            let filteredStaff = allStaff;
            if (selectedSite) {
                filteredStaff = filteredStaff.filter(s => s.site_name === selectedSite);
            }
            if (!showCasuals) {
                filteredStaff = filteredStaff.filter(s => s.employment_type !== 'casual');
            }

            if (filteredStaff.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No staff found for this site</td></tr>';
                return;
            }

            // Group by site
            const bySite = {};
            filteredStaff.forEach(staff => {
                const siteName = staff.site_name || 'No Site';
                if (!bySite[siteName]) {
                    bySite[siteName] = [];
                }
                bySite[siteName].push(staff);
            });

            // Sort and build HTML
            const sortedSites = Object.keys(bySite).sort();
            let html = '';
            sortedSites.forEach(siteName => {
                // Sort staff - highest daily rate first, then alphabetically
                bySite[siteName].sort((a, b) => {
                    const aRate = a.daily_rate || 0;
                    const bRate = b.daily_rate || 0;
                    if (bRate !== aRate) return bRate - aRate;
                    return a.full_name.localeCompare(b.full_name);
                });

                html += `
                    <tr style="background: #059669; color: white;">
                        <td colspan="4" style="padding: 0.75rem; font-weight: 700; font-size: 1rem;">
                            ${siteName} (${bySite[siteName].length} staff)
                        </td>
                    </tr>
                `;

                html += bySite[siteName].map(staff => {
                    const cellNo = staff.mobile || staff.phone || 'NO NUMBER';
                    const hasPhone = staff.mobile || staff.phone;
                    const locateBtn = hasPhone ? `<button onclick="quickLocate(${staff.id}, '${staff.full_name}')" style="background: none; border: none; cursor: pointer; font-size: 1.1rem; padding: 0 4px;" title="Request whereabouts">üìç</button>` : '';

                    return `
                    <tr>
                        <td><strong>${staff.full_name}</strong></td>
                        <td style="color: #dc2626; font-weight: 700;">${locateBtn}${cellNo}</td>
                        <td>R ${staff.daily_rate ? staff.daily_rate.toFixed(2) : '0.00'}</td>
                        <td>
                            <button class="btn btn-small" style="background: #3b82f6; color: white;" onclick='showEditStaffModal(${JSON.stringify(staff)})'>Edit</button>
                            <button class="btn btn-small" style="background: #0284c7; color: white;" onclick="showStaffHistory(${staff.id}, '${staff.full_name}')">History</button>
                            <button class="btn btn-small" style="background: #7c3aed; color: white;" onclick="manageLoans(${staff.id}, '${staff.full_name}')">Loans</button>
                            <button class="btn btn-small" style="background: #f59e0b; color: white;" onclick="manageDeductions(${staff.id}, '${staff.full_name}')">Deductions</button>
                        </td>
                    </tr>
                `;
                }).join('');
            });

            tbody.innerHTML = html;
        }

        function showAddStaffModal() {
            document.getElementById('addStaffForm').reset();
            updateSiteDropdowns();
            updatePositionDropdowns();
            document.getElementById('staffPositionOther').style.display = 'none';
            showModal('addStaffModal');
        }

        document.getElementById('addStaffForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                first_name: document.getElementById('staffFirstName').value,
                last_name: document.getElementById('staffLastName').value,
                id_number: document.getElementById('staffIdNumber').value || null,
                site_id: document.getElementById('staffSite').value || null,
                position: getSelectedPosition('staff'),
                employment_type: document.getElementById('staffEmploymentType').value,
                daily_rate: document.getElementById('staffDailyRate').value || 0,
                hourly_rate: document.getElementById('staffHourlyRate').value || 0,
                mobile: document.getElementById('staffMobile').value || null,
                phone: document.getElementById('staffPhone').value || null,
                email: document.getElementById('staffEmail').value || null,
                bank_name: document.getElementById('staffBankName').value || null,
                bank_account: document.getElementById('staffBankAccount').value || null,
                hire_date: new Date().toISOString()
            };

            const response = await apiCall('/api/staff', {
                method: 'POST',
                body: JSON.stringify(data)
            });

            if (response.ok) {
                closeModal('addStaffModal');
                loadStaff();
            }
        });

        function showEditStaffModal(staff) {
            document.getElementById('editStaffId').value = staff.id;
            document.getElementById('editStaffFirstName').value = staff.first_name;
            document.getElementById('editStaffLastName').value = staff.last_name;
            document.getElementById('editStaffIdNumber').value = staff.id_number || '';
            document.getElementById('editStaffEmploymentType').value = staff.employment_type;
            document.getElementById('editStaffDailyRate').value = staff.daily_rate || '';
            document.getElementById('editStaffHourlyRate').value = staff.hourly_rate || '';
            document.getElementById('editStaffMobile').value = staff.mobile || '';
            document.getElementById('editStaffPhone').value = staff.phone || '';
            document.getElementById('editStaffEmail').value = staff.email || '';
            document.getElementById('editStaffBankName').value = staff.bank_name || '';
            document.getElementById('editStaffBankAccount').value = staff.bank_account || '';

            updateSiteDropdowns();
            document.getElementById('editStaffSite').value = staff.site_id || '';

            // Set position dropdown
            updatePositionDropdowns();
            const positionSelect = document.getElementById('editStaffPositionSelect');
            const positionOther = document.getElementById('editStaffPositionOther');
            const currentPosition = staff.position || '';

            // Check if current position exists in dropdown options
            const existsInDropdown = [...positionSelect.options].some(opt => opt.value === currentPosition);
            if (currentPosition && !existsInDropdown) {
                // Position is custom - show Other field
                positionSelect.value = '__OTHER__';
                positionOther.value = currentPosition;
                positionOther.style.display = 'block';
            } else {
                positionSelect.value = currentPosition;
                positionOther.value = '';
                positionOther.style.display = 'none';
            }

            showModal('editStaffModal');
        }

        document.getElementById('editStaffForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const staffId = document.getElementById('editStaffId').value;
            const data = {
                first_name: document.getElementById('editStaffFirstName').value,
                last_name: document.getElementById('editStaffLastName').value,
                id_number: document.getElementById('editStaffIdNumber').value || null,
                site_id: document.getElementById('editStaffSite').value || null,
                position: getSelectedPosition('editStaff'),
                employment_type: document.getElementById('editStaffEmploymentType').value,
                daily_rate: document.getElementById('editStaffDailyRate').value || 0,
                hourly_rate: document.getElementById('editStaffHourlyRate').value || 0,
                mobile: document.getElementById('editStaffMobile').value || null,
                phone: document.getElementById('editStaffPhone').value || null,
                email: document.getElementById('editStaffEmail').value || null,
                bank_name: document.getElementById('editStaffBankName').value || null,
                bank_account: document.getElementById('editStaffBankAccount').value || null
            };

            const response = await apiCall(`/api/staff/${staffId}`, {
                method: 'PUT',
                body: JSON.stringify(data)
            });

            if (response.ok) {
                closeModal('editStaffModal');
                loadStaff();
            }
        });

        // ===== PAY PERIODS =====
        async function loadPayPeriods() {
            const response = await apiCall('/api/pay-periods');
            payPeriods = await response.json();

            const select = document.getElementById('payPeriodSelect');
            select.innerHTML = '<option value="">Select a pay period...</option>' +
                payPeriods.map(p => `
                    <option value="${p.id}">Period ${p.period_number} - ${p.year} (${formatDateDMY(p.start_date)} to ${formatDateDMY(p.end_date)})</option>
                `).join('');
        }

        function showAddPeriodModal() {
            document.getElementById('addPeriodForm').reset();

            // Calculate suggested dates based on last period
            let suggestedStartDate = new Date();
            let suggestedEndDate = new Date();

            if (payPeriods && payPeriods.length > 0) {
                // Get the most recent period (sorted by end_date descending)
                const sortedPeriods = [...payPeriods].sort((a, b) => new Date(b.end_date) - new Date(a.end_date));
                const lastPeriod = sortedPeriods[0];

                // Start date = day after last period ends
                suggestedStartDate = new Date(lastPeriod.end_date);
                suggestedStartDate.setDate(suggestedStartDate.getDate() + 1);

                // End date = 13 days after start (14-day period inclusive)
                suggestedEndDate = new Date(suggestedStartDate);
                suggestedEndDate.setDate(suggestedEndDate.getDate() + 13);
            } else {
                // No previous periods - suggest next Saturday as start
                const today = new Date();
                const dayOfWeek = today.getDay(); // 0=Sunday, 6=Saturday
                const daysUntilSaturday = (6 - dayOfWeek + 7) % 7 || 7; // Days until next Saturday

                suggestedStartDate.setDate(today.getDate() + daysUntilSaturday);

                // End date = 13 days later (Friday)
                suggestedEndDate = new Date(suggestedStartDate);
                suggestedEndDate.setDate(suggestedEndDate.getDate() + 13);
            }

            // Format dates as YYYY-MM-DD for input fields
            const formatDate = (date) => date.toISOString().split('T')[0];

            // Set year to current year
            document.getElementById('periodYear').value = suggestedStartDate.getFullYear();

            // Pre-fill dates
            document.getElementById('periodStartDate').value = formatDate(suggestedStartDate);
            document.getElementById('periodEndDate').value = formatDate(suggestedEndDate);

            showModal('addPeriodModal');
        }

        document.getElementById('addPeriodForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                year: parseInt(document.getElementById('periodYear').value),
                start_date: document.getElementById('periodStartDate').value,
                end_date: document.getElementById('periodEndDate').value
            };

            const response = await apiCall('/api/pay-periods', {
                method: 'POST',
                body: JSON.stringify(data)
            });

            if (response.ok) {
                closeModal('addPeriodModal');
                loadPayPeriods();
            }
        });

        // Force Delete Form Handler
        document.getElementById('forceDeleteForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const password = document.getElementById('forceDeletePassword').value;
            const periodId = window.forceDeletePeriodId;

            if (!periodId || !password) {
                alert('Missing period ID or password');
                return;
            }

            // Second confirmation - final warning before force delete
            if (!confirm('‚ö†Ô∏è FINAL CONFIRMATION ‚ö†Ô∏è\n\nAre you ABSOLUTELY SURE you want to FORCE DELETE this locked period?\n\nAll PDFs, payslips, and transactions will be PERMANENTLY DELETED.\n\nClick OK to proceed with FORCE DELETE.')) {
                return;
            }

            try {
                // Step 1: Verify admin password
                const verifyResponse = await apiCall('/api/auth/verify-password', {
                    method: 'POST',
                    body: JSON.stringify({ password })
                });

                if (!verifyResponse) {
                    alert('‚ùå Authentication error. Please log in again.');
                    return;
                }

                if (!verifyResponse.ok) {
                    const error = await verifyResponse.json();
                    alert('‚ùå Password verification failed: ' + (error.error || 'Invalid password'));
                    return;
                }

                // Step 2: Perform force delete with force=true parameter
                const deleteResponse = await apiCall(`/api/pay-periods/${periodId}?force=true`, {
                    method: 'DELETE'
                });

                if (!deleteResponse) {
                    alert('‚ùå Authentication error. Please log in again.');
                    return;
                }

                if (deleteResponse.ok) {
                    const result = await deleteResponse.json();
                    closeModal('forceDeleteModal');
                    alert('‚úÖ ' + result.message + '\n\n' + (result.pdfs_deleted ? 'PDFs were deleted.' : 'No PDFs found.'));
                    document.getElementById('payPeriodSelect').value = '';
                    document.getElementById('deletePeriodBtn').style.display = 'none';
                    document.getElementById('payslipsCard').classList.add('hidden');
                    loadPayPeriods();
                } else {
                    const error = await deleteResponse.json();
                    alert('‚ùå Force delete failed: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        });

        async function deleteCurrentPeriod() {
            const periodId = document.getElementById('payPeriodSelect').value;
            if (!periodId) {
                alert('Please select a pay period first');
                return;
            }

            const period = payPeriods.find(p => p.id == periodId);

            // First confirmation - standard delete warning
            if (!confirm(`Delete pay period ${period.year}-${period.period_number}?\n\nThis will delete:\n- The pay period\n- All payslips\n\nThis CANNOT be undone!`)) {
                return;
            }

            const response = await apiCall(`/api/pay-periods/${periodId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                const result = await response.json();
                alert(result.message);
                document.getElementById('payPeriodSelect').value = '';
                document.getElementById('deletePeriodBtn').style.display = 'none';
                document.getElementById('payslipsCard').classList.add('hidden');
                loadPayPeriods();
            } else {
                const error = await response.json();
                if (error.locked) {
                    // Period is locked - offer force delete option (admin only)
                    if (currentUser && currentUser.role === 'admin') {
                        // Show force delete modal with password confirmation
                        showForceDeleteModal(period, error.pdf_count || 0);
                    } else {
                        alert('‚ö†Ô∏è PERIOD IS LOCKED\n\n' + error.error + '\n\nPDFs have been generated for this period, so it cannot be deleted.\n\nThis protects your finalized payroll data.\n\nOnly ADMIN users can force delete locked periods.');
                    }
                } else {
                    alert('Error: ' + (error.error || 'Failed to delete period'));
                }
            }
        }

        function showForceDeleteModal(period, pdfCount) {
            // Populate modal with period info
            document.getElementById('forceDeletePeriodInfo').textContent = `${period.year}-${period.period_number}`;
            document.getElementById('forceDeletePdfCount').textContent = pdfCount;
            document.getElementById('forceDeletePassword').value = '';

            // Store period ID for later use
            window.forceDeletePeriodId = period.id;

            // Show modal
            document.getElementById('forceDeleteModal').style.display = 'flex';
        }

        // ===== PAYSLIPS =====
        async function loadPayslips() {
            const periodId = document.getElementById('payPeriodSelect').value;
            const deleteBtn = document.getElementById('deletePeriodBtn');

            if (!periodId) {
                document.getElementById('payslipsCard').classList.add('hidden');
                deleteBtn.style.display = 'none';
                return;
            }

            // Show delete button when a period is selected
            deleteBtn.style.display = 'block';

            currentPayPeriod = payPeriods.find(p => p.id == periodId);

            const response = await apiCall(`/api/payslips?pay_period_id=${periodId}`);
            currentPayslips = await response.json();

            // Get staff not in payslips yet
            const staffInPayslips = currentPayslips.map(p => p.staff_id);
            const staffNotInPayslips = allStaff.filter(s => !staffInPayslips.includes(s.id) && s.is_active);

            const container = document.getElementById('payslipsContainer');

            let html = '';

            // Existing payslips
            if (currentPayslips.length > 0) {
                html += '<h3 style="margin-bottom: 1rem;">Staff Payslips</h3>';

                // Filter by selected site and casuals checkbox
                const selectedSite = document.getElementById('payslipSiteFilter')?.value;
                const showCasuals = document.getElementById('payslipShowCasuals')?.checked ?? true;
                let filteredPayslips = currentPayslips;
                if (selectedSite) {
                    filteredPayslips = filteredPayslips.filter(p => p.staff_site_name === selectedSite);
                }
                if (!showCasuals) {
                    filteredPayslips = filteredPayslips.filter(p => p.staff_employment_type !== 'casual');
                }

                // Group payslips by site
                const bySite = {};
                filteredPayslips.forEach(payslip => {
                    const siteName = payslip.staff_site_name || 'No Site';
                    if (!bySite[siteName]) {
                        bySite[siteName] = [];
                    }
                    bySite[siteName].push(payslip);
                });

                // Sort sites alphabetically, then payslips within each site
                const sortedSites = Object.keys(bySite).sort();

                sortedSites.forEach(siteName => {
                    // Sort payslips within site - highest daily rate first, then alphabetically
                    bySite[siteName].sort((a, b) => {
                        const aRate = a.staff_daily_rate || 0;
                        const bRate = b.staff_daily_rate || 0;
                        if (bRate !== aRate) return bRate - aRate;
                        return a.staff_name.localeCompare(b.staff_name);
                    });

                    // Add site header row
                    html += `
                        <div style="background: #059669; color: white; padding: 0.75rem; font-weight: 700; font-size: 1rem; margin-bottom: 0.5rem; border-radius: 8px;">
                            ${siteName} (${bySite[siteName].length} payslips)
                        </div>
                    `;

                    // Add payslip cards for this site
                    bySite[siteName].forEach(payslip => {
                    // Calculate multipliers
                    const w1Weekdays = ['w1_monday', 'w1_tuesday', 'w1_wednesday', 'w1_thursday', 'w1_friday'];
                    const w2Weekdays = ['w2_monday', 'w2_tuesday', 'w2_wednesday', 'w2_thursday', 'w2_friday'];
                    const w1WeekdaysWorked = w1Weekdays.filter(d => payslip[d]).length;
                    const w2WeekdaysWorked = w2Weekdays.filter(d => payslip[d]).length;
                    const w1Multiplier = w1WeekdaysWorked >= 3 ? 1.5 : 1.0;
                    const w2Multiplier = w2WeekdaysWorked >= 3 ? 1.5 : 1.0;

                    // Build 14-day display
                    const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                    let daysHtml = '<div style="display: grid; grid-template-columns: auto repeat(7, 1fr); gap: 0.25rem; margin: 1rem 0; font-size: 0.85rem;">';

                    // Week 1
                    daysHtml += '<div style="font-weight: 600; padding: 0.25rem; font-size: 0.9rem;">W1</div>';
                    days.forEach(day => {
                        const dayValue = payslip[`w1_${day}`] || 0;  // 0.0, 0.5, or 1.0
                        const isWorked = dayValue > 0;
                        const isHalfDay = dayValue === 0.5;
                        const isFullDay = dayValue === 1.0;
                        const isWeekend = day === 'saturday' || day === 'sunday';
                        const gets15x = isFullDay && isWeekend && w1Multiplier === 1.5;
                        const bgColor = isWorked ? (isWeekend ? '#fef3c7' : '#dbeafe') : '#f3f4f6';
                        // Show: ¬Ω for half day, ‚úì* for weekend with 1.5x, ‚úì for full day
                        const checkMark = isHalfDay ? '¬Ω' : (isFullDay ? (gets15x ? '‚úì*' : '‚úì') : '');
                        daysHtml += `<div style="background: ${bgColor}; padding: 0.35rem; text-align: center; border-radius: 4px; border: 1px solid #e5e7eb; font-weight: 500;">
                            ${checkMark}
                        </div>`;
                    });

                    // Week 2
                    daysHtml += '<div style="font-weight: 600; padding: 0.25rem; font-size: 0.9rem;">W2</div>';
                    days.forEach(day => {
                        const dayValue = payslip[`w2_${day}`] || 0;  // 0.0, 0.5, or 1.0
                        const isWorked = dayValue > 0;
                        const isHalfDay = dayValue === 0.5;
                        const isFullDay = dayValue === 1.0;
                        const isWeekend = day === 'saturday' || day === 'sunday';
                        const gets15x = isFullDay && isWeekend && w2Multiplier === 1.5;
                        const bgColor = isWorked ? (isWeekend ? '#fef3c7' : '#dbeafe') : '#f3f4f6';
                        // Show: ¬Ω for half day, ‚úì* for weekend with 1.5x, ‚úì for full day
                        const checkMark = isHalfDay ? '¬Ω' : (isFullDay ? (gets15x ? '‚úì*' : '‚úì') : '');
                        daysHtml += `<div style="background: ${bgColor}; padding: 0.35rem; text-align: center; border-radius: 4px; border: 1px solid #e5e7eb; font-weight: 500;">
                            ${checkMark}
                        </div>`;
                    });

                    // Day labels
                    daysHtml += '<div></div>';
                    ['M', 'T', 'W', 'T', 'F', 'S', 'S'].forEach(label => {
                        daysHtml += `<div style="color: #6b7280; text-align: center; font-weight: 500; font-size: 0.8rem;">${label}</div>`;
                    });

                    daysHtml += '</div>';

                    // Weekend rates info
                    const ratesHtml = `<div style="font-size: 0.8rem; color: #92400e; margin-bottom: 0.5rem;">
                        Weekend rates: W1 ${w1Multiplier}x, W2 ${w2Multiplier}x
                    </div>`;

                    html += `
                        <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong style="font-size: 1.1rem;">${payslip.staff_name}</strong>
                                    <div style="color: #6b7280; font-size: 0.9rem;">${payslip.staff_position || ''}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 1.1rem; white-space: nowrap; font-weight: 600;">
                                        <span style="color: #dc2626;">GROSS R ${payslip.gross_pay.toFixed(2)}</span>
                                        <span style="color: #6b7280; margin: 0 0.5rem;">-</span>
                                        <span style="color: #7c3aed;">LOANS R ${(payslip.loan_deduction || 0).toFixed(2)}</span>
                                        <span style="color: #6b7280; margin: 0 0.5rem;">-</span>
                                        <span style="color: #059669;">SAVINGS R ${(payslip.savings_deduction || 0).toFixed(2)}</span>
                                        <span style="color: #6b7280; margin: 0 0.5rem;">-</span>
                                        <span style="color: #f59e0b;">DEDUCTIONS R ${(payslip.other_deductions || 0).toFixed(2)}</span>
                                        <span style="color: #6b7280; margin: 0 0.5rem;">=</span>
                                        <span style="color: #059669;">NETT R ${payslip.net_pay.toFixed(2)}</span>
                                    </div>
                                </div>
                            </div>
                            ${daysHtml}
                            ${ratesHtml}
                            <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                                <button class="btn btn-small" style="background: #3b82f6; color: white;" onclick="editDays(${payslip.id}, '${payslip.staff_name}')">Edit Days</button>
                                <button class="btn btn-small" style="background: #7c3aed; color: white;" onclick="manageLoans(${payslip.staff_id}, '${payslip.staff_name}')">Loans</button>
                                <button class="btn btn-small" style="background: #059669; color: white;" onclick="manageSavings(${payslip.staff_id}, '${payslip.staff_name}')">Savings</button>
                                <button class="btn btn-small" style="background: #f59e0b; color: white;" onclick="manageDeductions(${payslip.staff_id}, '${payslip.staff_name}')">Deductions</button>
                                <button class="btn btn-small" style="background: ${payslip.payment_method === 'CASH' ? '#dc2626' : '#0891b2'}; color: white;" onclick="event.stopPropagation(); togglePaymentMethod(${payslip.id}, '${payslip.payment_method || 'BANK'}')">
                                    PMNT: ${payslip.payment_method || 'BANK'}
                                </button>
                                <button class="btn btn-small" style="background: ${payslip.is_approved ? '#10b981' : '#6b7280'}; color: white;" onclick="approvePayslip(${payslip.id})">
                                    ${payslip.is_approved ? '‚úì Approved' : 'Approve'}
                                </button>
                            </div>
                        </div>
                    `;
                    });
                });
            }

            // Staff without payslips
            if (staffNotInPayslips.length > 0) {
                html += '<h3 style="margin-top: 2rem; margin-bottom: 1rem;">Add Payslips</h3>';

                // Group staff without payslips by site
                const staffBySite = {};
                staffNotInPayslips.forEach(staff => {
                    const siteName = staff.site_name || 'No Site';
                    if (!staffBySite[siteName]) {
                        staffBySite[siteName] = [];
                    }
                    staffBySite[siteName].push(staff);
                });

                // Sort sites alphabetically, then staff within each site
                const sortedStaffSites = Object.keys(staffBySite).sort();

                sortedStaffSites.forEach(siteName => {
                    // Sort staff within site - highest daily rate first, then alphabetically
                    staffBySite[siteName].sort((a, b) => {
                        const aRate = a.daily_rate || 0;
                        const bRate = b.daily_rate || 0;
                        if (bRate !== aRate) return bRate - aRate;
                        return a.full_name.localeCompare(b.full_name);
                    });

                    // Add site header row
                    html += `
                        <div style="background: #059669; color: white; padding: 0.75rem; font-weight: 700; font-size: 1rem; margin-bottom: 0.5rem; border-radius: 8px;">
                            ${siteName} (${staffBySite[siteName].length} staff)
                        </div>
                    `;

                    // Add staff cards for this site
                    staffBySite[siteName].forEach(staff => {
                        html += `
                            <div style="border: 1px dashed #d1d5db; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>${staff.full_name}</strong>
                                        <div style="color: #6b7280; font-size: 0.9rem;">${staff.position || ''}</div>
                                    </div>
                                    <button class="btn btn-primary btn-small" onclick="createPayslip(${staff.id})">Add to Payroll</button>
                                </div>
                            </div>
                        `;
                    });
                });
            }

            container.innerHTML = html;
            document.getElementById('payslipsCard').classList.remove('hidden');

            // Control button visibility
            const addAllBtn = document.getElementById('addAllToPayrollBtn');
            const paymentSummaryBtn = document.getElementById('paymentSummaryBtn');
            const generatePDFsBtn = document.getElementById('generatePDFsBtn');

            // Show "Add All to Payroll" button if there are staff not yet added
            if (staffNotInPayslips.length > 0) {
                addAllBtn.style.display = 'block';
            } else {
                addAllBtn.style.display = 'none';
            }

            // Show "Payment Summary" button if there are any payslips
            if (currentPayslips.length > 0) {
                paymentSummaryBtn.style.display = 'block';
            } else {
                paymentSummaryBtn.style.display = 'none';
            }

            // Show "Generate PDFs" and "Send SMS" buttons only if:
            // 1. There are payslips
            // 2. At least one payslip is approved
            const hasApprovedPayslips = currentPayslips.some(p => p.is_approved);
            const sendSMSBtn = document.getElementById('sendSMSBtn');
            if (currentPayslips.length > 0 && hasApprovedPayslips) {
                generatePDFsBtn.style.display = 'block';
                sendSMSBtn.style.display = 'block';
            } else {
                generatePDFsBtn.style.display = 'none';
                sendSMSBtn.style.display = 'none';
            }

            // Populate payslip site filter
            populatePayslipSiteFilter();
        }

        function populatePayslipSiteFilter() {
            const filter = document.getElementById('payslipSiteFilter');
            const uniqueSites = [...new Set(currentPayslips.map(p => p.staff_site_name).filter(Boolean))].sort();

            filter.innerHTML = '<option value="">All Sites</option>';
            uniqueSites.forEach(siteName => {
                const option = document.createElement('option');
                option.value = siteName;
                option.textContent = siteName;
                filter.appendChild(option);
            });
        }

        function filterPayslipsBySite() {
            // Simplified: Just reload payslips which will respect the current filter
            loadPayslips();
        }

        async function createPayslip(staffId) {
            const data = {
                staff_id: staffId,
                pay_period_id: currentPayPeriod.id,
                w1_monday: 1.0,
                w1_tuesday: 1.0,
                w1_wednesday: 1.0,
                w1_thursday: 1.0,
                w1_friday: 1.0,
                w1_saturday: 1.0,
                w1_sunday: 1.0,
                w2_monday: 1.0,
                w2_tuesday: 1.0,
                w2_wednesday: 1.0,
                w2_thursday: 1.0,
                w2_friday: 1.0,
                w2_saturday: 1.0,
                w2_sunday: 1.0
            };

            const response = await apiCall('/api/payslips', {
                method: 'POST',
                body: JSON.stringify(data)
            });

            if (response.ok) {
                loadPayslips();
            }
        }

        async function addAllToPayroll() {
            // Get staff not in payslips yet
            const staffInPayslips = currentPayslips.map(p => p.staff_id);
            const staffNotInPayslips = allStaff.filter(s => !staffInPayslips.includes(s.id) && s.is_active);

            if (staffNotInPayslips.length === 0) {
                return;
            }

            // Create payslips for all staff
            for (const staff of staffNotInPayslips) {
                await createPayslip(staff.id);
            }
        }

        function showPaymentSummary() {
            if (!currentPayPeriod || !currentPayslips || currentPayslips.length === 0) {
                alert('No payslips available for this period.');
                return;
            }

            // Set period info
            document.getElementById('summaryPeriodInfo').textContent =
                `${currentPayPeriod.year}-Period-${currentPayPeriod.period_number} (${formatDateDMY(currentPayPeriod.start_date)} to ${formatDateDMY(currentPayPeriod.end_date)})`;

            // Group payslips by site
            const bySite = {};
            let grandGross = 0;
            let grandDeductions = 0;
            let grandNet = 0;

            currentPayslips.forEach(p => {
                const siteName = p.staff_site_name || 'No Site';
                if (!bySite[siteName]) {
                    bySite[siteName] = {
                        payslips: [],
                        totalGross: 0,
                        totalDeductions: 0,
                        totalNet: 0
                    };
                }

                bySite[siteName].payslips.push(p);
                bySite[siteName].totalGross += p.gross_pay || 0;
                bySite[siteName].totalDeductions += p.total_deductions || 0;
                bySite[siteName].totalNet += p.net_pay || 0;

                grandGross += p.gross_pay || 0;
                grandDeductions += p.total_deductions || 0;
                grandNet += p.net_pay || 0;
            });

            // Build HTML
            let html = '';

            // Summary by site
            Object.keys(bySite).sort().forEach(siteName => {
                const site = bySite[siteName];
                html += `
                    <div style="border: 2px solid #0284c7; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; background: #f0f9ff;">
                        <h3 style="margin: 0 0 1rem 0; color: #0284c7;">${siteName} (${site.payslips.length} staff)</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #0284c7; color: white;">
                                    <th style="padding: 0.5rem; text-align: left; border: 1px solid #0369a1;">Staff Member</th>
                                    <th style="padding: 0.5rem; text-align: right; border: 1px solid #0369a1;">Gross Pay</th>
                                    <th style="padding: 0.5rem; text-align: right; border: 1px solid #0369a1;">Deductions</th>
                                    <th style="padding: 0.5rem; text-align: right; border: 1px solid #0369a1;">Nett Pay</th>
                                    <th style="padding: 0.5rem; text-align: center; border: 1px solid #0369a1;">Payment</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${site.payslips.map((p, idx) => `
                                    <tr style="background: ${idx % 2 === 0 ? 'white' : '#f8fafc'};">
                                        <td style="padding: 0.5rem; border: 1px solid #e2e8f0;">${p.staff_name}</td>
                                        <td style="padding: 0.5rem; text-align: right; border: 1px solid #e2e8f0;">R${(p.gross_pay || 0).toFixed(2)}</td>
                                        <td style="padding: 0.5rem; text-align: right; border: 1px solid #e2e8f0;">R${(p.total_deductions || 0).toFixed(2)}</td>
                                        <td style="padding: 0.5rem; text-align: right; border: 1px solid #e2e8f0; font-weight: 600;">R${(p.net_pay || 0).toFixed(2)}</td>
                                        <td style="padding: 0.5rem; text-align: center; border: 1px solid #e2e8f0;"><span style="padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600; background: ${(p.payment_method || 'BANK') === 'CASH' ? '#fee2e2' : '#dbeafe'}; color: ${(p.payment_method || 'BANK') === 'CASH' ? '#991b1b' : '#1e40af'};">${p.payment_method || 'BANK'}</span></td>
                                    </tr>
                                `).join('')}
                                <tr style="background: #0c4a6e; color: white; font-weight: 700;">
                                    <td style="padding: 0.5rem; border: 1px solid #0369a1;">SITE TOTAL</td>
                                    <td style="padding: 0.5rem; text-align: right; border: 1px solid #0369a1;">R${site.totalGross.toFixed(2)}</td>
                                    <td style="padding: 0.5rem; text-align: right; border: 1px solid #0369a1;">R${site.totalDeductions.toFixed(2)}</td>
                                    <td style="padding: 0.5rem; text-align: right; border: 1px solid #0369a1;" colspan="2">R${site.totalNet.toFixed(2)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            });

            // Group by SITE first, then by bank account for payment totals
            const bySiteThenBank = {};
            currentPayslips.forEach(p => {
                const staff = allStaff.find(s => s.id === p.staff_id);
                const site = allSites.find(s => s.name === p.staff_site_name);
                const siteName = p.staff_site_name || 'Unknown Site';
                const paymentMethod = p.payment_method || 'BANK';

                // Create site group if it doesn't exist
                if (!bySiteThenBank[siteName]) {
                    bySiteThenBank[siteName] = {};
                }

                let bankKey, bankName, accountNo;
                if (paymentMethod === 'CASH') {
                    // CASH payment - use SITE bank details (to draw cash from)
                    if (site?.bank_name && site?.account_number) {
                        bankName = `${site.bank_name} (CASH)`;
                        accountNo = site.account_number;
                        bankKey = `${site.bank_name} - ${site.account_number} - CASH`;
                    } else {
                        // Fallback if site has no bank details
                        bankName = 'CASH TO DRAW';
                        accountNo = 'N/A';
                        bankKey = 'CASH TO DRAW';
                    }
                } else {
                    // BANK payment - use individual STAFF bank details (for direct deposit)
                    if (staff?.bank_name && staff?.bank_account) {
                        bankName = `${staff.bank_name} (EFT)`;
                        accountNo = staff.bank_account;
                        bankKey = `${staff.bank_name} - ${staff.bank_account} - EFT`;
                    } else {
                        // Fallback if staff has no bank details
                        bankName = 'CASH TO DRAW';
                        accountNo = 'N/A';
                        bankKey = 'CASH TO DRAW';
                    }
                }

                if (!bySiteThenBank[siteName][bankKey]) {
                    bySiteThenBank[siteName][bankKey] = {
                        bankName: bankName,
                        accountNo: accountNo,
                        totalNet: 0,
                        count: 0,
                        staffNames: []
                    };
                }

                bySiteThenBank[siteName][bankKey].totalNet += p.net_pay || 0;
                bySiteThenBank[siteName][bankKey].count += 1;
                bySiteThenBank[siteName][bankKey].staffNames.push(p.staff_name);
            });

            // Grand total
            html += `
                <div style="border: 3px solid #059669; border-radius: 8px; padding: 1.5rem; background: #ecfdf5;">
                    <h2 style="margin: 0 0 1rem 0; color: #059669;">GRAND TOTAL (All Sites)</h2>
                    <table style="width: 100%; border-collapse: collapse; font-size: 1.1rem;">
                        <thead>
                            <tr style="background: #059669; color: white;">
                                <th style="padding: 0.75rem; text-align: left; border: 1px solid #047857;">Description</th>
                                <th style="padding: 0.75rem; text-align: right; border: 1px solid #047857;">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="background: white;">
                                <td style="padding: 0.75rem; border: 1px solid #d1d5db; font-weight: 600;">Total Gross Pay</td>
                                <td style="padding: 0.75rem; text-align: right; border: 1px solid #d1d5db; font-weight: 700;">R${grandGross.toFixed(2)}</td>
                            </tr>
                            <tr style="background: #f8fafc;">
                                <td style="padding: 0.75rem; border: 1px solid #d1d5db; font-weight: 600;">Total Deductions</td>
                                <td style="padding: 0.75rem; text-align: right; border: 1px solid #d1d5db; font-weight: 700;">R${grandDeductions.toFixed(2)}</td>
                            </tr>
                            <tr style="background: #047857; color: white; font-size: 1.3rem;">
                                <td style="padding: 0.75rem; border: 1px solid #059669; font-weight: 700;">NETT PAYOUT</td>
                                <td style="padding: 0.75rem; text-align: right; border: 1px solid #059669; font-weight: 700;">R${grandNet.toFixed(2)}</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3 style="margin: 2rem 0 1rem 0; color: #059669;">BANK ACCOUNT BREAKDOWN BY SITE</h3>
                    ${Object.keys(bySiteThenBank).sort().map(siteName => {
                        const siteAccounts = bySiteThenBank[siteName];
                        return `
                            <h4 style="margin: 1.5rem 0 0.5rem 0; color: #0284c7;">${siteName}</h4>
                            <table style="width: 100%; border-collapse: collapse; font-size: 1rem; margin-bottom: 1.5rem;">
                                <thead>
                                    <tr style="background: #10b981; color: white;">
                                        <th style="padding: 0.75rem; text-align: left; border: 1px solid #047857;">Bank</th>
                                        <th style="padding: 0.75rem; text-align: left; border: 1px solid #047857;">Account Number</th>
                                        <th style="padding: 0.75rem; text-align: left; border: 1px solid #047857;">Staff Names</th>
                                        <th style="padding: 0.75rem; text-align: center; border: 1px solid #047857;">Staff Count</th>
                                        <th style="padding: 0.75rem; text-align: right; border: 1px solid #047857;">Total Nett Pay</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Object.keys(siteAccounts).sort().map((key, idx) => {
                                        const bank = siteAccounts[key];
                                        return `
                                            <tr style="background: ${idx % 2 === 0 ? 'white' : '#f0fdf4'};">
                                                <td style="padding: 0.75rem; border: 1px solid #d1d5db; font-weight: 600;">${bank.bankName}</td>
                                                <td style="padding: 0.75rem; border: 1px solid #d1d5db; font-family: monospace;">${bank.accountNo}</td>
                                                <td style="padding: 0.75rem; border: 1px solid #d1d5db;">${bank.staffNames.join(', ')}</td>
                                                <td style="padding: 0.75rem; text-align: center; border: 1px solid #d1d5db;">${bank.count}</td>
                                                <td style="padding: 0.75rem; text-align: right; border: 1px solid #d1d5db; font-weight: 700; font-size: 1.1rem;">R${bank.totalNet.toFixed(2)}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        `;
                    }).join('')}
                </div>
            `;

            document.getElementById('paymentSummaryContent').innerHTML = html;
            showModal('paymentSummaryModal');
        }

        function printPaymentSummary() {
            const periodInfo = document.getElementById('summaryPeriodInfo').textContent;

            // Group payslips by site (rebuild for print)
            const bySite = {};
            let grandGross = 0;
            let grandDeductions = 0;
            let grandNet = 0;

            currentPayslips.forEach(p => {
                const siteName = p.staff_site_name || 'No Site';
                if (!bySite[siteName]) {
                    bySite[siteName] = {
                        payslips: [],
                        totalGross: 0,
                        totalDeductions: 0,
                        totalNet: 0
                    };
                }

                bySite[siteName].payslips.push(p);
                bySite[siteName].totalGross += p.gross_pay || 0;
                bySite[siteName].totalDeductions += p.total_deductions || 0;
                bySite[siteName].totalNet += p.net_pay || 0;

                grandGross += p.gross_pay || 0;
                grandDeductions += p.total_deductions || 0;
                grandNet += p.net_pay || 0;
            });

            // Build HTML with page breaks between sites
            let printContent = '';

            // Each site gets its own page
            Object.keys(bySite).sort().forEach((siteName, index) => {
                const site = bySite[siteName];

                printContent += `
                    <div class="site-page">
                        <h1 style="text-align: center; color: #0284c7; margin-bottom: 0.25rem; font-size: 12pt;">WAGEPRO Payment Summary</h1>
                        <h2 style="text-align: center; color: #64748b; margin-top: 0; margin-bottom: 1rem; font-size: 10pt;">${periodInfo}</h2>
                        <h2 style="color: #0284c7; margin-bottom: 0.5rem; font-size: 10pt;">${siteName} (${site.payslips.length} staff)</h2>
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 1rem; font-size: 8pt;">
                            <thead>
                                <tr style="background: #0284c7; color: white;">
                                    <th style="padding: 0.3rem; text-align: left; border: 1px solid #0369a1;">Staff Member</th>
                                    <th style="padding: 0.3rem; text-align: right; border: 1px solid #0369a1;">Gross Pay</th>
                                    <th style="padding: 0.3rem; text-align: right; border: 1px solid #0369a1;">Deductions</th>
                                    <th style="padding: 0.3rem; text-align: right; border: 1px solid #0369a1;">Nett Pay</th>
                                    <th style="padding: 0.3rem; text-align: center; border: 1px solid #0369a1;">Payment</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${site.payslips.map((p, idx) => `
                                    <tr style="background: ${idx % 2 === 0 ? 'white' : '#f8fafc'};">
                                        <td style="padding: 0.2rem 0.3rem; border: 1px solid #475569;">${p.staff_name}</td>
                                        <td style="padding: 0.2rem 0.3rem; text-align: right; border: 1px solid #475569;">R${(p.gross_pay || 0).toFixed(2)}</td>
                                        <td style="padding: 0.2rem 0.3rem; text-align: right; border: 1px solid #475569;">R${(p.total_deductions || 0).toFixed(2)}</td>
                                        <td style="padding: 0.2rem 0.3rem; text-align: right; border: 1px solid #475569; font-weight: 600;">R${(p.net_pay || 0).toFixed(2)}</td>
                                        <td style="padding: 0.2rem 0.3rem; text-align: center; border: 1px solid #475569;"><span style="padding: 0.1rem 0.25rem; border-radius: 3px; font-weight: 600; font-size: 7pt; background: ${(p.payment_method || 'BANK') === 'CASH' ? '#fee2e2' : '#dbeafe'}; color: ${(p.payment_method || 'BANK') === 'CASH' ? '#991b1b' : '#1e40af'};">${p.payment_method || 'BANK'}</span></td>
                                    </tr>
                                `).join('')}
                                <tr style="background: #0c4a6e; color: white; font-weight: 700; font-size: 9pt;">
                                    <td style="padding: 0.3rem; border: 1px solid #0369a1;">SITE TOTAL</td>
                                    <td style="padding: 0.3rem; text-align: right; border: 1px solid #0369a1;">R${site.totalGross.toFixed(2)}</td>
                                    <td style="padding: 0.3rem; text-align: right; border: 1px solid #0369a1;">R${site.totalDeductions.toFixed(2)}</td>
                                    <td style="padding: 0.3rem; text-align: right; border: 1px solid #0369a1;" colspan="2">R${site.totalNet.toFixed(2)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            });

            // Grand total on its own page
            printContent += `
                <div class="summary-page">
                    <h1 style="text-align: center; color: #0284c7; margin-bottom: 0.25rem; font-size: 12pt;">WAGEPRO Payment Summary</h1>
                    <h2 style="text-align: center; color: #64748b; margin-top: 0; margin-bottom: 1rem; font-size: 10pt;">${periodInfo}</h2>
                    <h2 style="color: #059669; margin-bottom: 0.5rem; font-size: 10pt;">GRAND TOTAL (All Sites)</h2>
                    <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                        <thead>
                            <tr style="background: #059669; color: white;">
                                <th style="padding: 0.4rem; text-align: left; border: 1px solid #047857;">Description</th>
                                <th style="padding: 0.4rem; text-align: right; border: 1px solid #047857;">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="background: white;">
                                <td style="padding: 0.4rem; border: 1px solid #d1d5db; font-weight: 600;">Total Gross Pay</td>
                                <td style="padding: 0.4rem; text-align: right; border: 1px solid #d1d5db; font-weight: 700; font-size: 10pt;">R${grandGross.toFixed(2)}</td>
                            </tr>
                            <tr style="background: #f8fafc;">
                                <td style="padding: 0.4rem; border: 1px solid #d1d5db; font-weight: 600;">Total Deductions</td>
                                <td style="padding: 0.4rem; text-align: right; border: 1px solid #d1d5db; font-weight: 700; font-size: 10pt;">R${grandDeductions.toFixed(2)}</td>
                            </tr>
                            <tr style="background: #047857; color: white; font-size: 10pt;">
                                <td style="padding: 0.4rem; border: 1px solid #059669; font-weight: 700;">NETT PAYOUT</td>
                                <td style="padding: 0.4rem; text-align: right; border: 1px solid #059669; font-weight: 700; font-size: 11pt;">R${grandNet.toFixed(2)}</td>
                            </tr>
                        </tbody>
                    </table>

                    <h3 style="margin: 1rem 0 0.5rem 0; color: #059669; font-size: 10pt;">BANK ACCOUNT BREAKDOWN BY SITE</h3>
                    ${(() => {
                        // Group by SITE first, then by bank account for payment totals
                        const bySiteThenBank = {};
                        currentPayslips.forEach(p => {
                            const staff = allStaff.find(s => s.id === p.staff_id);
                            const site = allSites.find(s => s.name === p.staff_site_name);
                            const siteName = p.staff_site_name || 'Unknown Site';
                            const paymentMethod = p.payment_method || 'BANK';

                            // Create site group if it doesn't exist
                            if (!bySiteThenBank[siteName]) {
                                bySiteThenBank[siteName] = {};
                            }

                            let bankKey, bankName, accountNo;
                            if (paymentMethod === 'CASH') {
                                // CASH payment - use SITE bank details (to draw cash from)
                                if (site?.bank_name && site?.account_number) {
                                    bankName = `${site.bank_name} (CASH)`;
                                    accountNo = site.account_number;
                                    bankKey = `${site.bank_name} - ${site.account_number} - CASH`;
                                } else {
                                    // Fallback if site has no bank details
                                    bankName = 'CASH TO DRAW';
                                    accountNo = 'N/A';
                                    bankKey = 'CASH TO DRAW';
                                }
                            } else {
                                // BANK payment - use individual STAFF bank details (for direct deposit)
                                if (staff?.bank_name && staff?.bank_account) {
                                    bankName = `${staff.bank_name} (EFT)`;
                                    accountNo = staff.bank_account;
                                    bankKey = `${staff.bank_name} - ${staff.bank_account} - EFT`;
                                } else {
                                    // Fallback if staff has no bank details
                                    bankName = 'CASH TO DRAW';
                                    accountNo = 'N/A';
                                    bankKey = 'CASH TO DRAW';
                                }
                            }

                            if (!bySiteThenBank[siteName][bankKey]) {
                                bySiteThenBank[siteName][bankKey] = {
                                    bankName: bankName,
                                    accountNo: accountNo,
                                    totalNet: 0,
                                    count: 0,
                                    staffNames: []
                                };
                            }

                            bySiteThenBank[siteName][bankKey].totalNet += p.net_pay || 0;
                            bySiteThenBank[siteName][bankKey].count += 1;
                            bySiteThenBank[siteName][bankKey].staffNames.push(p.staff_name);
                        });

                        return Object.keys(bySiteThenBank).sort().map(siteName => {
                            const siteAccounts = bySiteThenBank[siteName];

                            // Color-code sites: RUSPLAAS = purple, THE PADDOCK = orange
                            const siteColor = siteName.includes('RUSPLAAS') ? '#9333ea' :
                                            siteName.includes('PADDOCK') ? '#ea580c' : '#0284c7';
                            const siteBgColor = siteName.includes('RUSPLAAS') ? '#f3e8ff' :
                                              siteName.includes('PADDOCK') ? '#ffedd5' : '#f0f9ff';

                            return `
                                <h4 style="margin: 0.75rem 0 0.25rem 0; color: ${siteColor}; font-weight: 700; font-size: 9pt;">${siteName}</h4>
                                <table style="width: 100%; border-collapse: collapse; font-size: 7pt; margin-bottom: 0.75rem; border: 1px solid ${siteColor};">
                                    <thead>
                                        <tr style="background: ${siteColor}; color: white;">
                                            <th style="padding: 0.25rem; text-align: left; border: 1px solid #475569;">Bank</th>
                                            <th style="padding: 0.25rem; text-align: left; border: 1px solid #475569;">Account Number</th>
                                            <th style="padding: 0.25rem; text-align: left; border: 1px solid #475569;">Staff Names</th>
                                            <th style="padding: 0.25rem; text-align: center; border: 1px solid #475569;">Count</th>
                                            <th style="padding: 0.25rem; text-align: right; border: 1px solid #475569;">Total Nett</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${Object.keys(siteAccounts).sort().map((key, idx) => {
                                            const bank = siteAccounts[key];
                                            return `
                                                <tr style="background: ${idx % 2 === 0 ? 'white' : siteBgColor};">
                                                    <td style="padding: 0.2rem 0.25rem; border: 1px solid #475569; font-weight: 600;">${bank.bankName}</td>
                                                    <td style="padding: 0.2rem 0.25rem; border: 1px solid #475569; font-family: monospace;">${bank.accountNo}</td>
                                                    <td style="padding: 0.2rem 0.25rem; border: 1px solid #475569;">${bank.staffNames.join(', ')}</td>
                                                    <td style="padding: 0.2rem 0.25rem; text-align: center; border: 1px solid #475569;">${bank.count}</td>
                                                    <td style="padding: 0.2rem 0.25rem; text-align: right; border: 1px solid #475569; font-weight: 700; font-size: 8pt;">R${bank.totalNet.toFixed(2)}</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            `;
                        }).join('');
                    })()}

                    <p style="text-align: center; margin-top: 1.5rem; color: #64748b; font-style: italic; font-size: 7pt;">
                        Printed: ${new Date().toLocaleString('en-ZA')}
                    </p>
                </div>
            `;

            const printWindow = window.open('', '', 'width=900,height=700');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Payment Summary - ${periodInfo}</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            padding: 10px;
                            margin: 0;
                            font-size: 8pt;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                        }
                        th, td {
                            padding: 3px;
                            border: 1px solid #ddd;
                        }
                        h1, h2, h3 {
                            margin-top: 0;
                        }
                        .site-page {
                            page-break-after: always;
                            padding: 10px;
                        }
                        .summary-page {
                            padding: 10px;
                        }
                        @media print {
                            body { padding: 0; font-size: 8pt; }
                            .site-page {
                                padding: 15px;
                                page-break-after: always;
                            }
                            .summary-page {
                                padding: 15px;
                                page-break-after: avoid;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${printContent}
                    <script>
                        window.onload = function() {
                            window.print();
                            window.close();
                        };
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        let currentStaffHistoryData = null;  // Store full history data

        async function showStaffHistory(staffId, staffName) {
            // Set staff name in modal
            document.getElementById('historyStaffName').textContent = staffName;

            // Show modal with loading message
            showModal('staffHistoryModal');

            try {
                const response = await fetch(`/api/staff/${staffId}/payslip-history`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch staff history');
                }

                currentStaffHistoryData = await response.json();

                // Populate period dropdown
                const periodFilter = document.getElementById('historyPeriodFilter');
                periodFilter.innerHTML = '<option value="">All Periods</option>';
                const periods = currentStaffHistoryData.payslips.map(p => p.period);
                const uniquePeriods = [...new Set(periods)];
                uniquePeriods.forEach(period => {
                    const option = document.createElement('option');
                    option.value = period;
                    option.textContent = period;
                    periodFilter.appendChild(option);
                });

                // Render all periods initially
                renderStaffHistory(currentStaffHistoryData.payslips);

            } catch (error) {
                console.error('Error fetching staff history:', error);
                document.getElementById('staffHistoryContent').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #ef4444;">
                        <p>Failed to load staff history.</p>
                        <p style="font-size: 0.875rem;">${error.message}</p>
                    </div>
                `;
            }
        }

        function filterHistoryByPeriod() {
            const selectedPeriod = document.getElementById('historyPeriodFilter').value;
            if (!currentStaffHistoryData) return;

            let filteredPayslips = currentStaffHistoryData.payslips;
            if (selectedPeriod) {
                filteredPayslips = currentStaffHistoryData.payslips.filter(p => p.period === selectedPeriod);
            }

            renderStaffHistory(filteredPayslips);
        }

        function renderStaffHistory(payslips) {
            // Build history table
                let html = `
                    <div style="margin-bottom: 1rem; padding: 1rem; background: #f1f5f9; border-radius: 8px;">
                        <p style="margin: 0;"><strong>Staff:</strong> ${currentStaffHistoryData.staff_name}</p>
                        <p style="margin: 0.5rem 0 0 0;"><strong>Position:</strong> ${currentStaffHistoryData.staff_position || 'N/A'}</p>
                        <p style="margin: 0.5rem 0 0 0;"><strong>Site:</strong> ${currentStaffHistoryData.staff_site || 'N/A'}</p>
                        <p style="margin: 0.5rem 0 0 0;"><strong>Showing:</strong> ${payslips.length} of ${currentStaffHistoryData.payslips.length} payslips</p>
                    </div>

                    <div style="max-height: 500px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                            <thead style="background: #0284c7; color: white; position: sticky; top: 0;">
                                <tr>
                                    <th style="padding: 0.5rem; text-align: left; border: 1px solid #0369a1;">Period</th>
                                    <th style="padding: 0.5rem; text-align: right; border: 1px solid #0369a1;">Gross Pay</th>
                                    <th style="padding: 0.5rem; text-align: right; border: 1px solid #0369a1;">Deductions</th>
                                    <th style="padding: 0.5rem; text-align: right; border: 1px solid #0369a1;">Net Pay</th>
                                    <th style="padding: 0.5rem; text-align: center; border: 1px solid #0369a1;">Payment</th>
                                    <th style="padding: 0.5rem; text-align: center; border: 1px solid #0369a1;">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                if (payslips.length === 0) {
                    html += `
                        <tr>
                            <td colspan="6" style="padding: 2rem; text-align: center; color: #94a3b8;">
                                No payslip history found for the selected period.
                            </td>
                        </tr>
                    `;
                } else {
                    payslips.forEach((p, idx) => {
                        const statusBadge = p.is_paid
                            ? '<span style="padding: 0.25rem 0.5rem; background: #d1fae5; color: #065f46; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">PAID</span>'
                            : p.is_approved
                                ? '<span style="padding: 0.25rem 0.5rem; background: #dbeafe; color: #1e40af; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">APPROVED</span>'
                                : '<span style="padding: 0.25rem 0.5rem; background: #fef3c7; color: #92400e; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">PENDING</span>';

                        const paymentBadge = (p.payment_method || 'BANK') === 'CASH'
                            ? '<span style="padding: 0.25rem 0.5rem; background: #fee2e2; color: #991b1b; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">CASH</span>'
                            : '<span style="padding: 0.25rem 0.5rem; background: #dbeafe; color: #1e40af; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">BANK</span>';

                        // Build deductions tooltip
                        let deductionsDetail = 'Total Deductions: R' + (p.total_deductions || 0).toFixed(2);
                        if (p.loans && p.loans.length > 0) {
                            deductionsDetail += '\\n\\nLoans:';
                            p.loans.forEach(loan => {
                                deductionsDetail += `\\n  - ${loan.description}: R${loan.amount.toFixed(2)}`;
                            });
                        }

                        html += `
                            <tr style="background: ${idx % 2 === 0 ? 'white' : '#f8fafc'};">
                                <td style="padding: 0.5rem; border: 1px solid #e2e8f0;">
                                    <strong>${p.period}</strong><br>
                                    <span style="font-size: 0.75rem; color: #64748b;">${p.period_start} to ${p.period_end}</span>
                                </td>
                                <td style="padding: 0.5rem; text-align: right; border: 1px solid #e2e8f0;">
                                    <strong>R${(p.gross_pay || 0).toFixed(2)}</strong><br>
                                    <span style="font-size: 0.75rem; color: #64748b;">
                                        Weekday: R${(p.weekday_pay || 0).toFixed(2)}<br>
                                        Weekend: R${(p.weekend_pay || 0).toFixed(2)}<br>
                                        ${(p.overtime_pay || 0) > 0 ? 'OT: R' + (p.overtime_pay || 0).toFixed(2) + '<br>' : ''}
                                        ${(p.bonus || 0) > 0 ? 'Bonus: R' + (p.bonus || 0).toFixed(2) : ''}
                                    </span>
                                </td>
                                <td style="padding: 0.5rem; text-align: right; border: 1px solid #e2e8f0;" title="${deductionsDetail}">
                                    <strong>R${(p.total_deductions || 0).toFixed(2)}</strong><br>
                                    <span style="font-size: 0.75rem; color: #64748b;">
                                        ${p.loans && p.loans.length > 0 ? 'Loans: R' + (p.loan_deduction || 0).toFixed(2) + '<br>' : ''}
                                        ${(p.other_deductions || 0) > 0 ? 'Other: R' + (p.other_deductions || 0).toFixed(2) : ''}
                                    </span>
                                </td>
                                <td style="padding: 0.5rem; text-align: right; border: 1px solid #e2e8f0; font-weight: 700; color: #059669; font-size: 1rem;">
                                    R${(p.net_pay || 0).toFixed(2)}
                                </td>
                                <td style="padding: 0.5rem; text-align: center; border: 1px solid #e2e8f0;">
                                    ${paymentBadge}
                                </td>
                                <td style="padding: 0.5rem; text-align: center; border: 1px solid #e2e8f0;">
                                    ${statusBadge}
                                </td>
                            </tr>
                        `;
                    });
                }

                html += `
                            </tbody>
                        </table>
                    </div>
                `;

                document.getElementById('staffHistoryContent').innerHTML = html;
        }

        function editDays(payslipId, staffName) {
            const payslip = currentPayslips.find(p => p.id === payslipId);
            if (!payslip) return;

            document.getElementById('editDaysPayslipId').value = payslipId;
            document.getElementById('editDaysStaffName').textContent = staffName;

            // Calculate dates for the 14-day period
            const startDate = new Date(currentPayPeriod.start_date);
            const getDayDate = (dayIndex) => {
                const date = new Date(startDate);
                date.setDate(date.getDate() + dayIndex);
                return date.toISOString().split('T')[0]; // YYYY-MM-DD format
            };

            // Reorder days: Saturday to Friday (work week order)
            const days = ['Saturday', 'Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];

            // Build Week 1
            let week1Html = '';
            days.forEach((day, index) => {
                const fieldName = `w1_${day.toLowerCase()}`;
                const isWeekend = day === 'Saturday' || day === 'Sunday';
                const dateStr = getDayDate(index);
                // Convert float to dropdown value: 0.0->none, 0.5->half, 1.0->full
                const dayValue = payslip[fieldName] || 0;
                const currentValue = dayValue === 0 ? 'none' : (dayValue === 0.5 ? 'half' : 'full');

                week1Html += `
                    <div class="day-row ${isWeekend ? 'weekend' : ''}" style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; margin-bottom: 0.25rem; border-radius: 4px;">
                        <span style="font-weight: 500; flex: 1;">${day} <span style="color: #6b7280; font-weight: 400; font-size: 0.85rem;">(${dateStr})</span></span>
                        <select id="edit_${fieldName}" onchange="updateDaysSummary()" style="padding: 0.3rem 0.6rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem; min-width: 130px;">
                            <option value="none" ${currentValue === 'none' ? 'selected' : ''}>Not Worked</option>
                            <option value="half" ${currentValue === 'half' ? 'selected' : ''}>Half Day (0.5)</option>
                            <option value="full" ${currentValue === 'full' ? 'selected' : ''}>Full Day (1.0)</option>
                        </select>
                    </div>
                `;
            });

            // Build Week 2
            let week2Html = '';
            days.forEach((day, index) => {
                const fieldName = `w2_${day.toLowerCase()}`;
                const isWeekend = day === 'Saturday' || day === 'Sunday';
                const dateStr = getDayDate(index + 7); // Week 2 starts at day 7
                // Convert float to dropdown value: 0.0->none, 0.5->half, 1.0->full
                const dayValue = payslip[fieldName] || 0;
                const currentValue = dayValue === 0 ? 'none' : (dayValue === 0.5 ? 'half' : 'full');

                week2Html += `
                    <div class="day-row ${isWeekend ? 'weekend' : ''}" style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; margin-bottom: 0.25rem; border-radius: 4px;">
                        <span style="font-weight: 500; flex: 1;">${day} <span style="color: #6b7280; font-weight: 400; font-size: 0.85rem;">(${dateStr})</span></span>
                        <select id="edit_${fieldName}" onchange="updateDaysSummary()" style="padding: 0.3rem 0.6rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9rem; min-width: 130px;">
                            <option value="none" ${currentValue === 'none' ? 'selected' : ''}>Not Worked</option>
                            <option value="half" ${currentValue === 'half' ? 'selected' : ''}>Half Day (0.5)</option>
                            <option value="full" ${currentValue === 'full' ? 'selected' : ''}>Full Day (1.0)</option>
                        </select>
                    </div>
                `;
            });

            document.getElementById('week1Days').innerHTML = week1Html;
            document.getElementById('week2Days').innerHTML = week2Html;

            // Initialize summary
            updateDaysSummary();

            showModal('editDaysModal');
        }

        function selectAllDays() {
            // Set all dropdowns to "Full Day"
            const allSelects = document.querySelectorAll('#editDaysForm select');
            allSelects.forEach(select => {
                select.value = 'full';
            });
            updateDaysSummary();
        }

        function clearAllDays() {
            // Set all dropdowns to "Not Worked"
            const allSelects = document.querySelectorAll('#editDaysForm select');
            allSelects.forEach(select => {
                select.value = 'none';
            });
            updateDaysSummary();
        }

        function updateDaysSummary() {
            // Count Week 1 days (with half-day support)
            const w1Weekdays = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
            const w1Weekends = ['saturday', 'sunday'];
            let w1WeekdayCount = 0;
            let w1WeekendCount = 0;

            w1Weekdays.forEach(day => {
                const value = document.getElementById(`edit_w1_${day}`)?.value;
                if (value === 'full') w1WeekdayCount += 1;
                if (value === 'half') w1WeekdayCount += 0.5;
            });
            w1Weekends.forEach(day => {
                const value = document.getElementById(`edit_w1_${day}`)?.value;
                if (value === 'full') w1WeekendCount += 1;
                if (value === 'half') w1WeekendCount += 0.5;
            });

            // Count Week 2 days (with half-day support)
            const w2Weekdays = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
            const w2Weekends = ['saturday', 'sunday'];
            let w2WeekdayCount = 0;
            let w2WeekendCount = 0;

            w2Weekdays.forEach(day => {
                const value = document.getElementById(`edit_w2_${day}`)?.value;
                if (value === 'full') w2WeekdayCount += 1;
                if (value === 'half') w2WeekdayCount += 0.5;
            });
            w2Weekends.forEach(day => {
                const value = document.getElementById(`edit_w2_${day}`)?.value;
                if (value === 'full') w2WeekendCount += 1;
                if (value === 'half') w2WeekendCount += 0.5;
            });

            // Calculate multipliers (3+ weekdays = 1.5x, else 1.0x)
            const w1Multiplier = w1WeekdayCount >= 3 ? 1.5 : 1.0;
            const w2Multiplier = w2WeekdayCount >= 3 ? 1.5 : 1.0;

            // Update display (show decimals if half days present)
            document.getElementById('w1WeekdayCount').textContent = w1WeekdayCount % 1 === 0 ? w1WeekdayCount : w1WeekdayCount.toFixed(1);
            document.getElementById('w2WeekdayCount').textContent = w2WeekdayCount % 1 === 0 ? w2WeekdayCount : w2WeekdayCount.toFixed(1);
            document.getElementById('w1WeekendCount').textContent = w1WeekendCount % 1 === 0 ? w1WeekendCount : w1WeekendCount.toFixed(1);
            document.getElementById('w2WeekendCount').textContent = w2WeekendCount % 1 === 0 ? w2WeekendCount : w2WeekendCount.toFixed(1);

            document.getElementById('w1Rate').textContent = w1WeekendCount > 0 ? `(${w1Multiplier}x)` : '';
            document.getElementById('w2Rate').textContent = w2WeekendCount > 0 ? `(${w2Multiplier}x)` : '';

            document.getElementById('week1Multiplier').textContent = w1WeekendCount > 0 ? `Weekend Rate: ${w1Multiplier}x` : '';
            document.getElementById('week2Multiplier').textContent = w2WeekendCount > 0 ? `Weekend Rate: ${w2Multiplier}x` : '';
        }

        document.getElementById('editDaysForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const payslipId = document.getElementById('editDaysPayslipId').value;

            // Convert dropdown values to decimal: none->0.0, half->0.5, full->1.0
            const getValue = (id) => {
                const val = document.getElementById(id)?.value;
                if (val === 'none') return 0.0;
                if (val === 'half') return 0.5;
                if (val === 'full') return 1.0;
                return 0.0;  // Default to not worked
            };

            const data = {
                w1_monday: getValue('edit_w1_monday'),
                w1_tuesday: getValue('edit_w1_tuesday'),
                w1_wednesday: getValue('edit_w1_wednesday'),
                w1_thursday: getValue('edit_w1_thursday'),
                w1_friday: getValue('edit_w1_friday'),
                w1_saturday: getValue('edit_w1_saturday'),
                w1_sunday: getValue('edit_w1_sunday'),
                w2_monday: getValue('edit_w2_monday'),
                w2_tuesday: getValue('edit_w2_tuesday'),
                w2_wednesday: getValue('edit_w2_wednesday'),
                w2_thursday: getValue('edit_w2_thursday'),
                w2_friday: getValue('edit_w2_friday'),
                w2_saturday: getValue('edit_w2_saturday'),
                w2_sunday: getValue('edit_w2_sunday')
            };

            const response = await apiCall(`/api/payslips/${payslipId}`, {
                method: 'PUT',
                body: JSON.stringify(data)
            });

            if (response.ok) {
                closeModal('editDaysModal');
                loadPayslips();
            }
        });

        // ===== LOANS =====
        // (manageLoans function moved to line 3014 - removed duplicate)

        function showAddLoanForm() {
            const staffId = document.getElementById('loansStaffId').value;
            document.getElementById('loanStaffId').value = staffId;
            document.getElementById('addLoanForm').reset();

            // Set default dates
            document.getElementById('loanDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('loanStartDate').value = new Date().toISOString().split('T')[0];

            showModal('addLoanModal');
        }

        document.getElementById('addLoanForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                staff_id: document.getElementById('loanStaffId').value,
                description: document.getElementById('loanDescription').value,
                total_amount: document.getElementById('loanTotalAmount').value,
                installment_amount: document.getElementById('loanInstallment').value,
                loan_date: document.getElementById('loanDate').value,
                start_deduction_date: document.getElementById('loanStartDate').value
            };

            const response = await apiCall('/api/loans', {
                method: 'POST',
                body: JSON.stringify(data)
            });

            if (response.ok) {
                // Reset form for next entry
                document.getElementById('addLoanForm').reset();
                // Set default dates again
                document.getElementById('loanDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('loanStartDate').value = new Date().toISOString().split('T')[0];

                // Refresh loans display without closing modal
                const staffId = document.getElementById('loansStaffId').value;
                const staffName = document.getElementById('loansModalTitle').textContent.replace('Loans - ', '');

                // Reload loans list in background
                const loansResponse = await apiCall(`/api/loans?staff_id=${staffId}`);
                const loans = await loansResponse.json();

                const container = document.getElementById('loansContainer');
                if (loans.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #6b7280;">No loans found</p>';
                } else {
                    container.innerHTML = loans.map(loan => `
                        <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between;">
                                <div>
                                    <strong>${loan.description}</strong>
                                    <div style="font-size: 0.9rem; color: #6b7280;">
                                        Total: R${loan.total_amount.toFixed(2)} |
                                        Paid: R${loan.amount_paid.toFixed(2)} |
                                        Remaining: R${loan.amount_remaining.toFixed(2)}
                                    </div>
                                    <div style="font-size: 0.9rem; color: #6b7280;">
                                        Installment: R${loan.installment_amount.toFixed(2)}
                                    </div>
                                </div>
                                <div>
                                    <span style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; ${loan.is_active ? 'background: #d1fae5; color: #065f46;' : 'background: #fee2e2; color: #991b1b;'}">
                                        ${loan.is_active ? 'Active' : 'Completed'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }

                // Close the add loan modal
                closeModal('addLoanModal');

                // Update the main loans modal list
                const loansListResponse = await apiCall(`/api/loans?staff_id=${staffId}`);
                const updatedLoans = await loansListResponse.json();

                const mainContainer = document.getElementById('loansContainer');
                if (updatedLoans.length === 0) {
                    mainContainer.innerHTML = '<p style="text-align: center; color: #6b7280;">No loans found</p>';
                } else {
                    mainContainer.innerHTML = updatedLoans.map(loan => `
                        <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between;">
                                <div>
                                    <strong>${loan.description}</strong>
                                    <div style="font-size: 0.9rem; color: #6b7280;">
                                        Total: R${loan.total_amount.toFixed(2)} |
                                        Paid: R${loan.amount_paid.toFixed(2)} |
                                        Remaining: R${loan.amount_remaining.toFixed(2)}
                                    </div>
                                    <div style="font-size: 0.9rem; color: #6b7280;">
                                        Installment: R${loan.installment_amount.toFixed(2)}
                                    </div>
                                </div>
                                <div>
                                    <span style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; ${loan.is_active ? 'background: #d1fae5; color: #065f46;' : 'background: #fee2e2; color: #991b1b;'}">
                                        ${loan.is_active ? 'Active' : 'Completed'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }

                alert('‚úÖ Loan created successfully!');

                // Automatically reopen the add loan form for the next entry
                showAddLoanForm();
            }
        });

        // ===== DEDUCTIONS =====
        async function manageDeductions(staffId, staffName) {
            document.getElementById('deductionsStaffId').value = staffId;
            document.getElementById('deductionsModalTitle').textContent = `Deductions - ${staffName}`;

            const response = await apiCall(`/api/deductions?staff_id=${staffId}`);
            const deductions = await response.json();

            const container = document.getElementById('deductionsContainer');

            if (deductions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280;">No deductions found</p>';
            } else {
                container.innerHTML = deductions.map(d => `
                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between;">
                            <div>
                                <strong>${d.description}</strong>
                                <div style="font-size: 0.9rem; color: #6b7280;">
                                    ${d.deduction_type === 'percentage' ? `${d.percentage}% of gross pay` : `R${d.fixed_amount.toFixed(2)} fixed`}
                                    ${d.deduction_type === 'once_off' ? ' (Once Off)' : ''}
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-small ${d.is_active ? 'btn-secondary' : 'btn-primary'}"
                                        onclick="toggleDeduction(${d.id})">
                                    ${d.is_active ? 'Deactivate' : 'Activate'}
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            showModal('deductionsModal');
        }

        function showAddDeductionForm() {
            const staffId = document.getElementById('deductionsStaffId').value;
            document.getElementById('deductionStaffId').value = staffId;
            document.getElementById('addDeductionForm').reset();
            toggleDeductionFields();
            showModal('addDeductionModal');
        }

        function toggleDeductionFields() {
            const type = document.getElementById('deductionType').value;
            const fixedGroup = document.getElementById('fixedAmountGroup');
            const percentageGroup = document.getElementById('percentageGroup');

            if (type === 'percentage') {
                fixedGroup.classList.add('hidden');
                percentageGroup.classList.remove('hidden');
            } else {
                fixedGroup.classList.remove('hidden');
                percentageGroup.classList.add('hidden');
            }
        }

        document.getElementById('addDeductionForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const type = document.getElementById('deductionType').value;
            const data = {
                staff_id: document.getElementById('deductionStaffId').value,
                description: document.getElementById('deductionDescription').value,
                deduction_type: type,
                percentage: type === 'percentage' ? document.getElementById('deductionPercentage').value : null,
                fixed_amount: type !== 'percentage' ? document.getElementById('deductionFixed').value : null
            };

            const response = await apiCall('/api/deductions', {
                method: 'POST',
                body: JSON.stringify(data)
            });

            if (response.ok) {
                closeModal('addDeductionModal');
                // Refresh deductions display
                const staffId = document.getElementById('deductionsStaffId').value;
                const staffName = document.getElementById('deductionsModalTitle').textContent.replace('Deductions - ', '');
                manageDeductions(staffId, staffName);
            }
        });

        async function toggleDeduction(deductionId) {
            const response = await apiCall(`/api/deductions/${deductionId}/toggle`, {
                method: 'POST'
            });

            if (response.ok) {
                // Refresh deductions display
                const staffId = document.getElementById('deductionsStaffId').value;
                const staffName = document.getElementById('deductionsModalTitle').textContent.replace('Deductions - ', '');
                manageDeductions(staffId, staffName);
            }
        }

        // ===== LOANS =====
        async function manageLoans(staffId, staffName) {
            try {
                const response = await apiCall(`/api/loans/staff/${staffId}`);
                const loanData = await response.json();

                // Show loan management modal
                document.getElementById('loanStaffName').textContent = staffName;
                document.getElementById('loanStaffId').value = staffId;

                // Display summary
                document.getElementById('loanCurrentBalance').textContent = `R${loanData.summary.current_balance.toFixed(2)}`;
                document.getElementById('loanTotalBorrowed').textContent = `R${loanData.summary.total_borrowed.toFixed(2)}`;
                document.getElementById('loanTotalRepaid').textContent = `R${loanData.summary.total_repaid.toFixed(2)}`;
                document.getElementById('loanMaxAmount').textContent = `R${(loanData.summary.max_loan_amount || 0).toFixed(2)}`;
                document.getElementById('loanActiveCount').textContent = loanData.summary.active_loans_count;
                document.getElementById('loanNextDeduction').textContent = `R${loanData.summary.next_deduction.toFixed(2)}`;

                // Display active loans
                const activeLoansContainer = document.getElementById('activeLoansContainer');
                if (loanData.active_loans.length === 0) {
                    activeLoansContainer.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 1rem;">No active loans</p>';
                } else {
                    activeLoansContainer.innerHTML = loanData.active_loans.map(loan => `
                        <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 0.5rem;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 0.5rem;">${loan.description}</div>
                                    <div style="font-size: 0.875rem; color: #6b7280;">
                                        Started: ${formatDateDMY(loan.loan_date)}
                                    </div>
                                    <div style="font-size: 0.875rem; color: #6b7280;">
                                        Installment: R${loan.installment_amount.toFixed(2)}/period
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 0.875rem; color: #6b7280;">Remaining</div>
                                    <div style="font-size: 1.25rem; font-weight: 700; color: #ef4444;">R${loan.amount_remaining.toFixed(2)}</div>
                                    <div style="font-size: 0.875rem; color: #059669;">R${loan.amount_paid.toFixed(2)} paid</div>
                                </div>
                            </div>
                            <div style="margin-top: 0.5rem;">
                                <div style="background: #e5e7eb; height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div style="background: #059669; height: 100%; width: ${loan.progress_percentage}%;"></div>
                                </div>
                                <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                                    ${loan.payments_made} of ${loan.total_installments} payments (${loan.progress_percentage.toFixed(0)}%)
                                </div>
                            </div>
                        </div>
                    `).join('');
                }

                // Display transaction history
                const transactionsContainer = document.getElementById('loanTransactionsContainer');
                if (loanData.recent_transactions.length === 0) {
                    transactionsContainer.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 1rem;">No transactions</p>';
                } else {
                    transactionsContainer.innerHTML = `
                        <table style="width: 100%; font-size: 0.875rem;">
                            <thead>
                                <tr style="border-bottom: 2px solid #e5e7eb;">
                                    <th style="text-align: left; padding: 0.5rem; color: #6b7280;">Date</th>
                                    <th style="text-align: left; padding: 0.5rem; color: #6b7280;">Type</th>
                                    <th style="text-align: left; padding: 0.5rem; color: #6b7280;">Description</th>
                                    <th style="text-align: right; padding: 0.5rem; color: #6b7280;">Amount</th>
                                    <th style="text-align: right; padding: 0.5rem; color: #6b7280;">Balance</th>
                                    <th style="text-align: center; padding: 0.5rem; color: #6b7280;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${loanData.recent_transactions.map(txn => `
                                    <tr style="border-bottom: 1px solid #f3f4f6;">
                                        <td style="padding: 0.5rem;">${formatDateDMY(txn.transaction_date)}</td>
                                        <td style="padding: 0.5rem;">
                                            <span style="background: ${txn.transaction_type === 'disbursement' ? '#fef3c7' : '#d1fae5'}; color: ${txn.transaction_type === 'disbursement' ? '#92400e' : '#065f46'}; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">
                                                ${txn.transaction_type.toUpperCase()}
                                            </span>
                                        </td>
                                        <td style="padding: 0.5rem;">${txn.description}</td>
                                        <td style="padding: 0.5rem; text-align: right; font-weight: 600; color: ${txn.transaction_type === 'disbursement' ? '#ef4444' : '#059669'};">
                                            ${txn.transaction_type === 'disbursement' ? '+' : '-'}R${txn.amount.toFixed(2)}
                                        </td>
                                        <td style="padding: 0.5rem; text-align: right;">R${txn.balance_after.toFixed(2)}</td>
                                        <td style="padding: 0.5rem; text-align: center;">
                                            <button onclick="deleteLoanTransaction(${txn.id}, ${txn.loan_id})" style="background: #dc2626; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;" title="Delete">X</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }

                showModal('manageLoansModal');
            } catch (error) {
                alert('Error loading loan data: ' + error.message);
            }
        }

        // Delete loan transaction
        async function deleteLoanTransaction(transactionId, loanId) {
            if (!confirm('Are you sure you want to delete this transaction? This will recalculate the loan balance.')) {
                return;
            }

            try {
                const response = await fetch(`/api/loans/transactions/${transactionId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete transaction');
                }

                // Refresh the loans modal
                const staffId = document.getElementById('loanStaffId').value;
                const staffName = document.getElementById('loanStaffName').textContent;
                manageLoans(staffId, staffName);

                // Also refresh payslips
                loadPayslips();
            } catch (error) {
                alert('Error deleting transaction: ' + error.message);
            }
        }

        // Show new loan modal
        function showNewLoanModal() {
            const staffId = document.getElementById('loanStaffId').value;
            const staffName = document.getElementById('loanStaffName').textContent;
            document.getElementById('newLoanStaffName').textContent = staffName;
            document.getElementById('newLoanForm').reset();

            // Set default start date to today
            document.getElementById('newLoanStartDate').valueAsDate = new Date();

            document.getElementById('manageLoansModal').classList.remove('active');
            document.getElementById('newLoanModal').classList.add('active');
        }

        // Handle new loan form submission
        document.getElementById('newLoanForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const staffId = document.getElementById('loanStaffId').value;
            const description = document.getElementById('newLoanDescription').value;
            const totalAmount = parseFloat(document.getElementById('newLoanAmount').value);
            const installmentAmount = parseFloat(document.getElementById('newLoanInstallment').value);
            const startDate = document.getElementById('newLoanStartDate').value;
            const notes = document.getElementById('newLoanNotes').value;

            // Validation
            if (installmentAmount > totalAmount) {
                alert('Installment amount cannot exceed total amount!');
                return;
            }

            // Check max loan amount
            const maxLoanAmount = parseFloat(document.getElementById('loanMaxAmount').textContent.replace('R', ''));
            const currentBalance = parseFloat(document.getElementById('loanCurrentBalance').textContent.replace('R', ''));
            const totalOutstanding = currentBalance + totalAmount;

            if (maxLoanAmount > 0 && totalOutstanding > maxLoanAmount) {
                const proceed = confirm(
                    `WARNING: Total outstanding loans (R${totalOutstanding.toFixed(2)}) will exceed max loan amount (R${maxLoanAmount.toFixed(2)})!\n\n` +
                    `Current balance: R${currentBalance.toFixed(2)}\n` +
                    `New loan: R${totalAmount.toFixed(2)}\n\n` +
                    `Do you want to proceed anyway?`
                );
                if (!proceed) {
                    return;
                }
            }

            try {
                await apiCall('/api/loans', {
                    method: 'POST',
                    body: JSON.stringify({
                        staff_id: parseInt(staffId),
                        description,
                        total_amount: totalAmount,
                        installment_amount: installmentAmount,
                        start_deduction_date: startDate,
                        notes
                    })
                });

                alert('Loan created successfully!');
                closeModal('newLoanModal');

                // Refresh loans display
                const staffName = document.getElementById('loanStaffName').textContent;
                manageLoans(staffId, staffName);
            } catch (error) {
                alert('Error creating loan: ' + error.message);
            }
        });

        // Show manual repayment modal
        async function showManualRepaymentModal() {
            const staffId = document.getElementById('loanStaffId').value;

            try {
                // Populate loan dropdown with active loans
                const response = await apiCall(`/api/loans/staff/${staffId}`);
                const loanData = await response.json();
                const loanSelect = document.getElementById('repaymentLoanId');
                loanSelect.innerHTML = '<option value="">-- Select Loan --</option>';

                const activeLoans = loanData.active_loans || [];
                if (activeLoans.length === 0) {
                    alert('No active loans to repay');
                    return;
                }

                activeLoans.forEach(loan => {
                    loanSelect.innerHTML += `
                        <option value="${loan.id}">
                            ${loan.description} - R${loan.amount_remaining.toFixed(2)} remaining
                        </option>
                    `;
                });

                document.getElementById('manualRepaymentForm').reset();
                closeModal('manageLoansModal');
                showModal('manualRepaymentModal');
            } catch (error) {
                console.error('Error loading loans:', error);
                alert('Error loading loans: ' + error.message);
            }
        }

        // Handle manual repayment form submission
        document.getElementById('manualRepaymentForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const loanId = document.getElementById('repaymentLoanId').value;
            const amount = parseFloat(document.getElementById('repaymentAmount').value);
            const notes = document.getElementById('repaymentNotes').value;

            try {
                await apiCall(`/api/loans/${loanId}/repayment`, {
                    method: 'POST',
                    body: JSON.stringify({
                        amount,
                        notes
                    })
                });

                alert('Repayment recorded successfully!');
                closeModal('manualRepaymentModal');

                // Refresh loans display
                const staffId = document.getElementById('loanStaffId').value;
                const staffName = document.getElementById('loanStaffName').textContent;
                manageLoans(staffId, staffName);
            } catch (error) {
                alert('Error recording repayment: ' + error.message);
            }
        });

        // ===== SAVINGS =====
        async function manageSavings(staffId, staffName) {
            document.getElementById('savingsStaffId').value = staffId;
            document.getElementById('savingsModalTitle').textContent = `Savings - ${staffName}`;

            const response = await apiCall(`/api/savings/staff/${staffId}`);
            const data = await response.json();

            // Display current balance
            const balance = data.account ? data.account.total_balance : 0;
            document.getElementById('currentBalance').textContent = `R ${balance.toFixed(2)}`;

            // Display transactions
            const container = document.getElementById('savingsTransactionsContainer');

            if (data.transactions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280;">No transactions yet</p>';
            } else {
                container.innerHTML = data.transactions.map(t => `
                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span class="badge ${t.transaction_type === 'deposit' ? 'badge-success' : 'badge-warning'}">
                                        ${t.transaction_type.toUpperCase()}
                                    </span>
                                    <span style="font-weight: 600; font-size: 1.1rem;">R ${t.amount.toFixed(2)}</span>
                                </div>
                                <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">
                                    ${t.description || ''}
                                </div>
                                <div style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.25rem;">
                                    ${formatDateDMY(t.transaction_date)} - Balance after: R${t.balance_after.toFixed(2)}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            showModal('savingsModal');
        }

        function showAddSavingsTransaction(type) {
            const staffId = document.getElementById('savingsStaffId').value;
            document.getElementById('savingsTransactionStaffId').value = staffId;
            document.getElementById('savingsTransactionType').value = type;
            document.getElementById('savingsTransactionTitle').textContent = type === 'deposit' ? 'Deposit Savings' : 'Withdraw Savings';
            document.getElementById('addSavingsTransactionForm').reset();
            showModal('addSavingsTransactionModal');
        }

        document.getElementById('addSavingsTransactionForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                staff_id: parseInt(document.getElementById('savingsTransactionStaffId').value),
                transaction_type: document.getElementById('savingsTransactionType').value,
                amount: parseFloat(document.getElementById('savingsAmount').value),
                description: document.getElementById('savingsDescription').value
            };

            const response = await apiCall('/api/savings', {
                method: 'POST',
                body: JSON.stringify(data)
            });

            if (response.ok) {
                closeModal('addSavingsTransactionModal');
                // Refresh savings display
                const staffId = document.getElementById('savingsStaffId').value;
                const staffName = document.getElementById('savingsModalTitle').textContent.replace('Savings - ', '');
                manageSavings(staffId, staffName);
            }
        });

        // ===== USERS MANAGEMENT =====
        async function loadUsers() {
            const response = await apiCall('/api/users');
            const users = await response.json();

            const tbody = document.getElementById('usersTableBody');

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No users found</td></tr>';
            } else {
                tbody.innerHTML = users.map(u => `
                    <tr>
                        <td>${u.username}</td>
                        <td>${u.full_name}</td>
                        <td>${u.email || '-'}</td>
                        <td><span class="badge badge-info">${u.role.toUpperCase()}</span></td>
                        <td><span class="badge ${u.is_active ? 'badge-success' : 'badge-danger'}">${u.is_active ? 'Active' : 'Inactive'}</span></td>
                        <td>${u.last_login ? new Date(u.last_login).toLocaleString() : 'Never'}</td>
                        <td>
                            <button class="btn btn-small btn-secondary" onclick="showEditUserModal(${u.id}, '${u.username}', '${u.full_name}', '${u.email || ''}', '${u.role}')">Edit</button>
                            <button class="btn btn-small btn-secondary" onclick="showChangePasswordModal(${u.id})">Change PW</button>
                            <button class="btn btn-small ${u.is_active ? 'btn-warning' : 'btn-success'}" onclick="toggleUserActive(${u.id})">
                                ${u.is_active ? 'Deactivate' : 'Activate'}
                            </button>
                        </td>
                    </tr>
                `).join('');
            }
        }

        function showAddUserModal() {
            document.getElementById('addUserForm').reset();
            showModal('addUserModal');
        }

        function showEditUserModal(id, username, fullName, email, role) {
            document.getElementById('editUserId').value = id;
            document.getElementById('editUserUsername').value = username;
            document.getElementById('editUserFullName').value = fullName;
            document.getElementById('editUserEmail').value = email;
            document.getElementById('editUserRole').value = role;
            showModal('editUserModal');
        }

        function showChangePasswordModal(userId) {
            document.getElementById('passwordUserId').value = userId;
            document.getElementById('changePasswordForm').reset();
            showModal('changePasswordModal');
        }

        document.getElementById('addUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                username: document.getElementById('userUsername').value,
                password: document.getElementById('userPassword').value,
                full_name: document.getElementById('userFullName').value,
                email: document.getElementById('userEmail').value || null,
                role: document.getElementById('userRole').value
            };

            const response = await apiCall('/api/users', {
                method: 'POST',
                body: JSON.stringify(data)
            });

            if (response.ok) {
                closeModal('addUserModal');
                loadUsers();
            }
        });

        document.getElementById('editUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const userId = document.getElementById('editUserId').value;
            const data = {
                username: document.getElementById('editUserUsername').value,
                full_name: document.getElementById('editUserFullName').value,
                email: document.getElementById('editUserEmail').value || null,
                role: document.getElementById('editUserRole').value
            };

            const response = await apiCall(`/api/users/${userId}`, {
                method: 'PUT',
                body: JSON.stringify(data)
            });

            if (response.ok) {
                closeModal('editUserModal');
                loadUsers();
            }
        });

        document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                alert('Passwords do not match!');
                return;
            }

            const userId = document.getElementById('passwordUserId').value;
            const data = { new_password: newPassword };

            const response = await apiCall(`/api/users/${userId}/change-password`, {
                method: 'POST',
                body: JSON.stringify(data)
            });

            if (response.ok) {
                closeModal('changePasswordModal');
                alert('Password changed successfully');
            }
        });

        async function toggleUserActive(userId) {
            const response = await apiCall(`/api/users/${userId}/toggle-active`, {
                method: 'POST'
            });

            if (response.ok) {
                loadUsers();
            }
        }

        // ===== SITES MANAGEMENT (UPDATE) =====
        function showEditSiteModal(id, name, code, description, address, bank_name, account_number, gps_lat, gps_lng, gps_radius) {
            document.getElementById('editSiteId').value = id;
            document.getElementById('editSiteName').value = name;
            document.getElementById('editSiteCode').value = code || '';
            document.getElementById('editSiteDescription').value = description || '';
            document.getElementById('editSiteAddress').value = address || '';
            document.getElementById('editSiteBankName').value = bank_name || '';
            document.getElementById('editSiteAccountNumber').value = account_number || '';
            document.getElementById('editSiteLatitude').value = gps_lat || '';
            document.getElementById('editSiteLongitude').value = gps_lng || '';
            document.getElementById('editSiteRadius').value = gps_radius || 100;
            showModal('editSiteModal');
        }

        document.getElementById('editSiteForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const siteId = document.getElementById('editSiteId').value;
            const latVal = document.getElementById('editSiteLatitude').value;
            const lngVal = document.getElementById('editSiteLongitude').value;
            const radiusVal = document.getElementById('editSiteRadius').value;

            const data = {
                name: document.getElementById('editSiteName').value,
                code: document.getElementById('editSiteCode').value,
                description: document.getElementById('editSiteDescription').value,
                address: document.getElementById('editSiteAddress').value,
                bank_name: document.getElementById('editSiteBankName').value,
                account_number: document.getElementById('editSiteAccountNumber').value,
                gps_latitude: latVal ? parseFloat(latVal) : null,
                gps_longitude: lngVal ? parseFloat(lngVal) : null,
                gps_radius_meters: radiusVal ? parseInt(radiusVal) : 100
            };

            const response = await apiCall(`/api/sites/${siteId}`, {
                method: 'PUT',
                body: JSON.stringify(data)
            });

            if (response.ok) {
                closeModal('editSiteModal');
                loadSites();
            }
        });

        async function toggleSiteActive(siteId) {
            const response = await apiCall(`/api/sites/${siteId}/toggle-active`, {
                method: 'POST'
            });

            if (response.ok) {
                loadSites();
            }
        }

        // ===== PAYMENT METHOD TOGGLE =====
        async function togglePaymentMethod(payslipId, currentMethod) {
            const newMethod = currentMethod === 'BANK' ? 'CASH' : 'BANK';

            const response = await apiCall(`/api/payslips/${payslipId}`, {
                method: 'PUT',
                body: JSON.stringify({ payment_method: newMethod })
            });

            if (response && response.ok) {
                loadPayslips();
            } else {
                alert('Failed to update payment method');
            }
        }

        // ===== PAYSLIP APPROVAL & PDF GENERATION =====
        async function approvePayslip(payslipId) {
            const response = await apiCall(`/api/payslips/${payslipId}/approve`, {
                method: 'POST'
            });

            if (response.ok) {
                loadPayslips();
            }
        }

        async function generatePDFs() {
            const periodId = document.getElementById('payPeriodSelect').value;

            if (!periodId) {
                alert('Please select a pay period first');
                return;
            }
            const response = await apiCall(`/api/payslips/generate-pdfs/${periodId}`, {
                method: 'POST'
            });
            console.log('API response:', response);

            if (response.ok) {
                const result = await response.json();
                let message = `PDF Generation Complete!\n\n`;
                message += `Generated: ${result.generated}\n`;
                message += `Not Approved: ${result.not_approved}\n`;
                message += `Errors: ${result.errors}\n\n`;
                message += `PDFs saved to:\n${result.output_dir}\n\n`;
                if (result.pdf_files && result.pdf_files.length > 0) {
                    message += `Files:\n${result.pdf_files.join('\n')}`;
                }
                alert(message);
            } else {
                const error = await response.json();
                alert(`Error: ${error.error || 'Failed to generate PDFs'}`);
            }
        }

        async function sendPayslipSMS() {
            const periodId = document.getElementById('payPeriodSelect').value;

            if (!periodId) {
                alert('Please select a pay period first');
                return;
            }

            // Count staff with phone/mobile numbers
            const approvedPayslips = currentPayslips.filter(p => p.is_approved);
            const withMobile = approvedPayslips.filter(p => {
                const staff = allStaff.find(s => s.id === p.staff_id);
                const phone = staff?.mobile || staff?.phone;
                return staff && phone && phone.trim();
            });

            if (withMobile.length === 0) {
                alert('No approved staff have phone numbers recorded.');
                return;
            }

            // Warning confirmation
            if (!confirm(`Send SMS notifications to ${withMobile.length} staff members?\n\nThis will send payslip details via SMS to all approved staff with mobile numbers.\n\nContinue?`)) {
                return;
            }

            const response = await apiCall(`/api/payslips/send-sms/${periodId}`, {
                method: 'POST'
            });

            if (response.ok) {
                const result = await response.json();
                let message = `SMS Notifications Sent!\n\n`;
                message += `Sent to: ${result.sent_count} staff\n`;
                message += `No mobile: ${result.no_mobile_count} staff\n\n`;
                message += `${result.upload_message}`;
                alert(message);
            } else {
                const error = await response.json();
                alert(`Error: ${error.error || 'Failed to send SMS notifications'}`);
            }
        }

        // Check for existing token on page load
        window.addEventListener('load', () => {
            const token = localStorage.getItem('wagepro_token');
            if (token) {
                authToken = token;
                // Verify token is still valid
                fetch('/api/auth/me', {
                    headers: {'Authorization': `Bearer ${token}`}
                }).then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('Token invalid');
                    }
                }).then(data => {
                    currentUser = data;
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    document.getElementById('userName').textContent = currentUser.full_name;
                    loadInitialData();
                }).catch(() => {
                    localStorage.removeItem('wagepro_token');
                });
            }
        });

        // ===== TRACKING =====
        async function loadTracking() {
            try {
                const response = await apiCall('/api/tracking/today');
                const data = await response.json();

                // Update summary cards
                document.getElementById('trackingSignedIn').textContent = data.signed_in_count || 0;
                document.getElementById('trackingSignedOut').textContent = data.signed_out_count || 0;
                document.getElementById('trackingNotSignedIn').textContent = data.not_signed_in_count || 0;
                document.getElementById('trackingTotalHours').textContent = (data.total_hours || 0).toFixed(1);

                // Update signed in table
                const signedInTable = document.getElementById('trackingSignedInTable');
                if (data.signed_in && data.signed_in.length > 0) {
                    signedInTable.innerHTML = data.signed_in.map(a => `
                        <tr>
                            <td><strong>${a.staff_name}</strong></td>
                            <td>${a.site_name || 'No Site'}</td>
                            <td>${a.signin_time}</td>
                            <td>${a.hours_so_far.toFixed(1)}h</td>
                            <td>${a.gps_verified ? '<span style="color: #10b981;">‚úì Yes</span>' : '<span style="color: #ef4444;">‚úó No</span>'}</td>
                            <td>
                                <button class="btn btn-small" style="background: #8b5cf6; color: white;" onclick="requestWhereabouts(${a.staff_id}, '${a.staff_name}')">üìç Locate</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    signedInTable.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #6b7280;">No staff currently signed in</td></tr>';
                }

                // Update completed shifts table
                const completedTable = document.getElementById('trackingCompletedTable');
                if (data.completed && data.completed.length > 0) {
                    completedTable.innerHTML = data.completed.map(a => `
                        <tr>
                            <td>${a.staff_name}</td>
                            <td>${a.site_name || 'No Site'}</td>
                            <td>${a.signin_time}</td>
                            <td>${a.signout_time}</td>
                            <td><strong>${a.hours_worked.toFixed(1)}h</strong></td>
                            <td>${a.gps_verified ? '<span style="color: #10b981;">‚úì</span>' : '<span style="color: #ef4444;">‚úó</span>'}</td>
                        </tr>
                    `).join('');
                } else {
                    completedTable.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #6b7280;">No completed shifts today</td></tr>';
                }

                // Load location requests
                await loadLocationRequests();

            } catch (error) {
                console.error('Error loading tracking:', error);
            }
        }

        async function loadLocationRequests() {
            try {
                const response = await apiCall('/api/location/requests');
                const data = await response.json();

                const locationTable = document.getElementById('trackingLocationTable');
                if (data.requests && data.requests.length > 0) {
                    locationTable.innerHTML = data.requests.map(r => {
                        let statusBadge = '';
                        let locationLink = '-';

                        if (r.status === 'received') {
                            statusBadge = '<span style="background: #10b981; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Received</span>';
                            if (r.latitude && r.longitude) {
                                locationLink = `<a href="https://maps.google.com/?q=${r.latitude},${r.longitude}" target="_blank" style="color: #0ea5e9;">üìç View Map</a>`;
                            }
                        } else if (r.status === 'pending') {
                            statusBadge = '<span style="background: #f59e0b; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Pending</span>';
                        } else {
                            statusBadge = '<span style="background: #6b7280; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Expired</span>';
                        }

                        return `
                            <tr>
                                <td><strong>${r.staff_name}</strong></td>
                                <td style="color: #dc2626; font-weight: 700;">${r.staff_phone || '-'}</td>
                                <td>${r.requested_at}</td>
                                <td>${r.reason || '-'}</td>
                                <td>${statusBadge}</td>
                                <td>${locationLink}</td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    locationTable.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #6b7280;">No recent whereabouts checks</td></tr>';
                }
            } catch (error) {
                console.error('Error loading location requests:', error);
            }
        }

        async function quickLocate(staffId, staffName) {
            if (!confirm(`Send whereabouts request SMS to ${staffName}?`)) return;

            try {
                const response = await apiCall('/api/location/request', {
                    method: 'POST',
                    body: JSON.stringify({
                        staff_id: staffId,
                        reason: 'Whereabouts check'
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert(`üìç SMS sent to ${staffName}`);
                } else {
                    alert('Error: ' + (data.error || 'Failed to send SMS'));
                }
            } catch (error) {
                alert('Error sending whereabouts request');
            }
        }

        function showWhereaboutsModal() {
            // Populate staff dropdown
            const select = document.getElementById('whereaboutsStaff');
            select.innerHTML = '<option value="">Select staff...</option>' +
                allStaff.filter(s => s.mobile || s.phone).map(s =>
                    `<option value="${s.id}">${s.full_name} (${s.mobile || s.phone})</option>`
                ).join('');

            document.getElementById('whereaboutsReason').value = '';
            showModal('whereaboutsModal');
        }

        async function requestWhereabouts(staffId, staffName) {
            if (!confirm(`Send whereabouts request SMS to ${staffName}?`)) return;

            try {
                const response = await apiCall('/api/location/request', {
                    method: 'POST',
                    body: JSON.stringify({
                        staff_id: staffId,
                        reason: 'Location check from tracking'
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert(`SMS sent to ${staffName}`);
                    loadTracking();
                } else {
                    alert('Error: ' + (data.error || 'Failed to send SMS'));
                }
            } catch (error) {
                alert('Error sending whereabouts request');
            }
        }

        if (document.getElementById('whereaboutsForm')) {
            document.getElementById('whereaboutsForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const staffId = document.getElementById('whereaboutsStaff').value;
                const reason = document.getElementById('whereaboutsReason').value;

                try {
                    const response = await apiCall('/api/location/request', {
                        method: 'POST',
                        body: JSON.stringify({
                            staff_id: parseInt(staffId),
                            reason: reason || 'Whereabouts check'
                        })
                    });

                    const data = await response.json();
                    if (data.success) {
                        alert('SMS sent successfully!');
                        closeModal('whereaboutsModal');
                        loadTracking();
                    } else {
                        alert('Error: ' + (data.error || 'Failed to send SMS'));
                    }
                } catch (error) {
                    alert('Error sending whereabouts request');
                }
            });
        }

        // ===== CONFIG =====
        async function loadConfig() {
            try {
                const response = await apiCall('/api/config');
                const data = await response.json();

                document.getElementById('configAdminName').value = data.admin_name || '';
                document.getElementById('configAdminEmail').value = data.admin_email || '';
                document.getElementById('configAdminMobile').value = data.admin_mobile || '';
                document.getElementById('configCompanyName').value = data.company_name || '';
                document.getElementById('configPublicUrl').value = data.public_url || '';
                document.getElementById('configNotifySignin').checked = data.notify_signin !== false;
                document.getElementById('configNotifySignout').checked = data.notify_signout !== false;
                document.getElementById('configNotifyLocation').checked = data.notify_location !== false;
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }

        if (document.getElementById('configForm')) {
            document.getElementById('configForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                try {
                    const response = await apiCall('/api/config', {
                        method: 'POST',
                        body: JSON.stringify({
                            admin_name: document.getElementById('configAdminName').value,
                            admin_email: document.getElementById('configAdminEmail').value,
                            admin_mobile: document.getElementById('configAdminMobile').value,
                            company_name: document.getElementById('configCompanyName').value,
                            notify_signin: document.getElementById('configNotifySignin').checked,
                            notify_signout: document.getElementById('configNotifySignout').checked,
                            notify_location: document.getElementById('configNotifyLocation').checked
                        })
                    });

                    const data = await response.json();
                    if (data.success) {
                        alert('Configuration saved successfully!');
                    } else {
                        alert('Error: ' + (data.error || 'Failed to save'));
                    }
                } catch (error) {
                    alert('Error saving configuration');
                }
            });
        }

        async function savePublicUrl() {
            try {
                const response = await apiCall('/api/config/public-url', {
                    method: 'POST',
                    body: JSON.stringify({
                        public_url: document.getElementById('configPublicUrl').value
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert('Public URL saved successfully!');
                } else {
                    alert('Error: ' + (data.error || 'Failed to save'));
                }
            } catch (error) {
                alert('Error saving public URL');
            }
        }
    </script>
</body>
</html>
